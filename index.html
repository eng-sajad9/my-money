<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#3b82f6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%233b82f6' width='180' height='180'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='100' font-weight='bold' fill='white' font-family='Arial'>ğŸ’°</text></svg>" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%233b82f6' width='180' height='180' rx='40'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='90' fill='white' font-family='Arial'>ğŸ’°</text></svg>" />
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ%22,%22short_name%22:%22Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ%22,%22description%22:%22ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø³ÙŠØ· ÙˆÙØ¹Ø§Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©%22,%22start_url%22:%22/index.html%22,%22scope%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23ffffff%22,%22theme_color%22:%22%233b82f6%22,%22orientation%22:%22portrait-primary%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%233b82f6' width='192' height='192'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='120' fill='white' font-family='Arial'>ğŸ’°</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22any%22},{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%233b82f6' width='192' height='192' rx='50'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='120' fill='white' font-family='Arial'>ğŸ’°</text></svg>%22,%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22,%22purpose%22:%22maskable%22}]}" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Theme & palette (soft, mobile-friendly) */
      --bg: linear-gradient(180deg,#fbfdff 0%, #f3f6fb 100%);
      --card: #ffffff;
      --text: #0b1220; --muted: #5b6776;
      --accent-start:#6b8cff; --accent-end:#5ad0ff; --danger:#ff6b6b; --success:#34d399; --blue:#3b82f6; --gray:#9aa3b2;
      --glass: rgba(255,255,255,0.6);
      --radius:14px;
      font-family: 'Poppins', system-ui, Arial;
      font-size:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale; padding:20px 18px; -webkit-tap-highlight-color: transparent;
    }
    /* App grid: main + sidebar */
    .app{
      max-width:1100px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr 340px;
      align-items:start;
    }
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:20px;margin:0;font-weight:700}
    .top-actions{display:flex;gap:10px;align-items:center}
    
    /* Online/Offline indicator */
    .connection-indicator {
      position: fixed;
      top: 12px;
      right: 12px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      z-index: 1000;
      display: block;
      transition: all 0.3s;
      box-shadow: 0 0 8px rgba(0,0,0,0.15);
    }
    
    .connection-indicator.online {
      background: #22c55e;
      box-shadow: 0 0 6px rgba(34, 197, 94, 0.4);
    }
    
    .connection-indicator.offline {
      background: #ef4444;
      animation: pulse 1.5s infinite;
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .sync-status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Primary button (default) - neutral pleasant gradient
       Note: colors are kept as-is (ID selectors below override gradients for semantics).
       Styling focuses on size, padding, radius, shadow, and centering for touch. */
    .btn{
      background:linear-gradient(90deg,var(--accent-start),var(--accent-end));
      color:#fff;
      padding:0.9rem 1.1rem;
      border-radius:0.875rem;
      border:0;
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s, opacity .14s;
      font-weight:600;
      font-size:1.025rem;
      box-shadow:0 0.375rem 1.125rem rgba(16,24,40,.08);
      display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;line-height:1;
      text-align:center;
      vertical-align:middle;
      min-height:44px;
      touch-action:manipulation;
    }
    .btn:hover{transform:translateY(-0.125rem);box-shadow:0 0.75rem 1.75rem rgba(16,24,40,.10)}
    .btn:active{transform:translateY(-0.0625rem);box-shadow:0 0.375rem 1rem rgba(16,24,40,.06)}

    /* Ghost style (secondary) - subtle border */
    .ghost{background:transparent;color:var(--muted);box-shadow:none;border:1px solid rgba(100,110,140,.08);display:inline-flex;align-items:center;justify-content:center}

    /* Specific semantic colors by ID (do not change any IDs in HTML/JS) */
    /* Add / Create (green) */
    #openAddBtn, #addCatBtn, #openAddBtn:focus, #addCatBtn:focus{ background:linear-gradient(90deg,#34d399,#10b981); }
    /* Save actions (blue) */
    #saveBudgetCatBtn, #salarySave, #initFirebaseBtn{ background:linear-gradient(90deg,var(--blue),#60a5fa); }
    /* Cancel-like actions (gray/neutral) */
    #cancelAdd, #salaryCancel, #closeCats, #closeConfig{ background:transparent; color:var(--muted); border:1px solid rgba(100,110,140,.08); box-shadow:none }
    /* Clear / Delete month (destructive) */
    #clearMonthBtn{ background:linear-gradient(90deg,#ff7b7b,#ff5a5a); color:#fff; border:0; }

    /* Make the 'Ø§Ù„ÙØ¦Ø§Øª' (categories) button more prominent (purple) */
    #openCatsBtn{ background: linear-gradient(90deg,#8b5cf6,#7c3aed); color:#fff; border:0; padding:0.9rem 1.1rem; }
    
    /* Archive button (orange) */
    #archiveBtn{ background:linear-gradient(90deg,#f59e0b,#d97706); color:#fff; border:0; }

    /* For dynamic lists: treat the last ghost button inside an expense/card as Delete (red)
       This matches the structure where edit then delete buttons are appended. */
    .expense .btn.ghost:last-child{ background:linear-gradient(90deg,#ff6b6b,#ff4b4b); color:#fff; border:0 }

    /* Edit buttons inside expense rows should be blue for clarity */
    .expense .btn.ghost:first-child{ background: linear-gradient(90deg,#3b82f6,#60a5fa); color:#fff; border:0 }    /* Per-category budgets list: make the 'Ø­Ø°Ù' button visually destructive (red)
       Target the last button inside the right cell of each budget row so we don't
       need to change JS or add classes. Also ensure edit+delete buttons are
       consistent and touch-friendly on phones. */
    #catBudgetsList > div > div:last-child > button.btn.ghost:last-child{
      background: linear-gradient(90deg,#ff6b6b,#ff4b4b) !important;
      color: #fff !important;
      border: 0 !important;
      box-shadow: 0 8px 20px rgba(255,90,90,.12) !important;
      padding: 10px 12px !important;
      min-width: 64px;
      font-weight: 700 !important;
      border-radius: 10px !important;
      display: inline-flex !important; align-items: center; justify-content: center;
    }

    /* Make edit + delete buttons inside catBudgetsList consistent */
    #catBudgetsList button.btn.ghost{
      padding: 10px 12px !important;
      min-width: 64px !important;
      font-weight: 700 !important;
      border-radius: 10px !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 8px;
      color: inherit !important;
      background: transparent !important;
      border: 1px solid rgba(100,110,140,.06) !important;
    }

    /* Make the edit button in the budgets list blue (first button) */
    #catBudgetsList > div > div:last-child > button.btn.ghost:first-child{
      background: linear-gradient(90deg,#3b82f6,#60a5fa) !important;
      color:#fff !important; border:0 !important;
    }

    /* On small screens make buttons slightly larger for easier touch */
    @media (max-width:420px){
      #catBudgetsList button.btn.ghost{ padding:12px 14px !important; min-width:72px !important; }
      #catBudgetsList > div > div:last-child > button.btn.ghost:last-child{ padding:12px 14px !important; min-width:72px !important; }
      
      /* Archive modal improvements for mobile */
      #archiveModal .modal{
        max-width:100%;
        width:100%;
        min-width: auto;
        max-height: 85vh;
      }
      
      #archiveModal .modal .card {
        padding: 12px;
        gap: 10px;
      }

      #archiveModal h3 {
        font-size: 16px;
        margin-bottom: 10px;
      }

      #archiveSelectMonth,
      #archiveViewMonth {
        width: 100%;
        padding: 12px;
        font-size: 16px;
        box-sizing: border-box;
      }

      #executeArchiveBtn,
      #viewArchiveDetailBtn,
      #deleteArchiveMonthBtn,
      #archiveOverallStats {
        padding: 12px 16px;
        font-size: 14px;
        min-height: 44px;
        flex: 1;
      }

      #archiveModal > .modal > .card > div > div {
        padding: 12px;
        margin-bottom: 10px;
      }

      #archivePreview {
        font-size: 14px;
        padding: 12px;
        min-height: 80px;
      }

      #archiveViewContent,
      #archiveStatsContent {
        font-size: 14px;
        max-height: 250px !important;
        padding: 10px;
      }

      /* Button containers in archive modal should flex */
      #archiveModal > .modal > .card > div > div > div:first-child {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      #archiveModal > .modal > .card > div > div:last-child {
        display: flex;
        gap: 8px;
        justify-content: center;
        padding: 12px;
        margin-bottom: 0;
      }

      #archiveModal > .modal > .card > div > div:last-child button {
        flex: 1;
        min-height: 44px;
      }
    }

    /* Ensure archive modal is responsive and fits narrow screens */
    .modal#archiveModal{
      max-width:96vw !important;
      width:96vw !important;
      min-width:auto !important;
      padding:10px !important;
      box-sizing:border-box !important;
    }

    .search{display:flex;gap:8px;align-items:center}
    input,select,textarea{padding:12px;border-radius:12px;border:1px solid #e9eef6;background:var(--card);font-family:inherit;color:var(--text);font-size:15px}
    input::placeholder, textarea::placeholder{color:var(--gray)}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(16,24,40,.04);transition:transform .14s ease, box-shadow .14s}
    .card:hover{transform:translateY(-4px);box-shadow:0 20px 50px rgba(16,24,40,.06)}

    /* left column */
    .main{display:flex;flex-direction:column;gap:14px}
    .summary{display:flex;gap:12px}
    .summary .item{flex:1;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.4));}
    .month-list{display:flex;gap:8px;overflow:auto;padding-bottom:6px;align-items:center}
    .month-chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(100,110,140,.06);color:var(--muted);cursor:pointer;transition:transform .12s, box-shadow .12s}
    .month-chip:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(16,24,40,.04)}

   /* Allow the expenses list to grow taller so more items are visible on mobile.
     Use a viewport-based calc so it adapts to headers/summaries and keeps scrolling. */
   .expenses-list{display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 240px);overflow:auto;padding-right:6px}
    .expense{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px}
    .expense .left{display:flex;gap:12px;align-items:center}
    .cat-badge{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;background:linear-gradient(135deg, rgba(124,108,255,0.9), rgba(90,208,255,0.8));}
    .muted{color:var(--muted);font-size:13px}

    /* entry meta (date + notes) clearer and separated */
    .entry-meta{display:none}
    .entry-date{color:var(--muted);font-size:13px;margin-top:6px;font-weight:600}
    .entry-notes{color:var(--text);font-size:14px;margin-top:6px;opacity:0.98;line-height:1.35;font-weight:600}
    .meta-label{display:inline-block;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;padding:2px 8px;border-radius:999px;font-size:11px;margin-inline-end:8px;font-weight:700}
    .meta-value{color:inherit}

    /* right column */
    aside{display:flex;flex-direction:column;gap:12px}
    .small{font-size:13px}

    /* modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60;padding:18px}
    .modal{width:520px;max-width:100%;border-radius:14px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch}
    .modal .card{padding:18px}
    .row{display:flex;gap:8px}

    /* Categories modal adjustments for better mobile layout */
    #catsModal .card{display:flex;flex-direction:column;gap:0.75rem}
    /* Make the new-category row inputs stack on small screens */
    @media (max-width:420px){
      #newCatName, #newCatIcon, #newCatColor, #addCatBtn{width:100% !important;display:block;margin:0 0 0.5rem 0}
      #catsModal #catsList > div{flex-direction:column !important;align-items:stretch !important;gap:0.5rem;padding:0.6rem;border-bottom:1px solid rgba(2,6,23,0.04)}
      #catsModal #catsList > div > div.flex{width:100%}
      /* make delete button fill and easy to tap */
      #catsModal #catsList > div > button.btn.ghost{width:100% !important;padding:0.8rem 1rem !important;border-radius:0.6rem !important;justify-content:center}
      /* ensure badge and text wrap nicely */
      #catsModal #catsList .cat-badge{width:3rem;height:3rem;font-size:1rem}
    }

    /* Desktop/tablet: tidy spacing for cats list rows */
    #catsModal #catsList > div{display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0;border-bottom:1px solid rgba(2,6,23,0.03)}
    #catsModal #catsList > div > div.flex{display:flex;gap:0.6rem;align-items:center}
    #catsModal #catsList > div button.btn.ghost{min-width:6rem}

    /* Month Management Styling */
    #monthsList { 
      max-height: 350px; 
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    #monthsList > div {
      transition: all 0.2s ease;
    }
    #monthsList > div:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16,24,40,.08);
    }
    
    #monthsStatsBar {
      font-weight: 600;
    }

    /* Responsive: mobile-first improvements */
    @media (max-width:900px){
      .app{grid-template-columns:1fr; padding-bottom:40px}
      aside{order:2}
      .aside-hidden{display:none}
    }
    /* Target phones up to 430px for iPhone 14/15 family */
    @media (max-width:430px){
      body{padding:0.9rem}
      /* Buttons: consistent full-width stack in header/actions */
      .btn{padding:0.9rem 1rem;font-size:1.05rem;border-radius:0.9rem;min-height:3.2rem}
      input,select,textarea{padding:0.9rem;font-size:1rem}
      .month-chip{padding:0.6rem 0.9rem}
      /* Expenses: stack and add gaps for readability */
      .expense{flex-direction:column;align-items:flex-start;gap:0.5rem}
      .expense .left{width:100%}
      .right{width:100%;text-align:left;margin-top:0}
      .expenses-list{max-height:68vh}
      .entry-notes{font-size:1rem}
      .entry-date{font-size:0.95rem}
      .cat-badge{width:3.0rem;height:3.0rem;font-size:1.05rem}
      .actions{display:flex;gap:0.5rem;margin-top:0.5rem}
      .summary{flex-direction:column}
      header{flex-direction:column;align-items:stretch;gap:0.6rem}
      /* Top actions: search + buttons stack nicely and have equal spacing */
      .top-actions{flex-direction:column;align-items:stretch;gap:0.6rem}
      .top-actions .search{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap}
      .top-actions .btn, .top-actions .btn.ghost{
        width:100%;
        display:flex;
        justify-content:center;
        padding:0.95rem 1rem;
        font-size:1.05rem;
        min-height:3.2rem;
      }
      
      /* Arrange action buttons in 2 rows on mobile */
      .top-actions > .btn:nth-child(n+2){
        order: 1;
      }
      
      .top-actions .search {
        order: 0;
        margin-bottom: 0.5rem;
      }
      .modal{width:100%;max-width:40rem}
    }

    /* Extra small phones (< 380px width) */
    @media (max-width:380px){
      .btn{padding:0.8rem 0.9rem;font-size:0.95rem;min-height:40px}
      input,select,textarea{padding:0.8rem;font-size:15px}
      
      #archiveSelectMonth, #archiveViewMonth {
        font-size: 14px !important;
        padding: 10px !important;
      }

      #executeArchiveBtn, #viewArchiveDetailBtn, #deleteArchiveMonthBtn {
        padding: 8px 10px !important;
        font-size: 13px !important;
        min-width: 60px !important;
      }

      #archiveModal .modal {
        max-height: 80vh !important;
      }

      #archiveViewContent, #archiveStatsContent {
        max-height: 200px !important;
      }
    }


    /* progress */
    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));width:0;transition:width .6s ease}

    /* charts */
    canvas{width:100%;height:180px}

    /* toasts */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(12px) scale(.98);transition:opacity .24s cubic-bezier(.2,.9,.2,1),transform .24s cubic-bezier(.2,.9,.2,1);box-shadow:0 10px 30px rgba(16,24,40,.08)}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}

  /* Lightbox for full-size image preview */
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);z-index:9999;padding:18px}
  .lightbox.show{display:flex}
  .lightbox img{max-width:100%;max-height:100%;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.6)}
  img.clickable-thumb{cursor:pointer;border-radius:8px}
  /* Receipt preview and remove button styling (added for better mobile visibility) */
  #addModal #receiptPreview{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee;display:none}
  #addModal #removeReceiptBtn{padding:0.5rem 0.6rem;margin-left:0.375rem;border-radius:0.65rem;align-self:center}
  #addModal #receiptInput{display:inline-block}

    /* Archive modal content boxes - fixed heights with proper scrolling */
  #archiveViewContent, #archiveStatsContent {
    max-height: 320px;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;
    word-wrap: break-word;
    word-break: break-word;
  }

  /* Optimize Archive Modal for all devices */
  #archiveModal .modal {
    display: flex;
    flex-direction: column;
  }

  #archiveModal .modal .card {
    display: flex;
    flex-direction: column;
    max-height: 90vh;
    padding: 16px;
  }

  #archiveModal h3 {
    margin: 0 0 14px 0;
    flex-shrink: 0;
  }

  #archiveModal > .modal > .card > div:first-of-type {
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  #archiveModal > .modal > .card > div > div {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 14px;
    flex-shrink: 0;
  }

  #archiveSelectMonth, #archiveViewMonth {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    font-size: 15px;
    border: 1px solid #e9eef6;
  }

  #executeArchiveBtn, #viewArchiveDetailBtn, #deleteArchiveMonthBtn, #archiveOverallStats {
    width: auto;
    min-width: 80px;
    padding: 10px 14px;
    font-size: 14px;
    border-radius: 8px;
    white-space: nowrap;
  }

  #archivePreview {
    width: 100%;
    box-sizing: border-box;
    word-break: break-word;
  }  /* On small screens, stack receipt input, preview and remove button vertically and make button full-width */
  @media (max-width:420px){
    #addModal #receiptInput{display:block !important;width:100% !important;margin-bottom:0.5rem !important}
    #addModal #receiptPreview{display:block !important;width:100% !important;height:auto !important;max-height:6rem!important;margin-bottom:0.5rem !important;object-fit:contain !important}
    #addModal #removeReceiptBtn{display:flex !important;width:100% !important;margin-left:0 !important;padding:0.8rem 1rem !important;justify-content:center !important}
    
    /* Archive modal: ensure content boxes scroll properly on mobile */
    #archiveViewContent, #archiveStatsContent {
      max-height: 250px !important;
    }
  }
  /* iOS smoothing and momentum scroll improvements */
  .month-list, .expenses-list{ -webkit-overflow-scrolling:touch }

    /* tiny helpers */
    .flex{display:flex;align-items:center}
    .spacer{flex:1}
    /* Hide the raw category ID text rendered as <div class="muted" small>... */
    #catsList .muted[small], #catsList [small]{ display: none !important; }

    /* Gallery styles */
    #galleryGrid img{width:100%;height:100%;object-fit:cover;border-radius:8px;display:block}
    #galleryGrid .tile{background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 8px 22px rgba(16,24,40,.06);height:160px}
    #galleryModal .modal{max-width:44rem}
    #galleryModal .modal .card{padding:0;max-height:90vh;overflow:auto}
    #galleryModal h3{margin:0;padding:0.9rem 1rem;border-bottom:1px solid rgba(2,6,23,0.05);font-size:1.05rem}
    #galleryModal > .card > div{padding:1rem}
    /* Default grid: larger thumbnails (desktop/tablet) */
    #galleryGrid{grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    @media(max-width:760px){
      /* medium phones: 3 columns with slightly smaller tiles */
      #galleryGrid{grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
      #galleryGrid .tile{height:150px}
    }
    @media(max-width:430px){
      /* small phones: 2 columns to make images larger and more usable */
      #galleryGrid{grid-template-columns:repeat(2,1fr);gap:8px}
      #galleryGrid .tile{height:150px}
      #galleryModal #gallerySearch{min-width:80px}
    }

  </style>
</head>
<body>
  <!-- Connection status indicator -->
  <div class="connection-indicator online" id="connectionIndicator"></div>

  <div class="app">
    <main class="main">
      <header>
        <div>
          <h1>ğŸ’³ Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø®ØµÙŠØ©</h1>
        </div>
        <div class="top-actions">
          <div class="search">
            <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©" style="min-width:220px" />
            <select id="filterCategory"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
            <select id="filterMonth"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option></select>
          </div>
          <button class="btn" id="openAddBtn">â• Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ</button>
          <button class="btn" id="addSalaryBtn" title="Ø£Ø¶Ù Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ">ğŸ’° Ø£Ø¶Ù Ø±Ø§ØªØ¨</button>
          <button class="btn ghost" id="archiveBtn" title="Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©">ğŸ“¦ Ø£Ø±Ø´ÙŠÙ</button>
          <button class="btn ghost" id="clearMonthBtn" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±</button>
        </div>
      </header>

      <section class="card summary" id="summaryBar">
        <div class="item">
          <div class="small muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯Ø®Ù„)</div>
          <div style="font-weight:700;font-size:18px" id="totalIncome">0</div>
        </div>
        <div class="item">
          <div class="small muted" id="totalExpenseLabel">Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
          <div style="font-weight:700;font-size:18px;color:var(--danger)" id="totalExpense">0</div>
        </div>
        <div class="item">
          <div class="small muted">Ø§Ù„Ø¨Ù€Ø§Ù‚ÙŠ</div>
          <div style="font-weight:700;font-size:18px;color:var(--accent-start)" id="balance">0</div>
        </div>
      </section>

      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <strong>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</strong>
          <div class="muted small">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø´Ù‡Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
        </div>
        <div class="month-list" id="monthChips"></div>
      </section>

      <section class="card" style="padding-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</strong>
          <div class="flex"><div class="muted small" id="selectedMonthTitle">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</div></div>
        </div>
        <div class="expenses-list" id="expensesList"></div>
      </section>

      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none" onclick="toggleComparisonSection()">
          <strong id="comparisonToggleLabel">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</strong>
          <span id="comparisonToggleIcon" style="font-size:18px;transition:transform 0.3s">â–¼</span>
        </div>
        <div id="comparisonSection" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid #eee">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
            <div>
              <label style="font-size:13px;color:var(--muted);font-weight:600;display:block;margin-bottom:6px">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£ÙˆÙ„</label>
              <select id="comparisonMonth1" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e9eef6" onchange="updateComparison()"><option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±</option></select>
            </div>
            <div>
              <label style="font-size:13px;color:var(--muted);font-weight:600;display:block;margin-bottom:6px">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
              <select id="comparisonMonth2" style="width:100%;padding:10px;border-radius:8px;border:1px solid #e9eef6" onchange="updateComparison()"><option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±</option></select>
            </div>
          </div>
          <div style="margin-bottom:12px">
            <label style="font-size:13px;color:var(--muted);font-weight:600;display:block;margin-bottom:6px">Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</label>
            <div id="comparisonCategoriesFilter" style="display:flex;flex-wrap:wrap;gap:6px"></div>
            <div style="font-size:12px;color:var(--muted);margin-top:6px;font-style:italic">ğŸ’¡ Ù„Ø§ ØªØ®ØªØ§Ø± Ø£ÙŠ ÙØ¦Ø© Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
            <canvas id="comparisonBarChart" height="200"></canvas>
            <div id="comparisonStats" style="display:flex;flex-direction:column;gap:8px;justify-content:center"></div>
          </div>
        </div>
      </section>

    </main>

    <aside class="card" style="min-width:260px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><strong>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</strong>
        <button class="btn ghost" id="openCatsBtn">ğŸ·ï¸ Ø§Ù„ÙØ¦Ø§Øª</button>
      </div>

      <!-- Monthly budget removed â€” using per-category budgets only -->

      <!-- Per-category budgets -->
      <div style="margin-top:14px">
        <div class="small muted">ğŸ’° Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <select id="budgetCatSelect" style="flex:1;padding:10px;border-radius:8px"></select>
          <input id="budgetCatInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:100px;padding:10px;border-radius:8px" />
          <button class="btn" id="saveBudgetCatBtn" style="min-width:60px;padding:10px">Ø­ÙØ¸</button>
        </div>
        <div id="catBudgetsList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <div style="margin-top:10px">
        <div class="small muted">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</div>
        <div style="margin-top:10px"><canvas id="pieChart"></canvas></div>
      </div>

      <div style="margin-top:12px">
        <div class="small muted">ğŸ“‹ Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</div>
        <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
          <button class="btn" id="openGalleryBtn" style="flex:1">ğŸ–¼ï¸ Ø§ÙØªØ­ Ø§Ù„Ù…Ø¹Ø±Ø¶</button>
        </div>
      </div>

      <div style="margin-top:12px;padding-top:12px;border-top:1px solid #eee">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
          <div style="font-weight:700;font-size:15px;color:var(--text)">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</div>
          <div id="monthsStatsBar" style="display:flex;gap:8px;font-size:11px">
            <div style="padding:4px 8px;border-radius:6px;background:#f0f9ff;color:var(--blue);font-weight:600">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: </span><span id="quickTotalMonths">0</span>
            </div>
            <div style="padding:4px 8px;border-radius:6px;background:#fef3c7;color:#b45309;font-weight:600">
              <span>Ù…Ø¤Ø±Ø´ÙØ©: </span><span id="quickArchivedMonths">0</span>
            </div>
          </div>
        </div>
        
        <!-- Current month highlight -->
        <div id="currentMonthDisplay" style="padding:12px;border-radius:10px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-left:4px solid var(--blue);margin-bottom:12px;font-weight:600;display:flex;align-items:center;gap:10px">
          <span style="font-size:18px">ğŸ“…</span>
          <div>
            <div style="font-size:12px;color:var(--muted)">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div style="font-size:15px;color:var(--blue)" id="currentMonthText">--</div>
          </div>
        </div>
        
        <!-- New month action button -->
        <button class="btn" id="newMonthBtn" title="Ø£Ø±Ø´ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¨Ø¯Ø¡ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯" style="width:100%;background:linear-gradient(90deg,#f59e0b,#d97706);color:#fff;border:0;padding:12px;font-weight:700;margin-bottom:14px;border-radius:10px;font-size:14px">ğŸ”„ Ø£Ø±Ø´ÙØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¨Ø¯Ø¡ Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</button>
        
        <!-- Months list with inline actions -->
        <div style="display:flex;flex-direction:column;gap:8px">
          <div style="font-size:12px;color:var(--muted);font-weight:600;margin-bottom:4px">Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
          <div id="monthsList" style="display:flex;flex-direction:column;gap:8px;max-height:350px;overflow-y:auto;-webkit-overflow-scrolling:touch">
            <div style="text-align:center;color:var(--muted);padding:30px 20px;font-size:13px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±...</div>
          </div>
        </div>
        
        <!-- Advanced management button -->
        <button class="btn ghost" id="openMonthMgmtBtn" style="width:100%;margin-top:12px;border:2px solid var(--accent-start);color:var(--accent-start);background:transparent;font-weight:600">ğŸ”§ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ‚Ø¯Ù…Ø© (Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØ±ØªÙŠØ¨)</button>
      </div>

    </aside>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal card" id="addModal" style="display:none">
      <h3>Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ / Ø¯Ø®Ù„</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
  <div class="row"><input id="amountInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" type="text" inputmode="decimal" pattern="[0-9,\.]+" style="flex:1" /><select id="typeInput" style="width:130px"><option value="expense">Ù…ØµØ±ÙˆÙ</option></select></div>
        <div class="row"><select id="categoryInput" style="flex:1"></select><input id="dateInput" type="date" style="width:150px" /></div>
        <textarea id="notesInput" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." rows="2"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="btn ghost" id="cancelAdd">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="saveAdd">Ø£Ø¶Ù</button>
        </div>
      </div>
    </div>

    <div class="modal card" id="catsModal" style="display:none">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h3>
      <div styl
      e="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px"><input id="newCatName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©" /><input id="newCatColor" type="color" value="#ff7b7b" style="width:60px" /><input id="newCatIcon" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø±Ù…Ø²)" style="width:72px" /><button class="btn" id="addCatBtn">Ø£Ø¶Ù</button></div>
        <div id="catsList"></div>
        <div style="display:flex;justify-content:flex-end"><button class="btn ghost" id="closeCats">Ø¥ØºÙ„Ø§Ù‚</button></div>
      </div>
    </div>

    <div class="modal card" id="salaryModal" style="display:none">
      <h3>Ø£Ø¶Ù / Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø§ØªØ¨</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="salaryAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1" />
          <input id="salaryDate" type="date" style="width:150px" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        </div>
        <label style="display:flex;gap:8px;align-items:center"><input id="salaryAddNow" type="checkbox" checked /> Ø£Ø¶Ù Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</label>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="btn ghost" id="salaryDelete">Ø­Ø°Ù</button>
          <button class="btn ghost" id="salaryCancel">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="salarySave">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>

    <div class="modal card" id="configModal" style="display:none">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯ Firebase</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <textarea id="firebaseConfigInput" rows="6" placeholder='Ø§Ù†Ø³Ø® Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ firebase config JSON (object) Ù…Ù† Ù„ÙˆØ­Ø© Firebase'></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="closeConfig">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn" id="initFirebaseBtn">Initialize</button>
        </div>
      </div>
    </div>

    <!-- Month Management Modal -->
    <div class="modal card" id="monthMgmtModal" style="display:none;max-height:90vh;overflow-y:auto;min-width:auto">
      <h3 style="margin:0 0 14px 0">ğŸ“… Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø´Ù‡Ø±</h3>
      <div style="display:flex;flex-direction:column;gap:12px">
        
        <!-- Search and filter -->
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="monthSearchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø´Ù‡Ø±..." style="flex:1;min-width:150px;padding:10px;border-radius:8px;border:1px solid #e9eef6;font-size:13px" onkeyup="renderMonthsList()"/>
          <select id="monthSortBy" style="padding:10px;border-radius:8px;border:1px solid #e9eef6;font-size:13px" onchange="renderMonthsList()">
            <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="expense">Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
            <option value="income">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø£Ø¹Ù„Ù‰</option>
          </select>
        </div>

        <!-- Summary stats -->
        <div id="monthsSummaryStats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">
          <div style="padding:12px;border-radius:8px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-left:3px solid var(--blue)">
            <div style="font-size:11px;color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø´Ù‡Ø±</div>
            <div style="font-weight:700;font-size:16px" id="totalMonthsCount">0</div>
          </div>
          <div style="padding:12px;border-radius:8px;background:linear-gradient(135deg,#fef3c7,#fde68a);border-left:3px solid #f59e0b">
            <div style="font-size:11px;color:var(--muted)">Ù…Ø¤Ø±Ø´ÙØ©</div>
            <div style="font-weight:700;font-size:16px" id="archivedMonthsCount">0</div>
          </div>
          <div style="padding:12px;border-radius:8px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-left:3px solid var(--success)">
            <div style="font-size:11px;color:var(--muted)">Ù†Ø´Ø·Ø©</div>
            <div style="font-weight:700;font-size:16px" id="activeMonthsCount">0</div>
          </div>
        </div>

        <!-- Months list with actions -->
        <div style="border:1px solid #e9eef6;border-radius:8px;padding:12px;max-height:400px;overflow-y:auto">
          <div id="advancedMonthsList" style="display:flex;flex-direction:column;gap:8px">
            <div style="text-align:center;color:var(--muted);padding:40px 20px;font-size:13px">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±...</div>
          </div>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:8px;justify-content:flex-end;padding-top:12px;border-top:1px solid #eee">
          <button class="btn ghost" id="closeMgmtModal" style="min-width:100px">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

    <!-- Archive Modal: Advanced month management -->
    <div class="modal card" id="archiveModal" style="display:none;max-height:90vh;overflow-y:auto;min-width:auto">
      <h3 style="margin:0 0 14px 0">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±Ø´ÙØ© Ø§Ù„Ø£Ø´Ù‡Ø±</h3>
      <div style="display:flex;flex-direction:column;gap:12px;overflow-y:auto">
        
        <!-- Tab 1: Archive Month (Prominent) -->
        <div style="border:2px solid var(--accent-start);border-radius:8px;padding:14px;background:linear-gradient(135deg,rgba(107,140,255,0.05),rgba(90,208,255,0.05));flex-shrink:0">
          <div style="font-weight:700;margin-bottom:10px;color:var(--accent-start)">1ï¸âƒ£ Ø£Ø±Ø´ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯</div>
          <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:10px;flex-wrap:wrap">
            <select id="archiveSelectMonth" style="flex:1;min-width:150px;padding:10px;border-radius:8px;border:1px solid #e9eef6">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø£Ø±Ø´ÙØªÙ‡...</option>
            </select>
            <button class="btn" id="executeArchiveBtn" style="min-width:100px;background:linear-gradient(90deg,#34d399,#10b981);padding:10px 14px;">Ø£Ø±Ø´ÙØ©</button>
          </div>
          <div id="archivePreview" class="small muted" style="padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;min-height:60px;line-height:1.6;word-break:break-word">
            Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ù‡Ù†Ø§
          </div>
        </div>

        <!-- Tab 2: View Archived Months -->
        <div style="border:1px solid #eee;border-radius:8px;padding:14px;background:#f9f9f9;flex-shrink:0">
          <div style="font-weight:700;margin-bottom:10px">2ï¸âƒ£ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</div>
          <div style="display:flex;gap:8px;align-items:stretch;margin-bottom:10px;flex-wrap:wrap">
            <select id="archiveViewMonth" style="flex:1;min-width:150px;padding:10px;border-radius:8px;border:1px solid #e9eef6">
              <option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù…Ø¤Ø±Ø´ÙØ§Ù‹...</option>
            </select>
            <button class="btn ghost" id="viewArchiveDetailBtn" style="min-width:80px;background:linear-gradient(90deg,#3b82f6,#60a5fa);color:#fff;border:0;padding:10px 12px;">Ø¹Ø±Ø¶</button>
            <button class="btn ghost" id="deleteArchiveMonthBtn" style="min-width:80px;background:linear-gradient(90deg,#ff6b6b,#ff4b4b);color:#fff;border:0;display:none;padding:10px 12px;">Ø­Ø°Ù</button>
          </div>
          <div id="archiveViewContent" style="max-height:300px;overflow-y:auto;overflow-x:hidden;border:1px solid #ddd;border-radius:6px;padding:12px;display:none;background:#fff;-webkit-overflow-scrolling:touch;word-break:break-word">
            <!-- archived expenses will be rendered here -->
          </div>
        </div>

        <!-- Tab 3: Statistics -->
        <div style="border:1px solid #eee;border-radius:8px;padding:14px;background:#f9f9f9;flex-shrink:0">
          <div style="font-weight:700;margin-bottom:10px">3ï¸âƒ£ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø±Ø´ÙŠÙ</div>
          <button class="btn ghost" id="archiveOverallStats" style="width:100%;background:linear-gradient(90deg,#8b5cf6,#7c3aed);color:#fff;border:0;padding:10px 12px">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©</button>
          <div id="archiveStatsContent" style="margin-top:10px;padding:12px;background:#fff;border-radius:6px;border:1px solid #ddd;display:none;max-height:300px;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;word-break:break-word">
            <!-- stats will be displayed here -->
          </div>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;padding-top:12px;border-top:1px solid #eee;flex-shrink:0">
          <button class="btn ghost" id="closeArchive" style="flex:1;min-width:100px">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>

    <!-- Gallery Modal: Receipt gallery (thumbnails + full view) -->
    <div class="modal card" id="galleryModal" style="display:none">
      <h3>Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="galleryFilterCategory"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
          <select id="galleryFilterMonth"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option></select>
          <input id="gallerySearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1;min-width:120px" />
          <button class="btn ghost" id="galleryClear">Ø¨Ø­Ø«</button>
        </div>

        <div id="galleryGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px"></div>

        <div style="display:flex;justify-content:center;gap:8px">
          <button class="btn ghost" id="galleryClose">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…</div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- User-provided Firebase config (saved to localStorage so the app auto-initializes) -->
  <script>
    // Firebase config provided by user
    const firebaseConfig = {
      apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
      authDomain: "mony-ecb81.firebaseapp.com",
      databaseURL: "https://mony-ecb81-default-rtdb.firebaseio.com",
      projectId: "mony-ecb81",
      storageBucket: "mony-ecb81.firebasestorage.app",
      messagingSenderId: "1099032510981",
      appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
      measurementId: "G-PVHFMZ82XL"
    };
    try{
      localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
      // The main script will pick this up and initialize on load
      console.info('Firebase config injected to localStorage');
    }catch(e){console.warn('Could not save firebase config to localStorage', e)}
  </script>

  <script>
    /***** Helpers and state *****/
    // Simple todo: format numbers with comma separators
    const fmt = (v) => Number(v || 0).toLocaleString('en-US',{maximumFractionDigits:2});

    // Short id generator for local use
    const uid = ()=> 'id'+Math.random().toString(36).slice(2,9);

  // App state
  let db = null;
  let app = null;
  let categories = {};
  let expenses = {};
  let editingExpenseId = null;

    // DOM refs
    const refs = {};

    function $(id){return document.getElementById(id)}

  // Toast â€” accepts HTML string
  function showToast(msg='ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…',dur=3500){const t=$('toast'); t.innerHTML = String(msg); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),dur)}

    // Number formatting helpers (global) - used across functions
    function formatNumberWithCommas(value){
      if(value === null || value === undefined) return '';
      const parts = String(value).replace(/[^0-9.\-]/g,'').split('.');
      // remove leading zeros except if single zero
      parts[0] = parts[0].replace(/^0+(?=\d)/, '') || '0';
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.length>1 ? parts[0] + '.' + parts[1].slice(0,2) : parts[0];
    }

    function parseFormattedNumber(str){
      if(!str) return 0;
      const cleaned = String(str).replace(/,/g,'').replace(/[^0-9.\-]/g,'');
      return Number(cleaned) || 0;
    }

    // Date formatting helper: accept ISO 'YYYY-MM-DD' or other strings and return 'DD/MM/YYYY'
    function formatDisplayDate(d){
      if(!d) return '';
      try{
        // if already looks like YYYY-MM-DD
        if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(d)){
          const [y,m,day] = d.split('-');
          return String(day).padStart(2,'0') + '/' + String(m).padStart(2,'0') + '/' + y;
        }
        // try parsing as Date
        const dt = new Date(d);
        if(!isNaN(dt.getTime())){
          const dd = String(dt.getDate()).padStart(2,'0');
          const mm = String(dt.getMonth()+1).padStart(2,'0');
          const yy = dt.getFullYear();
          return dd + '/' + mm + '/' + yy;
        }
      }catch(e){}
      return String(d);
    }

    // Offline helpers: pending expenses queue stored locally until synced
    const PENDING_KEY = 'pendingExpenses';
    function getPendingExpenses(){ try{ return JSON.parse(localStorage.getItem(PENDING_KEY)||'{}'); }catch(e){ return {}; } }
    function savePendingExpenses(obj){ localStorage.setItem(PENDING_KEY, JSON.stringify(obj)); }
    function enqueuePendingExpense(payload){ const id = 'local_'+uid(); const p = {...payload, _localId:id, _createdAt:Date.now()}; const all = getPendingExpenses(); all[id]=p; savePendingExpenses(all); return id; }
    function removePendingExpense(id){ const all = getPendingExpenses(); delete all[id]; savePendingExpenses(all); }

    // Try to sync pending expenses to Firebase when possible
    async function syncPendingExpenses(){
      const pending = getPendingExpenses(); const keys = Object.keys(pending||{}); if(!keys.length) return 0;
      if(!db) return 0;
      let synced = 0;
      for(const id of keys){
        const p = {...pending[id]};
        // Handle different operation types
        try{
          if(p.isDelete && p.fbKey){
            // Delete operation
            await db.ref('expenses/'+p.fbKey).remove();
            removePendingExpense(id);
            synced++;
          } else if(p.isUpdate && p.fbKey){
            // Update operation
            const updatePayload = {...p};
            delete updatePayload.fbKey;
            delete updatePayload.isUpdate;
            delete updatePayload._localId;
            delete updatePayload._createdAt;
            await db.ref('expenses/'+p.fbKey).update(updatePayload);
            removePendingExpense(id);
            synced++;
          } else if(p.type === 'category'){
            // Category operation
            const cat = {...p};
            delete cat._localId;
            delete cat._createdAt;
            delete cat.localKey;
            delete cat.type;
            await db.ref('categories').push().set(cat);
            removePendingExpense(id);
            synced++;
          } else {
            // Regular expense add
            const expense = {...p};
            expense.createdAt = pending[id]._createdAt || Date.now();
            delete expense._localId; delete expense._createdAt;
            await db.ref('expenses').push().set(expense);
            removePendingExpense(id);
            synced++;
          }
        }catch(e){ console.warn('sync failed for', id, e); }
      }
      if(synced){
        showToast('âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ' + synced + ' Ø¹Ù†ØµØ±(Ø¹Ù†Ø§ØµØ±)', 3500);
        updatePendingCount();
        computeAndRender();
      }
      return synced;
    }

    // Month placeholders helpers (so months appear even if empty)
    const MONTHS_PLACEHOLDER_KEY = 'localMonthPlaceholders';
    function getLocalMonthPlaceholders(){ try{ return JSON.parse(localStorage.getItem(MONTHS_PLACEHOLDER_KEY)||'{}'); }catch(e){return{}} }
    function saveLocalMonthPlaceholders(obj){ localStorage.setItem(MONTHS_PLACEHOLDER_KEY, JSON.stringify(obj)); }
    function ensureMonthPlaceholder(yyyyMM){
      // persist placeholder either in Firebase (recommended) or localStorage
      if(db){
        db.ref('settings/monthPlaceholders/'+yyyyMM).set(true).catch(e=>console.warn('could not set month placeholder',e));
      } else {
        const p = getLocalMonthPlaceholders(); p[yyyyMM]=true; saveLocalMonthPlaceholders(p);
      }
    }
    // Return merged months placeholders from settings (firebase) and local
    function getMergedMonthPlaceholders(){
      const res = {};
      try{ if(window.settings && window.settings.monthPlaceholders) Object.assign(res, window.settings.monthPlaceholders); }catch(e){}
      const local = getLocalMonthPlaceholders(); Object.assign(res, local);
      return res;
    }

    // Month archiving system - persist old months separately
    const ARCHIVED_MONTHS_KEY = 'archivedMonths';
    function getArchivedMonths(){ 
      try{ 
        // First try to get from Firebase if available
        if(window.settings && window.settings.archivedMonths){
          return window.settings.archivedMonths;
        }
        // Fallback to localStorage
        return JSON.parse(localStorage.getItem(ARCHIVED_MONTHS_KEY)||'{}'); 
      }catch(e){ 
        return {}; 
      } 
    }
    
    function saveArchivedMonths(obj){ 
      // Save to Firebase if available
      if(db){
        db.ref('settings/archivedMonths').set(obj).catch(e=>console.warn('Failed to save archive to Firebase', e));
      }
      // Also keep local backup for offline access
      try{ localStorage.setItem(ARCHIVED_MONTHS_KEY, JSON.stringify(obj)); }catch(e){}
    }
    
    // Archive a specific month's expenses to separate storage
    function archiveMonth(yyyyMM){
      const allObj = getAllExpensesObject();
      const monthData = {};
      for(const [id,e] of Object.entries(allObj||{})){
        const d = new Date(e.date);
        const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        if(key === yyyyMM) monthData[id] = e;
      }
      const archived = getArchivedMonths();
      archived[yyyyMM] = monthData;
      saveArchivedMonths(archived);
    }
    
    // Get archived expenses for a month
    function getArchivedExpenses(yyyyMM){
      const archived = getArchivedMonths();
      return archived[yyyyMM] || {};
    }
    
    // Delete a month from archive
    function deleteArchivedMonth(yyyyMM){
      try{
        const archived = getArchivedMonths();
        if(archived[yyyyMM]){
          delete archived[yyyyMM];
          saveArchivedMonths(archived);
          // Also delete from Firebase if available
          if(db){
            db.ref('settings/archivedMonths/'+yyyyMM).remove().catch(e=>console.warn('Failed to delete from Firebase', e));
          }
          return true;
        }
        return false;
      }catch(e){
        console.warn('deleteArchivedMonth failed', e);
        return false;
      }
    }
    
    // Return merged expenses object (Firebase + pending local + archived for comparison)
    function getAllExpensesObject(){
      const merged = {};
      try{ Object.assign(merged, expenses); }catch(e){}
      const pending = getPendingExpenses();
      for(const [id,p] of Object.entries(pending||{})){
        merged[id] = {...p}; // keep local id
      }
      return merged;
    }
    
    // Get all expenses including archived (for comparison views)
    function getAllExpensesIncludingArchived(){
      const merged = getAllExpensesObject();
      const archived = getArchivedMonths();
      for(const [month, data] of Object.entries(archived||{})){
        Object.assign(merged, data);
      }
      return merged;
    }

    function attachFormattedInput(el){
      if(!el) return;
      el.addEventListener('input', (ev) => {
        const selectionStart = el.selectionStart;
        const oldValue = el.value;
        const raw = String(oldValue).replace(/,/g,'');
        const formatted = formatNumberWithCommas(raw);
        el.value = formatted;
        try{ const newPos = Math.max(0, formatted.length - (oldValue.length - selectionStart)); el.setSelectionRange(newPos, newPos); }catch(e){}
      });
      el.addEventListener('blur', ()=>{ el.value = formatNumberWithCommas(el.value); });
    }

    /***** Firebase initialization (user pastes config JSON) *****/
    function initFirebaseFromConfigString(cfgStr){
      try{
        const cfg = JSON.parse(cfgStr);
        // Save locally so user doesn't need to paste again
        localStorage.setItem('firebaseConfig', JSON.stringify(cfg));
        if(app){app.delete && app.delete();}
        app = firebase.initializeApp(cfg);
        db = firebase.database();
        attachListeners();
        showToast('Firebase Ù…ØªØµÙ„ âœ…');
        closeModalAndBackdrop();
        return true;
      }catch(e){alert('Ø®Ø·Ø£ Ø¨Ù…Ù„Ù config: '+e.message);return false}
    }

      // Dynamically load Firebase SDKs if the page was opened offline and the CDN scripts failed to load.
      function loadFirebaseSDKs(){
        return new Promise((resolve,reject)=>{
          try{
            if(window.firebase) return resolve();
            const libs = [
              'https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js',
              'https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js'
            ];
            let i = 0;
            function next(){
              if(i >= libs.length) return resolve();
              const s = document.createElement('script'); s.src = libs[i++]; s.async = true;
              s.onload = ()=> next();
              s.onerror = (err)=> reject(new Error('Failed loading firebase SDK: ' + libs[i-1]));
              document.head.appendChild(s);
            }
            next();
          }catch(er){ reject(er); }
        });
      }

    /***** Realtime listeners and syncing *****/
    function attachListeners(){
      if(!db) return;
      // Categories
      db.ref('categories').on('value', snap=>{
        categories = snap.val() || {};
        try{ localStorage.setItem('cachedCategories', JSON.stringify(categories)); }catch(e){}
        renderCategoriesUI();
        populateCategorySelects();
        try{ populateBudgetCatSelect(); }catch(e){}
        computeAndRender();
      });

      // Expenses
      db.ref('expenses').on('value', snap=>{
        expenses = snap.val() || {};
        computeAndRender();
      });

      // Settings (budgets)
      db.ref('settings').on('value', snap=>{
        window.settings = snap.val() || {};
        computeAndRender();
      });
    }

    /***** CRUD operations *****/
    function addExpense(payload){
      payload.createdAt = Date.now();
      // if Firebase available, write directly
      if(db && navigator.onLine){
        const ref = db.ref('expenses').push();
        ref.set(payload).then(()=>{
          const tmsg = `<div style="font-weight:700;color:#fff">${payload.type==='income'?'+':'-'} ${fmt(payload.amount)}</div><div style="font-size:12px;color:rgba(255,255,255,0.95)">${formatDisplayDate(payload.date)}${payload.notes? ' â€¢ '+(payload.notes||'') : ''}</div>`;
          showToast(tmsg, 4200);
          updatePendingCount();
          // try sync any pending too
          try{ syncPendingExpenses(); }catch(e){}
          computeAndRender();
        }).catch(e=>{
          // Failed to save to Firebase, enqueue locally
          enqueuePendingExpense(payload);
          showToast('âš ï¸ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ - Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹', 2000);
          updatePendingCount();
          computeAndRender();
        });
      } else {
        // offline: enqueue locally and show toast
        const localId = enqueuePendingExpense(payload);
        const tmsg = `<div style="font-weight:700;color:#111">ğŸ’¾ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</div><div style="font-size:12px;color:#333">${formatDisplayDate(payload.date)}${payload.notes? ' â€¢ '+(payload.notes||'') : ''}</div>`;
        showToast(tmsg, 4200);
        updatePendingCount();
        computeAndRender();
      }
    }

    function addCategory(cat){
      cat.createdAt = Date.now();
      if(db && navigator.onLine){
        const ref = db.ref('categories').push();
        ref.set(cat).then(()=>{
          showToast('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©', 2000);
          updatePendingCount();
          try{ syncPendingExpenses(); }catch(e){}
        }).catch(e=>{
          // Enqueue for later sync
          enqueuePendingExpense({type: 'category', ...cat});
          showToast('âš ï¸ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ - Ø³ÙŠØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹', 2000);
          updatePendingCount();
        });
      } else {
        // offline: create local key and persist to cachedCategories
        const key = 'localcat_'+uid();
        categories = categories || {};
        categories[key] = {...cat, id:key};
        try{ localStorage.setItem('cachedCategories', JSON.stringify(categories)); }catch(e){console.warn(e)}
        enqueuePendingExpense({type: 'category', ...cat, localKey: key});
        showToast('ğŸ’¾ Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (ÙØ¦Ø©)', 2000);
        updatePendingCount();
        renderCategoriesUI(); populateCategorySelects();
      }
    }

    // Ensure there is a category called 'Ø±Ø§ØªØ¨' and return its id if exists.
    // NOTE: We no longer auto-create a 'Ø±Ø§ØªØ¨' category. Salary entries are treated as incomes
    // and can be saved without assigning a dedicated category. This avoids cluttering the
    // categories list with a category that represents an income source rather than an expense.
    function ensureSalaryCategory(){
      return new Promise((resolve)=>{
        for(const [id,c] of Object.entries(categories||{})){
          if((c.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') return resolve(id);
        }
        // Do NOT create the category automatically. Return empty string to indicate no category.
        resolve('');
      });
    }

    // Comprehensive month archiving function - moves all expenses from a month to archive and removes from current
    function archiveMonthManually(yyyyMM){
      try{
        if(!yyyyMM) return false;
        
        const allObj = getAllExpensesObject();
        const monthData = {};
        const idsToDelete = [];
        
        // Collect all expenses for this month
        for(const [id,e] of Object.entries(allObj||{})){
          if(!e.date) continue;
          const d = new Date(e.date);
          const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
          if(key === yyyyMM) {
            monthData[id] = e;
            idsToDelete.push(id);
          }
        }
        
        if(Object.keys(monthData).length === 0) return false; // No data to archive
        
        // Save to archive
        const archived = getArchivedMonths();
        archived[yyyyMM] = monthData;
        saveArchivedMonths(archived);
        
        // Delete from Firebase
        for(const id of idsToDelete){
          if(db){
            db.ref('expenses/'+id).remove().catch(e=>console.warn('delete failed', e));
          }
        }
        
        // Delete from local pending
        const pending = getPendingExpenses();
        for(const id of idsToDelete){
          if(pending[id]) delete pending[id];
        }
        savePendingExpenses(pending);
        
        // Delete budgets for this month
        if(db){
          db.ref('settings/monthlyBudgets/'+yyyyMM).remove().catch(e=>console.warn('budget delete failed', e));
        }
        
        return true;
      }catch(e){
        console.warn('archiveMonthManually failed', e);
        return false;
      }
    }
    
    // New month initialization - archive previous month and clean up for new month
    function initializeNewMonth(){
      try{
        const now = new Date();
        const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
        const lastMonthInitKey = 'lastMonthInit_' + currentMM;
        
        // Check if we've already initialized this month
        if(localStorage.getItem(lastMonthInitKey)) return;
        
        // Get previous month
        const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const prevMM = prevDate.getFullYear() + '-' + String(prevDate.getMonth()+1).padStart(2,'0');
        
        // Archive previous month if it has data
        try{
          archiveMonthManually(prevMM);
        }catch(e){console.warn('archiving previous month failed', e)}
        
        // Mark this month as initialized
        localStorage.setItem(lastMonthInitKey, Date.now());
        localStorage.setItem('currentMonth', currentMM);
      }catch(e){console.warn('initializeNewMonth failed', e)}
    }
    
    // Remove any stored category whose name is 'Ø±Ø§ØªØ¨' (case-insensitive).
    // This removes from Firebase if connected, and from local cachedCategories.
    function removeSalaryCategories(){
      try{
        const toRemove = [];
        for(const [id,c] of Object.entries(categories||{})){
          if((c.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') toRemove.push(id);
        }
        if(!toRemove.length) return;
        for(const id of toRemove){
          // remove from in-memory categories
          delete categories[id];
          // remove from firebase if available
          if(db){ try{ db.ref('categories/'+id).remove().catch(()=>{}); }catch(e){} }
        }
        // also purge from cachedCategories in localStorage
        try{
          const cached = JSON.parse(localStorage.getItem('cachedCategories')||'{}');
          let changed = false;
          for(const id of toRemove){ if(cached && cached[id]){ delete cached[id]; changed = true; } }
          if(changed) localStorage.setItem('cachedCategories', JSON.stringify(cached));
        }catch(e){}
        // update UI
        try{ renderCategoriesUI(); populateCategorySelects(); populateBudgetCatSelect(); computeAndRender(); }catch(e){}
      }catch(e){console.warn('removeSalaryCategories failed', e)}
    }

    // find recurring 'Ø±Ø§ØªØ¨' entry if exists (firebase or local)
    function findSalaryRecurring(){
      const recs = (window.settings && window.settings.recurringIncomes) || {};
      for(const [id,r] of Object.entries(recs||{})){
        if((r.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') return {id, item:r};
      }
      try{ const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}'); for(const [id,r] of Object.entries(local||{})){ if((r.name||'').toLowerCase()==='Ø±Ø§ØªØ¨') return {id, item:r}; } }catch(e){}
      return null;
    }

    function updateExpense(id, payload){
      payload.updatedAt = Date.now();
      if(db && navigator.onLine){
        db.ref('expenses/'+id).update(payload).then(()=>{
          showToast('âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­', 2000);
          updatePendingCount();
          try{ syncPendingExpenses(); }catch(e){}
          computeAndRender();
        }).catch(e=>{
          // Enqueue for later sync
          enqueuePendingExpense({...payload, fbKey: id, isUpdate: true});
          showToast('âš ï¸ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚Ø§Ù‹', 2000);
          updatePendingCount();
          computeAndRender();
        });
      } else {
        // offline: enqueue the update
        enqueuePendingExpense({...payload, fbKey: id, isUpdate: true});
        showToast('ğŸ’¾ Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ (ØªØ­Ø¯ÙŠØ«)', 2000);
        updatePendingCount();
        computeAndRender();
      }
    }

    function deleteExpense(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
      if(db && navigator.onLine){
        db.ref('expenses/'+id).remove().then(()=>{
          showToast('âœ… Ø­ÙØ°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­', 2000);
          updatePendingCount();
          try{ syncPendingExpenses(); }catch(e){}
          computeAndRender();
        }).catch(e=>{
          // Enqueue deletion for later sync
          enqueuePendingExpense({fbKey: id, isDelete: true});
          showToast('âš ï¸ Ø³ÙŠØªÙ… Ø§Ù„Ø­Ø°Ù Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„', 2000);
          updatePendingCount();
          computeAndRender();
        });
      } else {
        // offline: enqueue the deletion
        enqueuePendingExpense({fbKey: id, isDelete: true});
        showToast('ğŸ’¾ Ù…Ø­ÙÙˆØ¸ Ù„Ù„Ø­Ø°Ù Ù…Ø­Ù„ÙŠÙ‹Ø§', 2000);
        updatePendingCount();
        computeAndRender();
      }
    }

    function exportExpensesCSV(filteredList){
      const rows = [['id','date','type','category','amount','notes']];
      for(const e of filteredList){
        rows.push([e.id, e.date, e.type, (categories[e.categoryId]?.name)||e.categoryId||'', Number(e.amount)||0, (e.notes||'')]);
      }
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'expenses.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV âœ…');
    }

    function deleteCategory(catId){
      if(!db) return;
      // Reassigning or deleting expenses in that category is left to user. We'll just delete category.
      db.ref('categories/'+catId).remove();
    }

    function saveBudgetForMonth(yyyyMM, amount){
      if(!db) return;
      db.ref('settings/monthlyBudgets/'+yyyyMM).set(Number(amount));
    }

    // Delete per-category budget for a given month (Firebase if available, otherwise local fallback)
    function deleteCategoryBudgetForMonth(yyyyMM, catId){
      if(!catId) return;
      if(db){
        db.ref('settings/monthlyBudgets/'+yyyyMM+'/categories/'+catId).remove().then(()=>{
          try{ showToast('ØªÙ… Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© âœ…'); }catch(e){}
        }).catch(e=>{ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù: '+e.message); });
      } else {
        try{
          const key = 'localMonthCategoryBudgets';
          const all = JSON.parse(localStorage.getItem(key)||'{}');
          if(all[yyyyMM] && all[yyyyMM][catId]){ delete all[yyyyMM][catId]; localStorage.setItem(key, JSON.stringify(all)); }
          // reflect in window.settings for UI
          try{
            if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories){
              delete window.settings.monthlyBudgets[yyyyMM].categories[catId];
            }
          }catch(e){}
          try{ showToast('ØªÙ… Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§) âœ…'); }catch(e){}
        }catch(e){ console.warn('deleteCategoryBudgetForMonth failed', e) }
      }
      // Recompute UI
      try{ renderCategoryBudgetsList(yyyyMM); computeAndRender(); }catch(e){}
    }

    // Global helper: populate budget category select (safe to call from listeners)
    function populateBudgetCatSelect(){
      const sel = $('budgetCatSelect'); if(!sel) return;
      sel.innerHTML = '';
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [id,c] of Object.entries(catObj||{})){
        const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
      }
    }

    // Global helper: render per-category budgets list for a given month
    function renderCategoryBudgetsList(yyyyMM){
      const el = $('catBudgetsList'); if(!el) return; el.innerHTML='';
      // read budgets from settings or local
      let catBud = {};
      try{ if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories) catBud = window.settings.monthlyBudgets[yyyyMM].categories; }catch(e){}
      try{ const local = JSON.parse(localStorage.getItem('localMonthCategoryBudgets')||'{}'); if(local[yyyyMM]) Object.assign(catBud, local[yyyyMM]); }catch(e){}
      // compute usage per category
      const allObj = getAllExpensesObject();
      const totals = {};
      for(const [id,e] of Object.entries(allObj||{})){
        const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(key!==yyyyMM) continue;
        const cid = e.categoryId || 'uncat'; totals[cid] = (totals[cid]||0) + Number(e.amount||0);
      }
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [cid,bud] of Object.entries(catBud||{})){
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${(catObj[cid]&&catObj[cid].name)||cid}</div><div class=muted style="font-size:12px">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(bud)} Â· Ù…Ø³ØªØ®Ø¯Ù…: ${fmt(totals[cid]||0)}</div>`;
        const percent = bud>0 ? Math.round((totals[cid]||0)/bud*100) : 0;
        const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
        const p = document.createElement('div'); p.style.minWidth='48px'; p.style.textAlign='right'; p.textContent = percent+'%';
  const edit = document.createElement('button'); edit.className='btn ghost'; edit.style.padding='6px 8px'; edit.textContent='ØªØ¹Ø¯ÙŠÙ„';
  edit.onclick = ()=>{ const sel = $('budgetCatSelect'); if(sel) sel.value = cid; const input = $('budgetCatInput'); if(input) input.value = formatNumberWithCommas(String(bud||0)); };
  const del = document.createElement('button');
  del.className='btn ghost';
  del.style.padding='10px 12px';
  del.style.fontWeight='700';
  del.style.borderRadius='10px';
  del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-inline-end:8px;vertical-align:middle;color:inherit"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>Ø­Ø°Ù';
  del.onclick = ()=>{ if(!confirm('Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù„Ù„Ø´Ù‡Ø± ' + yyyyMM + 'ØŸ')) return; deleteCategoryBudgetForMonth(yyyyMM, cid); };
  right.appendChild(p); right.appendChild(edit); right.appendChild(del);
        row.appendChild(left); row.appendChild(right); el.appendChild(row);
      }
      if(Object.keys(catBud||{}).length===0) el.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙØ¦Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
    }

    // Recurring incomes (salary) - add/update/delete with localStorage fallback when Firebase not connected
    function addRecurringIncome(payload){
      if(db){
        const ref = db.ref('settings/recurringIncomes').push();
        ref.set(payload).then(()=>{ showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸: '+e.message));
        return ref.key;
      } else {
        // local fallback
        const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
        const id = uid();
        local[id] = payload;
        localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
        // also reflect in window.settings for immediate UI updates
        window.settings = window.settings || {};
        window.settings.recurringIncomes = window.settings.recurringIncomes || {};
        window.settings.recurringIncomes['local_'+id] = payload;
        computeAndRender();
        showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        return 'local_'+id;
      }
    }

    function updateRecurringIncome(id, payload){
      if(db){
        db.ref('settings/recurringIncomes/'+id).set(payload).then(()=>{ showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message));
      } else {
        try{
          const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
          const realId = id.startsWith('local_') ? id.slice(6) : id;
          if(local[realId]) local[realId] = payload;
          localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
          window.settings = window.settings || {};
          window.settings.recurringIncomes = window.settings.recurringIncomes || {};
          window.settings.recurringIncomes[id] = payload;
          computeAndRender();
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        }catch(e){alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ: '+e.message)}
      }
    }

    function deleteRecurringIncome(id){
      if(db){
        db.ref('settings/recurringIncomes/'+id).remove().then(()=>{ showToast('Ø­ÙØ°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù: '+e.message));
      } else {
        try{
          const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
          const realId = id.startsWith('local_') ? id.slice(6) : id;
          delete local[realId];
          localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
          if(window.settings && window.settings.recurringIncomes) delete window.settings.recurringIncomes[id];
          computeAndRender();
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        }catch(e){alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ: '+e.message)}
      }
    }

    /***** UI rendering and computations *****/
  function computeAndRender(){
      // Group expenses by month YYYY-MM
      const months = {};
      const allObj = getAllExpensesObject();
      const allExpenses = Object.entries(allObj).map(([id,e])=>({id,...e}));
      for(const e of allExpenses){
        const d = new Date(e.date);
        const yyyyMM = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        months[yyyyMM] = months[yyyyMM] || [];
        months[yyyyMM].push(e);
      }

      // Sort months desc
      let monthKeys = Object.keys(months).sort((a,b)=>b.localeCompare(a));
      // Include persisted month placeholders (DB or local) and ensure current/next exist
      try{
        const placeholders = getMergedMonthPlaceholders();
        const s = new Set(monthKeys);
        Object.keys(placeholders||{}).forEach(k=>s.add(k));
        const now = new Date();
        const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
        const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
        const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
        s.add(currentMM); s.add(nextMM);
        monthKeys = Array.from(s).sort((a,b)=>b.localeCompare(a));
      }catch(e){}
      renderMonthChips(monthKeys);
      populateFilterMonths(monthKeys);
  // render per-category budgets for selected month
  try{ const selMonth = $('filterMonth').value || (new Date()).getFullYear()+'-'+String((new Date()).getMonth()+1).padStart(2,'0'); renderCategoryBudgetsList(selMonth); }catch(e){}

      // compute global totals (all data)
      let globalIncome = 0, globalExpense = 0;
      for(const e of allExpenses){ const amt = Number(e.amount)||0; if(e.type==='income') globalIncome += amt; else globalExpense += amt; }

      // apply current filters (category, month, search) for the list view
      const filtered = applyFilters(allExpenses);

      // compute expense total for filtered view (used when a category filter is active)
      let filteredExpense = 0;
      for(const e of filtered){ if(e.type !== 'income') filteredExpense += Number(e.amount||0); }

      // show global income always, show expense either filtered (when category selected) or global
      const catFilter = $('filterCategory').value;
      $('totalIncome').textContent = fmt(globalIncome);
      $('totalExpense').textContent = fmt(catFilter ? filteredExpense : globalExpense);
      // Update expense label to include selected category name when filtered
      try{
        const lbl = $('totalExpenseLabel');
        if(lbl){
          if(catFilter){ const cname = (categories[catFilter] && categories[catFilter].name) || catFilter; lbl.textContent = 'Ø§Ù„Ù…ØµØ±ÙˆÙ â€” ' + cname; }
          else lbl.textContent = 'Ø§Ù„Ù…ØµØ±ÙˆÙ';
        }
      }catch(e){}
      // keep balance as global balance (income - global expense)
      $('balance').textContent = fmt(globalIncome - globalExpense);

      // Render expenses list (use prefiltered list)
      renderExpensesList(filtered, true);

  // Charts
  renderBarChart(monthKeys.slice(0,6).reverse(), months);
  renderPieChartForSelectedMonth();

      // budget and month management UI
      updateBudgetUI();
      updateMonthManagementUI();
    }

    function renderMonthChips(monthKeys){
      const el = $('monthChips'); el.innerHTML='';
      const addAll = document.createElement('button'); addAll.className='month-chip'; addAll.textContent='ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±'; addAll.onclick=()=>{ $('filterMonth').value=''; $('selectedMonthTitle').textContent='ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±'; computeAndRender(); };
      el.appendChild(addAll);
      for(const m of monthKeys){
        const btn = document.createElement('button'); btn.className='month-chip'; btn.textContent=m; btn.onclick=()=>{ $('filterMonth').value=m; $('selectedMonthTitle').textContent=m; computeAndRender(); };
        el.appendChild(btn);
      }
    }

    // Apply filters (search, category, month) to an array of expense objects
    function applyFilters(items){
      const search = $('searchInput').value.trim().toLowerCase();
      const catFilter = $('filterCategory').value;
      const monthFilter = $('filterMonth').value;
      let list = items.slice();
      if(search){
        list = list.filter(e=>(((e.notes||'')+ (categories[e.categoryId]?.name||'') + (e.amount||'')).toLowerCase().includes(search)));
      }
      if(catFilter) list = list.filter(e=>e.categoryId === catFilter);
      if(monthFilter) list = list.filter(e=>{const d=new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); return key===monthFilter});
      return list;
    }

    // renderExpensesList accepts either a full list (and will filter it) or a prefiltered
    // list with the second argument set to true to skip filtering.
    function renderExpensesList(items, prefiltered){
      let list = items.slice();
      if(!prefiltered){
        list = applyFilters(list);
      }

      const out = $('expensesList'); out.innerHTML='';
      list.sort((a,b)=>b.createdAt - a.createdAt);
      for(const e of list){
        const row = document.createElement('div'); row.className='expense card';
        const left = document.createElement('div'); left.className='left';
        // Determine category display: if this entry is a salary (isSalary true or notes contains 'Ø±Ø§ØªØ¨')
        // show a transient 'Ø±Ø§ØªØ¨' label in the details but do NOT require a persistent category.
        let cat = categories[e.categoryId] || null;
        let transientSalary = false;
        try{ if(e.isSalary || ((e.notes||'').toLowerCase().includes('Ø±Ø§ØªØ¨') && e.type==='income')) transientSalary = true; }catch(ex){}
        if(!cat){ if(transientSalary){ cat = { name:'Ø±Ø§ØªØ¨', color: 'linear-gradient(135deg, #60a5fa, #34d399)', icon: 'ğŸ’°' }; } else { cat = {name:'Ø¨Ø¯ÙˆÙ†',color:'#999',icon:'â”'}; } }
        const badge = document.createElement('div'); badge.className='cat-badge'; badge.style.background=cat.color; badge.textContent = cat.icon || 'â€¢';
  const meta = document.createElement('div');
  const titleLine = document.createElement('div');
  titleLine.style.fontWeight = '600';
  titleLine.style.color = 'var(--text)';
  titleLine.textContent = `${cat.name} â€¢ ${fmt(e.amount)}`;
  const dateEl = document.createElement('div');
  dateEl.className = 'entry-date';
  const dateLabel = document.createElement('span'); dateLabel.className = 'meta-label'; dateLabel.textContent = 'Ø§Ù„ØªØ§Ø±ÙŠØ®';
  const dateVal = document.createElement('span'); dateVal.className = 'meta-value'; dateVal.textContent = formatDisplayDate(e.date);
  dateEl.appendChild(dateLabel); dateEl.appendChild(dateVal);

  const notesEl = document.createElement('div');
  notesEl.className = 'entry-notes';
  if(e.notes){
    const notesLabel = document.createElement('span'); notesLabel.className = 'meta-label'; notesLabel.textContent = 'Ù…Ù„Ø§Ø­Ø¸Ø©';
    const notesVal = document.createElement('span'); notesVal.className = 'meta-value'; notesVal.textContent = e.notes || '';
    notesEl.appendChild(notesLabel); notesEl.appendChild(notesVal);
  } else {
    notesEl.textContent = '';
  }

  meta.appendChild(titleLine);
  meta.appendChild(dateEl);
  if(e.notes) meta.appendChild(notesEl);
  left.appendChild(badge);
  left.appendChild(meta);

  const right = document.createElement('div'); right.className='right'; right.style.textAlign='right';
  const mainVal = document.createElement('div'); mainVal.style.fontWeight = '700'; mainVal.style.color = e.type==='income' ? 'var(--accent-start)' : 'var(--danger)'; mainVal.textContent = (e.type==='income'?'+':'-') + ' ' + fmt(e.amount);
        // receipt thumbnail (if any)
        if(e.imageData){
          try{
            const thumb = document.createElement('img'); thumb.src = e.imageData; thumb.alt = 'ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„'; thumb.style.width='56px'; thumb.style.height='56px'; thumb.style.objectFit='cover'; thumb.style.borderRadius='8px'; thumb.style.marginRight='8px';
            // mark as clickable-thumb and store full image in data attribute; lightbox handler added separately
            thumb.className = 'clickable-thumb';
            thumb.dataset.full = e.imageData;
            right.appendChild(thumb);
          }catch(ex){console.warn(ex)}
        }
        const sub = document.createElement('div'); sub.className = 'muted'; sub.textContent = e.createdAt? new Date(e.createdAt).toLocaleString() : '';

        // action buttons
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.justifyContent='flex-end'; actions.style.marginTop='6px';
        const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.style.padding='6px 8px'; editBtn.textContent='ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = ()=>{
          // populate modal for editing
          editingExpenseId = e.id;
          refs.amountInput.value = formatNumberWithCommas(String(e.amount || '0'));
          refs.typeInput.value = e.type || 'expense';
          refs.categoryInput.value = e.categoryId || '';
          refs.dateInput.value = e.date || new Date().toISOString().slice(0,10);
          refs.notesInput.value = e.notes || '';
          refs.saveAdd.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
          openModal('addModal');
          // populate receipt preview when editing
          try{
            refs._removeReceipt = false;
            if(e.imageData){
              refs._receiptData = e.imageData;
              if(refs.receiptPreview) { refs.receiptPreview.src = e.imageData; refs.receiptPreview.style.display = 'block'; }
              if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'inline-block';
            } else {
              if(refs.receiptPreview) { refs.receiptPreview.src = ''; refs.receiptPreview.style.display = 'none'; }
              if(refs.receiptInput) refs.receiptInput.value = '';
              if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'none';
            }
          }catch(ex){console.warn(ex)}
        };
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.style.padding='6px 8px'; delBtn.textContent='Ø­Ø°Ù';
        delBtn.onclick = ()=>{ deleteExpense(e.id); };

        actions.appendChild(editBtn); actions.appendChild(delBtn);

        right.appendChild(mainVal); right.appendChild(sub); right.appendChild(actions);

        row.appendChild(left); row.appendChild(right);
        out.appendChild(row);
      }
    }

    function populateCategorySelects(){
      const sel = $('categoryInput'); const filter = $('filterCategory'); sel.innerHTML=''; filter.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [id,c] of Object.entries(catObj||{})){
        const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
        const f = document.createElement('option'); f.value=id; f.textContent=c.name; filter.appendChild(f);
      }
    }

    function renderCategoriesUI(){
      const list = $('catsList'); list.innerHTML='';
      for(const [id,c] of Object.entries(categories)){
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='8px 0';
        const left = document.createElement('div'); left.className='flex'; left.innerHTML = `<div class=cat-badge style=background:${c.color}>${c.icon||'â€¢'}</div><div style=marginInlineStart:10px><div style=font-weight:600>${c.name}</div><div class=muted small>${c.id||id}</div></div>`;
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Ø­Ø°Ù'; del.onclick=()=>{ if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ')) deleteCategory(id); };
        el.appendChild(left); el.appendChild(del); list.appendChild(el);
      }
    }

    function populateFilterMonths(monthKeys){
      const sel = $('filterMonth'); const prev = sel.value; sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>';
      for(const m of monthKeys){ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o);} if(prev) sel.value = prev;
    }

    /***** Charts (vanilla canvas) *****/
    function renderBarChart(monthKeys, months){
      const c = $('barChart'); const ctx = c.getContext('2d'); c.width = c.clientWidth*devicePixelRatio; c.height = 180*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      // clear
      ctx.clearRect(0,0,c.clientWidth,180);
      const w = c.clientWidth; const h = 160;
      const padding = 20; const barWidth = Math.max(18, (w - padding*2) / Math.max(1, monthKeys.length) - 12);
      // compute totals per month (expense total)
      const totals = monthKeys.map(k=>{ const arr = months[k]||[]; return arr.reduce((s,x)=> s + (x.type==='expense'?Number(x.amount): -Number(x.amount)),0) });
      const max = Math.max(...totals.map(Math.abs),1);
      // draw bars
      monthKeys.forEach((k,i)=>{
        const val = totals[i]; const x = padding + i*(barWidth+12);
        const barH = Math.abs(val)/max * (h-40);
        ctx.fillStyle = val<0 ? '#ff7b7b' : 'rgba(108,92,231,0.9)';
        ctx.fillRect(x, h - barH, barWidth, barH);
        ctx.fillStyle = '#333'; ctx.font = '12px Poppins'; ctx.fillText(k, x, h+12);
      });
    }

    function renderPieChartForSelectedMonth(){
      const monthSel = $('filterMonth').value; if(!monthSel) return; // only show when a month selected
      const month = monthSel;
      // collect category totals in month
      const totals = {};
      const allObj = getAllExpensesObject();
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(key !== month) continue;
        const cat = e.categoryId || 'uncat';
        totals[cat] = (totals[cat]||0) + Number(e.amount || 0);
      }
      const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
      // draw pie
      const c = $('pieChart'); const ctx = c.getContext('2d'); c.width = c.clientWidth*devicePixelRatio; c.height = 160*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      ctx.clearRect(0,0,c.clientWidth,160);
      const w = c.clientWidth; const cx = w/2; const cy = 80; const r = 60;
      let start = -Math.PI/2; const total = entries.reduce((s,_)=>s+_[1],0) || 1;
      entries.forEach(([cid,val],i)=>{
        const slice = val/total * Math.PI*2; const end = start + slice;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
        const color = categories[cid]?.color || `hsl(${(i*60)%360} 70% 60%)`;
        ctx.fillStyle = color; ctx.fill();
        start = end;
      });
      // legend
      ctx.fillStyle='#333'; ctx.font='12px Poppins'; let yy=10; entries.forEach(([cid,val],i)=>{ ctx.fillText(`${categories[cid]?.name||cid} (${Math.round(val/total*100)}%)`, 10, yy+=14) });
    }

    /***** Advanced Comparison Functions *****/
    function toggleComparisonSection(){
      const section = $('comparisonSection');
      const icon = $('comparisonToggleIcon');
      const isHidden = section.style.display === 'none';
      section.style.display = isHidden ? 'block' : 'none';
      icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
      if(isHidden) populateComparisonMonths();
    }

    function populateComparisonMonths(){
      const allObj = getAllExpensesObject();
      const monthSet = new Set();
      const now = new Date();
      const currentMonth = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        monthSet.add(key);
      }
      
      // Add archived months
      try{
        if(db && db.ref){
          db.ref('settings/archivedMonths').once('value', snap=>{
            const archived = snap.val() || {};
            Object.keys(archived).forEach(m=>monthSet.add(m));
            const monthList = Array.from(monthSet).sort().reverse();
            renderComparisonMonthSelects(monthList);
          });
        }else{
          renderComparisonMonthSelects(Array.from(monthSet).sort().reverse());
        }
      }catch(e){
        renderComparisonMonthSelects(Array.from(monthSet).sort().reverse());
      }
    }

    function renderComparisonMonthSelects(months){
      const sel1 = $('comparisonMonth1');
      const sel2 = $('comparisonMonth2');
      const html = months.map(m=>`<option value="${m}">${m}</option>`).join('');
      sel1.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±</option>' + html;
      sel2.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±</option>' + html;
      
      // Populate categories filter
      const allCategories = Object.keys(categories).map(id=>({id, name: categories[id].name, color: categories[id].color}));
      const filterDiv = $('comparisonCategoriesFilter');
      filterDiv.innerHTML = allCategories.map(cat=>`
        <label style="display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:8px;background:#f0f0f0;cursor:pointer;font-size:13px">
          <input type="checkbox" value="${cat.id}" onchange="updateComparison()" style="cursor:pointer" />
          <span style="background:${cat.color};width:12px;height:12px;border-radius:50%"></span>
          ${cat.name}
        </label>
      `).join('');
    }

    function updateComparison(){
      const month1 = $('comparisonMonth1').value;
      const month2 = $('comparisonMonth2').value;
      
      if(!month1 && !month2){
        $('comparisonBarChart').style.display = 'none';
        $('comparisonStats').innerHTML = '<div style="color:var(--muted);text-align:center">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</div>';
        return;
      }
      
      // Get selected categories
      const selectedCats = new Set();
      document.querySelectorAll('#comparisonCategoriesFilter input:checked').forEach(cb=>selectedCats.add(cb.value));
      
      // Get data for both months (will handle archived months too)
      Promise.all([
        getMonthCategoryDataAsync(month1, selectedCats),
        getMonthCategoryDataAsync(month2, selectedCats)
      ]).then(([data1, data2])=>{
        drawComparisonChart(data1, data2, month1, month2);
        renderComparisonStats(data1, data2, month1, month2);
      });
    }

    async function getMonthCategoryDataAsync(month, selectedCats){
      const result = {};
      
      // First try to get from current expenses
      const allObj = getAllExpensesObject();
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(key !== month) continue;
        if(e.type !== 'expense') continue;
        
        const catId = e.categoryId || 'uncat';
        if(selectedCats.size > 0 && !selectedCats.has(catId)) continue;
        
        result[catId] = (result[catId]||0) + Number(e.amount||0);
      }
      
      // If month not found in current expenses, try archived data
      if(Object.keys(result).length === 0){
        try{
          if(db && db.ref){
            // Get archived months list first
            const monthsSnap = await db.ref('settings/archivedMonths').once('value');
            const archivedMonths = monthsSnap.val() || {};
            
            // Check if this month is in archived data
            if(archivedMonths[month]){
              const monthData = archivedMonths[month];
              
              // monthData is an object with {expenseId: expenseObject}
              for(const [id, e] of Object.entries(monthData)){
                if(e.type !== 'expense') continue;
                
                const catId = e.categoryId || 'uncat';
                if(selectedCats.size > 0 && !selectedCats.has(catId)) continue;
                
                result[catId] = (result[catId]||0) + Number(e.amount||0);
              }
            }
          }
        }catch(e){
          console.warn('Error loading archived month data:', e);
        }
      }
      
      return result;
    }

    function getMonthCategoryData(month, selectedCats){
      const result = {};
      const allObj = getAllExpensesObject();
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(key !== month) continue;
        if(e.type !== 'expense') continue;
        
        const catId = e.categoryId || 'uncat';
        if(selectedCats.size > 0 && !selectedCats.has(catId)) continue;
        
        result[catId] = (result[catId]||0) + Number(e.amount||0);
      }
      
      return result;
    }

    function drawComparisonChart(data1, data2, month1, month2){
      const c = $('comparisonBarChart');
      const ctx = c.getContext('2d');
      c.width = c.clientWidth * devicePixelRatio;
      c.height = 200 * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.clearRect(0, 0, c.clientWidth, 200);
      
      // Get all categories
      const allCats = new Set([...Object.keys(data1), ...Object.keys(data2)]);
      const catArray = Array.from(allCats).sort();
      
      const w = c.clientWidth;
      const h = 180;
      const padding = 20;
      const barWidth = Math.max(8, (w - padding*2) / Math.max(1, catArray.length*2) - 4);
      const maxVal = Math.max(...catArray.map(c=>Math.max(data1[c]||0, data2[c]||0)), 1);
      
      // Draw bars
      catArray.forEach((cat, i)=>{
        const val1 = data1[cat]||0;
        const val2 = data2[cat]||0;
        
        const baseX = padding + i * (barWidth*2 + 8);
        const barH1 = val1/maxVal * (h-40);
        const barH2 = val2/maxVal * (h-40);
        
        ctx.fillStyle = 'rgba(107,140,255,0.8)';
        ctx.fillRect(baseX, h - barH1, barWidth, barH1);
        
        ctx.fillStyle = 'rgba(90,208,255,0.8)';
        ctx.fillRect(baseX + barWidth + 2, h - barH2, barWidth, barH2);
        
        ctx.fillStyle = '#333';
        ctx.font = '11px Poppins';
        ctx.textAlign = 'center';
        ctx.fillText((categories[cat]?.name||cat).substring(0,3), baseX + barWidth/2, h+12);
      });
      
      // Legend
      ctx.fillStyle = '#333';
      ctx.font = '12px Poppins';
      ctx.textAlign = 'left';
      ctx.fillStyle = 'rgba(107,140,255,0.8)';
      ctx.fillRect(padding, h+20, 10, 10);
      ctx.fillStyle = '#333';
      ctx.fillText(month1||'Ø§Ù„Ø´Ù‡Ø± 1', padding+15, h+28);
      
      ctx.fillStyle = 'rgba(90,208,255,0.8)';
      ctx.fillRect(padding+100, h+20, 10, 10);
      ctx.fillStyle = '#333';
      ctx.fillText(month2||'Ø§Ù„Ø´Ù‡Ø± 2', padding+115, h+28);
    }

    function renderComparisonStats(data1, data2, month1, month2){
      const total1 = Object.values(data1).reduce((s,v)=>s+v, 0);
      const total2 = Object.values(data2).reduce((s,v)=>s+v, 0);
      const diff = total1 - total2;
      const diffPercent = total1 ? ((diff/total1)*100).toFixed(1) : 0;
      
      const statsHtml = `
        <div style="padding:8px;border-radius:8px;background:#f0f9ff;border-left:3px solid var(--blue)">
          <div style="font-size:12px;color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${month1||'Ø§Ù„Ø´Ù‡Ø± 1'}</div>
          <div style="font-weight:700;font-size:16px;color:var(--blue)">${fmt(total1)}</div>
        </div>
        <div style="padding:8px;border-radius:8px;background:#f0fdf4;border-left:3px solid var(--success)">
          <div style="font-size:12px;color:var(--muted)">Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${month2||'Ø§Ù„Ø´Ù‡Ø± 2'}</div>
          <div style="font-weight:700;font-size:16px;color:var(--success)">${fmt(total2)}</div>
        </div>
        <div style="padding:8px;border-radius:8px;background:${diff>0?'#fef3c7':'#dcfce7'};border-left:3px solid ${diff>0?'var(--danger)':'var(--success)'}">
          <div style="font-size:12px;color:var(--muted)">Ø§Ù„ÙØ±Ù‚</div>
          <div style="font-weight:700;font-size:16px;color:${diff>0?'var(--danger)':'var(--success)'}">${diff>0?'+':'-'} ${fmt(Math.abs(diff))} (${diffPercent}%)</div>
        </div>
      `;
      $('comparisonStats').innerHTML = statsHtml;
    }

    /***** Budget UI *****/
    function updateBudgetUI(){
      // Update per-category budgets list for the selected month
      const month = $('filterMonth').value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
      try{ renderCategoryBudgetsList(month); }catch(e){}
    }

    /***** Month Management Functions *****/
    function updateMonthManagementUI(){
      renderQuickMonthsList();
      updateMonthStats();
    }

    function updateMonthStats(){
      const allObj = getAllExpensesObject();
      const monthSet = new Set();
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        monthSet.add(key);
      }
      
      // Count archived from localStorage
      try{
        const archived = getArchivedMonths();
        const archivedCount = Object.keys(archived).length;
        $('quickArchivedMonths').textContent = archivedCount;
        $('quickTotalMonths').textContent = monthSet.size + archivedCount;
      }catch(e){
        $('quickArchivedMonths').textContent = '0';
        $('quickTotalMonths').textContent = monthSet.size;
      }
    }

    function renderQuickMonthsList(){
      const allObj = getAllExpensesObject();
      const monthSet = new Set();
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        monthSet.add(key);
      }
      
      // Add archived months
      try{
        if(db && db.ref){
          db.ref('settings/archivedMonths').once('value', snap=>{
            const archived = snap.val() || {};
            Object.keys(archived).forEach(m=>monthSet.add(m));
            displayQuickMonthsList(Array.from(monthSet).sort().reverse());
          });
          return;
        }
      }catch(e){}
      
      displayQuickMonthsList(Array.from(monthSet).sort().reverse());
    }

    function displayQuickMonthsList(months){
      const html = months.map(m=>{
        const allObj = getAllExpensesObject();
        let exp = 0, inc = 0;
        
        // Check in current expenses
        for(const [id,e] of Object.entries(allObj)){
          const d = new Date(e.date);
          const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
          if(key !== m) continue;
          const amt = Number(e.amount||0);
          if(e.type === 'income') inc += amt;
          else exp += amt;
        }
        
        // Also check in archived data (from localStorage)
        try{
          const archived = getArchivedMonths();
          if(archived[m]){
            const monthData = archived[m];
            for(const [id, e] of Object.entries(monthData)){
              const amt = Number(e.amount||0);
              if(e.type === 'income') inc += amt;
              else exp += amt;
            }
          }
        }catch(e){}
        
        const now = new Date();
        const currentMonth = now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0');
        const isCurrent = m === currentMonth;
        
        return `
          <div style="padding:12px;border-radius:10px;background:${isCurrent?'linear-gradient(135deg,#f0f9ff,#e0f2fe)':'#f9fafb'};border:${isCurrent?'2px solid var(--blue)':'1px solid #e5e7eb'};display:flex;justify-content:space-between;align-items:center;gap:10px;transition:all 0.2s">
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;font-size:14px;color:${isCurrent?'var(--blue)':'var(--text)'}">${m} ${isCurrent?'<span style="background:var(--blue);color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-right:6px">Ø­Ø§Ù„ÙŠ</span>':''}</div>
              <div style="font-size:12px;color:var(--muted);margin-top:4px;display:flex;gap:12px">
                <span style="color:var(--success)">ğŸ“ˆ ${fmt(inc)}</span>
                <span style="color:var(--danger)">ğŸ“‰ ${fmt(exp)}</span>
                <span style="color:var(--accent-start);font-weight:600">ğŸ’° ${fmt(inc-exp)}</span>
              </div>
            </div>
            <button class="btn ghost" onclick="deleteMonth('${m}')" style="padding:8px 12px;font-size:12px;background:#ffe0e0;color:#ff6b6b;border:none;border-radius:8px;transition:all 0.2s" onmouseover="this.style.background='#ffc0c0'" onmouseout="this.style.background='#ffe0e0'">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        `;
      }).join('');
      
      $('monthsList').innerHTML = html || '<div style="text-align:center;color:var(--muted);padding:30px 20px;font-size:13px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø± Ø¨Ø¹Ø¯</div>';
    }

    function toggleMonthManagement(){
      // This function is no longer needed
    }

    function openAdvancedMonthMgmt(){
      openModal('monthMgmtModal');
      renderMonthsList();
    }

    function renderMonthsList(){
      const allObj = getAllExpensesObject();
      const monthMap = new Map();
      
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(!monthMap.has(key)) monthMap.set(key, {exp:0, inc:0});
        const m = monthMap.get(key);
        const amt = Number(e.amount||0);
        if(e.type === 'income') m.inc += amt;
        else m.exp += amt;
      }
      
      // Add archived months
      let archived = [];
      try{
        // Get from localStorage first (always available)
        const localArchived = getArchivedMonths();
        Object.keys(localArchived).forEach(monthKey=>{
          archived.push(monthKey);
          if(!monthMap.has(monthKey)) monthMap.set(monthKey, {exp:0, inc:0});
          const m = monthMap.get(monthKey);
          const monthData = localArchived[monthKey];
          for(const [id, e] of Object.entries(monthData)){
            const amt = Number(e.amount||0);
            if(e.type === 'income') m.inc += amt;
            else m.exp += amt;
          }
        });
      }catch(e){}
      
      displayAdvancedMonthsList(monthMap, archived);
    }

    function displayAdvancedMonthsList(monthMap, archived){
      const search = $('monthSearchInput').value.toLowerCase();
      const sort = $('monthSortBy').value;
      
      let months = Array.from(monthMap.entries()).map(([m, {exp, inc}])=>({m, exp, inc, isArchived: archived.includes(m)}));
      
      // Filter by search
      if(search){
        months = months.filter(x=>x.m.includes(search));
      }
      
      // Sort
      if(sort === 'recent') months.sort((a,b)=>b.m.localeCompare(a.m));
      else if(sort === 'oldest') months.sort((a,b)=>a.m.localeCompare(b.m));
      else if(sort === 'expense') months.sort((a,b)=>b.exp-a.exp);
      else if(sort === 'income') months.sort((a,b)=>b.inc-a.inc);
      
      // Update stats
      $('totalMonthsCount').textContent = months.length;
      $('archivedMonthsCount').textContent = months.filter(x=>x.isArchived).length;
      $('activeMonthsCount').textContent = months.filter(x=>!x.isArchived).length;
      
      // Render
      const html = months.map(({m, exp, inc, isArchived})=>`
        <div style="padding:12px;border-radius:8px;background:#f9f9f9;border:1px solid #e9eef6;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div style="flex:1;min-width:120px">
            <div style="font-weight:600;font-size:14px">${m} ${isArchived?'<span style="background:#fef3c7;color:#b45309;padding:2px 6px;border-radius:4px;font-size:11px">Ù…Ø¤Ø±Ø´ÙØ©</span>':''}</div>
            <div style="font-size:12px;color:var(--muted);margin-top:4px">
              <span style="color:var(--success)">ğŸ“ˆ ${fmt(inc)}</span> | 
              <span style="color:var(--danger)">ğŸ“‰ ${fmt(exp)}</span> | 
              <span style="color:var(--accent-start)">ğŸ’° ${fmt(inc-exp)}</span>
            </div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn ghost" onclick="showMonthDetails('${m}')" style="padding:6px 10px;font-size:12px;background:linear-gradient(90deg,#3b82f6,#60a5fa);color:#fff;border:none;border-radius:6px">ğŸ“Š ØªÙØ§ØµÙŠÙ„</button>
            <button class="btn ghost" onclick="deleteMonth('${m}')" style="padding:6px 10px;font-size:12px;background:#ffe0e0;color:#ff6b6b;border:none;border-radius:6px">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        </div>
      `).join('');
      
      $('advancedMonthsList').innerHTML = html || '<div style="text-align:center;color:var(--muted);padding:40px 20px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø± Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
    }

    function deleteMonth(monthKey){
      if(!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„Ø´Ù‡Ø± ${monthKey}ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§`)) return;
      
      const allObj = getAllExpensesObject();
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date);
        const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(key === monthKey){
          try{
            if(db && db.ref) db.ref('expenses/'+id).remove();
          }catch(e){}
          delete expenses[id];
        }
      }
      
      localStorage.setItem('expenses', JSON.stringify(expenses));
      showToast(`ØªÙ… Ø­Ø°Ù Ø´Ù‡Ø± ${monthKey} âœ…`);
      renderMonthsList();
      renderQuickMonthsList();
      computeAndRender();
    }

    function showMonthDetails(monthKey){
      alert(`ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ù‡Ø± ${monthKey}:\n\nÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§`);
    }

    /***** Modal helpers *****/
    function openModal(modalId){
      $('modalBackdrop').style.display='flex';
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
      $(modalId).style.display='block';
    }
    function closeModalAndBackdrop(){
      $('modalBackdrop').style.display='none';
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    }

    /***** Wire events on DOMContentLoaded *****/
    document.addEventListener('DOMContentLoaded', ()=>{
      // refs
  ['searchInput','filterCategory','filterMonth','openAddBtn','addSalaryBtn','clearMonthBtn','openCatsBtn','addCatBtn','saveAdd','cancelAdd','addModal','catsModal','salaryModal','configModal','modalBackdrop','initFirebaseBtn','firebaseConfigInput','closeConfig','closeCats','newCatName','newCatColor','newCatIcon','catsList','amountInput','typeInput','categoryInput','dateInput','notesInput','salaryAmount','salaryDate','salaryAddNow','salarySave','salaryDelete','salaryCancel','archiveBtn','archiveModal','archiveSelectMonth','executeArchiveBtn','archivePreview','archiveViewMonth','viewArchiveDetailBtn','archiveViewContent','archiveOverallStats','archiveStatsContent','closeArchive','deleteArchiveMonthBtn'].forEach(id=>refs[id]=$(id));

  // extra refs added: per-category budget, receipt photo, and month management
  ['budgetCatSelect','budgetCatInput','saveBudgetCatBtn','catBudgetsList','receiptInput','receiptPreview','removeReceiptBtn','newMonthBtn','currentMonthText','openMonthMgmtBtn','closeMgmtModal','monthMgmtModal','monthSearchInput','monthSortBy'].forEach(id=>{ try{ refs[id] = $(id); }catch(e){} });

  // buttons
  refs.openAddBtn.onclick = ()=>{ editingExpenseId = null; refs.saveAdd.textContent = 'Ø£Ø¶Ù'; openModal('addModal'); refs.dateInput.value = new Date().toISOString().slice(0,10); try{ if(refs.receiptPreview) refs.receiptPreview.src=''; refs._receiptData = null; if(refs.receiptInput) refs.receiptInput.value=''; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display='none'; refs._removeReceipt = false;}catch(e){} };
      refs.cancelAdd.onclick = closeModalAndBackdrop;
      refs.openCatsBtn.onclick = ()=>openModal('catsModal');
      refs.closeCats.onclick = closeModalAndBackdrop;
  // (config modal remains accessible via settings area) openConfigBtn removed from header
      refs.closeConfig.onclick = closeModalAndBackdrop;

      // add / edit expense
        refs.saveAdd.onclick = ()=>{
        const amt = parseFormattedNumber(refs.amountInput.value || '0'); if(!amt){ alert('Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨'); return }
        const payload = { amount: Math.abs(amt), categoryId: refs.categoryInput.value || '', notes: refs.notesInput.value, date: refs.dateInput.value || new Date().toISOString().slice(0,10), type: refs.typeInput.value };
        // include or remove receipt image data if requested
        try{
          if(refs._removeReceipt){ payload.imageData = null; }
          else if(refs._receiptData){ payload.imageData = refs._receiptData; }
        }catch(e){}
        if(editingExpenseId){
          // update
          updateExpense(editingExpenseId, payload);
        } else {
          addExpense(payload);
        }
        // clear
        refs.amountInput.value=''; refs.notesInput.value=''; editingExpenseId = null; refs.saveAdd.textContent = 'Ø£Ø¶Ù'; closeModalAndBackdrop();
        // clear receipt preview and flags
        try{ if(refs.receiptPreview) refs.receiptPreview.src=''; refs._receiptData = null; refs._removeReceipt = false; if(refs.receiptInput) refs.receiptInput.value=''; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display='none'; }catch(e){}
      };

      // open salary modal for add/edit
      if(refs.addSalaryBtn){ refs.addSalaryBtn.onclick = ()=>{
        // prefill from existing recurring if present
        const found = findSalaryRecurring();
        if(found){
          refs.salaryAmount.value = formatNumberWithCommas(String(found.item.amount||0));
          refs.salarySave.dataset.editing = found.id;
        } else {
          refs.salaryAmount.value = formatNumberWithCommas(localStorage.getItem('lastSalary')||'30000');
          delete refs.salarySave.dataset.editing;
        }
        refs.salaryDate.value = new Date().toISOString().slice(0,10);
        refs.salaryAddNow.checked = true;
        openModal('salaryModal');
        try{ refs.salaryAmount.focus(); }catch(e){}
      } }

      // add category
      refs.addCatBtn.onclick = ()=>{
        const name = refs.newCatName.value.trim(); if(!name){alert('Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨');return}
        addCategory({name, color: refs.newCatColor.value, icon: refs.newCatIcon.value || 'â€¢'});
        refs.newCatName.value=''; refs.newCatIcon.value='';
      };

      // populate budget category select (uses categories or cached)
      function populateBudgetCatSelect(){
        const sel = refs.budgetCatSelect; if(!sel) return;
        sel.innerHTML = '';
        const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
        for(const [id,c] of Object.entries(catObj||{})){
          const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
        }
      }

      // save per-category budget for month
      function saveCategoryBudgetForMonth(yyyyMM, catId, amount){
        if(!catId) return;
        if(db){
          db.ref('settings/monthlyBudgets/'+yyyyMM+'/categories/'+catId).set(Number(amount)).then(()=>{ showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸: '+e.message));
        } else {
          // local fallback
          const key = 'localMonthCategoryBudgets';
          const all = JSON.parse(localStorage.getItem(key)||'{}');
          all[yyyyMM] = all[yyyyMM] || {};
          all[yyyyMM][catId] = Number(amount);
          localStorage.setItem(key, JSON.stringify(all));
          // reflect in window.settings for UI
          window.settings = window.settings || {};
          window.settings.monthlyBudgets = window.settings.monthlyBudgets || {};
          window.settings.monthlyBudgets[yyyyMM] = window.settings.monthlyBudgets[yyyyMM] || {};
          window.settings.monthlyBudgets[yyyyMM].categories = window.settings.monthlyBudgets[yyyyMM].categories || {};
          window.settings.monthlyBudgets[yyyyMM].categories[catId] = Number(amount);
          computeAndRender();
          showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§) âœ…');
        }
      }

      // render per-category budgets list for selected month
      function renderCategoryBudgetsList(yyyyMM){
        const el = refs.catBudgetsList; if(!el) return; el.innerHTML='';
        // read budgets from settings or local
        let catBud = {};
        try{ if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories) catBud = window.settings.monthlyBudgets[yyyyMM].categories; }catch(e){}
        try{ const local = JSON.parse(localStorage.getItem('localMonthCategoryBudgets')||'{}'); if(local[yyyyMM]) Object.assign(catBud, local[yyyyMM]); }catch(e){}
        // compute usage per category
        const allObj = getAllExpensesObject();
        const totals = {};
        for(const [id,e] of Object.entries(allObj||{})){
          const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(key!==yyyyMM) continue;
          const cid = e.categoryId || 'uncat'; totals[cid] = (totals[cid]||0) + Number(e.amount||0);
        }
        const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
        for(const [cid,bud] of Object.entries(catBud||{})){
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
          const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${(catObj[cid]&&catObj[cid].name)||cid}</div><div class=muted style="font-size:12px">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(bud)} Â· Ù…Ø³ØªØ®Ø¯Ù…: ${fmt(totals[cid]||0)}</div>`;
          const percent = bud>0 ? Math.round((totals[cid]||0)/bud*100) : 0;
          const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
          const p = document.createElement('div'); p.style.minWidth='48px'; p.style.textAlign='right'; p.textContent = percent+'%';
          const edit = document.createElement('button'); edit.className='btn ghost'; edit.style.padding='6px 8px'; edit.textContent='ØªØ¹Ø¯ÙŠÙ„';
          edit.onclick = ()=>{ refs.budgetCatSelect.value = cid; refs.budgetCatInput.value = formatNumberWithCommas(String(bud||0)); };
          const del = document.createElement('button');
          del.className='btn ghost';
          del.style.padding='10px 12px';
          del.style.fontWeight='700';
          del.style.borderRadius='10px';
          del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-inline-end:8px;vertical-align:middle;color:inherit"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>Ø­Ø°Ù';
          del.onclick = ()=>{ if(!confirm('Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù„Ù„Ø´Ù‡Ø± ' + yyyyMM + 'ØŸ')) return; deleteCategoryBudgetForMonth(yyyyMM, cid); };
          right.appendChild(p); right.appendChild(edit); right.appendChild(del);
          row.appendChild(left); row.appendChild(right); el.appendChild(row);
        }
        if(Object.keys(catBud||{}).length===0) el.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙØ¦Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
      }

      // wire saveBudgetCatBtn
      if(refs.saveBudgetCatBtn){ refs.saveBudgetCatBtn.onclick = ()=>{
        const month = refs.filterMonth.value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
        const cid = refs.budgetCatSelect.value; const amt = parseFormattedNumber(refs.budgetCatInput.value||'0');
        if(!cid){ alert('Ø§Ø®ØªØ± ÙØ¦Ø©'); return }
        saveCategoryBudgetForMonth(month, cid, Math.abs(amt));
        refs.budgetCatInput.value=''; renderCategoryBudgetsList(month);
      } }

      // populate select initially
      populateBudgetCatSelect();

      // receipt photo input handling (downscale & preview)
      function readImageFileAsDataURL(file, maxWidth=1000){
        return new Promise((res,rej)=>{
          const reader = new FileReader(); reader.onload = (e)=>{
            const img = new Image(); img.onload = ()=>{
              // downscale if needed
              const canvas = document.createElement('canvas');
              let w = img.width; let h = img.height; if(w>maxWidth){ h = Math.round(h * (maxWidth / w)); w = maxWidth; }
              canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8); res(dataUrl);
            };
            img.onerror = ()=>res(e.target.result); img.src = e.target.result;
          };
          reader.onerror = rej; reader.readAsDataURL(file);
        })
      }

      // create file input and preview inside add modal if not present
      try{
        const addModal = $('addModal');
        if(addModal && !$('receiptInput')){
          const container = document.createElement('div'); container.style.marginTop='8px';
          container.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><input id="receiptInput" type="file" accept="image/*" /><img id="receiptPreview" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee;display:none" /><button id="removeReceiptBtn" class="btn ghost" type="button" style="padding:6px 8px;display:none;margin-left:6px">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button></div>`;
          addModal.querySelector('div[style*="margin-top:10px;display:flex;flex-direction:column;gap:8px"]').appendChild(container);
          refs.receiptInput = $('receiptInput'); refs.receiptPreview = $('receiptPreview'); refs.removeReceiptBtn = $('removeReceiptBtn');
          refs.receiptInput.onchange = async (ev)=>{
            const f = ev.target.files && ev.target.files[0]; if(!f) return;
            try{ const data = await readImageFileAsDataURL(f, 800); refs._receiptData = data; refs.receiptPreview.src = data; refs.receiptPreview.style.display='block'; refs._removeReceipt = false; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'inline-block'; }catch(e){ console.warn(e) }
          };
          if(refs.removeReceiptBtn){ refs.removeReceiptBtn.onclick = ()=>{ try{ refs._receiptData = null; refs._removeReceipt = true; refs.receiptPreview.src=''; refs.receiptPreview.style.display='none'; if(refs.receiptInput) refs.receiptInput.value=''; refs.removeReceiptBtn.style.display='none'; }catch(e){} } }
        }
      }catch(e){console.warn(e)}

      // salary modal actions
      if(refs.salarySave){ refs.salarySave.onclick = async ()=>{
        const amt = parseFormattedNumber(refs.salaryAmount.value||'0'); if(!amt){ alert('Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨'); return }
        const payload = { name: 'Ø±Ø§ØªØ¨', amount: Math.abs(amt), notes: '' };
        const editing = refs.salarySave.dataset.editing;
        try{
          if(editing) updateRecurringIncome(editing, payload); else addRecurringIncome(payload);
          localStorage.setItem('lastSalary', String(Math.abs(amt)));
          // optionally add now to expenses
          if(refs.salaryAddNow && refs.salaryAddNow.checked){
            const catId = await ensureSalaryCategory();
            const date = refs.salaryDate.value || new Date().toISOString().slice(0,10);
            // mark the expense as a salary record but do not create a persistent category
            addExpense({ amount: Math.abs(amt), categoryId: catId||'', notes:'Ø±Ø§ØªØ¨', date, type:'income', isSalary: true });
          }
          closeModalAndBackdrop();
        }catch(e){ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸: '+(e.message||e)); }
      }}

      if(refs.salaryDelete){ refs.salaryDelete.onclick = ()=>{
        const editing = refs.salarySave.dataset.editing; if(!editing){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± Ù„Ù„Ø­Ø°Ù'); return }
        deleteRecurringIncome(editing); delete refs.salarySave.dataset.editing; refs.salaryAmount.value='';
      }}

      if(refs.salaryCancel) refs.salaryCancel.onclick = closeModalAndBackdrop;

      // attach formatted input to salary amount
      try{ attachFormattedInput(refs.salaryAmount); }catch(e){}

      // config initialize
      refs.initFirebaseBtn.onclick = ()=>{
        const txt = refs.firebaseConfigInput.value.trim(); if(!txt){alert('Ø§Ù„ØµÙ‚ Ø§Ù„config JSON');return}
        initFirebaseFromConfigString(txt);
      };

      // Archive modal handlers
      if(refs.archiveBtn){ refs.archiveBtn.onclick = ()=>{
        // Populate both selects with months that have data
        const months = {};
        const allObj = getAllExpensesObject();
        
        // Get months with current data (not yet archived)
        for(const [id,e] of Object.entries(allObj||{})){
          if(!e.date) continue;
          const d = new Date(e.date);
          const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
          months[key] = (months[key]||0) + 1;
        }
        
        // Populate archive select (current months to archive)
        refs.archiveSelectMonth.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ Ø£Ø±Ø´ÙØªÙ‡...</option>';
        for(const month of Object.keys(months).sort().reverse()){
          const opt = document.createElement('option');
          opt.value = month;
          opt.textContent = month + ' (' + months[month] + ' Ø¹Ù†ØµØ±)';
          refs.archiveSelectMonth.appendChild(opt);
        }
        
        // Populate view select (archived months)
        refs.archiveViewMonth.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù…Ø¤Ø±Ø´ÙØ§Ù‹...</option>';
        const archived = getArchivedMonths();
        for(const month of Object.keys(archived||{}).sort().reverse()){
          const count = Object.keys(archived[month]||{}).length;
          const opt = document.createElement('option');
          opt.value = month;
          opt.textContent = month + ' (' + count + ' Ø¹Ù†ØµØ±)';
          refs.archiveViewMonth.appendChild(opt);
        }
        
        openModal('archiveModal');
      }}
      
      // Show preview when selecting month to archive
      if(refs.archiveSelectMonth){ refs.archiveSelectMonth.onchange = ()=>{
        const month = refs.archiveSelectMonth.value;
        if(!month){
          refs.archivePreview.textContent = 'Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø±Ø´ÙØ© Ù‡Ù†Ø§';
          return;
        }
        const allObj = getAllExpensesObject();
        let count = 0, totalExpense = 0, totalIncome = 0;
        for(const [id,e] of Object.entries(allObj||{})){
          if(!e.date) continue;
          const d = new Date(e.date);
          const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
          if(key === month){
            count++;
            const amt = Number(e.amount||0);
            if(e.type === 'income') totalIncome += amt;
            else totalExpense += amt;
          }
        }
        refs.archivePreview.innerHTML = `<strong>Ø§Ù„Ø´Ù‡Ø±:</strong> ${month}<br><strong>Ø§Ù„Ø¹Ù†Ø§ØµØ±:</strong> ${count}<br><strong>Ø§Ù„Ø¯Ø®Ù„:</strong> ${fmt(totalIncome)}<br><strong>Ø§Ù„Ù…ØµØ±ÙˆÙ:</strong> ${fmt(totalExpense)}<br><strong>Ø§Ù„ØµØ§ÙÙŠ:</strong> ${fmt(totalIncome - totalExpense)}<br><span class="muted small">Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>`;
      }}
      
      // Execute archiving
      if(refs.executeArchiveBtn){ refs.executeArchiveBtn.onclick = ()=>{
        const month = refs.archiveSelectMonth.value;
        if(!month){ alert('Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹'); return }
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø£Ø±Ø´ÙØ© Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª ' + month + 'ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©.')) return;
        
        try{
          const success = archiveMonthManually(month);
          if(success){
            computeAndRender();
            showToast('âœ… ØªÙ… Ø£Ø±Ø´ÙØ© ' + month + ' Ø¨Ù†Ø¬Ø§Ø­!', 4000);
            
            // Refresh the selects
            refs.archiveSelectMonth.value = '';
            refs.archivePreview.textContent = 'ØªÙ… Ø§Ù„Ø£Ø±Ø´ÙØ© Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ø¢Ø®Ø±';
            
            // Re-populate view select
            refs.archiveViewMonth.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù…Ø¤Ø±Ø´ÙØ§Ù‹...</option>';
            const archived = getArchivedMonths();
            for(const m of Object.keys(archived||{}).sort().reverse()){
              const count = Object.keys(archived[m]||{}).length;
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m + ' (' + count + ' Ø¹Ù†ØµØ±)';
              refs.archiveViewMonth.appendChild(opt);
            }
          } else {
            alert('Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø£Ø±Ø´ÙØªÙ‡Ø§ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±');
          }
        }catch(e){alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø£Ø±Ø´ÙØ©: ' + e.message)}
      }}
      
      // View archived month details
      if(refs.viewArchiveDetailBtn){ refs.viewArchiveDetailBtn.onclick = ()=>{
        const month = refs.archiveViewMonth.value;
        if(!month){ alert('Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹'); return }
        
        const data = getArchivedExpenses(month);
        const items = Object.entries(data).map(([id,e])=>({id,...e})).sort((a,b)=>new Date(b.date) - new Date(a.date));
        const content = refs.archiveViewContent;
        content.innerHTML = '';
        
        if(items.length === 0){
          content.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
        } else {
          let totalExpense = 0, totalIncome = 0;
          
          for(const e of items){
            const amt = Number(e.amount||0);
            if(e.type === 'income') totalIncome += amt;
            else totalExpense += amt;
            
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.alignItems = 'center';
            row.style.padding = '10px';
            row.style.borderBottom = '1px solid #eee';
            row.style.backgroundColor = e.type === 'income' ? '#f0fdf4' : '#fef2f2';
            
            const left = document.createElement('div');
            left.innerHTML = `
              <div style="font-weight:600;color:${e.type==='income'?'var(--success)':'var(--danger)'}">${categories[e.categoryId]?.name || e.categoryId || 'Ø¨Ø¯ÙˆÙ† ÙØ¦Ø©'}</div>
              <div class="muted" style="font-size:12px; word-break: break-word;">${formatDisplayDate(e.date)} ${e.notes ? 'â€¢ ' + e.notes : ''}</div>
            `;
            
            const right = document.createElement('div');
            right.style.fontWeight = '700';
            right.style.fontSize = '15px';
            right.style.color = e.type === 'income' ? 'var(--success)' : 'var(--danger)';
            right.textContent = (e.type === 'income' ? '+' : '-') + ' ' + fmt(amt);
            
            // Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if(e.imageData){
              try{
                const thumbDiv = document.createElement('div');
                thumbDiv.style.marginTop = '8px';
                const thumb = document.createElement('img');
                thumb.src = e.imageData;
                thumb.alt = 'ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„';
                thumb.style.width = '100%';
                thumb.style.maxWidth = '200px';
                thumb.style.height = 'auto';
                thumb.style.borderRadius = '6px';
                thumb.style.border = '1px solid #ddd';
                thumb.style.cursor = 'pointer';
                thumb.className = 'clickable-thumb';
                thumb.dataset.full = e.imageData;
                thumb.onclick = (ev)=>{ ev.stopPropagation(); showImage(e.imageData); };
                thumbDiv.appendChild(thumb);
                row.appendChild(thumbDiv);
              }catch(ex){console.warn(ex)}
            }
            
            row.appendChild(left);
            row.appendChild(right);
            content.appendChild(row);
          }
          
          const summary = document.createElement('div');
          summary.style.marginTop = '12px';
          summary.style.padding = '12px';
          summary.style.background = '#f0f9ff';
          summary.style.borderRadius = '8px';
          summary.style.borderLeft = '4px solid var(--blue)';
          summary.innerHTML = `
            <div style="display:flex;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.1)">
              <span style="font-weight:600">Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø± ${month}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span>Ø§Ù„Ø¯Ø®Ù„:</span>
              <span style="color:var(--success);font-weight:700">${fmt(totalIncome)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;margin-bottom:5px">
              <span>Ø§Ù„Ù…ØµØ±ÙˆÙ:</span>
              <span style="color:var(--danger);font-weight:700">${fmt(totalExpense)}</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px solid rgba(0,0,0,0.1)">
              <span style="font-weight:600">Ø§Ù„ØµØ§ÙÙŠ:</span>
              <span style="font-weight:700;color:${totalIncome - totalExpense >= 0 ? 'var(--success)' : 'var(--danger)'}">${fmt(totalIncome - totalExpense)}</span>
            </div>
          `;
          content.appendChild(summary);
        }
        content.style.display = 'block';
        
        // Show delete button when viewing archived month
        if(refs.deleteArchiveMonthBtn && month){
          refs.deleteArchiveMonthBtn.style.display = 'inline-block';
          refs.deleteArchiveMonthBtn.dataset.monthToDelete = month;
        }
      }}
      
      // Delete archived month handler
      if(refs.deleteArchiveMonthBtn){ refs.deleteArchiveMonthBtn.onclick = ()=>{
        const month = refs.deleteArchiveMonthBtn.dataset.monthToDelete;
        if(!month){ alert('Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹'); return; }
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø¤Ø±Ø´Ù ' + month + 'ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.')) return;
        
        try{
          const success = deleteArchivedMonth(month);
          if(success){
            showToast('âœ… ØªÙ… Ø­Ø°Ù Ø£Ø±Ø´ÙŠÙ ' + month + ' Ø¨Ù†Ø¬Ø§Ø­!', 4000);
            
            // Clear the view
            refs.archiveViewContent.innerHTML = '';
            refs.archiveViewContent.style.display = 'none';
            refs.archiveViewMonth.value = '';
            refs.deleteArchiveMonthBtn.style.display = 'none';
            
            // Refresh the select list
            refs.archiveViewMonth.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø´Ù‡Ø±Ø§Ù‹ Ù…Ø¤Ø±Ø´ÙØ§Ù‹...</option>';
            const archived = getArchivedMonths();
            for(const m of Object.keys(archived||{}).sort().reverse()){
              const count = Object.keys(archived[m]||{}).length;
              const opt = document.createElement('option');
              opt.value = m;
              opt.textContent = m + ' (' + count + ' Ø¹Ù†ØµØ±)';
              refs.archiveViewMonth.appendChild(opt);
            }
            
            // Refresh statistics if visible
            try{ if(refs.archiveStatsContent && refs.archiveStatsContent.style.display !== 'none') refs.archiveOverallStats.click(); }catch(e){}
          } else {
            alert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù - Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ø§Ù„Ø´Ù‡Ø± Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹');
          }
        }catch(e){alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù: ' + e.message)}
      }}
      
      // Overall archive statistics
      if(refs.archiveOverallStats){ refs.archiveOverallStats.onclick = ()=>{
        const archived = getArchivedMonths();
        const months = Object.keys(archived||{}).sort();
        
        if(months.length === 0){
          refs.archiveStatsContent.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø± Ù…Ø¤Ø±Ø´ÙØ© Ø¨Ø¹Ø¯</div>';
          refs.archiveStatsContent.style.display = 'block';
          return;
        }
        
        let totalExpense = 0, totalIncome = 0, totalItems = 0;
        let monthsData = {};
        
        for(const month of months){
          const items = Object.values(archived[month]||{});
          const monthExpense = items.filter(e=>e.type!=='income').reduce((s,e)=>s+Number(e.amount||0),0);
          const monthIncome = items.filter(e=>e.type==='income').reduce((s,e)=>s+Number(e.amount||0),0);
          
          totalExpense += monthExpense;
          totalIncome += monthIncome;
          totalItems += items.length;
          monthsData[month] = { count: items.length, expense: monthExpense, income: monthIncome };
        }
        
        let html = `
          <div style="font-weight:600;margin-bottom:10px;padding-bottom:10px;border-bottom:2px solid var(--blue)">
            Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ø£Ø±Ø´ÙŠÙ
          </div>
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px">
            <div style="background:#f0fdf4;padding:10px;border-radius:6px;border-left:3px solid var(--success)">
              <div class="small muted">Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
              <div style="font-weight:700;font-size:16px;color:var(--success)">${fmt(totalIncome)}</div>
            </div>
            <div style="background:#fef2f2;padding:10px;border-radius:6px;border-left:3px solid var(--danger)">
              <div class="small muted">Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
              <div style="font-weight:700;font-size:16px;color:var(--danger)">${fmt(totalExpense)}</div>
            </div>
          </div>
          <div style="background:#f0f9ff;padding:10px;border-radius:6px;border-left:3px solid var(--blue);margin-bottom:12px">
            <div class="small muted">Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
            <div style="font-weight:700;font-size:16px;color:${totalIncome-totalExpense>=0?'var(--success)':'var(--danger)'}">${fmt(totalIncome - totalExpense)}</div>
          </div>
          <div style="background:#fef3c7;padding:10px;border-radius:6px;border-left:3px solid #f59e0b;margin-bottom:12px">
            <div class="small muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©</div>
            <div style="font-weight:700;font-size:16px">${months.length} Ø£Ø´Ù‡Ø±</div>
          </div>
          <div style="font-weight:600;margin:12px 0 8px 0;padding-bottom:8px;border-bottom:1px solid #ddd">ØªÙØµÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±:</div>
        `;
        
        for(const month of months){
          const data = monthsData[month];
          html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff9e6;margin-bottom:6px;border-radius:4px">
              <div>
                <strong>${month}</strong>
                <span class="muted small"> (${data.count} Ø¹Ù†ØµØ±)</span>
              </div>
              <div style="text-align:right">
                <div style="font-size:12px">Ø§Ù„Ø¯Ø®Ù„: <span style="color:var(--success);font-weight:600">${fmt(data.income)}</span></div>
                <div style="font-size:12px">Ø§Ù„Ù…ØµØ±ÙˆÙ: <span style="color:var(--danger);font-weight:600">${fmt(data.expense)}</span></div>
              </div>
            </div>
          `;
        }
        
        refs.archiveStatsContent.innerHTML = html;
        refs.archiveStatsContent.style.display = 'block';
      }}
      
      if(refs.closeArchive){ refs.closeArchive.onclick = closeModalAndBackdrop; }

      // Month management modal
      if(refs.openMonthMgmtBtn){ refs.openMonthMgmtBtn.onclick = openAdvancedMonthMgmt; }
      if(refs.closeMgmtModal){ refs.closeMgmtModal.onclick = closeModalAndBackdrop; }

      // New month button handler
      if(refs.newMonthBtn){ refs.newMonthBtn.onclick = ()=>{
        if(!confirm('Ù‡Ø°Ø§ Ø³ÙŠØ¤Ø±Ø´Ù Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ³ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
        try{
          const now = new Date();
          const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
          
          const success = archiveMonthManually(currentMM);
          if(success){
            // Clear the "initialization flag" so next month gets initialized
            const lastMonthInitKey = 'lastMonthInit_' + currentMM;
            localStorage.removeItem(lastMonthInitKey);
            
            // Refresh UI
            computeAndRender();
            showToast('âœ… ØªÙ… Ø£Ø±Ø´ÙØ© ' + currentMM + ' Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 4000);
          } else {
            alert('Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙØ©');
          }
        }catch(e){alert('Ø®Ø·Ø£: '+e.message)}
      }}
      
      // Update current month display
      function updateCurrentMonthDisplay(){
        try{
          const now = new Date();
          const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
          if(refs.currentMonthText) refs.currentMonthText.textContent = currentMM;
        }catch(e){}
      }
      updateCurrentMonthDisplay();

      // monthly budget removed â€” use per-category budgets instead

      // export button removed from header; exportExpensesCSV still available for future use

      // clear all expenses in selected month
      refs.clearMonthBtn.onclick = ()=>{
        const monthFilter = refs.filterMonth.value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„Ø´Ù‡Ø± ' + monthFilter + ' ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.')) return;
        for(const [id,e] of Object.entries(expenses)){
          const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
          if(key === monthFilter){ db.ref('expenses/'+id).remove(); }
        }
        showToast('ØªÙ… Ø­Ø°Ù Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø± âœ…');
      };

      // filters
      refs.searchInput.oninput = debounce(()=>computeAndRender(), 300);
      refs.filterCategory.onchange = ()=>computeAndRender();
      refs.filterMonth.onchange = ()=>{ computeAndRender(); renderPieChartForSelectedMonth(); };

      // load cached firebase config automatically if present
      const cached = localStorage.getItem('firebaseConfig');
      if(cached){ try{ initFirebaseFromConfigString(cached); }catch(e){console.log('no init') } }

      // Try to sync pending local expenses when app loads (if firebase available later attach will call sync too)
      try{ syncPendingExpenses(); }catch(e){}
      
      // Initialize new month (archive previous if needed)
      try{ initializeNewMonth(); }catch(e){ console.warn('new month init error', e); }

      // Ensure current and next month placeholders exist (persisted) so user can add for next month
      try{
        const now = new Date();
        const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
        const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
        const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
        ensureMonthPlaceholder(currentMM);
        ensureMonthPlaceholder(nextMM);
      }catch(e){}

      // Online/offline events: attempt auto-init and sync when connection returns
      window.addEventListener('online', ()=>{
        updateConnectionStatus();
        showToast('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª - Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©',2000);
        const cached = localStorage.getItem('firebaseConfig');
        // If the page opened offline the Firebase SDKs may not be loaded. Load them dynamically
        // then initialize and sync pending expenses.
        (async ()=>{
          try{
            if(cached && !db){
              if(typeof firebase === 'undefined'){
                try{ await loadFirebaseSDKs(); }catch(e){ console.warn('could not load firebase SDKs', e); }
              }
              try{ initFirebaseFromConfigString(cached); }catch(e){ console.warn('init on online failed', e); }
            }
          }catch(e){ console.warn('online init error', e); }
          try{ 
            const synced = await syncPendingExpenses();
            if(synced > 0) showToast(`âœ… ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ${synced} Ø¹Ù…Ù„ÙŠØ©`, 2000);
          }catch(e){console.warn(e)}
        })();
      });
      
      window.addEventListener('offline', ()=>{ 
        updateConnectionStatus();
        showToast('âš ï¸ Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ - Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§', 2000);
      });
      
      // Update connection status indicator
      function updateConnectionStatus(){
        const ind = $('connectionIndicator');
        if(navigator.onLine){
          ind.classList.remove('offline');
          ind.classList.add('online');
        } else {
          ind.classList.remove('online');
          ind.classList.add('offline');
        }
      }
      
      // Check pending count
      function updatePendingCount(){
        try{
          const pending = getPendingExpenses();
          const count = Object.keys(pending).length;
          const statusEl = $('connectionIndicator');
          // Just update class based on connection + pending state
          if(!navigator.onLine){
            statusEl.classList.add('offline');
            statusEl.classList.remove('online');
          } else if(count > 0){
            // Has pending but online - show amber/warning state
            statusEl.classList.add('offline'); // reuse offline style temporarily for pending
            statusEl.classList.remove('online');
          } else {
            statusEl.classList.add('online');
            statusEl.classList.remove('offline');
          }
        }catch(e){}
      }
      
      // also ensure month placeholders when we go online (persist next month in DB if possible)
      window.addEventListener('online', ()=>{
        try{
          const now = new Date();
          const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
          const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
          ensureMonthPlaceholder(nextMM);
        }catch(e){}
      });

  // default to current month for quicker daily logging
  const defaultMonth = (new Date()).getFullYear() + '-' + String((new Date()).getMonth()+1).padStart(2,'0');
  if(!refs.filterMonth.value) { refs.filterMonth.value = defaultMonth; $('selectedMonthTitle').textContent = defaultMonth; }

      // initial placeholder categories if none (local-first)
      if(!localStorage.getItem('seededCats')){
        const sample = {
          food:{name:'Ø·Ø¹Ø§Ù…',color:'#ff8a65',icon:'ğŸ”'},
          transport:{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',color:'#4fd1c5',icon:'ğŸš—'},
          clothes:{name:'Ù…Ù„Ø§Ø¨Ø³',color:'#9f7aea',icon:'ğŸ‘—'}
        };
        // only show locally; will be overwritten when firebase loads
        categories = Object.fromEntries(Object.entries(sample).map(([k,v])=>[k,{...v,id:k}]));
        localStorage.setItem('seededCats','1');
        renderCategoriesUI(); populateCategorySelects();
      }

      // If offline or no firebase yet, try load cached categories from previous session
      try{
        const cachedCats = localStorage.getItem('cachedCategories');
        if(cachedCats){
          const parsed = JSON.parse(cachedCats);
          if(parsed && Object.keys(parsed).length){
            categories = parsed;
            renderCategoriesUI(); populateCategorySelects();
          }
        }
      }catch(e){console.warn('failed loading cachedCategories',e)}

      // Immediately remove any existing persistent 'Ø±Ø§ØªØ¨' categories per user request
      try{ removeSalaryCategories(); }catch(e){}

      // small helpers
        function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

  // attach to amount and per-category budget inputs for nicer UX (refs available)
  /* Gallery: render thumbnails from expenses with imageData and provide filters */
  try{
    const galleryBtn = $('openGalleryBtn'); const galleryModal = $('galleryModal'); const galleryGrid = $('galleryGrid');
    const galleryFilterCategory = $('galleryFilterCategory'); const galleryFilterMonth = $('galleryFilterMonth'); const gallerySearch = $('gallerySearch');
    const galleryClose = $('galleryClose'); const galleryClear = $('galleryClear');

    function buildMonthKeys(){ const months = new Set(); const all = getAllExpensesObject(); for(const [id,e] of Object.entries(all||{})){ try{ const d=new Date(e.date); const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); months.add(k); }catch(_){} } const placeholders = getMergedMonthPlaceholders(); Object.keys(placeholders||{}).forEach(k=>months.add(k)); return Array.from(months).sort((a,b)=>b.localeCompare(a)); }

    function populateGalleryFilters(){ try{ galleryFilterCategory.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>'; const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })(); for(const [id,c] of Object.entries(catObj||{})){ const o=document.createElement('option'); o.value=id; o.textContent=c.name; galleryFilterCategory.appendChild(o); } galleryFilterMonth.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>'; const months = buildMonthKeys(); months.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; galleryFilterMonth.appendChild(o); }); }catch(e){console.warn(e)} }

    function renderGallery(){ if(!galleryGrid) return; galleryGrid.innerHTML = ''; const all = getAllExpensesObject(); const items = Object.entries(all||{}).map(([id,e])=>({id,...e})).filter(x=>x.imageData); const catFilter = galleryFilterCategory ? galleryFilterCategory.value : ''; const monthFilter = galleryFilterMonth ? galleryFilterMonth.value : ''; const search = gallerySearch ? gallerySearch.value.trim().toLowerCase() : ''; const filtered = items.filter(e=>{ if(catFilter && e.categoryId !== catFilter) return false; if(monthFilter){ try{ const d=new Date(e.date); const k = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(k !== monthFilter) return false; }catch(_){} } if(search){ const hay = ((e.notes||'') + ' ' + (e.amount||'')).toLowerCase(); if(!hay.includes(search)) return false; } return true; }).sort((a,b)=> (b.createdAt||0) - (a.createdAt||0)); if(!filtered.length){ galleryGrid.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±</div>'; return; } for(const e of filtered){ try{ const tile = document.createElement('div'); tile.className='tile'; const img = document.createElement('img'); img.src = e.imageData; img.loading = 'lazy'; img.className = 'clickable-thumb'; img.dataset.full = e.imageData; img.alt = e.notes || ('Ø¥ÙŠØµØ§Ù„ '+(e.id||'')); tile.appendChild(img); const meta = document.createElement('div'); meta.style.padding='6px'; meta.style.fontSize='12px'; meta.style.display='flex'; meta.style.justifyContent='space-between'; meta.style.alignItems='center'; meta.innerHTML = `<div style="font-weight:700">${(e.amount?fmt(e.amount):'')}</div><div class=muted style="font-size:11px">${formatDisplayDate(e.date)}</div>`; tile.appendChild(meta); galleryGrid.appendChild(tile); }catch(ex){console.warn(ex)} }
    }

    if(galleryBtn){ galleryBtn.onclick = ()=>{ populateGalleryFilters(); renderGallery(); openModal('galleryModal'); }; }
    if(galleryClose){ galleryClose.onclick = closeModalAndBackdrop; }
    if(galleryClear){ galleryClear.onclick = ()=>{ try{ if(galleryFilterCategory) galleryFilterCategory.value=''; if(galleryFilterMonth) galleryFilterMonth.value=''; if(gallerySearch) gallerySearch.value=''; renderGallery(); }catch(e){} } }
    if(galleryFilterCategory) galleryFilterCategory.onchange = renderGallery;
    if(galleryFilterMonth) galleryFilterMonth.onchange = ()=>{ renderGallery(); renderPieChartForSelectedMonth(); };
    if(gallerySearch) gallerySearch.oninput = debounce(()=>renderGallery(), 250);
  }catch(e){console.warn('gallery init failed', e)}

  attachFormattedInput(refs.amountInput);
  try{ attachFormattedInput(refs.budgetCatInput); }catch(e){}

    });

  </script>
</script>

  <!-- Lightbox element for full-size image preview -->
  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true">
    <img id="lightboxImg" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©" />
  </div>

  <script>
    // Lightweight lightbox: opens any image with class 'clickable-thumb' or the receipt preview
    (function(){
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightboxImg');
      function showImage(src){ if(!lb||!lbImg) return; lbImg.src = src; lb.classList.add('show'); document.documentElement.style.overflow = 'hidden'; lb.setAttribute('aria-hidden','false'); }
      function hideImage(){ if(!lb||!lbImg) return; lb.classList.remove('show'); lbImg.src = ''; document.documentElement.style.overflow = ''; lb.setAttribute('aria-hidden','true'); }

      // Delegate clicks for thumbnails and receipt preview
      document.addEventListener('click', function(e){
        const t = e.target;
        if(!t) return;
        // clickable thumbnail inside expense rows
        if(t.classList && t.classList.contains('clickable-thumb')){
          e.preventDefault(); e.stopPropagation();
          const src = t.dataset.full || t.src;
          if(src) showImage(src);
          return;
        }
        // receipt preview image by id
        if(t.id === 'receiptPreview'){
          e.preventDefault(); e.stopPropagation();
          const src = t.src;
          if(src) showImage(src);
          return;
        }
        // clicking the lightbox backdrop closes it
        if(t.id === 'lightbox'){
          hideImage();
          return;
        }
      }, false);

      // close on ESC
      document.addEventListener('keyup', function(e){ if(e.key === 'Escape') hideImage(); });

      // also close when tapping outside the image
      if(lb){ lb.addEventListener('click', function(ev){ if(ev.target === lb) hideImage(); }); }

      // Register Service Worker for PWA
      if('serviceWorker' in navigator){
        navigator.serviceWorker.register('data:application/javascript;charset=utf-8,' + encodeURIComponent(`
          self.addEventListener('install', e => {
            e.waitUntil(caches.open('v1').then(c => c.addAll(['/'])));
            self.skipWaiting();
          });
          self.addEventListener('activate', e => {
            e.waitUntil(clients.claim());
          });
          self.addEventListener('fetch', e => {
            e.respondWith(
              caches.match(e.request).then(r => r || fetch(e.request))
            );
          });
        `)).catch(e => console.log('SW registration failed:', e));
      }
    })();
  </script>

</body>
</html>
