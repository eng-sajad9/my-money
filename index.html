<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>

    /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø¯ÙŠØ± */
#tab-admin .card {
  margin-bottom: 10px;
}

.admin-user-card {
  background: var(--muted-bg);
  border-radius: 14px;
  padding: 10px;
  border: 1px solid var(--border-color);
  margin-bottom: 8px;
}

.admin-user-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 6px;
}

.admin-user-id {
  font-size: 12px;
  color: var(--subtext-color);
  word-break: break-all;
}

.admin-user-stats {
  font-size: 12px;
}

.admin-user-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}

.admin-user-actions .btn {
  font-size: 11px;
  padding: 4px 8px;
}

.admin-user-months {
  margin-top: 6px;
  border-top: 1px dashed var(--border-color);
  padding-top: 6px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.admin-month-item {
  background: var(--card-bg);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px solid var(--border-color);
}

.admin-month-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  cursor: pointer;
}

.admin-month-header span {
  display: inline-block;
}

.admin-month-expenses {
  margin-top: 4px;
  padding-top: 4px;
  border-top: 1px dashed var(--border-color);
  font-size: 11px;
}

.admin-expense-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 2px;
}

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© */
.admin-settings-card {
  background: linear-gradient(135deg, rgba(37,99,235,0.05), rgba(79,70,229,0.03));
  border: 1px solid rgba(37,99,235,0.15);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}

.admin-settings-group {
  margin-bottom: 10px;
}

.admin-settings-group:last-child {
  margin-bottom: 0;
}

.admin-settings-label {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 6px;
  color: var(--text-color);
  display: flex;
  align-items: center;
  gap: 6px;
}

.toggle-switch {
  display: inline-flex;
  width: 44px;
  height: 24px;
  border-radius: 12px;
  background: var(--muted-bg-2);
  border: 1px solid var(--border-color);
  cursor: pointer;
  align-items: center;
  padding: 2px;
  transition: background 0.2s;
}

.toggle-switch.active {
  background: #10b981;
  border-color: #059669;
}

.toggle-circle {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-switch.active .toggle-circle {
  transform: translateX(20px);
}

.password-change-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.password-input-group {
  display: flex;
  gap: 6px;
}

.password-input-group input {
  flex: 1;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 13px;
  background: var(--muted-bg);
}

.password-input-group button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  transition: 0.2s;
}

.password-input-group button:hover {
  background: var(--accent-strong);
}

.password-error {
  color: var(--danger);
  font-size: 12px;
  margin-top: -4px;
}

.password-success {
  color: var(--success);
  font-size: 12px;
  margin-top: -4px;
}

    :root {
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-color: #111827;
      --subtext-color: #6b7280;
      --border-color: #e5e7eb;
      --muted-bg: #f9fafb;
      --muted-bg-2: #e5e7eb;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --danger: #b91c1c;
      --success: #059669;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.18);
    }

    :root[data-theme="dark"] {
      --bg-color: #020617;
      --card-bg: #020617;
      --text-color: #f9fafb;
      --subtext-color: #9ca3af;
      --border-color: #1f2937;
      --muted-bg: #020617;
      --muted-bg-2: #111827;
      --accent: #3b82f6;
      --accent-strong: #60a5fa;
      --danger: #f97373;
      --success: #4ade80;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.85);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    html, body {
      height: auto;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      font-size: 15px;
    }

    /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    .login-container {
      width: 100%;
      max-width: 420px;
      border-radius: 20px;
      padding: 20px 18px 18px;
      background: radial-gradient(circle at top, #2563eb22, transparent 50%),
                  radial-gradient(circle at bottom, #22c55e22, transparent 55%),
                  var(--card-bg);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-color);
      animation: fadeInUp 0.4s ease-out;
    }

    .login-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .login-icon {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.6);
    }

    .login-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .login-title h1 {
      font-size: 22px;
      font-weight: 700;
    }

    .login-title span {
      font-size: 13px;
      color: var(--subtext-color);
    }

    .login-body {
      margin-top: 10px;
    }

    /* Loader to avoid login flash */
    .app-loader {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 14px;
    }

    .login-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .login-tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      font-weight: 600;
    }

    .login-tab-btn.active {
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: #fff;
      box-shadow: 0 6px 18px rgba(37,99,235,0.18);
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--subtext-color);
      display: block;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 8px 11px;
      font-size: 14px;
      background: var(--muted-bg);
      color: var(--text-color);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--card-bg);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .password-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-toggle-pw {
      border-radius: 999px;
      border: 1px solid var(--border-color);
      font-size: 11px;
      padding: 5px 9px;
      background: var(--muted-bg);
      cursor: pointer;
      color: var(--subtext-color);
    }

    .login-footer {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: 0.15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.5);
    }

    .btn-outline {
      background: transparent;
      color: var(--accent-strong);
      border: 1px solid var(--border-color);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .login-error {
      min-height: 18px;
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    .login-small-note {
      font-size: 11px;
      color: var(--subtext-color);
      margin-top: 4px;
    }

    /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    .app-container {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      padding: 16px;
      border: 1px solid var(--border-color);
      display: none;
      animation: fadeInUp 0.4s ease-out;
      overflow: visible !important;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    header h2 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h2 span.icon {
      font-size: 22px;
    }

    .header-sub {
      font-size: 12px;
      color: var(--subtext-color);
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    @media (min-width: 420px) {
      .header-actions {
        flex-direction: row;
        align-items: center;
      }
    }

    .user-label {
      font-size: 11px;
      color: var(--subtext-color);
    }

    /* ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--muted-bg-2);
      border-radius: 999px;
      padding: 4px;
      margin: 10px 0 14px;
    }

    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 7px 0;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: var(--subtext-color);
    }

    .tab-btn.active {
      background: var(--card-bg);
      color: var(--text-color);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± */
    .month-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .month-select {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      font-size: 13px;
      background: var(--muted-bg);
      color: var(--text-color);
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª */
    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .card-header h3 {
      font-size: 14px;
      font-weight: 600;
    }

    /* Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø± */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 6px;
    }

    .summary-item {
      background: var(--muted-bg);
      border-radius: 12px;
      padding: 7px 8px;
      text-align: center;
    }

    .summary-label {
      font-size: 12px;
      color: var(--subtext-color);
    }

    .summary-value {
      font-size: 14px;
      font-weight: 700;
      margin-top: 3px;
    }

    .summary-value.positive {
      color: var(--success);
    }

    .summary-value.negative {
      color: var(--danger);
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ */
    .expense-list {
      max-height: none !important;
      overflow: visible !important;
      padding-right: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .expense-item {
      padding: 14px 10px;
      border-radius: 12px;
      background: var(--muted-bg);
      border: 1px solid #174599;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .expense-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .expense-title {
      font-size: 14px;
      font-weight: 600;
    }

    .expense-meta {
      font-size: 12px;
      color: var(--subtext-color);
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .expense-note {
      font-size: 12px;
      color: var(--text-color);
    }

    .expense-amount {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      background: rgba(37, 99, 235, 0.08);
      color: #2563eb;
      padding: 6px 10px;
      border-radius: 0 8px 8px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: auto;
      text-align: center;
      box-shadow: none;
      border: 1px solid rgba(37, 99, 235, 0.15);
      border-left: none;
      flex-shrink: 0;
    }

    .expense-amount-container {
      display: flex;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: none;
    }

    .expense-amount-badge {
      font-size: 16px;
      padding: 6px 7px;
      background: rgba(37, 99, 235, 0.06);
      border-radius: 8px 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(37, 99, 235, 0.12);
      border-right: none;
      backdrop-filter: none;
    }

    /* Dark mode Ù„Ù„Ø³Ø¹Ø± */
    [data-theme="dark"] .expense-amount-badge {
      background: rgba(96, 165, 250, 0.08);
      border-color: rgba(96, 165, 250, 0.15);
    }

    [data-theme="dark"] .expense-amount {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
      box-shadow: none;
      border-color: rgba(96, 165, 250, 0.2);
    }

    [data-theme="dark"] .expense-amount-container {
      box-shadow: none;
    }

    .expense-image-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }

    .expense-thumb {
      margin-top: 6px;
      max-height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      object-fit: cover;
      cursor: pointer;
    }

    .expense-actions {
      display: flex;
      gap: 4px;
      margin-top: 3px;
      flex-wrap: wrap;
    }

    /* Ø²Ø± Ø¹Ø§Ù… */
    .btn-ghost {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.15s ease-in-out;
      background: rgba(0, 0, 0, 0.03);
      border: 1px solid var(--border-color);
    }

    /* Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
    .btn-edit {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.06);
      border-color: rgba(37, 99, 235, 0.25);
    }

    .btn-edit:hover {
      background: rgba(37, 99, 235, 0.15);
      border-color: rgba(37, 99, 235, 0.4);
    }

    /* Ø²Ø± Ø§Ù„Ø­Ø°Ù */
    .btn-delete {
      color: #b91c1c;
      background: rgba(185, 28, 28, 0.06);
      border-color: rgba(185, 28, 28, 0.25);
    }

    .btn-delete:hover {
      background: rgba(185, 28, 28, 0.15);
      border-color: rgba(185, 28, 28, 0.4);
    }

    .btn-ghost:hover {
      background: var(--muted-bg);
    }

    /* Ù…ÙˆØ¯Ø§Ù„Ø§Øª */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: var(--card-bg);
      width: 100%;
      max-width: 520px;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      animation: fadeInUp 0.25s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-header h3 {
      font-size: 15px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .image-modal {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 20px;
      padding: 8px;
      background: #000;
      border: none;
    }

    .image-modal img {
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: 0 auto;
      border-radius: 16px;
    }

    /* Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø± */
    .compare-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .compare-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .compare-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .compare-bar-bg {
      background: var(--muted-bg-2);
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
    }

    .compare-bar-fill {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      width: 0%;
      transition: width 0.3s;
    }

    /* Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .compare-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card-bg));
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 22px rgba(15,23,42,0.06);
    }
    .compare-card:hover {
      transform: translateY(-4px);
      transition: transform 0.18s ease;
      box-shadow: 0 18px 36px rgba(15,23,42,0.08);
    }

    .compare-row {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .stacked-bar {
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      gap: 1px;
      background: var(--muted-bg-2);
      margin-top: 8px;
    }

    .stacked-seg {
      height: 100%;
      transition: width 0.35s ease;
    }

    .compare-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--subtext-color);
    }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    .compare-table th,
    .compare-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    .compare-table th {
      background: var(--muted-bg);
      font-weight: 700;
      font-size: 12px;
    }

    .category-legend {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .legend-item {
      padding: 6px 8px;
      border-radius: 999px;
      background: var(--muted-bg);
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    @media (min-width: 760px) {
      .compare-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1100px) {
      .compare-grid { grid-template-columns: repeat(3, 1fr); }
    }

    .empty-state {
      font-size: 12px;
      color: var(--subtext-color);
      text-align: center;
      padding: 12px 6px;
    }

    /* ÙÙ„ØªØ±Ø© */
    .filter-row {
      display: flex;
      gap: 6px;
      margin: 6px 0;
      flex-wrap: wrap;
    }

    .filter-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 4px;
    }

    .filter-toggle input {
      transform: scale(0.9);
    }

    .form-input-sm,
    .form-select-sm {
      padding: 6px 9px;
      font-size: 12px;
      border-radius: 999px;
    }

    .filter-summary {
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 4px;
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© (Ø·ÙŠ/ÙØªØ­) */
    .collapse-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
    }

    .collapse-body.open {
      max-height: 500px;
    }

    .collapse-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .collapse-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 11px;
    }

    .collapse-icon.open {
      transform: rotate(180deg);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 6px;
    }

    .stats-item {
      background: var(--muted-bg);
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 12px;
    }

    .stats-item-title {
      color: var(--subtext-color);
      margin-bottom: 3px;
    }

    .stats-item-value {
      font-weight: 600;
    }

    .category-bars {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .category-bar {
      font-size: 11px;
    }

    .category-bar-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .category-bar-bg {
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--muted-bg-2);
    }

    .category-bar-fill {
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #4f46e5, #2563eb);
      width: 0%;
      transition: width 0.3s;
    }

    /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª */
    .category-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--muted-bg), rgba(37, 99, 235, 0.05));
      border: 1px solid rgba(37, 99, 235, 0.15);
      font-size: 13px;
      margin: 4px;
      user-select: none;
      transition: 0.15s ease;
    }

    .category-chip:hover {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.1));
      border-color: rgba(37, 99, 235, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    }

    .category-chip.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .category-chip-controls {
      display: flex;
      gap: 3px;
      align-items: center;
    }

    .category-chip button {
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
      color: var(--subtext-color);
      padding: 2px 4px;
      border-radius: 4px;
      transition: 0.1s;
    }

    .category-chip button:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent);
    }

    #categoryList {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Admin) */
    .admin-info {
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 8px;
    }

    .admin-users-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .admin-user-card {
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 10px;
      background: var(--muted-bg);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .admin-user-main {
      font-size: 12px;
    }

    .admin-user-uid {
      font-size: 11px;
      color: var(--subtext-color);
      word-break: break-all;
    }

    .admin-user-email {
      font-size: 12px;
      font-weight: 600;
    }

    .admin-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
    }

    .admin-badge-active {
      background: rgba(34, 197, 94, 0.12);
      color: #15803d;
      border-color: rgba(34, 197, 94, 0.35);
    }

    .admin-badge-disabled {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.4);
    }

    .admin-badge-admin {
      background: rgba(37, 99, 235, 0.07);
      color: #1d4ed8;
      border-color: rgba(37, 99, 235, 0.3);
    }

    .admin-user-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .admin-stat-line {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .admin-stat-label {
      color: var(--subtext-color);
    }

    .admin-stat-value {
      font-weight: 600;
    }

    .admin-user-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-danger-soft {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.35);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-danger-soft:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    .btn-soft {
      background: rgba(37, 99, 235, 0.05);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.25);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-soft:hover {
      background: rgba(37, 99, 235, 0.12);
    }

    .admin-note {
      font-size: 11px;
      color: var(--subtext-color);
      margin-top: 6px;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-6px); }
    }

    .fade-out {
      animation: fadeOut 280ms ease-out forwards;
    }

    .fade-in {
      animation: fadeInUp 280ms ease-out forwards;
    }

    /* login processing bar */
    .login-processing-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(37,99,235,0.03));
      color: #1e40af;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(2,6,23,0.06);
    }

    .processing-spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(30,64,175,0.18);
      border-top-color: #1e40af;
      animation: spin 800ms linear infinite;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    @media (max-width: 360px) {
      header h2 { font-size: 18px; }
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .stats-grid { grid-template-columns: 1fr; }
      .admin-user-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Ù„ÙˆØ¯Ø± ØªØ­Ù…ÙŠÙ„ (ÙŠØ¸Ù‡Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <div id="appLoader" class="app-loader">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„...</div>

  <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginView" class="login-container" style="display:none;">
    <div class="login-header">
      <div class="login-icon">ğŸ’¸</div>
      <div class="login-title">
        <h1>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h1>
        <span>Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ØµØ§Ø±ÙŠÙÙƒ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².</span>
      </div>
    </div>
    <div class="login-body">
      <div class="login-tabs">
        <button id="tabLogin" class="login-tab-btn active">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
        <button id="tabRegister" class="login-tab-btn">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
      </div>

      <!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="loginEmail" type="email" class="form-input" placeholder="Email" />
        </div>
        <div class="form-group">
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <div class="password-row">
            <input id="loginPassword" type="password" class="form-input" placeholder="password" />
            <button id="btnTogglePwLogin" class="btn-toggle-pw">ğŸ‘ï¸</button>
          </div>
        </div>
        <div id="authError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnLogin" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
          <div class="login-small-note">
            ÙŠØ¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†ØªØŒ ÙˆÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø­Ø§Ø¨Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ù†Øª.
          </div>
        </div>
        <div id="loginProcessingBar" class="login-processing-bar" role="status" aria-live="polite">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div>Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...</div>
        </div>
      </div>

      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <div id="registerForm" style="display:none;">
        <div class="form-group">
          <label class="form-label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="registerEmail" type="email" class="form-input" placeholder="example@mail.com" />
        </div>
        <div class="form-group">
          <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <div class="password-row">
            <input id="registerPassword" type="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
            <button id="btnTogglePwReg" class="btn-toggle-pw">ğŸ‘ï¸</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
          <input id="registerPasswordConfirm" type="password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
        </div>
        <div id="registerError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnRegister" class="btn btn-outline">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          <button id="btnCancelRegister" class="btn btn-ghost">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <div id="appView" class="app-container">
    <header>
      <div class="header-left">
        <h2><span class="icon">ğŸ“Š</span>Ù…ØµØ±ÙˆÙØ§ØªÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h2>
        <div class="header-sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù…Ø¹ ÙØµÙ„ ÙƒØ§Ù…Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ø´Ù‡Ø±.</div>
      </div>
      <div class="header-actions">
        <span id="userEmailLabel" class="user-label"></span>
        <button id="btnChangePasswordQuick" class="btn btn-outline btn-sm">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
        <button id="btnToggleTheme" class="btn btn-outline btn-sm">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</button>
        <button id="btnLogout" class="btn btn-outline btn-sm">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="month">Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
      <button class="tab-btn" data-tab="compare">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</button>
      <button id="adminTabBtn" class="tab-btn" data-tab="admin" style="display:none;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
    </div>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± -->
    <div class="month-row">
      <select id="monthSelect" class="month-select"></select>
      <button id="btnEditMonth" class="btn btn-outline btn-sm">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø±</button>
      <button id="btnAddMonth" class="btn btn-primary btn-sm">+ Ø´Ù‡Ø±</button>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ -->
    <div id="tab-month">
      <!-- Ù…Ù„Ø®Øµ -->
      <div class="card">
        <div class="card-header">
          <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±</h3>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">Ø§Ù„Ø±Ø§ØªØ¨</div>
            <div id="summarySalary" class="summary-value">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</div>
            <div id="summaryExpenses" class="summary-value negative">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div id="summaryRemaining" class="summary-value positive">0</div>
          </div>
        </div>
      </div>

      <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© -->
      <div class="card">
        <div class="card-header">
          <div class="collapse-toggle" id="advancedStatsToggle">
            <span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ù„Ù„Ø´Ù‡Ø±</span>
            <span id="advancedStatsIcon" class="collapse-icon">â–¼</span>
          </div>
        </div>
        <div id="advancedStatsBody" class="collapse-body">
          <div class="stats-grid">
            <div class="stats-item">
              <div class="stats-item-title">Ù…ØªÙˆØ³Ø· Ø§Ù„ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
              <div id="statDailyAvg" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„ÙƒÙ„ ÙŠÙˆÙ…</div>
              <div id="statRemainingPerDay" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">Ø£ÙƒØ¨Ø± Ù…ØµØ±ÙˆÙ</div>
              <div id="statMaxExpense" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">Ø£ÙƒØ«Ø± ØªØµÙ†ÙŠÙ ØµØ±ÙÙ‹Ø§</div>
              <div id="statTopCategory" class="stats-item-value">Ù„Ø§ ÙŠÙˆØ¬Ø¯</div>
            </div>
          </div>
          <div class="category-bars" id="categoryBars"></div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ -->
      <div class="card">
        <div class="card-header">
          <h3>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
          <button id="btnAddExpense" class="btn btn-primary btn-sm">+ Ù…ØµØ±ÙˆÙ</button>
        </div>
        <div class="filter-row">
          <input
            id="searchInput"
            type="text"
            class="form-input form-input-sm"
            placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ØµØ±ÙˆÙ (Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø©)"
          />
          <select id="filterCategory" class="form-select form-select-sm">
            <option value="all">ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</option>
          </select>
        </div>
        <label class="filter-toggle">
          <input type="checkbox" id="filterHasImage" />
          Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØµÙˆØ±Ø© ÙÙ‚Ø·
        </label>
        <div id="filterSummary" class="filter-summary"></div>
        <div id="expenseList" class="expense-list"></div>
      </div>

      <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
      <div class="card">
        <div class="card-header">
          <h3>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
        </div>
        <div class="form-group" style="margin-bottom:6px;">
          <div style="display:flex; gap:6px;">
            <input
              id="newCategoryInput"
              type="text"
              class="form-input form-input-sm"
              placeholder="Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯ (Ù…Ø«Ø§Ù„: Ù‚Ù‡ÙˆØ©)"
            />
            <button id="btnAddCategory" class="btn btn-outline btn-sm">+ Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>
        <div id="categoryList"></div>
      </div>
    </div>

    <!-- ØªØ¨ÙˆÙŠØ¨ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø± -->
    <div id="tab-compare" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø£Ø´Ù‡Ø±</h3>
        </div>
        <div id="compareContainer" class="compare-row"></div>
      </div>
    </div>

 <!-- ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·) -->
<div id="tab-admin" style="display:none;">

  <div class="card">
    <div class="card-header">
      <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
      <button id="btnAdminRefresh" class="btn btn-outline btn-sm">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <div id="adminNote" class="login-small-note">
      ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ù…Ø´Ø§Ù‡Ø¯Ø© Ù…Ù„Ø®Øµ Ø±ÙˆØ§ØªØ¨ ÙˆÙ…ØµØ§Ø±ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±.<br>
      <strong>Ù…Ù‡Ù…:</strong> Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ±.
    </div>
  </div>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© -->
  <div class="card">
    <div class="card-header">
      <h3>ğŸ”§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©</h3>
    </div>

    <!-- Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <div class="admin-settings-card">
      <div class="admin-settings-group">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label class="admin-settings-label">
            ğŸ“‹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
          </label>
          <button id="btnToggleRegistration" class="toggle-switch active">
            <div class="toggle-circle"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="adminUsersContainer" class="admin-users-container"></div>

  <div class="admin-note">
    âš ï¸ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„Ù‡Ù…ØŒ Ù„ÙƒÙ† Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ù‡Ù… Ù…Ù† Firebase Auth.
  </div>

</div>
  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø± -->
  <div id="modalMonth" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalMonthTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ù‡Ø±</h3>
        <button id="btnCloseMonth" class="btn btn-outline btn-sm">âœ•</button>
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø´Ù‡Ø±</label>
        <select id="monthInput" class="form-select">
          <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
          <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
          <option value="3">Ù…Ø§Ø±Ø³</option>
          <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
          <option value="5">Ù…Ø§ÙŠÙˆ</option>
          <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
          <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
          <option value="8">Ø£ØºØ³Ø·Ø³</option>
          <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
          <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
          <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
          <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø³Ù†Ø©</label>
        <input id="yearInput" type="number" inputmode="numeric" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label>
        <input
          id="salaryInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="Ù…Ø«Ø§Ù„: 1.000.000"
        />
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteMonthBtn" class="btn btn-outline btn-sm" style="display:none;">
          ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelMonth">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="saveMonthBtn" class="btn btn-primary">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ -->
  <div id="modalExpense" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="expenseModalTitle">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
        <button id="btnCloseExpense" class="btn btn-outline btn-sm">âœ•</button>
      </div>
      <div class="form-group">
        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
        <input
          id="expenseTitleInput"
          type="text"
          class="form-input"
          placeholder="Ù…Ø«Ø§Ù„: ØºØ¯Ø§Ø¡ØŒ Ø¨Ù†Ø²ÙŠÙ†ØŒ Ø´Ø±Ø§Ø¡ ÙƒØªØ§Ø¨"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ù…Ø¨Ù„Øº</label>
        <input
          id="expenseAmountInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="Ù…Ø«Ø§Ù„: 25.000"
        />
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„ØªØµÙ†ÙŠÙ</label>
        <select id="expenseCategoryInput" class="form-select"></select>
        <div id="categoryError" style="color: var(--danger); font-size: 12px; margin-top: 3px; display: none;">âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙÙ‹Ø§</div>
      </div>
      <div class="form-group">
        <label class="form-label">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="expenseDateInput" type="date" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea
          id="expenseNoteInput"
          class="form-textarea"
          placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª"
        ></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="expenseImageInput" type="file" accept="image/*" class="form-input" />
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteExpenseBtn" class="btn btn-outline btn-sm" style="display:none;">
          ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelExpense">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="saveExpenseBtn" class="btn btn-primary">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© -->
  <div id="modalImage" class="modal-backdrop">
    <div class="modal image-modal">
      <img id="imageModalView" src="" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ" />
    </div>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± -->
  <div id="modalPassword" class="modal-backdrop" style="display:none;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</h3>
        <button id="btnClosePassword" class="btn btn-outline btn-sm">âœ•</button>
      </div>
      <div class="form-group">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
        <input 
          id="modalCurrentPassword" 
          type="password" 
          class="form-input" 
          placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <input 
          id="modalNewPassword" 
          type="password" 
          class="form-input" 
          placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <input 
          id="modalConfirmPassword" 
          type="password" 
          class="form-input" 
          placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"
        />
      </div>
      <div id="modalPasswordMessage" style="font-size: 13px; margin-bottom: 12px; min-height: 18px;"></div>
      <button id="btnModalChangePassword" class="btn btn-primary" style="width: 100%;">
        âœ“ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
      </button>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ + Firebase -->
  <script type="module">
    /* âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø£Ù…Ø§Ù†:
     * - ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø© ÙÙŠ localStorage (Ù…Ø­Ù…ÙŠ Ø¨Ø±Ù‚Ù… UID Ø§Ù„ÙØ±ÙŠØ¯)
     * - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ù…Ø³Ø§Ø± users/{uid}/state (Ù…Ø­Ù…ÙŠ Ø¨Ù€ UID)
     * - ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
     * - ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚ Firebase Security Rules Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
     */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
  getDatabase,
  ref,
  set,
  get,
  remove,
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
     
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
      authDomain: "mony-ecb81.firebaseapp.com",
      databaseURL: "https://mony-ecb81-default-rtdb.firebaseio.com",
      projectId: "mony-ecb81",
      storageBucket: "mony-ecb81.firebasestorage.app",
      messagingSenderId: "1099032510981",
      appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
      measurementId: "G-PVHFMZ82XL",
    };

    const ADMIN_UID = "6Ss694f4QSOPYeM5TWnfnlxP2O32";

    let app = null;
    let db = null;
    let auth = null;
    let firebaseEnabled = false;

    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      firebaseEnabled = true;
    } catch (e) {
      console.warn("Firebase init failed:", e);
    }

    const STORAGE_KEY_PREFIX = "expense_manager_";
    const THEME_KEY = "expense_manager_theme";
    const LAST_UID_KEY = STORAGE_KEY_PREFIX + "last_uid";
    const defaultCategories = ["Ø£ÙƒÙ„", "Ù…ÙˆØ§ØµÙ„Ø§Øª", "ØªØ³ÙˆÙ‚", "ÙÙˆØ§ØªÙŠØ±", "ØªØ±ÙÙŠÙ‡", "Ø£Ø®Ø±Ù‰"];

    let state = {
      months: [],
      selectedMonthId: null,
      categories: [...defaultCategories],
    };

    let filterState = {
      search: "",
      category: "all",
      hasImageOnly: false,
    };

    let currentUser = null;
    let userRef = null;

    function getStorageKey() {
      if (currentUser && currentUser.uid) {
        return STORAGE_KEY_PREFIX + currentUser.uid;
      }
      return STORAGE_KEY_PREFIX + "guest";
    }

    const monthNames = [
      "",
      "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
      "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±",
    ];

    function formatNumber(value) {
      if (value === null || value === undefined) return "0";
      const number =
        typeof value === "number"
          ? value
          : parseInt(String(value).replace(/\D/g, "")) || 0;
      return number.toLocaleString("en-US");
    }

    function parseFormattedNumber(str) {
      if (!str) return 0;
      const digits = str.replace(/\D/g, "");
      return parseInt(digits || "0", 10);
    }

    function generateMonthId(year, month) {
      return `${year}-${String(month).padStart(2, "0")}`;
    }

    function normalizeState(raw) {
      let s = raw && typeof raw === "object" ? raw : {};
      if (!Array.isArray(s.months)) s.months = [];
      if (!Array.isArray(s.categories)) s.categories = [...defaultCategories];
      if (s.categories.length === 0) s.categories = [...defaultCategories];
      if (typeof s.selectedMonthId !== "string") s.selectedMonthId = null;

      s.months.forEach((m) => {
        if (!Array.isArray(m.expenses)) m.expenses = [];
        m.year = parseInt(m.year) || new Date().getFullYear();
        m.month = parseInt(m.month) || 1;
        m.name = monthNames[m.month] || m.name || "";
        m.salary = parseInt(m.salary) || 0;
        m.id = m.id || generateMonthId(m.year, m.month);
      });

      if (s.months.length === 0) {
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const id = generateMonthId(year, month);
        s.months.push({
          id,
          year,
          month,
          name: monthNames[month],
          salary: 0,
          expenses: [],
        });
        s.selectedMonthId = id;
      } else {
        if (!s.months.find((m) => m.id === s.selectedMonthId)) {
          s.selectedMonthId = s.months[s.months.length - 1].id;
        }
      }

      return s;
    }

    function getSelectedMonth() {
      return state.months.find((m) => m.id === state.selectedMonthId) || null;
    }

    function saveStateLocal() {
      const key = getStorageKey();
      localStorage.setItem(key, JSON.stringify(state));
    }

    async function saveStateRemote() {
      if (!firebaseEnabled || !currentUser || !userRef) return;
      try {
        await set(userRef, state);
      } catch (e) {
        console.warn("Failed to sync with Firebase:", e);
      }
    }

    async function saveState() {
      saveStateLocal();
      await saveStateRemote();
    }

    function loadStateLocal() {
      const key = getStorageKey();
      const raw = localStorage.getItem(key);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state = normalizeState(data);
      } catch (e) {
        console.error("Failed to parse local state:", e);
      }
    }

    async function loadStateRemoteIfExists() {
      if (!firebaseEnabled || !currentUser || !userRef) return;
      try {
        const snap = await get(userRef);
        if (snap.exists()) {
          const remoteState = normalizeState(snap.val());
          state = remoteState;
        } else {
          await set(userRef, state);
        }
      } catch (e) {
        console.warn("Failed to load from Firebase:", e);
      }
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      root.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      const btn = document.getElementById("btnToggleTheme");
      if (btn) btn.textContent = theme === "dark" ? "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­" : "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
    }

    /* ======= Ø¹Ù†Ø§ØµØ± DOM ======= */

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const appLoader = document.getElementById("appLoader");
    const authErrorEl = document.getElementById("authError");

    // Login form elements
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnTogglePwLogin = document.getElementById("btnTogglePwLogin");

    // Register form elements
    const registerEmailInput = document.getElementById("registerEmail");
    const registerPasswordInput = document.getElementById("registerPassword");
    const registerPasswordConfirmInput = document.getElementById("registerPasswordConfirm");
    const btnRegister = document.getElementById("btnRegister");
    const registerErrorEl = document.getElementById("registerError");
    const btnCancelRegister = document.getElementById("btnCancelRegister");

    const userEmailLabel = document.getElementById("userEmailLabel");
    const btnLogout = document.getElementById("btnLogout");
    const btnToggleTheme = document.getElementById("btnToggleTheme");

    const tabButtons = document.querySelectorAll(".tab-btn");
const tabMonth = document.getElementById("tab-month");
const tabCompare = document.getElementById("tab-compare");
const tabAdminBtn = document.getElementById("tabAdminBtn");

const adminUsersContainer = document.getElementById("adminUsersContainer");
const adminNoteEl = document.getElementById("adminNote");
const btnAdminRefresh = document.getElementById("btnAdminRefresh");
const btnToggleRegistration = document.getElementById("btnToggleRegistration");
const registrationStatusEl = document.getElementById("registrationStatus");
const btnChangePasswordQuick = document.getElementById("btnChangePasswordQuick");
const modalPassword = document.getElementById("modalPassword");
const btnClosePassword = document.getElementById("btnClosePassword");
const btnModalChangePassword = document.getElementById("btnModalChangePassword");
const modalCurrentPassword = document.getElementById("modalCurrentPassword");
const modalNewPassword = document.getElementById("modalNewPassword");
const modalConfirmPassword = document.getElementById("modalConfirmPassword");
const modalPasswordMessage = document.getElementById("modalPasswordMessage");

    const tabAdmin = document.getElementById("tab-admin");
    const adminTabBtn = document.getElementById("adminTabBtn");

    const monthSelect = document.getElementById("monthSelect");
    const btnAddMonth = document.getElementById("btnAddMonth");
    const btnEditMonth = document.getElementById("btnEditMonth");

    const summarySalaryEl = document.getElementById("summarySalary");
    const summaryExpensesEl = document.getElementById("summaryExpenses");
    const summaryRemainingEl = document.getElementById("summaryRemaining");

    const advancedStatsToggle = document.getElementById("advancedStatsToggle");
    const advancedStatsIcon = document.getElementById("advancedStatsIcon");
    const advancedStatsBody = document.getElementById("advancedStatsBody");
    const dailyAvgEl = document.getElementById("statDailyAvg");
    const remainingPerDayEl = document.getElementById("statRemainingPerDay");
    const maxExpenseEl = document.getElementById("statMaxExpense");
    const topCategoryEl = document.getElementById("statTopCategory");
    const categoryBars = document.getElementById("categoryBars");

    const btnAddExpense = document.getElementById("btnAddExpense");
    const expenseList = document.getElementById("expenseList");
    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterHasImage = document.getElementById("filterHasImage");
    const filterSummaryEl = document.getElementById("filterSummary");

    const newCategoryInput = document.getElementById("newCategoryInput");
    const btnAddCategory = document.getElementById("btnAddCategory");
    const categoryList = document.getElementById("categoryList");

    const modalMonth = document.getElementById("modalMonth");
    const modalMonthTitle = document.getElementById("modalMonthTitle");
    const monthInput = document.getElementById("monthInput");
    const yearInput = document.getElementById("yearInput");
    const salaryInput = document.getElementById("salaryInput");
    const deleteMonthBtn = document.getElementById("deleteMonthBtn");
    const saveMonthBtn = document.getElementById("saveMonthBtn");
    const btnCancelMonth = document.getElementById("btnCancelMonth");
    const btnCloseMonth = document.getElementById("btnCloseMonth");

    const modalExpense = document.getElementById("modalExpense");
    const expenseModalTitle = document.getElementById("expenseModalTitle");
    const expenseTitleInput = document.getElementById("expenseTitleInput");
    const expenseAmountInput = document.getElementById("expenseAmountInput");
    const expenseCategoryInput = document.getElementById("expenseCategoryInput");
    const expenseDateInput = document.getElementById("expenseDateInput");
    const expenseNoteInput = document.getElementById("expenseNoteInput");
    const expenseImageInput = document.getElementById("expenseImageInput");
    const deleteExpenseBtn = document.getElementById("deleteExpenseBtn");
    const saveExpenseBtn = document.getElementById("saveExpenseBtn");
    const btnCancelExpense = document.getElementById("btnCancelExpense");
    const btnCloseExpense = document.getElementById("btnCloseExpense");

    const modalImage = document.getElementById("modalImage");
    const imageModalView = document.getElementById("imageModalView");

    const compareContainer = document.getElementById("compareContainer");
    const monthRow = document.querySelector(".month-row");

    let editingMonthId = null;
    let editingExpenseId = null;

    /* ======= ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù†Ù…Ø§Ø°Ø¬ Ù…Ù†ÙØµÙ„Ø©) ======= */

    const tabLoginBtn = document.getElementById("tabLogin");
    const tabRegisterBtn = document.getElementById("tabRegister");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    function switchToLogin() {
      tabLoginBtn.classList.add("active");
      tabRegisterBtn.classList.remove("active");
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    function switchToRegister() {
      tabLoginBtn.classList.remove("active");
      tabRegisterBtn.classList.add("active");
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    tabLoginBtn.addEventListener("click", switchToLogin);
    tabRegisterBtn.addEventListener("click", switchToRegister);
    btnCancelRegister.addEventListener("click", (e) => {
      e.preventDefault();
      switchToLogin();
    });

    // Toggle password visibility
    if (btnTogglePwLogin) {
      btnTogglePwLogin.addEventListener("click", () => {
        const isPassword = loginPasswordInput.type === "password";
        loginPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwLogin.textContent = isPassword ? "ğŸ™ˆ" : "ğŸ‘ï¸";
      });
    }
    const btnTogglePwReg = document.getElementById("btnTogglePwReg");
    if (btnTogglePwReg) {
      btnTogglePwReg.addEventListener("click", () => {
        const isPassword = registerPasswordInput.type === "password";
        registerPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwReg.textContent = isPassword ? "ğŸ™ˆ" : "ğŸ‘ï¸";
      });
    }

    btnRegister.addEventListener("click", async () => {
      registerErrorEl.textContent = "";
      const email = (registerEmailInput.value || "").trim();
      const password = (registerPasswordInput.value || "").trim();
      const confirm = (registerPasswordConfirmInput.value || "").trim();
      if (!email || !password) {
        registerErrorEl.textContent = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";
        return;
      }
      if (password !== confirm) {
        registerErrorEl.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†.";
        return;
      }
      if (!firebaseEnabled || !auth) {
        registerErrorEl.textContent = "ÙŠØªØ·Ù„Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø´Ø¨ÙƒØ©.";
        return;
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      try {
        if (firebaseEnabled && db) {
          const statusRef = ref(db, "settings/registrationEnabled");
          const snap = await get(statusRef);
          const isEnabled = snap.exists() ? snap.val() : true;
          if (!isEnabled) {
            registerErrorEl.textContent = "âœ— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹Ø·Ù‘Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„.";
            return;
          }
        }
      } catch (err) {
        console.error("Error checking registration status:", err);
        // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
      }

      try {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = result.user;
        userRef = ref(db, "users/" + currentUser.uid + "/state");
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        await saveStateRemote();
        if (firebaseEnabled && db) {
          try {
            await set(ref(db, "users/" + currentUser.uid + "/profile"), {
              email: currentUser.email || email,
            });
          } catch (e) {
            console.warn("Failed to save user profile:", e);
          }
        }
        registerPasswordInput.value = "";
        registerPasswordConfirmInput.value = "";
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}
        try { localStorage.setItem(STORAGE_KEY_PREFIX + currentUser.uid + "_profile", JSON.stringify({ email: currentUser.email || "" })); } catch (e) {}
      } catch (e) {
        console.error(e);
        registerErrorEl.textContent = "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";
      }
    });

    btnLogin.addEventListener("click", async () => {
      authErrorEl.textContent = "";
      const email = (loginEmailInput.value || "").trim();
      const password = (loginPasswordInput.value || "").trim();
      if (!email || !password) {
        authErrorEl.textContent = "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";
        return;
      }

      const loginProcessingBar = document.getElementById("loginProcessingBar");
      try {
        // show processing UI
        if (loginProcessingBar) {
          loginProcessingBar.style.display = "flex";
          loginProcessingBar.classList.remove("fade-out");
          loginProcessingBar.classList.add("fade-in");
        }
        btnLogin.disabled = true;

        await signInWithEmailAndPassword(auth, email, password);
        loginPasswordInput.value = "";
      } catch (e) {
        console.error(e);
        authErrorEl.textContent = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£.";
      } finally {
        // hide processing UI
        if (loginProcessingBar) {
          loginProcessingBar.classList.remove("fade-in");
          loginProcessingBar.classList.add("fade-out");
          setTimeout(() => {
            if (loginProcessingBar) {
              loginProcessingBar.style.display = "none";
              loginProcessingBar.classList.remove("fade-out");
            }
          }, 320);
        }
        btnLogin.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        filterState = {
          search: "",
          category: "all",
          hasImageOnly: false,
        };
        currentUser = null;
        userRef = null;

        try { localStorage.removeItem(LAST_UID_KEY); } catch (e) {}

        await signOut(auth);
      } catch (e) {
        console.error(e);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬.");
      }
    });

    /* ======= ØªØ¨ÙˆÙŠØ¨Ø§Øª ======= */

   /* ======= ØªØ¨ÙˆÙŠØ¨Ø§Øª ======= */

tabButtons.forEach((btn) => {
  btn.addEventListener("click", async () => {
    tabButtons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    if (tab === "month") {
      tabMonth.style.display = "block";
      tabCompare.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "flex";
    } else if (tab === "compare") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "block";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "none";
    } else if (tab === "admin") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "block";
      if (monthRow) monthRow.style.display = "none";

      // Ø¹Ù†Ø¯ ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…ØŒ Ø­Ù…Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      await loadAdminUsers();
    }
  });
});


    /* ======= Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…ØªÙ‚Ø¯Ù…Ø© Ø·ÙŠ/ÙØªØ­ ======= */

    advancedStatsToggle.addEventListener("click", () => {
      const isOpen = advancedStatsBody.classList.contains("open");
      if (isOpen) {
        advancedStatsBody.classList.remove("open");
        advancedStatsIcon.classList.remove("open");
      } else {
        advancedStatsBody.classList.add("open");
        advancedStatsIcon.classList.add("open");
      }
    });

    function refreshMonthSelect() {
      monthSelect.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø±";
        monthSelect.appendChild(option);
        monthSelect.disabled = true;
        return;
      }
      monthSelect.disabled = false;
      state.months
        .slice()
        .sort((a, b) => a.year - b.year || a.month - b.month)
        .forEach((m) => {
          const option = document.createElement("option");
          option.value = m.id;
          option.textContent = `${m.name} ${m.year}`;
          monthSelect.appendChild(option);
        });
      if (!state.selectedMonthId) {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      monthSelect.value = state.selectedMonthId;
    }

    function renderSummary() {
      const month = getSelectedMonth();
      if (!month) {
        summarySalaryEl.textContent = "0";
        summaryExpensesEl.textContent = "0";
        summaryRemainingEl.textContent = "0";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const remaining = (month.salary || 0) - totalExpenses;

      summarySalaryEl.textContent = formatNumber(month.salary || 0);
      summaryExpensesEl.textContent = formatNumber(totalExpenses);
      summaryRemainingEl.textContent = formatNumber(remaining);

      summaryRemainingEl.classList.toggle("positive", remaining >= 0);
      summaryRemainingEl.classList.toggle("negative", remaining < 0);
    }

    function renderAdvancedStats() {
      const month = getSelectedMonth();
      categoryBars.innerHTML = "";
      if (!month) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
        return;
      }

      const today = new Date();
      const year = month.year;
      const monthIndex = month.month - 1;
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
      const nowMonth = today.getMonth();
      const nowYear = today.getFullYear();

      let daysPassed;
      if (nowMonth === monthIndex && nowYear === year) {
        daysPassed = today.getDate();
      } else {
        daysPassed = daysInMonth;
      }

      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const dailyAvg =
        daysPassed > 0 ? Math.round(totalExpenses / daysPassed) : totalExpenses;
      dailyAvgEl.textContent = formatNumber(dailyAvg);

      const remaining = (month.salary || 0) - totalExpenses;
      const daysRemaining =
        daysInMonth - (nowMonth === monthIndex && nowYear === year ? today.getDate() : daysInMonth);
      const remainingPerDay =
        daysRemaining > 0 ? Math.round(remaining / daysRemaining) : remaining;
      remainingPerDayEl.textContent = formatNumber(remainingPerDay);

      const maxExpense = expenses.reduce(
        (max, e) => (e.amount > max.amount ? e : max),
        expenses[0]
      );
      maxExpenseEl.textContent = `${formatNumber(maxExpense.amount || 0)} (${maxExpense.title || "Ù…ØµØ±ÙˆÙ"})`;

      const categoryTotals = {};
      expenses.forEach((e) => {
        const cat = e.category || "Ø£Ø®Ø±Ù‰";
        categoryTotals[cat] = (categoryTotals[cat] || 0) + (e.amount || 0);
      });

      let topCategory = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
      let topTotal = 0;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        if (total > topTotal) {
          topTotal = total;
          topCategory = cat;
        }
      });
      topCategoryEl.textContent = `${topCategory} (${formatNumber(topTotal)})`;

      const maxCatTotal = Math.max(...Object.values(categoryTotals)) || 1;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        const item = document.createElement("div");
        item.className = "category-bar";

        const top = document.createElement("div");
        top.className = "category-bar-top";
        const nameEl = document.createElement("span");
        nameEl.textContent = cat;
        const amountEl = document.createElement("span");
        amountEl.textContent = formatNumber(total);
        top.appendChild(nameEl);
        top.appendChild(amountEl);

        const bg = document.createElement("div");
        bg.className = "category-bar-bg";

        const fill = document.createElement("div");
        fill.className = "category-bar-fill";
        fill.style.width = (total / maxCatTotal) * 100 + "%";

        bg.appendChild(fill);
        item.appendChild(top);
        item.appendChild(bg);
        categoryBars.appendChild(item);
      });
    }

    function applyFilters(expenses) {
      const search = filterState.search.toLowerCase();
      const category = filterState.category;
      const hasImageOnly = filterState.hasImageOnly;

      return expenses.filter((e) => {
        if (category !== "all" && e.category !== category) return false;
        if (
          search &&
          !(
            (e.title || "").toLowerCase().includes(search) ||
            (e.note || "").toLowerCase().includes(search)
          )
        ) {
          return false;
        }
        if (hasImageOnly && !e.imageDataUrl) return false;
        return true;
      });
    }

    function renderExpenses() {
      const month = getSelectedMonth();
      expenseList.innerHTML = "";
      filterSummaryEl.textContent = "";

      if (!month) {
        expenseList.innerHTML =
          '<div class="empty-state">Ø£Ø¶Ù Ø´Ù‡Ø±Ù‹Ø§ Ø«Ù… Ø£Ø¶Ù Ù…ØµØ§Ø±ÙŠÙ Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ù‡Ù†Ø§.</div>';
        return;
      }

      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø¹Ø¯.</div>';
        return;
      }

      const sorted = expenses
        .slice()
        .sort((a, b) => b.id - a.id);

      const filtered = applyFilters(sorted);

      if (filtered.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¨Ø­Ø«/Ø§Ù„ÙÙ„ØªØ±Ø©.</div>';
      } else {
        filtered.forEach((e) => {
          const item = document.createElement("div");
          item.className = "expense-item";

          const main = document.createElement("div");
          main.className = "expense-main";

          const title = document.createElement("div");
          title.className = "expense-title";
          title.textContent = e.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";

          const meta = document.createElement("div");
          meta.className = "expense-meta";
          const catSpan = document.createElement("span");
          catSpan.textContent = e.category || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
          const dateSpan = document.createElement("span");
          dateSpan.textContent = e.date || "Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®";
          meta.appendChild(catSpan);
          meta.appendChild(document.createTextNode(" Â· "));
          meta.appendChild(dateSpan);

          const note = document.createElement("div");
          note.className = "expense-note";
          note.textContent = e.note || "";

          main.appendChild(title);
          main.appendChild(meta);
          if (e.note) main.appendChild(note);

          if (e.imageDataUrl) {
            const imgBadge = document.createElement("div");
            imgBadge.className = "expense-image-badge";
            imgBadge.textContent = "ğŸ“· ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©";
            main.appendChild(imgBadge);

            const img = document.createElement("img");
            img.src = e.imageDataUrl;
            img.alt = "ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ";
            img.className = "expense-thumb";
            img.addEventListener("click", () => {
              imageModalView.src = e.imageDataUrl;
              modalImage.style.display = "flex";
            });
            main.appendChild(img);
          }

          const actions = document.createElement("div");
          actions.className = "expense-actions";
          const editBtn = document.createElement("button");
          editBtn.className = "btn-ghost btn-edit";
          editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
          editBtn.addEventListener("click", () => openExpenseModal(e.id));

          const delBtn = document.createElement("button");
          delBtn.className = "btn-ghost btn-delete";
          delBtn.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù";
          delBtn.addEventListener("click", () => deleteExpense(e.id));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          main.appendChild(actions);

          const amountContainer = document.createElement("div");
          amountContainer.className = "expense-amount-container";

          const amountBadge = document.createElement("div");
          amountBadge.className = "expense-amount-badge";
          amountBadge.textContent = "ğŸ’°";

          const amount = document.createElement("div");
          amount.className = "expense-amount";
          amount.textContent = formatNumber(e.amount || 0);

          amountContainer.appendChild(amountBadge);
          amountContainer.appendChild(amount);
          item.appendChild(main);
          item.appendChild(amountContainer);
          expenseList.appendChild(item);
        });
      }

      if (filterState.category !== "all") {
        const catTotal = filtered.reduce((sum, e) => sum + (e.amount || 0), 0);
        filterSummaryEl.textContent =
          "Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙØ¦Ø© " +
          filterState.category +
          ": " +
          formatNumber(catTotal);
      }
    }
async function loadAllUsersForAdmin() {
  adminUsersContainer.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>";

  const usersSnap = await get(ref(db, "users"));
  if (!usersSnap.exists()) {
    adminUsersContainer.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>";
    return;
  }

  const users = usersSnap.val();
  adminUsersContainer.innerHTML = "";

  Object.keys(users).forEach(uid => {
    const userData = users[uid];

    const profile = userData.profile || {};
    const state = userData.state || {};
    const months = state.months || [];

    let totalExpenses = 0;
    months.forEach(m => {
      if (Array.isArray(m.expenses)) {
        m.expenses.forEach(e => totalExpenses += (e.amount || 0));
      }
    });

    const totalSalaries = months.reduce((acc, m) => acc + (m.salary || 0), 0);

    const card = document.createElement("div");
    card.className = "admin-user-card";

    card.innerHTML = `
      <h3>${profile.email || "Ø¨Ø¯ÙˆÙ† Ø¨Ø±ÙŠØ¯"}</h3>
      <p><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${uid}</p>
      <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±:</strong> ${months.length}</p>
      <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:</strong> ${formatNumber(totalSalaries)}</p>
      <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:</strong> ${formatNumber(totalExpenses)}</p>
      <p><strong>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong> ${formatNumber(totalSalaries - totalExpenses)}</p>
    `;

    adminUsersContainer.appendChild(card);
  });
}

    function renderComparison() {
      // helper: deterministic color palette for categories
      function getCategoryColor(cat, i) {
        const palette = [
          "#2563eb",
          "#4f46e5",
          "#06b6d4",
          "#10b981",
          "#f59e0b",
          "#ef4444",
          "#8b5cf6",
          "#ec4899",
          "#0ea5b3",
          "#f97316",
        ];
        if (!cat) return palette[i % palette.length];
        // simple hash to pick color for category name consistently
        let h = 0;
        for (let j = 0; j < cat.length; j++) h = (h << 5) - h + cat.charCodeAt(j);
        const idx = Math.abs(h) % palette.length;
        return palette[idx];
      }

      compareContainer.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        compareContainer.innerHTML =
          '<div class="empty-state">Ø£Ø¶Ù Ø´Ù‡Ø±Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©.</div>';
        return;
      }

      const monthsSorted = state.months
        .slice()
        .sort((a, b) => b.year - a.year || b.month - a.month);

      // collect category list across months
      const allCategories = new Set();
      monthsSorted.forEach((m) => {
        (m.expenses || []).forEach((e) => allCategories.add(e.category || "Ø£Ø®Ø±Ù‰"));
      });
      const categories = Array.from(allCategories.length ? allCategories : state.categories);

      // totals per month and per-category
      const monthData = monthsSorted.map((m) => {
        const expenses = Array.isArray(m.expenses) ? m.expenses : [];
        const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const catTotals = {};
        categories.forEach((c) => (catTotals[c] = 0));
        expenses.forEach((e) => {
          const cat = e.category || "Ø£Ø®Ø±Ù‰";
          catTotals[cat] = (catTotals[cat] || 0) + (e.amount || 0);
        });
        return {
          id: m.id,
          label: `${m.name} ${m.year}`,
          year: m.year,
          month: m.month,
          salary: m.salary || 0,
          total,
          remaining: (m.salary || 0) - total,
          catTotals,
        };
      });

      const maxTotal = Math.max(...monthData.map((d) => d.total), 1);

      // build header summary card
      const grid = document.createElement("div");
      grid.className = "compare-grid";

      const topCard = document.createElement("div");
      topCard.className = "compare-card";
      topCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø±</h3><div class="compare-meta">` +
        `<div>Ø£Ø´Ù‡Ø±: ${monthData.length}</div>` +
        `<div>ØªØµÙ†ÙŠÙØ§Øª Ù…ÙØ­ÙˆØµØ©: ${categories.length}</div>` +
        `</div></div>`;

      // legend for categories (show top few)
      const legend = document.createElement("div");
      legend.className = "category-legend";
      categories.slice(0, 8).forEach((c, i) => {
        const li = document.createElement("div");
        li.className = "legend-item";
        const sw = document.createElement("span");
        sw.className = "legend-swatch";
        sw.style.background = getCategoryColor(c, i);
        li.appendChild(sw);
        const txt = document.createElement("span");
        txt.textContent = c;
        li.appendChild(txt);
        legend.appendChild(li);
      });
      topCard.appendChild(legend);
      grid.appendChild(topCard);

      // create a compare card per month with bar and small table of top categories
      monthData.forEach((d) => {
        const card = document.createElement("div");
        card.className = "compare-card";

        const row = document.createElement("div");
        row.className = "compare-row";

        const left = document.createElement("div");
        left.style.flex = "1";
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = d.label;
        const meta = document.createElement("div");
        meta.className = "compare-meta";
        meta.innerHTML = `Ø§Ù„Ø±Ø§ØªØ¨: ${formatNumber(d.salary)} Â· Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: ${formatNumber(d.total)} Â· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatNumber(d.remaining)}`;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.width = "140px";
        right.style.textAlign = "right";
        right.innerHTML = `<div style="font-weight:700;color:#2563eb">${formatNumber(d.total)}</div>` +
          `<div style="font-size:12px;color:var(--subtext-color)">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatNumber(d.remaining)}</div>`;

        row.appendChild(left);
        row.appendChild(right);

        // stacked bar showing category breakdown
        const stacked = document.createElement("div");
        stacked.className = "stacked-bar";
        if (d.total <= 0) {
          const emptySeg = document.createElement("div");
          emptySeg.className = "stacked-seg";
          emptySeg.style.width = "100%";
          emptySeg.style.background = "linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02))";
          stacked.appendChild(emptySeg);
        } else {
          Object.entries(d.catTotals).forEach(([cat, amt], ci) => {
            const pct = d.total > 0 ? (amt / d.total) * 100 : 0;
            const seg = document.createElement("div");
            seg.className = "stacked-seg";
            seg.style.width = pct > 0 ? pct + "%" : "0%";
            seg.style.background = getCategoryColor(cat, ci);
            seg.title = `${cat}: ${formatNumber(amt)} (${Math.round(pct)}%)`;
            stacked.appendChild(seg);
          });
        }

        card.appendChild(row);
        card.appendChild(stacked);

        // add small table of top 4 categories
        const catEntries = Object.entries(d.catTotals).sort((a, b) => b[1] - a[1]);
        const table = document.createElement("table");
        table.className = "compare-table";
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        const top4 = catEntries.slice(0, 4);
        top4.forEach(([cat, amt]) => {
          const tr = document.createElement("tr");
          const pct = maxTotal > 0 ? Math.round((amt / d.total) * 100) : 0;
          tr.innerHTML = `<td>${cat}</td><td>${formatNumber(amt)}</td><td>${pct}%</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);

        grid.appendChild(card);
      });

      compareContainer.appendChild(grid);
    }

    /* ======= Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ======= */

    function renderCategoryOptions() {
      expenseCategoryInput.innerHTML = "";
      filterCategory.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "ÙƒÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª";
      filterCategory.appendChild(allOpt);

      state.categories.forEach((cat) => {
        const opt1 = document.createElement("option");
        opt1.value = cat;
        opt1.textContent = cat;
        expenseCategoryInput.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = cat;
        opt2.textContent = cat;
        filterCategory.appendChild(opt2);
      });
    }

    function renderCategoryList() {
      categoryList.innerHTML = "";
      state.categories.forEach((cat, index) => {
        const chip = document.createElement("span");
        chip.className = "category-chip";
        chip.draggable = true;
        chip.dataset.index = index;

        const name = document.createElement("span");
        name.textContent = cat;
        name.style.flex = "1";
        chip.appendChild(name);

        const controls = document.createElement("div");
        controls.className = "category-chip-controls";

        if (index > 0) {
          const upBtn = document.createElement("button");
          upBtn.textContent = "â†‘";
          upBtn.title = "ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø¹Ù„Ù‰";
          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index - 1];
            state.categories[index - 1] = temp;
            refreshUI();
          });
          controls.appendChild(upBtn);
        }

        if (index < state.categories.length - 1) {
          const downBtn = document.createElement("button");
          downBtn.textContent = "â†“";
          downBtn.title = "ØªØ­Ø±ÙŠÙƒ Ù„Ø£Ø³ÙÙ„";
          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index + 1];
            state.categories[index + 1] = temp;
            refreshUI();
          });
          controls.appendChild(downBtn);
        }

        if (state.categories.length > 1) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "âœ•";
          delBtn.title = "Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙ";
          delBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙØŸ")) return;
            state.categories.splice(index, 1);
            refreshUI();
          });
          controls.appendChild(delBtn);
        }

        chip.appendChild(controls);

        chip.addEventListener("dragstart", (e) => {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/html", chip.innerHTML);
          chip.classList.add("dragging");
        });

        chip.addEventListener("dragend", () => {
          chip.classList.remove("dragging");
        });

        chip.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        chip.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedIndex = parseInt(
            document.querySelector(".category-chip.dragging")?.dataset.index || -1
          );
          if (draggedIndex !== -1 && draggedIndex !== index) {
            const temp = state.categories[draggedIndex];
            state.categories[draggedIndex] = state.categories[index];
            state.categories[index] = temp;
            refreshUI();
          }
        });

        categoryList.appendChild(chip);
      });
    }

    btnAddCategory.addEventListener("click", async () => {
      const name = newCategoryInput.value.trim();
      if (!name) return;
      if (state.categories.includes(name)) {
        alert("Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.");
        return;
      }
      state.categories.push(name);
      newCategoryInput.value = "";
      await refreshUI();
    });

    expenseCategoryInput.addEventListener("change", () => {
      const categoryError = document.getElementById("categoryError");
      if (expenseCategoryInput.value && expenseCategoryInput.value.trim() !== "") {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }
    });

    /* ======= Month Modal ======= */

    function openMonthModal(edit = false) {
      const now = new Date();
      const currentMonth = getSelectedMonth();
      if (edit && currentMonth) {
        editingMonthId = currentMonth.id;
        modalMonthTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø±";
        monthInput.value = String(currentMonth.month);
        yearInput.value = currentMonth.year;
        salaryInput.value = formatNumber(currentMonth.salary || 0);
        deleteMonthBtn.style.display = "inline-flex";
      } else {
        editingMonthId = null;
        modalMonthTitle.textContent = "Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯";
        monthInput.value = String(now.getMonth() + 1);
        yearInput.value = now.getFullYear();
        salaryInput.value = "";
        deleteMonthBtn.style.display = "none";
      }
      modalMonth.style.display = "flex";
    }

    function closeMonthModal() {
      modalMonth.style.display = "none";
    }

    btnAddMonth.addEventListener("click", () => openMonthModal(false));
    btnEditMonth.addEventListener("click", () => {
      if (!getSelectedMonth()) openMonthModal(false);
      else openMonthModal(true);
    });

    salaryInput.addEventListener("input", () => {
      const digits = salaryInput.value.replace(/\D/g, "");
      salaryInput.value = formatNumber(digits);
      salaryInput.selectionEnd = salaryInput.value.length;
    });

    btnCancelMonth.addEventListener("click", closeMonthModal);
    btnCloseMonth.addEventListener("click", closeMonthModal);

    deleteMonthBtn.addEventListener("click", async () => {
      if (!editingMonthId) return;
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙˆØ¬Ù…ÙŠØ¹ Ù…ØµØ§Ø±ÙŠÙÙ‡ØŸ")) return;
      const idx = state.months.findIndex((m) => m.id === editingMonthId);
      if (idx !== -1) state.months.splice(idx, 1);
      if (state.months.length === 0) {
        state.selectedMonthId = null;
      } else {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    saveMonthBtn.addEventListener("click", async () => {
      const monthNum = parseInt(monthInput.value, 10);
      const yearNum = parseInt(yearInput.value, 10);
      const salary = parseFormattedNumber(salaryInput.value);

      if (!yearNum || yearNum < 1900) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø³Ù†Ø© ØµØ­ÙŠØ­Ø©.");
        return;
      }
      if (!monthNum || monthNum < 1 || monthNum > 12) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø´Ù‡Ø±Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.");
        return;
      }

      const id = generateMonthId(yearNum, monthNum);
      const name = monthNames[monthNum];

      if (editingMonthId) {
        const existing = state.months.find((m) => m.id === editingMonthId);
        if (!existing) return;
        if (editingMonthId !== id) {
          const conflict = state.months.find((m) => m.id === id);
          if (conflict) {
            alert("ÙŠÙˆØ¬Ø¯ Ø´Ù‡Ø± Ø¨Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø§Ù„ÙØ¹Ù„.");
            return;
          }
        }
        existing.year = yearNum;
        existing.month = monthNum;
        existing.name = name;
        existing.salary = salary;
        existing.id = id;
        state.selectedMonthId = id;
      } else {
        const exists = state.months.find((m) => m.id === id);
        if (exists) {
          alert("Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ø§ÙØªØ­Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¹Ø¯ÙŠÙ„Ù‡.");
          return;
        }
        state.months.push({
          id,
          year: yearNum,
          month: monthNum,
          name,
          salary,
          expenses: [],
        });
        state.selectedMonthId = id;
      }

      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    monthSelect.addEventListener("change", async (e) => {
      state.selectedMonthId = e.target.value || null;
      await refreshUI();
    });

    modalMonth.addEventListener("click", (e) => {
      if (e.target === modalMonth) closeMonthModal();
    });

    /* ======= Expense Modal ======= */

    function openExpenseModal(expenseId = null) {
      const month = getSelectedMonth();
      if (!month) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¶Ù Ø´Ù‡Ø±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (expenseId) {
        const exp = (month.expenses || []).find((e) => e.id === expenseId);
        if (!exp) return;
        editingExpenseId = expenseId;
        expenseModalTitle.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ù…ØµØ±ÙˆÙ";
        expenseTitleInput.value = exp.title || "";
        expenseAmountInput.value = formatNumber(exp.amount || 0);
        expenseCategoryInput.value = exp.category || state.categories[0];
        expenseDateInput.value = exp.date || "";
        expenseNoteInput.value = exp.note || "";
        expenseImageInput.value = "";
        deleteExpenseBtn.style.display = "inline-flex";
      } else {
        editingExpenseId = null;
        expenseModalTitle.textContent = "Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ";
        expenseTitleInput.value = "";
        expenseAmountInput.value = "";
        expenseCategoryInput.value = state.categories[0];
        expenseDateInput.valueAsDate = new Date();
        expenseNoteInput.value = "";
        expenseImageInput.value = "";
        deleteExpenseBtn.style.display = "none";
      }
      modalExpense.style.display = "flex";
    }

    function closeExpenseModal() {
      modalExpense.style.display = "none";
    }

    btnAddExpense.addEventListener("click", () => openExpenseModal(null));
    btnCancelExpense.addEventListener("click", closeExpenseModal);
    btnCloseExpense.addEventListener("click", closeExpenseModal);

    modalExpense.addEventListener("click", (e) => {
      if (e.target === modalExpense) closeExpenseModal();
    });

    expenseAmountInput.addEventListener("input", () => {
      const digits = expenseAmountInput.value.replace(/\D/g, "");
      expenseAmountInput.value = formatNumber(digits);
      expenseAmountInput.selectionEnd = expenseAmountInput.value.length;
    });

    async function deleteExpense(expenseId) {
      const month = getSelectedMonth();
      if (!month || !Array.isArray(month.expenses)) return;
      if (!confirm("Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) return;
      const idx = month.expenses.findIndex((e) => e.id === expenseId);
      if (idx !== -1) {
        month.expenses.splice(idx, 1);
        await refreshUI();
      }
    }

    deleteExpenseBtn.addEventListener("click", async () => {
      if (!editingExpenseId) return;
      await deleteExpense(editingExpenseId);
      closeExpenseModal();
    });

    saveExpenseBtn.addEventListener("click", () => {
      const month = getSelectedMonth();
      const categoryError = document.getElementById("categoryError");

      if (!month) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¶Ù Ø´Ù‡Ø±Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      if (!Array.isArray(month.expenses)) month.expenses = [];

      const title = expenseTitleInput.value.trim() || "Ù…ØµØ±ÙˆÙ";
      const amount = parseFormattedNumber(expenseAmountInput.value);
      const category = expenseCategoryInput.value;
      const date = expenseDateInput.value || "";
      const note = expenseNoteInput.value.trim();

      if (!amount || amount <= 0) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.");
        return;
      }

      if (!category || category.trim() === "") {
        categoryError.style.display = "block";
        expenseCategoryInput.focus();
        expenseCategoryInput.style.borderColor = "var(--danger)";
        return;
      } else {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }

      const file = expenseImageInput.files[0];

      if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          const imageDataUrl = e.target.result;
          await saveExpenseObject(month, {
            id: editingExpenseId,
            title,
            amount,
            category,
            date,
            note,
            imageDataUrl,
          });
          closeExpenseModal();
        };
        reader.readAsDataURL(file);
      } else {
        let imageDataUrl = null;
        if (editingExpenseId) {
          const existing = month.expenses.find((exp) => exp.id === editingExpenseId);
          imageDataUrl = existing ? existing.imageDataUrl || null : null;
        }
        saveExpenseObject(month, {
          id: editingExpenseId,
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        }).then(() => {
          closeExpenseModal();
        });
      }
    });

    async function saveExpenseObject(
      month,
      { id, title, amount, category, date, note, imageDataUrl }
    ) {
      if (!Array.isArray(month.expenses)) month.expenses = [];
      if (id) {
        const existing = month.expenses.find((e) => e.id === id);
        if (!existing) return;
        existing.title = title;
        existing.amount = amount;
        existing.category = category;
        existing.date = date;
        existing.note = note;
        existing.imageDataUrl = imageDataUrl;
      } else {
        month.expenses.push({
          id: Date.now().toString(),
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        });
      }
      editingExpenseId = null;
      await refreshUI();
    }

    /* ======= ÙÙ„ØªØ±Ø© ======= */

    searchInput.addEventListener("input", () => {
      filterState.search = searchInput.value;
      renderExpenses();
    });

    filterCategory.addEventListener("change", () => {
      filterState.category = filterCategory.value;
      renderExpenses();
    });

    filterHasImage.addEventListener("change", () => {
      filterState.hasImageOnly = filterHasImage.checked;
      renderExpenses();
    });

    /* ======= Image Modal ======= */

    modalImage.addEventListener("click", (e) => {
      if (e.target === modalImage) {
        modalImage.style.display = "none";
        imageModalView.src = "";
      }
    });

    /* ======= Theme ======= */

    btnToggleTheme.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(current === "light" ? "dark" : "light");
    });

    /* ======= Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======= */

    function computeUserStats(userState) {
      const normalized = normalizeState(userState || {});
      const months = Array.isArray(normalized.months) ? normalized.months : [];
      let totalSalary = 0;
      let totalExpenses = 0;
      let expensesCount = 0;

      months.forEach((m) => {
        totalSalary += m.salary || 0;
        if (Array.isArray(m.expenses)) {
          expensesCount += m.expenses.length;
          m.expenses.forEach((ex) => {
            totalExpenses += ex.amount || 0;
          });
        }
      });

      const remaining = totalSalary - totalExpenses;
      return {
        monthsCount: months.length,
        totalSalary,
        totalExpenses,
        remaining,
        expensesCount,
      };
    }

    async function adminDeleteUserData(uid) {
      if (!firebaseEnabled || !db) {
        alert("Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØªØ·Ù„Ø¨ Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
        return;
      }
      if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ")) {
        return;
      }
      try {
        await set(ref(db, "users/" + uid), null);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("ØªØ¹Ø°Ø± Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
      }
    }

    async function adminToggleUserDisabled(uid, currentlyDisabled) {
      if (!firebaseEnabled || !db) {
        alert("Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØªØ·Ù„Ø¨ Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
        return;
      }
      const newValue = !currentlyDisabled;
      try {
        await set(ref(db, "users/" + uid + "/disabled"), newValue);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("ØªØ¹Ø°Ø± ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
      }
    }

    async function loadAdminUsers() {
      if (!firebaseEnabled || !db || !currentUser) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØªØ·Ù„Ø¨ Ø§ØªØµØ§Ù„Ø§Ù‹ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆFirebase.</div>';
        return;
      }
      if (currentUser.uid !== ADMIN_UID) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">Ù„ÙŠØ³Øª Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….</div>';
        return;
      }

      adminUsersContainer.innerHTML =
        '<div class="empty-state">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>';

      try {
        const usersSnap = await get(ref(db, "users"));
        if (!usersSnap.exists()) {
          adminUsersContainer.innerHTML =
            '<div class="empty-state">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø¹Ø¯.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();

        usersSnap.forEach((userSnap) => {
          const uid = userSnap.key;
          const data = userSnap.val() || {};
          const stateData = data.state || {};
          const profile = data.profile || {};
          const disabled = !!data.disabled;
          const isOwner = uid === ADMIN_UID;

          const stats = computeUserStats(stateData);

          const card = document.createElement("div");
          card.className = "admin-user-card";

          // Header
          const header = document.createElement("div");
          header.className = "admin-user-header";

          const main = document.createElement("div");
          main.className = "admin-user-main";

          const emailEl = document.createElement("div");
          emailEl.className = "admin-user-email";
          emailEl.textContent = profile.email || "(Ø¨Ø¯ÙˆÙ† Ø¨Ø±ÙŠØ¯ Ù…Ø­ÙÙˆØ¸)";
          const uidEl = document.createElement("div");
          uidEl.className = "admin-user-uid";
          uidEl.textContent = "UID: " + uid;

          main.appendChild(emailEl);
          main.appendChild(uidEl);

          const badgesContainer = document.createElement("div");

          const statusBadge = document.createElement("span");
          statusBadge.className =
            "admin-badge " + (disabled ? "admin-badge-disabled" : "admin-badge-active");
          statusBadge.textContent = disabled ? "Ù…Ø¹Ø·Ù‘Ù„" : "Ù†Ø´Ø·";

          badgesContainer.appendChild(statusBadge);

          if (isOwner) {
            const ownerBadge = document.createElement("span");
            ownerBadge.className = "admin-badge admin-badge-admin";
            ownerBadge.textContent = "Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù…";
            badgesContainer.appendChild(ownerBadge);
          }

          header.appendChild(main);
          header.appendChild(badgesContainer);

          // Summary stats
          const statsEl = document.createElement("div");
          statsEl.className = "admin-user-stats";

          function makeStat(labelText, valText) {
            const line = document.createElement("div");
            line.className = "admin-stat-line";
            const l = document.createElement("span");
            l.className = "admin-stat-label";
            l.textContent = labelText;
            const v = document.createElement("span");
            v.className = "admin-stat-value";
            v.textContent = valText;
            line.appendChild(l);
            line.appendChild(v);
            return line;
          }

          statsEl.appendChild(makeStat("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ÙˆØ§ØªØ¨:", formatNumber(stats.totalSalary)));
          statsEl.appendChild(makeStat("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:", formatNumber(stats.totalExpenses)));
          statsEl.appendChild(makeStat("Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:", formatNumber(stats.remaining)));
          statsEl.appendChild(makeStat("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ù‡Ø±:", stats.monthsCount));
          statsEl.appendChild(makeStat("Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ:", stats.expensesCount));

          // Actions
          const actions = document.createElement("div");
          actions.className = "admin-user-actions";

          if (!isOwner) {
            const toggleBtn = document.createElement("button");
            toggleBtn.className = "btn-soft";
            toggleBtn.textContent = disabled ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø·ÙŠÙ„" : "ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…";
            toggleBtn.addEventListener("click", () => {
              adminToggleUserDisabled(uid, disabled);
            });
            actions.appendChild(toggleBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn-danger-soft";
            deleteBtn.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
            deleteBtn.addEventListener("click", () => {
              adminDeleteUserData(uid);
            });
            actions.appendChild(deleteBtn);
          } else {
            const infoOwner = document.createElement("div");
            infoOwner.className = "admin-note";
            infoOwner.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø·ÙŠÙ„ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù†Ø¸Ø§Ù….";
            actions.appendChild(infoOwner);
          }

          card.appendChild(header);
          card.appendChild(statsEl);

          // Detailed months (+ expenses) view
          const monthsNormalized = normalizeState(stateData).months || [];
          const monthsSorted = monthsNormalized.slice().sort((a, b) => a.year - b.year || a.month - b.month);

          const monthsContainer = document.createElement("div");
          monthsContainer.className = "admin-user-months";

          if (monthsSorted.length === 0) {
            const empty = document.createElement("div");
            empty.className = "admin-note";
            empty.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø´Ù‡Ø± Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
            monthsContainer.appendChild(empty);
          } else {
            monthsSorted.forEach((m) => {
              const mItem = document.createElement("div");
              mItem.className = "admin-month-item";

              const mHeader = document.createElement("div");
              mHeader.className = "admin-month-header";
              const nameSpan = document.createElement("span");
              nameSpan.textContent = `${m.name} ${m.year}`;
              const statsSpan = document.createElement("span");
              const mTotal = (Array.isArray(m.expenses) ? m.expenses.reduce((s, e) => s + (e.amount || 0), 0) : 0);
              const mRemaining = (m.salary || 0) - mTotal;
              statsSpan.textContent = `Ø§Ù„Ø±Ø§ØªØ¨: ${formatNumber(m.salary || 0)} Â· Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: ${formatNumber(mTotal)} Â· Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatNumber(mRemaining)}`;
              mHeader.appendChild(nameSpan);
              mHeader.appendChild(statsSpan);

              const mExpenses = document.createElement("div");
              mExpenses.className = "admin-month-expenses";
              mExpenses.style.display = "none";

              // Toggle expand/collapse
              mHeader.addEventListener("click", () => {
                mExpenses.style.display = mExpenses.style.display === "none" ? "block" : "none";
              });

              // Expense rows
              const expensesArr = Array.isArray(m.expenses) ? m.expenses.slice().sort((a,b)=> (b.id||0)-(a.id||0)) : [];
              if (expensesArr.length === 0) {
                const emptyRow = document.createElement("div");
                emptyRow.className = "empty-state";
                emptyRow.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.";
                mExpenses.appendChild(emptyRow);
              } else {
                expensesArr.forEach((ex) => {
                  const row = document.createElement("div");
                  row.className = "admin-expense-row";

                  const left = document.createElement("div");
                  left.style.flex = "1";
                  const t = document.createElement("div");
                  t.textContent = ex.title || "Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†";
                  t.style.fontWeight = "600";
                  const meta = document.createElement("div");
                  meta.style.fontSize = "12px";
                  meta.style.color = "var(--subtext-color)";
                  meta.textContent = `${ex.category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'} Â· ${ex.date || 'Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®'}`;
                  if (ex.note) {
                    const note = document.createElement("div");
                    note.style.fontSize = "12px";
                    note.textContent = ex.note;
                    left.appendChild(t);
                    left.appendChild(meta);
                    left.appendChild(note);
                  } else {
                    left.appendChild(t);
                    left.appendChild(meta);
                  }

                  const right = document.createElement("div");
                  right.style.minWidth = "110px";
                  right.style.textAlign = "right";
                  const amountEl = document.createElement("div");
                  amountEl.textContent = formatNumber(ex.amount || 0);
                  amountEl.style.fontWeight = "700";
                  amountEl.style.color = "#2563eb";

                  right.appendChild(amountEl);

                  if (ex.imageDataUrl) {
                    const img = document.createElement("img");
                    img.src = ex.imageDataUrl;
                    img.alt = "ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ";
                    img.style.height = "40px";
                    img.style.borderRadius = "6px";
                    img.style.marginLeft = "8px";
                    img.addEventListener("click", () => {
                      imageModalView.src = ex.imageDataUrl;
                      modalImage.style.display = "flex";
                    });
                    right.appendChild(img);
                  }

                  row.appendChild(left);
                  row.appendChild(right);
                  mExpenses.appendChild(row);
                });
              }

              mItem.appendChild(mHeader);
              mItem.appendChild(mExpenses);
              monthsContainer.appendChild(mItem);
            });
          }

          card.appendChild(monthsContainer);
          card.appendChild(actions);

          fragment.appendChild(card);
        });

        adminUsersContainer.innerHTML = "";
        adminUsersContainer.appendChild(fragment);
      } catch (e) {
        console.error(e);
        adminUsersContainer.innerHTML =
          '<div class="empty-state">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</div>';
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Firebase
    async function loadRegistrationStatus() {
      if (!firebaseEnabled || !db) return;
      try {
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const isEnabled = snap.exists() ? snap.val() : true;
        updateRegistrationUI(isEnabled);
      } catch (err) {
        console.error("Error loading registration status:", err);
        updateRegistrationUI(true);
      }
    }

    // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ù‚ÙÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    function updateRegistrationUI(isEnabled) {
      if (btnToggleRegistration) {
        btnToggleRegistration.classList.toggle("active", isEnabled);
        btnToggleRegistration.style.background = isEnabled ? "#10b981" : "#ef4444";
        btnToggleRegistration.style.borderColor = isEnabled ? "#059669" : "#dc2626";
      }
    }

    // ØªØ¨Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    async function toggleRegistration() {
      if (!firebaseEnabled || !db || currentUser?.uid !== ADMIN_UID) {
        return;
      }

      try {
        btnToggleRegistration.disabled = true;
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const currentStatus = snap.exists() ? snap.val() : true;
        const newStatus = !currentStatus;

        await set(statusRef, newStatus);
        updateRegistrationUI(newStatus);
      } catch (err) {
        console.error("Error toggling registration:", err);
      } finally {
        btnToggleRegistration.disabled = false;
      }
    }

    // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    async function changePassword() {
      const current = modalCurrentPassword?.value?.trim();
      const newPwd = modalNewPassword?.value?.trim();
      const confirmPwd = modalConfirmPassword?.value?.trim();

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
      if (!current) {
        showModalPasswordMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©.", "error");
        return;
      }
      if (!newPwd) {
        showModalPasswordMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.", "error");
        return;
      }
      if (newPwd.length < 6) {
        showModalPasswordMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", "error");
        return;
      }
      if (newPwd !== confirmPwd) {
        showModalPasswordMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØªØ£ÙƒÙŠØ¯Ù‡Ø§ ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©.", "error");
        return;
      }
      if (newPwd === current) {
        showModalPasswordMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„ÙŠØ©.", "error");
        return;
      }

      try {
        btnModalChangePassword.disabled = true;
        btnModalChangePassword.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
        const email = currentUser.email;
        const credential = EmailAuthProvider.credential(email, current);
        await reauthenticateWithCredential(currentUser, credential);

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
        await updatePassword(currentUser, newPwd);

        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";

        showModalPasswordMessage("âœ“ ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­.", "success");
        setTimeout(() => {
          closePasswordModal();
        }, 1500);
      } catch (err) {
        console.error("Error changing password:", err);

        if (err.code === "auth/wrong-password") {
          showModalPasswordMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.", "error");
        } else if (err.code === "auth/weak-password") {
          showModalPasswordMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹.", "error");
        } else if (err.code === "auth/requires-recent-login") {
          showModalPasswordMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø«Ù… Ø­Ø§ÙˆÙ„.", "error");
        } else {
          showModalPasswordMessage("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±: " + (err.message || "Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"), "error");
        }
      } finally {
        btnModalChangePassword.disabled = false;
        btnModalChangePassword.textContent = "âœ“ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±";
      }
    }

    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    function showModalPasswordMessage(message, type) {
      if (!modalPasswordMessage) return;
      modalPasswordMessage.textContent = message;
      modalPasswordMessage.className = type === "success" ? "password-success" : "password-error";
    }

    // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    function openPasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "flex";
        modalCurrentPassword.focus();
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    function closePasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "none";
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // Ø²Ø± Ù‚ÙÙ„/ÙØªØ­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙÙ‚Ø·)
    if (btnToggleRegistration) {
      btnToggleRegistration.addEventListener("click", toggleRegistration);
    }

    // Ø²Ø± ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù…Ù† Ø§Ù„Ø±Ø£Ø³
    if (btnChangePasswordQuick) {
      btnChangePasswordQuick.addEventListener("click", openPasswordModal);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
    if (btnClosePassword) {
      btnClosePassword.addEventListener("click", closePasswordModal);
    }

    // Ø²Ø± ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    if (btnModalChangePassword) {
      btnModalChangePassword.addEventListener("click", changePassword);
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡
    if (modalPassword) {
      modalPassword.addEventListener("click", (e) => {
        if (e.target === modalPassword) {
          closePasswordModal();
        }
      });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ ÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
    let registrationLoaded = false;
    if (adminTabBtn) {
      adminTabBtn.addEventListener("click", () => {
        if (!registrationLoaded) {
          loadRegistrationStatus();
          registrationLoaded = true;
        }
      });
    }

    // Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†)
    if (btnAdminRefresh) {
      btnAdminRefresh.addEventListener("click", async () => {
        const prevText = btnAdminRefresh.textContent;
        try {
          btnAdminRefresh.disabled = true;
          btnAdminRefresh.textContent = "ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
          await loadAdminUsers();
          await loadRegistrationStatus();

        } catch (err) {
          console.error(err);
          alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.");
        } finally {
          btnAdminRefresh.textContent = prevText;
          btnAdminRefresh.disabled = false;
        }
      });
    }

    async function refreshUI() {
      state = normalizeState(state);

      // apply fade-out to the main app view so existing data hides smoothly
      if (appView) {
        appView.classList.remove("fade-in");
        appView.classList.add("fade-out");
        // wait for animation to finish (match CSS duration ~280ms)
        await new Promise((r) => setTimeout(r, 300));
      }

      refreshMonthSelect();
      renderSummary();
      renderAdvancedStats();
      renderExpenses();
      renderComparison();
      renderCategoryOptions();
      renderCategoryList();

      // reveal updated UI with a subtle fade-in
      if (appView) {
        appView.classList.remove("fade-out");
        appView.classList.add("fade-in");
        // remove the class after animation to keep DOM clean
        setTimeout(() => appView && appView.classList.remove("fade-in"), 350);
      }

      await saveState();
    }

    (function init() {
      const savedTheme = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(savedTheme);

      // Show loader while we determine auth state to prevent UI flash
      if (appLoader) {
        appLoader.style.display = "flex";
      }
      if (loginView) loginView.style.display = "none";
      if (appView) appView.style.display = "none";

      // If we have a last signed-in uid and local state, show app immediately (avoid loader flash)
      try {
        const lastUid = localStorage.getItem(LAST_UID_KEY);
        if (lastUid) {
          const raw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid);
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              state = normalizeState(parsed);
              // show app using local data while firebase confirms session
              if (appLoader) appLoader.style.display = "none";
              if (loginView) loginView.style.display = "none";
              if (appView) appView.style.display = "block";
              if (adminTabBtn) adminTabBtn.style.display = "none"; // will update after auth

              // try to show cached profile/email immediately (speeds up UI on refresh)
              try {
                const profileRaw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid + "_profile");
                if (profileRaw) {
                  const p = JSON.parse(profileRaw);
                  if (userEmailLabel) userEmailLabel.textContent = p.email || "";
                }
                // show admin tab from cache when uid matches ADMIN_UID (will be revalidated by auth handler)
                if (adminTabBtn) {
                  adminTabBtn.style.display = lastUid === ADMIN_UID ? "block" : "none";
                }
              } catch (e) {
                /* ignore cache read errors */
              }
              // render local UI
              refreshUI();
            } catch (e) {
              console.warn("failed to parse local cached state", e);
            }
          }
        }
      } catch (e) {
        console.warn("failed to read last uid", e);
      }

      if (firebaseEnabled && auth) {
        onAuthStateChanged(auth, async (user) => {
         if (user) {
  currentUser = user;
  userRef = ref(db, "users/" + currentUser.uid + "/state");

        // remember last uid locally to speed up UI on refresh
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}

  /* ğŸ”’ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹Ø·Ù‘Ù„Ø§Ù‹ */
  try {
    const disabledSnap = await get(ref(db, "users/" + currentUser.uid + "/disabled"));
    if (disabledSnap.exists() && disabledSnap.val() === true) {
      alert("ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.");
      await signOut(auth);
      return;
    }
  } catch (e) {
    console.warn("Failed to check disabled flag:", e);
  }

  /* ğŸ“Œ ØªØ­Ø¯ÙŠØ« Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
  try {
    await set(ref(db, "users/" + currentUser.uid + "/profile"), {
      email: currentUser.email || "",
    });
  } catch (e) {
    console.warn("Failed to update user profile:", e);
  }

  /* ğŸ“§ Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
  userEmailLabel.textContent = user.email || "";

  /* ğŸ‘‘ Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ± */
  if (adminTabBtn) {
    if (currentUser.uid === ADMIN_UID) {
      adminTabBtn.style.display = "block";
    } else {
      adminTabBtn.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
    }
  }

  /* â˜ï¸ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
  loadStateLocal();
  state = normalizeState(state);

  await loadStateRemoteIfExists();
  state = normalizeState(state);

  /* ğŸ”„ Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";

  await refreshUI();

} else {
  /* ğŸšª Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
  currentUser = null;
  userRef = null;
  userEmailLabel.textContent = "";
  
  if (adminTabBtn) adminTabBtn.style.display = "none";
  if (tabAdmin) tabAdmin.style.display = "none";

  /* ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
  state = {
    months: [],
    selectedMonthId: null,
    categories: [...defaultCategories],
  };

  filterState = {
    search: "",
    category: "all",
    hasImageOnly: false,
  };

  /* Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
  if (appLoader) appLoader.style.display = "none";
  appView.style.display = "none";
  loginView.style.display = "block";
}
});
} else {
  // ÙÙŠ Ø­Ø§Ù„Ø© Ù„Ù… ÙŠØ¹Ù…Ù„ Firebase (ÙˆØ¶Ø¹ Offline)
  currentUser = null;
  userRef = null;
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";
  refreshUI();
}
})();
    </script>
</body>
</html>
