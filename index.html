<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>ูุธุงู ุฅุฏุงุฑุฉ ุงููุตุงุฑูู</title>
  <icon rel="icon" href="http://pngegg.com/ar/png-pxffu" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="style.css">
 
</head>
<body>
  <!-- ููุฏุฑ ุชุญููู (ูุธูุฑ ุฃุซูุงุก ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏุฎูู) -->
  <div id="appLoader" class="app-loader">๐ ุฌุงุฑู ุงูุชุญูู ูู ุญุงูุฉ ุงูุฏุฎูู...</div>

  <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู -->
  <div id="loginView" class="login-container" style="display:none;">
    <div class="login-header">
      <div class="login-icon">๐ธ</div>
      <div class="login-title">
        <h1>ูุธุงู ุฅุฏุงุฑุฉ ุงููุตุงุฑูู</h1>
        <span>ุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ูุตุงุฑููู ูู ุฃู ุฌูุงุฒ.</span>
      </div>
    </div>
    <div class="login-body">
      <div class="login-tabs">
        <button id="tabLogin" class="login-tab-btn active">ุชุณุฌูู ุฏุฎูู</button>
        <button id="tabRegister" class="login-tab-btn">ุญุณุงุจ ุฌุฏูุฏ</button>
      </div>

      <!-- ูููุฐุฌ ุชุณุฌูู ุงูุฏุฎูู -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="loginEmail" type="email" class="form-input" placeholder="Email" />
        </div>
        <div class="form-group">
          <label class="form-label">ูููุฉ ุงูุณุฑ</label>
          <div class="password-row">
            <input id="loginPassword" type="password" class="form-input" placeholder="password" />
            <button id="btnTogglePwLogin" class="btn-toggle-pw">๐๏ธ</button>
          </div>
        </div>
        <div id="authError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnLogin" class="btn btn-primary">ุชุณุฌูู ุงูุฏุฎูู</button>
          <div class="login-small-note">
            ูุนูู ุจุฏูู ุฅูุชุฑูุชุ ููููู ุจุงููุฒุงููุฉ ูุน ุงูุณุญุงุจุฉ ุนูุฏ ุชููุฑ ุงููุช.
          </div>
        </div>
        <div id="loginProcessingBar" class="login-processing-bar" role="status" aria-live="polite">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div>ุฌุงุฑู ุชุณุฌูู ุงูุฏุฎูู...</div>
        </div>
      </div>

      <!-- ูููุฐุฌ ุงูุชุณุฌูู -->
      <div id="registerForm" style="display:none;">
        <div class="form-group">
          <label class="form-label">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
          <input id="registerEmail" type="email" class="form-input" placeholder="Email" />
        </div>
        <div class="form-group">
          <label class="form-label">ูููุฉ ุงูุณุฑ</label>
          <div class="password-row">
            <input id="registerPassword" type="password" class="form-input" placeholder="password" />
            <button id="btnTogglePwReg" class="btn-toggle-pw">๐๏ธ</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ุชุฃููุฏ ูููุฉ ุงูุณุฑ</label>
          <input id="registerPasswordConfirm" type="password" class="form-input" placeholder="password" />
        </div>
        <div id="registerError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnRegister" class="btn btn-outline">ุฅูุดุงุก ุญุณุงุจ</button>
          <button id="btnCancelRegister" class="btn btn-ghost">ุฅูุบุงุก</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ูุงุฌูุฉ ุงูุชุทุจูู -->
  <div id="appView" class="app-container">
    <header>
      <div class="header-left">
        <h2><span class="icon">๐</span>ูุตุฑููุงุชู ุงูุดูุฑูุฉ</h2>
        <div class="header-sub">ุฅุฏุงุฑุฉ ุงูุฑุงุชุจ ูุงููุตุงุฑูู ูุน ูุตู ูุงูู ุจูู ุงูุฃุดูุฑ.</div>
      </div>
      <div class="header-actions">
        <span id="userEmailLabel" class="user-label"></span>
        <button id="btnChangePasswordQuick" class="btn btn-outline btn-sm">๐ ุชุบููุฑ ูููุฉ ุงูุณุฑ</button>
        <button id="btnToggleTheme" class="btn btn-outline btn-sm">๐ ุงููุถุน ุงูุฏุงูู</button>
        <button id="btnLogout" class="btn btn-outline btn-sm">๐ช ุชุณุฌูู ุฎุฑูุฌ</button>
      </div>
    </header>

    <!-- ุชุจููุจุงุช -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="month">ุงูุดูุฑ ุงูุญุงูู</button>
      <button class="tab-btn" data-tab="compare">ููุงุฑูุฉ ุงูุฃุดูุฑ</button>
      <button class="tab-btn" data-tab="private">๐ ููุงุญุธุงุชู</button>
      <button id="adminTabBtn" class="tab-btn" data-tab="admin" style="display:none;">ููุญุฉ ุงูุชุญูู</button>
    </div>

    <!-- ุงุฎุชูุงุฑ ุงูุดูุฑ -->
    <div class="month-row">
      <select id="monthSelect" class="month-select"></select>
      <button id="btnEditMonth" class="btn btn-outline btn-sm">โ๏ธ ุฅุฏุงุฑุฉ ุงูุดูุฑ</button>
      <button id="btnAddMonth" class="btn btn-primary btn-sm">+ ุดูุฑ</button>
    </div>

    <!-- ุชุจููุจ ุงูุดูุฑ ุงูุญุงูู -->
    <div id="tab-month">
      <!-- ููุฎุต -->
      <div class="card">
        <div class="card-header">
          <h3>ููุฎุต ุงูุดูุฑ</h3>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">ุงูุฑุงุชุจ</div>
            <div id="summarySalary" class="summary-value">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ุฅุฌูุงูู ุงููุตุงุฑูู</div>
            <div id="summaryExpenses" class="summary-value negative">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">ุงููุชุจูู</div>
            <div id="summaryRemaining" class="summary-value positive">0</div>
          </div>
        </div>
      </div>

      <!-- ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ -->
      <div class="card">
        <div class="card-header">
          <div class="collapse-toggle" id="advancedStatsToggle">
            <span>ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ ููุดูุฑ</span>
            <span id="advancedStatsIcon" class="collapse-icon">โผ</span>
          </div>
        </div>
        <div id="advancedStatsBody" class="collapse-body">
          <div class="stats-grid">
            <div class="stats-item">
              <div class="stats-item-title">ูุชูุณุท ุงูุตุฑู ุงููููู</div>
              <div id="statDailyAvg" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">ุงููุชุจูู ููู ููู</div>
              <div id="statRemainingPerDay" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">ุฃูุจุฑ ูุตุฑูู</div>
              <div id="statMaxExpense" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">ุฃูุซุฑ ุชุตููู ุตุฑููุง</div>
              <div id="statTopCategory" class="stats-item-value">ูุง ููุฌุฏ</div>
            </div>
          </div>
          <div class="category-bars" id="categoryBars"></div>
        </div>
      </div>

      <!-- ุงููุตุงุฑูู -->
      <div class="card">
        <div class="card-header">
          <h3>ุงููุตุงุฑูู</h3>
          <button id="btnAddExpense" class="btn btn-primary btn-sm">+ ูุตุฑูู</button>
        </div>
        <div class="filter-row">
          <input
            id="searchInput"
            type="text"
            class="form-input form-input-sm"
            placeholder="ุจุญุซ ุนู ูุตุฑูู (ุนููุงู ุฃู ููุงุญุธุฉ)"
          />
          <select id="filterCategory" class="form-select form-select-sm">
            <option value="all">ูู ุงูุชุตูููุงุช</option>
          </select>
        </div>
        <label class="filter-toggle">
          <input type="checkbox" id="filterHasImage" />
          ุนุฑุถ ุงููุตุงุฑูู ุงูุชู ุชุญุชูู ุนูู ุตูุฑุฉ ููุท
        </label>
        <div id="filterSummary" class="filter-summary"></div>
        <div id="expenseList" class="expense-list"></div>
      </div>

      <!-- ุฅุฏุงุฑุฉ ุงูุชุตูููุงุช -->
      <div class="card">
        <div class="card-header">
          <h3>ุงูุชุตูููุงุช</h3>
        </div>
        <div class="form-group" style="margin-bottom:6px;">
          <div style="display:flex; gap:6px;">
            <input
              id="newCategoryInput"
              type="text"
              class="form-input form-input-sm"
              placeholder="ุฅุถุงูุฉ ุชุตููู ุฌุฏูุฏ (ูุซุงู: ูููุฉ)"
            />
            <button id="btnAddCategory" class="btn btn-outline btn-sm">+ ุฅุถุงูุฉ</button>
          </div>
        </div>
        <div id="categoryList"></div>
      </div>
    </div>

    <!-- ุชุจููุจ ููุงุฑูุฉ ุงูุฃุดูุฑ -->
    <div id="tab-compare" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3>ููุงุฑูุฉ ูุตุงุฑูู ุงูุฃุดูุฑ</h3>
        </div>
        <div id="compareContainer" class="compare-row"></div>
      </div>
    </div>

    <!-- ุชุจููุจ ููุงุญุธุงุชู ูุงูุญุณุงุจุงุช (ูุญูู ุจุฑูู PIN) -->
    <div id="tab-private" style="display:none;">
      <div id="privateSection" class="private-section-locked">
        <div class="private-lock-container">
          <div class="private-lock-icon">๐</div>
          <div class="private-lock-text">ุจูุงูุงุช ุญุณุงุณุฉ ูุญููุฉ ุจุฑูู PIN</div>
          <div class="private-pin-input-group">
            <input id="privatePinInput" type="text" inputmode="numeric" pattern="[0-9]*" class="private-pin-input" placeholder="0000" maxlength="6" />
            <button id="btnOpenPrivate" class="btn-open-private">ูุชุญ</button>
          </div>
          <div id="privateErrorMsg" class="private-error-msg"></div>
        </div>
      </div>

      <div id="privateContent" class="private-content" style="display:none;">
        <!-- ูุณู ุฑุตูุฏู ุงููุงูู -->
        <div class="private-card budget-summary-card">
          <div class="private-card-title">๐ฐ ุฑุตูุฏู ุงููุงูู</div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- ุญูู ุงูุฑุตูุฏ ุงูููู -->
            <div class="budget-input-group">
              <label style="font-size: 11px; color: var(--subtext-color); font-weight: 600; margin-bottom: 4px; display: block;">ุฅุฌูุงูู ุฃููุงูู</label>
              <input id="totalBalanceInput" type="text" inputmode="numeric" class="form-input form-input-sm" placeholder="0" />
            </div>

            <!-- ุงุฎุชูุงุฑ ูุทุงู ุงูุฃุดูุฑ -->
            <div class="budget-range-group">
              <label style="font-size: 11px; color: var(--subtext-color); font-weight: 600; margin-bottom: 6px; display: block;">๐ ุงุญุณุจ ูู:</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div>
                  <label style="font-size: 10px; color: var(--subtext-color); display: block; margin-bottom: 3px;">ูู</label>
                  <select id="budgetFromMonth" class="form-select form-select-sm"></select>
                </div>
                <div>
                  <label style="font-size: 10px; color: var(--subtext-color); display: block; margin-bottom: 3px;">ุฅูู</label>
                  <select id="budgetToMonth" class="form-select form-select-sm"></select>
                </div>
              </div>
            </div>

            <!-- ููุฎุต ุงูุญุณุงุจุงุช -->
            <div class="budget-summary">
              <div class="budget-stat">
                <span class="budget-stat-label">ุงููุตุฑูู</span>
                <span id="privateTotalExpenses" class="budget-stat-value danger">0</span>
              </div>
              <div class="budget-stat">
                <span class="budget-stat-label">ุงูุฃุดูุฑ</span>
                <span id="privateAllMonthsCount" class="budget-stat-value">0</span>
              </div>
              <div class="budget-stat">
                <span class="budget-stat-label">ุงููุชุจูู</span>
                <span id="privateActualRemaining" class="budget-stat-value success">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ูุณู ุชูุณูู ุงูุฑุตูุฏ ุญุณุจ ุงููุฆุงุช -->
        <div class="private-card budget-allocation-card">
          <div class="private-card-title">๐ ุชูุฒูุน ุฑุตูุฏู</div>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div id="budgetAllocations" class="budget-allocations-container"></div>
            <button id="btnAddAllocation" class="btn btn-outline btn-sm" style="width: 100%; margin-top: 4px;">+ ุฅุถุงูุฉ ูุฆุฉ ุฌุฏูุฏุฉ</button>
          </div>
        </div>

        <!-- ูุณู ุงูุญุงุณุจุฉ ุงูุฐููุฉ -->
        <div class="private-card">
          <div class="private-card-title">๐งฎ ุญุงุณุจุชู ุงูุฐููุฉ</div>
          <div class="private-calculator">
            <input id="calcInput" type="text" class="calc-input" placeholder="ูุซุงู: 100 + 50 * 2 - 20" />
            <div class="calc-result" id="calcResult">ุงูุชุธุฑ ุงูุญุณุงุจ...</div>
            <div style="font-size: 11px; color: var(--subtext-color); text-align: center;">
              ุชุฏุนู: + (ุฌูุน) | - (ุทุฑุญ) | * (ุถุฑุจ) | / (ูุณูุฉ)
            </div>
          </div>
        </div>



        <!-- ูุณู ุงูููุงุญุธุงุช ุงูุนุงูุฉ -->
        <div class="private-card">
          <div class="private-card-title">๐ ููุงุญุธุงุชู ุงูุนุงูุฉ</div>
          <textarea id="privateNotes" class="private-notes-textarea" placeholder="ุงูุชุจ ููุงุญุธุงุชู ููุง... (ุขุฎุฑ ุชุญุฏูุซ ูุชู ุญูุธูุง ุชููุงุฆูุงู)"></textarea>
          <div class="private-notes-meta" id="privateNotesLastUpdate"></div>
        </div>

        <!-- ุฒุฑ ุชุนุทูู PIN -->
        <div class="private-card" style="background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.03));">
          <div class="private-card-title" style="color: #b91c1c;">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุฃูุงู</div>
          <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="pinEnabledToggle" checked />
              <span>ุชูุนูู ููู PIN</span>
            </label>
            <div style="font-size: 11px; color: var(--subtext-color);">
              ุนุทูู ูุฐุง ุงูุฎูุงุฑ ุฅุฐุง ููุช ุชุฑูุฏ ุงููุตูู ุงููุจุงุดุฑ ุจุฏูู ูููุฉ ุณุฑ.
            </div>
            <button id="btnChangePinCode" class="btn btn-outline btn-sm">๐ ุชุบููุฑ ุฑูู PIN</button>
          </div>
        </div>

        <!-- ุฒุฑ ุชุณุฌูู ุงูุฎุฑูุฌ ูู ุงููุณู -->
        <button id="btnPrivateLogout" class="btn-private-logout">๐ ููู ูุฐุง ุงููุณู</button>
      </div>
    </div>

 <!-- ุชุจููุจ ููุญุฉ ุงูุชุญูู (ูุธูุฑ ูููุฏูุฑ ููุท) -->
<div id="tab-admin" style="display:none;">

  <div class="card">
    <div class="card-header">
      <h3>ููุญุฉ ุชุญูู ุงููุฏูุฑ</h3>
      <button id="btnAdminRefresh" class="btn btn-outline btn-sm">๐ ุชุญุฏูุซ ุงูุจูุงูุงุช</button>
    </div>

    <div id="adminNote" class="login-small-note">
      ููููู ููุง ูุดุงูุฏุฉ ููุฎุต ุฑูุงุชุจ ููุตุงุฑูู ุฌููุน ุงููุณุชุฎุฏููู ูุน ุชูุงุตูู ุงูุฃุดูุฑ.<br>
      <strong>ููู:</strong> ูุฐู ุงูุตูุญุฉ ุชุนูู ููุท ูุญุณุงุจ ุงููุฏูุฑ.
    </div>
  </div>

  <!-- ูุณู ุงูุฅุนุฏุงุฏุงุช ุงูุฅุฏุงุฑูุฉ -->
  <div class="card">
    <div class="card-header">
      <h3>๐ง ุงูุฅุนุฏุงุฏุงุช ุงูุฅุฏุงุฑูุฉ</h3>
    </div>

    <!-- ููู ุงูุชุณุฌูู ุงูุฌุฏูุฏ -->
    <div class="admin-settings-card">
      <div class="admin-settings-group">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label class="admin-settings-label">
            ๐ ุงูุชุณุฌูู ุงูุฌุฏูุฏ
          </label>
          <button id="btnToggleRegistration" class="toggle-switch active">
            <div class="toggle-circle"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="adminUsersContainer" class="admin-users-container"></div>

  <div class="admin-note">
    โ๏ธ ููููู ุญุฐู ุจูุงูุงุช ุงููุณุชุฎุฏููู ุฃู ุชุนุทููููุ ููู ูุง ูููู ุญุฐู ุญุณุงุจูู ูู Firebase Auth.
  </div>

</div>
  <!-- ููุฏุงู ุฅุฏุงุฑุฉ ุงูุดูุฑ -->
  <div id="modalMonth" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalMonthTitle">ุฅุฏุงุฑุฉ ุงูุดูุฑ</h3>
        <button id="btnCloseMonth" class="btn btn-outline btn-sm">โ</button>
      </div>
      <div class="form-group">
        <label class="form-label">ุงูุดูุฑ</label>
        <select id="monthInput" class="form-select">
          <option value="1">ููุงูุฑ</option>
          <option value="2">ูุจุฑุงูุฑ</option>
          <option value="3">ูุงุฑุณ</option>
          <option value="4">ุฃุจุฑูู</option>
          <option value="5">ูุงูู</option>
          <option value="6">ููููู</option>
          <option value="7">ููููู</option>
          <option value="8">ุฃุบุณุทุณ</option>
          <option value="9">ุณุจุชูุจุฑ</option>
          <option value="10">ุฃูุชูุจุฑ</option>
          <option value="11">ููููุจุฑ</option>
          <option value="12">ุฏูุณูุจุฑ</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ุงูุณูุฉ</label>
        <input id="yearInput" type="number" inputmode="numeric" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">ุงูุฑุงุชุจ ุงูุดูุฑู</label>
        <input
          id="salaryInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="ูุซุงู: 1.000.000"
        />
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteMonthBtn" class="btn btn-outline btn-sm" style="display:none;">
          ๐๏ธ ุญุฐู ุงูุดูุฑ
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelMonth">ุฅูุบุงุก</button>
          <button id="saveMonthBtn" class="btn btn-primary">ุญูุธ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ููุฏุงู ุงููุตุฑูู -->
  <div id="modalExpense" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="expenseModalTitle">ุฅุถุงูุฉ ูุตุฑูู</h3>
        <button id="btnCloseExpense" class="btn btn-outline btn-sm">โ</button>
      </div>
      <div class="form-group">
        <label class="form-label">ุนููุงู ุงููุตุฑูู</label>
        <input
          id="expenseTitleInput"
          type="text"
          class="form-input"
          placeholder="ูุซุงู: ุบุฏุงุกุ ุจูุฒููุ ุดุฑุงุก ูุชุงุจ"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ุงููุจูุบ</label>
        <input
          id="expenseAmountInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="ูุซุงู: 25.000"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ุงูุชุตููู</label>
        <select id="expenseCategoryInput" class="form-select"></select>
        <div id="categoryError" style="color: var(--danger); font-size: 12px; margin-top: 3px; display: none;">โ๏ธ ูู ูุถูู ุงุฎุชุฑ ุชุตููููุง</div>
      </div>
      <div class="form-group">
        <label class="form-label">ุงูุชุงุฑูุฎ</label>
        <input id="expenseDateInput" type="date" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">ููุงุญุธุงุช</label>
        <textarea
          id="expenseNoteInput"
          class="form-textarea"
          placeholder="ุชูุงุตูู ุฅุถุงููุฉ ุฅู ูุฌุฏุช"
        ></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ุตูุฑุฉ (ุงุฎุชูุงุฑู)</label>
        <input id="expenseImageInput" type="file" accept="image/*" class="form-input" />
        <!-- ูุนุงููุฉ ุงูุตูุฑุฉ -->
        <div id="imagePreviewContainer" class="image-preview-container">
          <div class="image-preview-box">
            <img id="imagePreviewImg" src="" alt="ูุนุงููุฉ ุงูุตูุฑุฉ" />
          </div>
          <div class="image-preview-info">
            <span class="image-preview-filename" id="imagePreviewFilename"></span>
            <span class="image-preview-size" id="imagePreviewSize"></span>
          </div>
          <button type="button" id="imagePreviewRemove" class="image-preview-remove">
            โ ุฅุฒุงูุฉ ุงูุตูุฑุฉ
          </button>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteExpenseBtn" class="btn btn-outline btn-sm" style="display:none;">
          ๐๏ธ ุญุฐู ุงููุตุฑูู
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelExpense">ุฅูุบุงุก</button>
          <button id="saveExpenseBtn" class="btn btn-primary">ุญูุธ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ููุฏุงู ุนุฑุถ ุงูุตูุฑุฉ -->
  <div id="modalImage" class="modal-backdrop">
    <div class="modal image-modal">
      <img id="imageModalView" src="" alt="ุตูุฑุฉ ุงููุตุฑูู" />
    </div>
  </div>

  <!-- ููุฏุงู ุชุบููุฑ ูููุฉ ุงูุณุฑ -->
  <div id="modalPassword" class="modal-backdrop" style="display:none;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>๐ ุชุบููุฑ ูููุฉ ุงูุณุฑ</h3>
        <button id="btnClosePassword" class="btn btn-outline btn-sm">โ</button>
      </div>
      <div class="form-group">
        <label class="form-label">ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ</label>
        <input 
          id="modalCurrentPassword" 
          type="password" 
          class="form-input" 
          placeholder="ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ</label>
        <input 
          id="modalNewPassword" 
          type="password" 
          class="form-input" 
          placeholder="ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ (6 ุฃุญุฑู ุนูู ุงูุฃูู)"
        />
      </div>
      <div class="form-group">
        <label class="form-label">ุชุฃููุฏ ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ</label>
        <input 
          id="modalConfirmPassword" 
          type="password" 
          class="form-input" 
          placeholder="ุชุฃููุฏ ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ"
        />
      </div>
      <div id="modalPasswordMessage" style="font-size: 13px; margin-bottom: 12px; min-height: 18px;"></div>
      <button id="btnModalChangePassword" class="btn btn-primary" style="width: 100%;">
        โ ุชุญุฏูุซ ูููุฉ ุงูุณุฑ
      </button>
    </div>
  </div>

  <!-- ุณูุฑุจุช ุงูุชุทุจูู + Firebase -->
  <script type="module">
    /* โ๏ธ ููุงุญุธุฉ ุงูุฃูุงู:
     * - ูู ูุณุชุฎุฏู ูู ุจูุงูุงุช ูููุตูุฉ ูู localStorage (ูุญูู ุจุฑูู UID ุงููุฑูุฏ)
     * - ุงูุจูุงูุงุช ูู Firebase ูุฎุฒูุฉ ูู ูุณุงุฑ users/{uid}/state (ูุญูู ุจู UID)
     * - ูุชู ูุณุญ ุฌููุน ุงูุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ ุนูุฏ ุชุณุฌูู ุงูุฎุฑูุฌ
     * - ูุฌุจ ุชุทุจูู Firebase Security Rules ููุญูุงูุฉ ุงูุฅุถุงููุฉ
     */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
  getDatabase,
  ref,
  set,
  get,
  remove,
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
     
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
      authDomain: "mony-ecb81.firebaseapp.com",
      databaseURL: "https://mony-ecb81-default-rtdb.firebaseio.com",
      projectId: "mony-ecb81",
      storageBucket: "mony-ecb81.firebasestorage.app",
      messagingSenderId: "1099032510981",
      appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
      measurementId: "G-PVHFMZ82XL",
    };

    const ADMIN_UID = "6Ss694f4QSOPYeM5TWnfnlxP2O32";

    let app = null;
    let db = null;
    let auth = null;
    let firebaseEnabled = false;

    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      firebaseEnabled = true;
    } catch (e) {
      console.warn("Firebase init failed:", e);
    }

    const STORAGE_KEY_PREFIX = "expense_manager_";
    const THEME_KEY = "expense_manager_theme";
    const LAST_UID_KEY = STORAGE_KEY_PREFIX + "last_uid";
    const SYNC_QUEUE_KEY = STORAGE_KEY_PREFIX + "sync_queue";
    const LAST_SYNC_KEY = STORAGE_KEY_PREFIX + "last_sync";
    const defaultCategories = ["ุฃูู", "ููุงุตูุงุช", "ุชุณูู", "ููุงุชูุฑ", "ุชุฑููู", "ุฃุฎุฑู"];

    // ูุชุบูุฑุงุช ููุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู ูุงููุฒุงููุฉ
    let isOnline = navigator.onLine;
    let isSyncing = false;
    let syncQueue = [];

    // ูุฑุงูุจุฉ ุญุงูุฉ ุงูุงุชุตุงู ุจุงูุงูุชุฑูุช
    window.addEventListener("online", () => {
      isOnline = true;
      updateConnectionUI();
      // ูุญุงููุฉ ูุฒุงููุฉ ุงูุจูุงูุงุช ุงููุนููุฉ ุนูุฏ ุงูุนูุฏุฉ ููุงุชุตุงู
      syncPendingChanges();
    });

    window.addEventListener("offline", () => {
      isOnline = false;
      updateConnectionUI();
    });

    // ุชุญุฏูุซ ุงููุงุฌูุฉ ูุฅุธูุงุฑ ุญุงูุฉ ุงูุงุชุตุงู
    function updateConnectionUI() {
      const indicator = document.querySelector(".connection-indicator");
      if (!indicator) return;
      
      if (isOnline) {
        indicator.classList.remove("offline");
        indicator.classList.add("online");
      } else {
        indicator.classList.remove("online");
        indicator.classList.add("offline");
      }
    }

    let state = {
      months: [],
      selectedMonthId: null,
      categories: [...defaultCategories],
    };

    let filterState = {
      search: "",
      category: "all",
      hasImageOnly: false,
    };

    // ุญุงูุฉ ุงููุณู ุงููุญูู
    let privateState = {
      pinCode: "1234", // ุงูุฑูู ุงูุงูุชุฑุงุถู
      pinEnabled: true,
      isUnlocked: false,
      totalBalance: 0,
      budgetFromMonth: null,
      budgetToMonth: null,
      allocations: [
        { id: 1, name: "ุฌุงูุนุฉ", amount: 0 },
        { id: 2, name: "ููุงุตูุงุช", amount: 0 },
        { id: 3, name: "ุฃูู", amount: 0 }
      ],
      notes: "",
      lastNotesUpdate: null,
      nextAllocationId: 4
    };

    let currentUser = null;
    let userRef = null;

    function getStorageKey() {
      // Prefer the currently signed-in user's UID. If none, try the last saved UID
      // (so refreshing the page without being signed-in still uses the user's local data).
      if (currentUser && currentUser.uid) {
        return STORAGE_KEY_PREFIX + currentUser.uid;
      }
      try {
        const lastUid = localStorage.getItem(LAST_UID_KEY);
        if (lastUid) return STORAGE_KEY_PREFIX + lastUid;
      } catch (e) {
        /* ignore localStorage read errors */
      }
      return STORAGE_KEY_PREFIX + "guest";
    }

    const monthNames = [
      "",
      "ููุงูุฑ", "ูุจุฑุงูุฑ", "ูุงุฑุณ", "ุฃุจุฑูู", "ูุงูู", "ููููู",
      "ููููู", "ุฃุบุณุทุณ", "ุณุจุชูุจุฑ", "ุฃูุชูุจุฑ", "ููููุจุฑ", "ุฏูุณูุจุฑ",
    ];

    function formatNumber(value) {
      if (value === null || value === undefined) return "0";
      const number =
        typeof value === "number"
          ? value
          : parseInt(String(value).replace(/\D/g, "")) || 0;
      return number.toLocaleString("en-US");
    }

    function parseFormattedNumber(str) {
      if (!str) return 0;
      const digits = str.replace(/\D/g, "");
      return parseInt(digits || "0", 10);
    }

    function generateMonthId(year, month) {
      return `${year}-${String(month).padStart(2, "0")}`;
    }

    function normalizeState(raw) {
      let s = raw && typeof raw === "object" ? raw : {};
      if (!Array.isArray(s.months)) s.months = [];
      if (!Array.isArray(s.categories)) s.categories = [...defaultCategories];
      if (s.categories.length === 0) s.categories = [...defaultCategories];
      if (typeof s.selectedMonthId !== "string") s.selectedMonthId = null;

      s.months.forEach((m) => {
        if (!Array.isArray(m.expenses)) m.expenses = [];
        m.year = parseInt(m.year) || new Date().getFullYear();
        m.month = parseInt(m.month) || 1;
        m.name = monthNames[m.month] || m.name || "";
        m.salary = parseInt(m.salary) || 0;
        m.id = m.id || generateMonthId(m.year, m.month);
      });

      if (s.months.length === 0) {
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const id = generateMonthId(year, month);
        s.months.push({
          id,
          year,
          month,
          name: monthNames[month],
          salary: 0,
          expenses: [],
        });
        s.selectedMonthId = id;
      } else {
        if (!s.months.find((m) => m.id === s.selectedMonthId)) {
          s.selectedMonthId = s.months[s.months.length - 1].id;
        }
      }

      return s;
    }

    function getSelectedMonth() {
      return state.months.find((m) => m.id === state.selectedMonthId) || null;
    }

    function saveStateLocal() {
      const key = getStorageKey();
      localStorage.setItem(key, JSON.stringify(state));
    }

    async function saveStateRemote() {
      if (!firebaseEnabled || !currentUser || !userRef) return;
      try {
        await set(userRef, state);
        // ุชุณุฌูู ููุช ุขุฎุฑ ูุฒุงููุฉ ูุงุฌุญุฉ
        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
        return true;
      } catch (e) {
        console.warn("Failed to sync with Firebase:", e);
        return false;
      }
    }

    // ุฅุถุงูุฉ ุงูุจูุงูุงุช ุฅูู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ูููุฒุงููุฉ
    function queueForSync(action, data) {
      try {
        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || "[]");
        queue.push({
          action,
          data,
          timestamp: Date.now(),
          id: Math.random().toString(36).substr(2, 9)
        });
        localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));
      } catch (e) {
        console.warn("Failed to queue sync:", e);
      }
    }

    // ูุนุงูุฌุฉ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุนูุฏ ุงูุนูุฏุฉ ููุงุชุตุงู
    async function syncPendingChanges() {
      if (isSyncing || !isOnline || !firebaseEnabled || !currentUser) return;
      
      isSyncing = true;
      try {
        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || "[]");
        if (queue.length === 0) {
          isSyncing = false;
          return;
        }

        // ูุญุงููุฉ ุงููุฒุงููุฉ
        const success = await saveStateRemote();
        if (success) {
          // ุญุฐู ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุจุนุฏ ุงููุฒุงููุฉ ุงููุงุฌุญุฉ
          localStorage.removeItem(SYNC_QUEUE_KEY);
        }
      } catch (e) {
        console.warn("Sync failed:", e);
      } finally {
        isSyncing = false;
      }
    }

    async function saveState() {
      saveStateLocal();
      
      if (!isOnline) {
        // ุฅุฐุง ููุง ุฏูู ุงุชุตุงูุ ุฃุถู ูููุงุฆูุฉ
        queueForSync("save", state);
        return;
      }
      
      // ุฅุฐุง ูุงู ููุงู ุงุชุตุงูุ ุญุงูู ุงููุฒุงููุฉ ูุจุงุดุฑุฉ
      const success = await saveStateRemote();
      if (!success) {
        // ุฅุฐุง ูุดูุช ุงููุฒุงููุฉุ ุฃุถู ูููุงุฆูุฉ
        queueForSync("save", state);
      }
    }

    function loadStateLocal() {
      const key = getStorageKey();
      const raw = localStorage.getItem(key);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state = normalizeState(data);
      } catch (e) {
        console.error("Failed to parse local state:", e);
      }
    }

    async function loadStateRemoteIfExists() {
      if (!firebaseEnabled || !userRef) return;
      try {
        // If there is a local state saved for this storage key, treat localStorage
        // as authoritative: do NOT overwrite it with remote data. Instead push
        // the local copy to Firebase so remote matches the local version.
        const localKey = getStorageKey();
        let localRaw = null;
        try {
          localRaw = localStorage.getItem(localKey);
        } catch (e) {
          /* ignore localStorage read errors */
        }

        const snap = await get(userRef);

        if (localRaw) {
          // Local data exists: prefer it. Ensure remote is updated to match local.
          try {
            const localData = JSON.parse(localRaw);
            // normalize then set to remote
            const normalized = normalizeState(localData);
            await set(userRef, normalized);
            // update last sync timestamp locally
            try { localStorage.setItem(LAST_SYNC_KEY, Date.now().toString()); } catch (e) {}
            // keep in-memory state in sync with local
            state = normalizeState(normalized);
          } catch (e) {
            console.warn("Failed to parse local state while syncing to Firebase:", e);
          }
        } else {
          // No local data: if remote exists, load it; otherwise write current (empty) state
          if (snap.exists()) {
            const remoteState = normalizeState(snap.val());
            state = remoteState;
          } else {
            await set(userRef, state);
          }
        }
      } catch (e) {
        console.warn("Failed to load/sync from Firebase:", e);
      }
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      root.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      const btn = document.getElementById("btnToggleTheme");
      if (btn) btn.textContent = theme === "dark" ? "โ๏ธ ุงููุถุน ุงููุงุชุญ" : "๐ ุงููุถุน ุงูุฏุงูู";
    }

    /* ======= ุนูุงุตุฑ DOM ======= */

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const appLoader = document.getElementById("appLoader");
    const authErrorEl = document.getElementById("authError");

    // Login form elements
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnTogglePwLogin = document.getElementById("btnTogglePwLogin");

    // Register form elements
    const registerEmailInput = document.getElementById("registerEmail");
    const registerPasswordInput = document.getElementById("registerPassword");
    const registerPasswordConfirmInput = document.getElementById("registerPasswordConfirm");
    const btnRegister = document.getElementById("btnRegister");
    const registerErrorEl = document.getElementById("registerError");
    const btnCancelRegister = document.getElementById("btnCancelRegister");

    const userEmailLabel = document.getElementById("userEmailLabel");
    const btnLogout = document.getElementById("btnLogout");
    const btnToggleTheme = document.getElementById("btnToggleTheme");

    const tabButtons = document.querySelectorAll(".tab-btn");
const tabMonth = document.getElementById("tab-month");
const tabCompare = document.getElementById("tab-compare");
const tabPrivate = document.getElementById("tab-private");
const tabAdminBtn = document.getElementById("tabAdminBtn");

    // ุนูุงุตุฑ ุงููุณู ุงููุญูู
    const privateSection = document.getElementById("privateSection");
    const privateContent = document.getElementById("privateContent");
    const privatePinInput = document.getElementById("privatePinInput");
    const btnOpenPrivate = document.getElementById("btnOpenPrivate");
    const privateErrorMsg = document.getElementById("privateErrorMsg");
    const btnPrivateLogout = document.getElementById("btnPrivateLogout");
    const totalBalanceInput = document.getElementById("totalBalanceInput");
    const privateTotalExpenses = document.getElementById("privateTotalExpenses");
    const privateAllMonthsCount = document.getElementById("privateAllMonthsCount");
    const privateActualRemaining = document.getElementById("privateActualRemaining");
    const budgetFromMonth = document.getElementById("budgetFromMonth");
    const budgetToMonth = document.getElementById("budgetToMonth");
    const budgetAllocationsContainer = document.getElementById("budgetAllocations");
    const btnAddAllocation = document.getElementById("btnAddAllocation");
    const calcInput = document.getElementById("calcInput");
    const calcResult = document.getElementById("calcResult");
    const privateNotes = document.getElementById("privateNotes");
    const privateNotesLastUpdate = document.getElementById("privateNotesLastUpdate");
    const pinEnabledToggle = document.getElementById("pinEnabledToggle");
    const btnChangePinCode = document.getElementById("btnChangePinCode");

const adminUsersContainer = document.getElementById("adminUsersContainer");
const adminNoteEl = document.getElementById("adminNote");
const btnAdminRefresh = document.getElementById("btnAdminRefresh");
const btnToggleRegistration = document.getElementById("btnToggleRegistration");
const registrationStatusEl = document.getElementById("registrationStatus");
const btnChangePasswordQuick = document.getElementById("btnChangePasswordQuick");
const modalPassword = document.getElementById("modalPassword");
const btnClosePassword = document.getElementById("btnClosePassword");
const btnModalChangePassword = document.getElementById("btnModalChangePassword");
const modalCurrentPassword = document.getElementById("modalCurrentPassword");
const modalNewPassword = document.getElementById("modalNewPassword");
const modalConfirmPassword = document.getElementById("modalConfirmPassword");
const modalPasswordMessage = document.getElementById("modalPasswordMessage");

    const tabAdmin = document.getElementById("tab-admin");
    const adminTabBtn = document.getElementById("adminTabBtn");

    const monthSelect = document.getElementById("monthSelect");
    const btnAddMonth = document.getElementById("btnAddMonth");
    const btnEditMonth = document.getElementById("btnEditMonth");

    const summarySalaryEl = document.getElementById("summarySalary");
    const summaryExpensesEl = document.getElementById("summaryExpenses");
    const summaryRemainingEl = document.getElementById("summaryRemaining");

    const advancedStatsToggle = document.getElementById("advancedStatsToggle");
    const advancedStatsIcon = document.getElementById("advancedStatsIcon");
    const advancedStatsBody = document.getElementById("advancedStatsBody");
    const dailyAvgEl = document.getElementById("statDailyAvg");
    const remainingPerDayEl = document.getElementById("statRemainingPerDay");
    const maxExpenseEl = document.getElementById("statMaxExpense");
    const topCategoryEl = document.getElementById("statTopCategory");
    const categoryBars = document.getElementById("categoryBars");

    const btnAddExpense = document.getElementById("btnAddExpense");
    const expenseList = document.getElementById("expenseList");
    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterHasImage = document.getElementById("filterHasImage");
    const filterSummaryEl = document.getElementById("filterSummary");

    const newCategoryInput = document.getElementById("newCategoryInput");
    const btnAddCategory = document.getElementById("btnAddCategory");
    const categoryList = document.getElementById("categoryList");

    const modalMonth = document.getElementById("modalMonth");
    const modalMonthTitle = document.getElementById("modalMonthTitle");
    const monthInput = document.getElementById("monthInput");
    const yearInput = document.getElementById("yearInput");
    const salaryInput = document.getElementById("salaryInput");
    const deleteMonthBtn = document.getElementById("deleteMonthBtn");
    const saveMonthBtn = document.getElementById("saveMonthBtn");
    const btnCancelMonth = document.getElementById("btnCancelMonth");
    const btnCloseMonth = document.getElementById("btnCloseMonth");

    const modalExpense = document.getElementById("modalExpense");
    const expenseModalTitle = document.getElementById("expenseModalTitle");
    const expenseTitleInput = document.getElementById("expenseTitleInput");
    const expenseAmountInput = document.getElementById("expenseAmountInput");
    const expenseCategoryInput = document.getElementById("expenseCategoryInput");
    const expenseDateInput = document.getElementById("expenseDateInput");
    const expenseNoteInput = document.getElementById("expenseNoteInput");
    const expenseImageInput = document.getElementById("expenseImageInput");
    const deleteExpenseBtn = document.getElementById("deleteExpenseBtn");
    const saveExpenseBtn = document.getElementById("saveExpenseBtn");
    const btnCancelExpense = document.getElementById("btnCancelExpense");
    const btnCloseExpense = document.getElementById("btnCloseExpense");

    const modalImage = document.getElementById("modalImage");
    const imageModalView = document.getElementById("imageModalView");

    const compareContainer = document.getElementById("compareContainer");
    const monthRow = document.querySelector(".month-row");

    let editingMonthId = null;
    let editingExpenseId = null;
    let isSavingExpense = false; // ุนูู ููุชุญูู ุจุนูููุฉ ุงูุญูุธ ูููุน ุงูุชูุฑุงุฑ

    /* ======= ุชุณุฌูู ุงูุฏุฎูู (ููุงุฐุฌ ูููุตูุฉ) ======= */

    const tabLoginBtn = document.getElementById("tabLogin");
    const tabRegisterBtn = document.getElementById("tabRegister");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    function switchToLogin() {
      tabLoginBtn.classList.add("active");
      tabRegisterBtn.classList.remove("active");
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    function switchToRegister() {
      tabLoginBtn.classList.remove("active");
      tabRegisterBtn.classList.add("active");
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    tabLoginBtn.addEventListener("click", switchToLogin);
    tabRegisterBtn.addEventListener("click", switchToRegister);
    btnCancelRegister.addEventListener("click", (e) => {
      e.preventDefault();
      switchToLogin();
    });

    // Toggle password visibility
    if (btnTogglePwLogin) {
      btnTogglePwLogin.addEventListener("click", () => {
        const isPassword = loginPasswordInput.type === "password";
        loginPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwLogin.textContent = isPassword ? "๐" : "๐๏ธ";
      });
    }
    const btnTogglePwReg = document.getElementById("btnTogglePwReg");
    if (btnTogglePwReg) {
      btnTogglePwReg.addEventListener("click", () => {
        const isPassword = registerPasswordInput.type === "password";
        registerPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwReg.textContent = isPassword ? "๐" : "๐๏ธ";
      });
    }

    btnRegister.addEventListener("click", async () => {
      registerErrorEl.textContent = "";
      const email = (registerEmailInput.value || "").trim();
      const password = (registerPasswordInput.value || "").trim();
      const confirm = (registerPasswordConfirmInput.value || "").trim();
      if (!email || !password) {
        registerErrorEl.textContent = "ุฃุฏุฎู ุงูุจุฑูุฏ ููููุฉ ุงูุณุฑ.";
        return;
      }
      if (password !== confirm) {
        registerErrorEl.textContent = "ูููุฉ ุงูุณุฑ ูุชุฃููุฏูุง ุบูุฑ ูุชุทุงุจููู.";
        return;
      }
      if (!firebaseEnabled || !auth) {
        registerErrorEl.textContent = "ูุชุทูุจ ุฅูุดุงุก ุงูุญุณุงุจ ุงุชุตุงูุงู ุจุงูุฅูุชุฑูุช. ุญุงูู ูุฑุฉ ุฃุฎุฑู ุนูุฏ ุชููุฑ ุงูุดุจูุฉ.";
        return;
      }

      // ุงูุชุญูู ูู ุญุงูุฉ ุงูุชุณุฌูู
      try {
        if (firebaseEnabled && db) {
          const statusRef = ref(db, "settings/registrationEnabled");
          const snap = await get(statusRef);
          const isEnabled = snap.exists() ? snap.val() : true;
          if (!isEnabled) {
            registerErrorEl.textContent = "โ ุงูุชุณุฌูู ุงูุฌุฏูุฏ ูุนุทูู ุญุงููุงู. ูุฑุฌู ุงูุชูุงุตู ูุน ุงููุณุคูู.";
            return;
          }
        }
      } catch (err) {
        console.error("Error checking registration status:", err);
        // ูู ุญุงูุฉ ุงูุฎุทุฃุ ุงุณูุญ ุจุงููุชุงุจุนุฉ
      }

      try {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = result.user;
        userRef = ref(db, "users/" + currentUser.uid + "/state");
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        await saveStateRemote();
        if (firebaseEnabled && db) {
          try {
            await set(ref(db, "users/" + currentUser.uid + "/profile"), {
              email: currentUser.email || email,
            });
          } catch (e) {
            console.warn("Failed to save user profile:", e);
          }
        }
        registerPasswordInput.value = "";
        registerPasswordConfirmInput.value = "";
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}
        try { localStorage.setItem(STORAGE_KEY_PREFIX + currentUser.uid + "_profile", JSON.stringify({ email: currentUser.email || "" })); } catch (e) {}
      } catch (e) {
        console.error(e);
        registerErrorEl.textContent = "ุชุนุฐุฑ ุฅูุดุงุก ุงูุญุณุงุจ. ุชุฃูุฏ ูู ุตุญุฉ ุงูุจุฑูุฏ ููููุฉ ุงูุณุฑ.";
      }
    });

    btnLogin.addEventListener("click", async () => {
      authErrorEl.textContent = "";
      const email = (loginEmailInput.value || "").trim();
      const password = (loginPasswordInput.value || "").trim();
      if (!email || !password) {
        authErrorEl.textContent = "ุฃุฏุฎู ุงูุจุฑูุฏ ููููุฉ ุงูุณุฑ.";
        return;
      }

      const loginProcessingBar = document.getElementById("loginProcessingBar");
      try {
        // show processing UI
        if (loginProcessingBar) {
          loginProcessingBar.style.display = "flex";
          loginProcessingBar.classList.remove("fade-out");
          loginProcessingBar.classList.add("fade-in");
        }
        btnLogin.disabled = true;

        await signInWithEmailAndPassword(auth, email, password);
        loginPasswordInput.value = "";
      } catch (e) {
        console.error(e);
        authErrorEl.textContent = "ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ ุฃู ุญุฏุซ ุฎุทุฃ.";
      } finally {
        // hide processing UI
        if (loginProcessingBar) {
          loginProcessingBar.classList.remove("fade-in");
          loginProcessingBar.classList.add("fade-out");
          setTimeout(() => {
            if (loginProcessingBar) {
              loginProcessingBar.style.display = "none";
              loginProcessingBar.classList.remove("fade-out");
            }
          }, 320);
        }
        btnLogin.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        filterState = {
          search: "",
          category: "all",
          hasImageOnly: false,
        };
        currentUser = null;
        userRef = null;

        try { localStorage.removeItem(LAST_UID_KEY); } catch (e) {}

        await signOut(auth);
      } catch (e) {
        console.error(e);
        alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุณุฌูู ุงูุฎุฑูุฌ.");
      }
    });

    /* ======= ุชุจููุจุงุช ======= */

    /* ======= ุงููุณู ุงููุญูู (ููุงุญุธุงุชู ูุงูุญุณุงุจุงุช) ======= */

    function loadPrivateState() {
      const key = getStorageKey();
      const savedPrivate = localStorage.getItem(key + "_private");
      if (savedPrivate) {
        try {
          const loaded = JSON.parse(savedPrivate);
          privateState = {
            ...privateState,
            ...loaded
          };
        } catch (e) {
          console.warn("Failed to load private state:", e);
        }
      }
      privateState.isUnlocked = false;
      resetPrivateUI();
      populateBudgetMonthSelects();
      updatePrivateSummary();
      
      // ุงุณุชุนุงุฏุฉ ุงูุจูุงูุงุช ูู ุงูุญููู
      totalBalanceInput.value = formatNumber(privateState.totalBalance || 0);
      if (privateState.budgetFromMonth && budgetFromMonth) {
        budgetFromMonth.value = privateState.budgetFromMonth;
      }
      if (privateState.budgetToMonth && budgetToMonth) {
        budgetToMonth.value = privateState.budgetToMonth;
      }
      if (privateNotes) {
        privateNotes.value = privateState.notes || "";
        if (privateState.lastNotesUpdate && privateNotesLastUpdate) {
          privateNotesLastUpdate.textContent = `ุขุฎุฑ ุญูุธ: ${privateState.lastNotesUpdate}`;
        }
      }
      if (pinEnabledToggle) {
        pinEnabledToggle.checked = privateState.pinEnabled !== false;
      }
    }

    function savePrivateState() {
      const key = getStorageKey();
      localStorage.setItem(key + "_private", JSON.stringify(privateState));
    }

    function resetPrivateUI() {
      privatePinInput.value = "";
      privateErrorMsg.textContent = "";
      calcResult.textContent = "ุงูุชุธุฑ ุงูุญุณุงุจ...";
      
      // ุฅุฐุง ูุงู PIN ูุนุทููุ ูุชุญ ูุจุงุดุฑุฉ
      if (!privateState.pinEnabled) {
        privateSection.style.display = "none";
        privateContent.style.display = "flex";
        privateState.isUnlocked = true;
      } else {
        // ุฅุฐุง ูุงู PIN ููุนููุ ุฃุธูุฑ ุดุงุดุฉ ุงูููู
        privateSection.style.display = "flex";
        privateContent.style.display = "none";
        privateState.isUnlocked = false;
      }
    }

    function populateBudgetMonthSelects() {
      budgetFromMonth.innerHTML = "";
      budgetToMonth.innerHTML = "";

      state.months.forEach((m) => {
        const optFrom = document.createElement("option");
        optFrom.value = m.id;
        optFrom.textContent = `${m.name} ${m.year}`;
        budgetFromMonth.appendChild(optFrom);

        const optTo = document.createElement("option");
        optTo.value = m.id;
        optTo.textContent = `${m.name} ${m.year}`;
        budgetToMonth.appendChild(optTo);
      });

      if (state.months.length > 0) {
        budgetFromMonth.value = state.months[0].id;
        budgetToMonth.value = state.months[state.months.length - 1].id;
      }
    }

    function unlockPrivateSection() {
      // ุฅุฐุง ูุงู ุงูููู ูุนุทููุ ูุชุญ ูุจุงุดุฑุฉ
      if (!privateState.pinEnabled) {
        privateState.isUnlocked = true;
        privateSection.style.display = "none";
        privateContent.style.display = "flex";
        updatePrivateSummary();
        renderAllocations();
        // ุฅุฎูุงุก ุงูููุจูุฑุฏ ุจุฅุฒุงูุฉ ุงูุชุฑููุฒ ูุคูุชุงู
        document.activeElement.blur();
        setTimeout(() => {
          calcInput.focus();
        }, 300);
        return;
      }

      const pin = privatePinInput.value.trim();
      privateErrorMsg.textContent = "";

      if (!pin) {
        privateErrorMsg.textContent = "ุฃุฏุฎู ุฑูู PIN";
        return;
      }

      if (pin !== privateState.pinCode) {
        privateErrorMsg.textContent = "โ ุฑูู PIN ุบูุฑ ุตุญูุญ";
        privatePinInput.value = "";
        privatePinInput.focus();
        return;
      }

      privateState.isUnlocked = true;
      privateSection.style.display = "none";
      privateContent.style.display = "flex";
      updatePrivateSummary();
      renderAllocations();
      // ุฅุฎูุงุก ุงูููุจูุฑุฏ ุจุฅุฒุงูุฉ ุงูุชุฑููุฒ ูุคูุชุงู
      document.activeElement.blur();
      setTimeout(() => {
        calcInput.focus();
      }, 300);
    }

    function lockPrivateSection() {
      privateState.isUnlocked = false;
      resetPrivateUI();
    }

    function updatePrivateSummary() {
      const fromMonthId = budgetFromMonth?.value || null;
      const toMonthId = budgetToMonth?.value || null;

      let totalExp = 0;
      let countedMonths = 0;

      if (fromMonthId && toMonthId) {
        const months = state.months.map(m => m.id);
        const fromIdx = months.indexOf(fromMonthId);
        const toIdx = months.indexOf(toMonthId);

        if (fromIdx !== -1 && toIdx !== -1) {
          const start = Math.min(fromIdx, toIdx);
          const end = Math.max(fromIdx, toIdx);

          for (let i = start; i <= end; i++) {
            const m = state.months[i];
            if (Array.isArray(m.expenses)) {
              m.expenses.forEach((e) => {
                totalExp += (e.amount || 0);
              });
            }
            countedMonths++;
          }
        }
      }

      privateTotalExpenses.textContent = formatNumber(totalExp);
      privateAllMonthsCount.textContent = countedMonths;

      const totalBal = parseFormattedNumber(totalBalanceInput.value || "0");
      const remaining = totalBal - totalExp;
      privateActualRemaining.textContent = formatNumber(remaining);
      privateActualRemaining.parentElement.className = "budget-stat-value " + (remaining >= 0 ? "success" : "danger");
    }

    function renderAllocations() {
      budgetAllocationsContainer.innerHTML = "";
      
      privateState.allocations.forEach((alloc, idx) => {
        const item = document.createElement("div");
        item.className = "allocation-item";
        item.style.animationDelay = (idx * 0.05) + "s";

        const inputs = document.createElement("div");
        inputs.className = "allocation-inputs";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "form-input form-input-sm";
        nameInput.value = alloc.name;
        nameInput.placeholder = "ุงุณู ุงููุฆุฉ";
        nameInput.addEventListener("change", () => {
          privateState.allocations[idx].name = nameInput.value;
          savePrivateState();
        });

        const amountInput = document.createElement("input");
        amountInput.type = "text";
        amountInput.inputMode = "numeric";
        amountInput.className = "form-input form-input-sm";
        amountInput.value = formatNumber(alloc.amount);
        amountInput.placeholder = "0";
        amountInput.addEventListener("input", () => {
          const digits = amountInput.value.replace(/\D/g, "");
          amountInput.value = formatNumber(digits);
          amountInput.selectionEnd = amountInput.value.length;
          privateState.allocations[idx].amount = parseFormattedNumber(amountInput.value);
          savePrivateState();
          updateAllocationResult(idx);
        });

        inputs.appendChild(nameInput);
        inputs.appendChild(amountInput);

        const resultDiv = document.createElement("div");
        resultDiv.className = "allocation-result";
        const resultLabel = document.createElement("div");
        resultLabel.className = "allocation-result-label";
        resultLabel.textContent = "ูุชุจูู";
        const resultValue = document.createElement("div");
        resultValue.className = "allocation-result-value";
        resultValue.id = "alloc-result-" + alloc.id;
        resultValue.textContent = "0";
        resultDiv.appendChild(resultLabel);
        resultDiv.appendChild(resultValue);

        const removeBtn = document.createElement("button");
        removeBtn.className = "allocation-remove-btn";
        removeBtn.textContent = "ุญุฐู";
        removeBtn.addEventListener("click", () => {
          privateState.allocations.splice(idx, 1);
          savePrivateState();
          renderAllocations();
        });

        item.appendChild(inputs);
        item.appendChild(resultDiv);
        item.appendChild(removeBtn);

        budgetAllocationsContainer.appendChild(item);
      });

      // ุชุญุฏูุซ ุงููุชุงุฆุฌ
      privateState.allocations.forEach((_, idx) => updateAllocationResult(idx));
    }

    function updateAllocationResult(idx) {
      const totalBal = parseFormattedNumber(totalBalanceInput.value || "0");
      const totalUsed = privateState.allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
      const remaining = totalBal - totalUsed;

      const resultEl = document.getElementById("alloc-result-" + privateState.allocations[idx].id);
      if (resultEl) {
        resultEl.textContent = formatNumber(remaining);
        resultEl.parentElement.style.color = remaining >= 0 ? "#10b981" : "#ef4444";
      }
    }

    function evaluateExpression(expr) {
      try {
        const sanitized = expr.trim()
          .replace(/[^\d+\-*/.()]/g, "")
          .replace(/\d+/g, (match) => match)
          .trim();

        if (!sanitized) return "ุฃุฏุฎู ูุนุงุฏูุฉ";

        if (!/^[\d+\-*/.()]+$/.test(sanitized)) {
          return "ูุนุงุฏูุฉ ุบูุฑ ุตุญูุญุฉ";
        }

        const result = new Function(`"use strict"; return (${sanitized})`)();
        
        if (typeof result !== "number" || !isFinite(result)) {
          return "ุฎุทุฃ ูู ุงูุญุณุงุจ";
        }

        return formatNumber(Math.round(result * 100) / 100);
      } catch (e) {
        return "ุฎุทุฃ: " + (e.message || "ูุนุงุฏูุฉ ุบูุฑ ุตุญูุญุฉ");
      }
    }

    function updateCalculator() {
      const expr = calcInput.value;
      if (!expr) {
        calcResult.textContent = "ุงูุชุธุฑ ุงูุญุณุงุจ...";
        return;
      }
      const result = evaluateExpression(expr);
      calcResult.textContent = result;
    }

    function openChangePinDialog() {
      const newPin = prompt("ุฃุฏุฎู ุฑูู PIN ุฌุฏูุฏ (4-6 ุฃุฑูุงู):");
      if (!newPin) return;

      if (!/^\d{4,6}$/.test(newPin)) {
        alert("ุฑูู PIN ูุฌุจ ุฃู ูููู 4-6 ุฃุฑูุงู ููุท");
        return;
      }

      privateState.pinCode = newPin;
      savePrivateState();
      alert("โ ุชู ุชุญุฏูุซ ุฑูู PIN ุจูุฌุงุญ");
    }

    // ูุณุชูุนู ุฃุญุฏุงุซ ุงููุณู ุงููุญูู
    if (btnOpenPrivate) {
      btnOpenPrivate.addEventListener("click", unlockPrivateSection);
    }

    if (privatePinInput) {
      // ุชุตููุฉ ุงูุฃุฑูุงู ููุท ูู PIN input
      privatePinInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, "");
      });

      privatePinInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") unlockPrivateSection();
      });
    }

    if (btnPrivateLogout) {
      btnPrivateLogout.addEventListener("click", lockPrivateSection);
    }

    if (totalBalanceInput) {
      totalBalanceInput.addEventListener("input", () => {
        const digits = totalBalanceInput.value.replace(/\D/g, "");
        totalBalanceInput.value = formatNumber(digits);
        totalBalanceInput.selectionEnd = totalBalanceInput.value.length;
        updatePrivateSummary();
        privateState.totalBalance = parseFormattedNumber(totalBalanceInput.value);
        savePrivateState();
        renderAllocations();
      });
    }

    if (budgetFromMonth) {
      budgetFromMonth.addEventListener("change", () => {
        privateState.budgetFromMonth = budgetFromMonth.value;
        savePrivateState();
        updatePrivateSummary();
      });
    }

    if (budgetToMonth) {
      budgetToMonth.addEventListener("change", () => {
        privateState.budgetToMonth = budgetToMonth.value;
        savePrivateState();
        updatePrivateSummary();
      });
    }

    if (btnAddAllocation) {
      btnAddAllocation.addEventListener("click", () => {
        privateState.allocations.push({
          id: privateState.nextAllocationId++,
          name: "ูุฆุฉ ุฌุฏูุฏุฉ",
          amount: 0
        });
        savePrivateState();
        renderAllocations();
      });
    }

    if (calcInput) {
      calcInput.addEventListener("input", updateCalculator);
    }

    if (privateNotes) {
      privateNotes.addEventListener("input", () => {
        privateState.notes = privateNotes.value;
        privateState.lastNotesUpdate = new Date().toLocaleString("ar-EG");
        savePrivateState();
        if (privateNotesLastUpdate) {
          privateNotesLastUpdate.textContent = `ุขุฎุฑ ุญูุธ: ${privateState.lastNotesUpdate}`;
        }
      });
    }

    if (pinEnabledToggle) {
      pinEnabledToggle.addEventListener("change", () => {
        privateState.pinEnabled = pinEnabledToggle.checked;
        savePrivateState();
      });
    }

    if (btnChangePinCode) {
      btnChangePinCode.addEventListener("click", openChangePinDialog);
    }

    /* ======= ุชุจููุจุงุช ======= */

tabButtons.forEach((btn) => {
  btn.addEventListener("click", async () => {
    tabButtons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    if (tab === "month") {
      tabMonth.style.display = "block";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "flex";
    } else if (tab === "compare") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "block";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "none";
    } else if (tab === "private") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "block";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "none";
      loadPrivateState();
    } else if (tab === "admin") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "block";
      if (monthRow) monthRow.style.display = "none";

      // ุนูุฏ ูุชุญ ุชุจููุจ ููุญุฉ ุงูุชุญููุ ุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู
      await loadAdminUsers();
    }
  });
});


    /* ======= ุฅุญุตุงุฆูุงุช ูุชูุฏูุฉ ุทู/ูุชุญ ======= */

    advancedStatsToggle.addEventListener("click", () => {
      const isOpen = advancedStatsBody.classList.contains("open");
      if (isOpen) {
        advancedStatsBody.classList.remove("open");
        advancedStatsIcon.classList.remove("open");
      } else {
        advancedStatsBody.classList.add("open");
        advancedStatsIcon.classList.add("open");
      }
    });

    function refreshMonthSelect() {
      monthSelect.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "ูุง ููุฌุฏ ุฃุดูุฑ";
        monthSelect.appendChild(option);
        monthSelect.disabled = true;
        return;
      }
      monthSelect.disabled = false;
      state.months
        .slice()
        .sort((a, b) => a.year - b.year || a.month - b.month)
        .forEach((m) => {
          const option = document.createElement("option");
          option.value = m.id;
          option.textContent = `${m.name} ${m.year}`;
          monthSelect.appendChild(option);
        });
      if (!state.selectedMonthId) {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      monthSelect.value = state.selectedMonthId;
    }

    function renderSummary() {
      const month = getSelectedMonth();
      if (!month) {
        summarySalaryEl.textContent = "0";
        summaryExpensesEl.textContent = "0";
        summaryRemainingEl.textContent = "0";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const remaining = (month.salary || 0) - totalExpenses;

      summarySalaryEl.textContent = formatNumber(month.salary || 0);
      summaryExpensesEl.textContent = formatNumber(totalExpenses);
      summaryRemainingEl.textContent = formatNumber(remaining);

      summaryRemainingEl.classList.toggle("positive", remaining >= 0);
      summaryRemainingEl.classList.toggle("negative", remaining < 0);
    }

    function renderAdvancedStats() {
      const month = getSelectedMonth();
      categoryBars.innerHTML = "";
      if (!month) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "ูุง ููุฌุฏ";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "ูุง ููุฌุฏ";
        return;
      }

      const today = new Date();
      const year = month.year;
      const monthIndex = month.month - 1;
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
      const nowMonth = today.getMonth();
      const nowYear = today.getFullYear();

      let daysPassed;
      if (nowMonth === monthIndex && nowYear === year) {
        daysPassed = today.getDate();
      } else {
        daysPassed = daysInMonth;
      }

      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const dailyAvg =
        daysPassed > 0 ? Math.round(totalExpenses / daysPassed) : totalExpenses;
      dailyAvgEl.textContent = formatNumber(dailyAvg);

      const remaining = (month.salary || 0) - totalExpenses;
      const daysRemaining =
        daysInMonth - (nowMonth === monthIndex && nowYear === year ? today.getDate() : daysInMonth);
      const remainingPerDay =
        daysRemaining > 0 ? Math.round(remaining / daysRemaining) : remaining;
      remainingPerDayEl.textContent = formatNumber(remainingPerDay);

      const maxExpense = expenses.reduce(
        (max, e) => (e.amount > max.amount ? e : max),
        expenses[0]
      );
      maxExpenseEl.textContent = `${formatNumber(maxExpense.amount || 0)} (${maxExpense.title || "ูุตุฑูู"})`;

      const categoryTotals = {};
      expenses.forEach((e) => {
        const cat = e.category || "ุฃุฎุฑู";
        categoryTotals[cat] = (categoryTotals[cat] || 0) + (e.amount || 0);
      });

      let topCategory = "ูุง ููุฌุฏ";
      let topTotal = 0;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        if (total > topTotal) {
          topTotal = total;
          topCategory = cat;
        }
      });
      topCategoryEl.textContent = `${topCategory} (${formatNumber(topTotal)})`;

      const maxCatTotal = Math.max(...Object.values(categoryTotals)) || 1;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        const item = document.createElement("div");
        item.className = "category-bar";

        const top = document.createElement("div");
        top.className = "category-bar-top";
        const nameEl = document.createElement("span");
        nameEl.textContent = cat;
        const amountEl = document.createElement("span");
        amountEl.textContent = formatNumber(total);
        top.appendChild(nameEl);
        top.appendChild(amountEl);

        const bg = document.createElement("div");
        bg.className = "category-bar-bg";

        const fill = document.createElement("div");
        fill.className = "category-bar-fill";
        fill.style.width = (total / maxCatTotal) * 100 + "%";

        bg.appendChild(fill);
        item.appendChild(top);
        item.appendChild(bg);
        categoryBars.appendChild(item);
      });
    }

    function applyFilters(expenses) {
      const search = filterState.search.toLowerCase();
      const category = filterState.category;
      const hasImageOnly = filterState.hasImageOnly;

      return expenses.filter((e) => {
        if (category !== "all" && e.category !== category) return false;
        if (
          search &&
          !(
            (e.title || "").toLowerCase().includes(search) ||
            (e.note || "").toLowerCase().includes(search)
          )
        ) {
          return false;
        }
        if (hasImageOnly && !e.imageDataUrl) return false;
        return true;
      });
    }

    function renderExpenses() {
      const month = getSelectedMonth();
      expenseList.innerHTML = "";
      filterSummaryEl.textContent = "";

      if (!month) {
        expenseList.innerHTML =
          '<div class="empty-state">ุฃุถู ุดูุฑูุง ุซู ุฃุถู ูุตุงุฑูู ูุนุฑุถูุง ููุง.</div>';
        return;
      }

      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">ูุง ุชูุฌุฏ ูุตุงุฑูู ููุฐุง ุงูุดูุฑ ุจุนุฏ.</div>';
        return;
      }

      const sorted = expenses
        .slice()
        .sort((a, b) => b.id - a.id);

      const filtered = applyFilters(sorted);

      if (filtered.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">ูุง ุชูุฌุฏ ูุตุงุฑูู ูุทุงุจูุฉ ูุฎูุงุฑุงุช ุงูุจุญุซ/ุงูููุชุฑุฉ.</div>';
      } else {
        filtered.forEach((e) => {
          const item = document.createElement("div");
          item.className = "expense-item";

          const main = document.createElement("div");
          main.className = "expense-main";

          const title = document.createElement("div");
          title.className = "expense-title";
          title.textContent = e.title || "ุจุฏูู ุนููุงู";

          const meta = document.createElement("div");
          meta.className = "expense-meta";
          const catSpan = document.createElement("span");
          catSpan.textContent = e.category || "ุบูุฑ ูุญุฏุฏ";
          const dateSpan = document.createElement("span");
          dateSpan.textContent = e.date || "ุจุฏูู ุชุงุฑูุฎ";
          meta.appendChild(catSpan);
          meta.appendChild(document.createTextNode(" ยท "));
          meta.appendChild(dateSpan);

          const note = document.createElement("div");
          note.className = "expense-note";
          note.textContent = e.note || "";

          main.appendChild(title);
          main.appendChild(meta);
          if (e.note) main.appendChild(note);

          if (e.imageDataUrl) {
            const imgBadge = document.createElement("div");
            imgBadge.className = "expense-image-badge";
            imgBadge.textContent = "๐ท ุชูุฌุฏ ุตูุฑุฉ";
            main.appendChild(imgBadge);

            const img = document.createElement("img");
            img.src = e.imageDataUrl;
            img.alt = "ุตูุฑุฉ ุงููุตุฑูู";
            img.className = "expense-thumb";
            img.addEventListener("click", () => {
              imageModalView.src = e.imageDataUrl;
              modalImage.style.display = "flex";
            });
            main.appendChild(img);
          }

          const actions = document.createElement("div");
          actions.className = "expense-actions";
          const editBtn = document.createElement("button");
          editBtn.className = "btn-ghost btn-edit";
          editBtn.textContent = "โ๏ธ ุชุนุฏูู";
          editBtn.addEventListener("click", () => openExpenseModal(e.id));

          const delBtn = document.createElement("button");
          delBtn.className = "btn-ghost btn-delete";
          delBtn.textContent = "๐๏ธ ุญุฐู";
          delBtn.addEventListener("click", () => deleteExpense(e.id));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          main.appendChild(actions);

          const amountContainer = document.createElement("div");
          amountContainer.className = "expense-amount-container";

          const amountBadge = document.createElement("div");
          amountBadge.className = "expense-amount-badge";
          amountBadge.textContent = "๐ฐ";

          const amount = document.createElement("div");
          amount.className = "expense-amount";
          amount.textContent = formatNumber(e.amount || 0);

          amountContainer.appendChild(amountBadge);
          amountContainer.appendChild(amount);
          item.appendChild(main);
          item.appendChild(amountContainer);
          expenseList.appendChild(item);
        });
      }

      if (filterState.category !== "all") {
        const catTotal = filtered.reduce((sum, e) => sum + (e.amount || 0), 0);
        filterSummaryEl.textContent =
          "ุฅุฌูุงูู ูุฆุฉ " +
          filterState.category +
          ": " +
          formatNumber(catTotal);
      }
    }
async function loadAllUsersForAdmin() {
  adminUsersContainer.innerHTML = "<p>ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>";

  const usersSnap = await get(ref(db, "users"));
  if (!usersSnap.exists()) {
    adminUsersContainer.innerHTML = "<p>ูุง ููุฌุฏ ูุณุชุฎุฏููู.</p>";
    return;
  }

  const users = usersSnap.val();
  adminUsersContainer.innerHTML = "";

  Object.keys(users).forEach(uid => {
    const userData = users[uid];

    const profile = userData.profile || {};
    const state = userData.state || {};
    const months = state.months || [];

    let totalExpenses = 0;
    months.forEach(m => {
      if (Array.isArray(m.expenses)) {
        m.expenses.forEach(e => totalExpenses += (e.amount || 0));
      }
    });

    const totalSalaries = months.reduce((acc, m) => acc + (m.salary || 0), 0);

    const card = document.createElement("div");
    card.className = "admin-user-card";

    card.innerHTML = `
      <h3>${profile.email || "ุจุฏูู ุจุฑูุฏ"}</h3>
      <p><strong>ุงููุณุชุฎุฏู:</strong> ${uid}</p>
      <p><strong>ุนุฏุฏ ุงูุฃุดูุฑ:</strong> ${months.length}</p>
      <p><strong>ุฅุฌูุงูู ุงูุฑูุงุชุจ:</strong> ${formatNumber(totalSalaries)}</p>
      <p><strong>ุฅุฌูุงูู ุงููุตุงุฑูู:</strong> ${formatNumber(totalExpenses)}</p>
      <p><strong>ุงููุชุจูู:</strong> ${formatNumber(totalSalaries - totalExpenses)}</p>
    `;

    adminUsersContainer.appendChild(card);
  });
}

    function renderComparison() {
      // helper: deterministic color palette for categories
      function getCategoryColor(cat, i) {
        const palette = [
          "#2563eb",
          "#4f46e5",
          "#06b6d4",
          "#10b981",
          "#f59e0b",
          "#ef4444",
          "#8b5cf6",
          "#ec4899",
          "#0ea5b3",
          "#f97316",
        ];
        if (!cat) return palette[i % palette.length];
        // simple hash to pick color for category name consistently
        let h = 0;
        for (let j = 0; j < cat.length; j++) h = (h << 5) - h + cat.charCodeAt(j);
        const idx = Math.abs(h) % palette.length;
        return palette[idx];
      }

      compareContainer.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        compareContainer.innerHTML =
          '<div class="empty-state">ุฃุถู ุดูุฑุงู ูุงุญุฏุงู ุนูู ุงูุฃูู ูุนุฑุถ ุงูููุงุฑูุฉ.</div>';
        return;
      }

      const monthsSorted = state.months
        .slice()
        .sort((a, b) => b.year - a.year || b.month - a.month);

      // collect category list across months
      const allCategories = new Set();
      monthsSorted.forEach((m) => {
        (m.expenses || []).forEach((e) => allCategories.add(e.category || "ุฃุฎุฑู"));
      });
      const categories = Array.from(allCategories.length ? allCategories : state.categories);

      // totals per month and per-category
      const monthData = monthsSorted.map((m) => {
        const expenses = Array.isArray(m.expenses) ? m.expenses : [];
        const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const catTotals = {};
        categories.forEach((c) => (catTotals[c] = 0));
        expenses.forEach((e) => {
          const cat = e.category || "ุฃุฎุฑู";
          catTotals[cat] = (catTotals[cat] || 0) + (e.amount || 0);
        });
        return {
          id: m.id,
          label: `${m.name} ${m.year}`,
          year: m.year,
          month: m.month,
          salary: m.salary || 0,
          total,
          remaining: (m.salary || 0) - total,
          catTotals,
        };
      });

      const maxTotal = Math.max(...monthData.map((d) => d.total), 1);

      // build header summary card
      const grid = document.createElement("div");
      grid.className = "compare-grid";

      const topCard = document.createElement("div");
      topCard.className = "compare-card";
      topCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>ููุงุฑูุฉ ุงูุฃุดูุฑ</h3><div class="compare-meta">` +
        `<div>ุฃุดูุฑ: ${monthData.length}</div>` +
        `<div>ุชุตูููุงุช ููุญูุตุฉ: ${categories.length}</div>` +
        `</div></div>`;

      // legend for categories (show top few)
      const legend = document.createElement("div");
      legend.className = "category-legend";
      categories.slice(0, 8).forEach((c, i) => {
        const li = document.createElement("div");
        li.className = "legend-item";
        const sw = document.createElement("span");
        sw.className = "legend-swatch";
        sw.style.background = getCategoryColor(c, i);
        li.appendChild(sw);
        const txt = document.createElement("span");
        txt.textContent = c;
        li.appendChild(txt);
        legend.appendChild(li);
      });
      topCard.appendChild(legend);
      grid.appendChild(topCard);

      // create a compare card per month with bar and small table of top categories
      monthData.forEach((d) => {
        const card = document.createElement("div");
        card.className = "compare-card";

        const row = document.createElement("div");
        row.className = "compare-row";

        const left = document.createElement("div");
        left.style.flex = "1";
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = d.label;
        const meta = document.createElement("div");
        meta.className = "compare-meta";
        meta.innerHTML = `ุงูุฑุงุชุจ: ${formatNumber(d.salary)} ยท ุงููุตุงุฑูู: ${formatNumber(d.total)} ยท ุงููุชุจูู: ${formatNumber(d.remaining)}`;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.width = "140px";
        right.style.textAlign = "right";
        right.innerHTML = `<div style="font-weight:700;color:#2563eb">${formatNumber(d.total)}</div>` +
          `<div style="font-size:12px;color:var(--subtext-color)">ุงููุชุจูู: ${formatNumber(d.remaining)}</div>`;

        row.appendChild(left);
        row.appendChild(right);

        // stacked bar showing category breakdown
        const stacked = document.createElement("div");
        stacked.className = "stacked-bar";
        if (d.total <= 0) {
          const emptySeg = document.createElement("div");
          emptySeg.className = "stacked-seg";
          emptySeg.style.width = "100%";
          emptySeg.style.background = "linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02))";
          stacked.appendChild(emptySeg);
        } else {
          Object.entries(d.catTotals).forEach(([cat, amt], ci) => {
            const pct = d.total > 0 ? (amt / d.total) * 100 : 0;
            const seg = document.createElement("div");
            seg.className = "stacked-seg";
            seg.style.width = pct > 0 ? pct + "%" : "0%";
            seg.style.background = getCategoryColor(cat, ci);
            seg.title = `${cat}: ${formatNumber(amt)} (${Math.round(pct)}%)`;
            stacked.appendChild(seg);
          });
        }

        card.appendChild(row);
        card.appendChild(stacked);

        // add small table of top 4 categories
        const catEntries = Object.entries(d.catTotals).sort((a, b) => b[1] - a[1]);
        const table = document.createElement("table");
        table.className = "compare-table";
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr><th>ุงูุชุตููู</th><th>ุงููุจูุบ</th><th>ุงููุณุจุฉ</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        const top4 = catEntries.slice(0, 4);
        top4.forEach(([cat, amt]) => {
          const tr = document.createElement("tr");
          const pct = maxTotal > 0 ? Math.round((amt / d.total) * 100) : 0;
          tr.innerHTML = `<td>${cat}</td><td>${formatNumber(amt)}</td><td>${pct}%</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);

        grid.appendChild(card);
      });

      compareContainer.appendChild(grid);
    }

    /* ======= ุงูุชุตูููุงุช ======= */

    function renderCategoryOptions() {
      expenseCategoryInput.innerHTML = "";
      filterCategory.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "ูู ุงูุชุตูููุงุช";
      filterCategory.appendChild(allOpt);

      state.categories.forEach((cat) => {
        const opt1 = document.createElement("option");
        opt1.value = cat;
        opt1.textContent = cat;
        expenseCategoryInput.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = cat;
        opt2.textContent = cat;
        filterCategory.appendChild(opt2);
      });
    }

    function renderCategoryList() {
      categoryList.innerHTML = "";
      state.categories.forEach((cat, index) => {
        const chip = document.createElement("span");
        chip.className = "category-chip";
        chip.draggable = true;
        chip.dataset.index = index;

        const name = document.createElement("span");
        name.textContent = cat;
        name.style.flex = "1";
        chip.appendChild(name);

        const controls = document.createElement("div");
        controls.className = "category-chip-controls";

        if (index > 0) {
          const upBtn = document.createElement("button");
          upBtn.textContent = "โ";
          upBtn.title = "ุชุญุฑูู ูุฃุนูู";
          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index - 1];
            state.categories[index - 1] = temp;
            refreshUI();
          });
          controls.appendChild(upBtn);
        }

        if (index < state.categories.length - 1) {
          const downBtn = document.createElement("button");
          downBtn.textContent = "โ";
          downBtn.title = "ุชุญุฑูู ูุฃุณูู";
          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index + 1];
            state.categories[index + 1] = temp;
            refreshUI();
          });
          controls.appendChild(downBtn);
        }

        if (state.categories.length > 1) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "โ";
          delBtn.title = "ุญุฐู ุงูุชุตููู";
          delBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!confirm("ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุชุตูููุ")) return;
            state.categories.splice(index, 1);
            refreshUI();
          });
          controls.appendChild(delBtn);
        }

        chip.appendChild(controls);

        chip.addEventListener("dragstart", (e) => {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/html", chip.innerHTML);
          chip.classList.add("dragging");
        });

        chip.addEventListener("dragend", () => {
          chip.classList.remove("dragging");
        });

        chip.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        chip.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedIndex = parseInt(
            document.querySelector(".category-chip.dragging")?.dataset.index || -1
          );
          if (draggedIndex !== -1 && draggedIndex !== index) {
            const temp = state.categories[draggedIndex];
            state.categories[draggedIndex] = state.categories[index];
            state.categories[index] = temp;
            refreshUI();
          }
        });

        categoryList.appendChild(chip);
      });
    }

    btnAddCategory.addEventListener("click", async () => {
      const name = newCategoryInput.value.trim();
      if (!name) return;
      if (state.categories.includes(name)) {
        alert("ูุฐุง ุงูุชุตููู ููุฌูุฏ ุจุงููุนู.");
        return;
      }
      state.categories.push(name);
      newCategoryInput.value = "";
      await refreshUI();
    });

    expenseCategoryInput.addEventListener("change", () => {
      const categoryError = document.getElementById("categoryError");
      if (expenseCategoryInput.value && expenseCategoryInput.value.trim() !== "") {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }
    });

    /* ======= Month Modal ======= */

    function openMonthModal(edit = false) {
      const now = new Date();
      const currentMonth = getSelectedMonth();
      if (edit && currentMonth) {
        editingMonthId = currentMonth.id;
        modalMonthTitle.textContent = "ุชุนุฏูู ุงูุดูุฑ";
        monthInput.value = String(currentMonth.month);
        yearInput.value = currentMonth.year;
        salaryInput.value = formatNumber(currentMonth.salary || 0);
        deleteMonthBtn.style.display = "inline-flex";
      } else {
        editingMonthId = null;
        modalMonthTitle.textContent = "ุฅุถุงูุฉ ุดูุฑ ุฌุฏูุฏ";
        monthInput.value = String(now.getMonth() + 1);
        yearInput.value = now.getFullYear();
        salaryInput.value = "";
        deleteMonthBtn.style.display = "none";
      }
      modalMonth.style.display = "flex";
    }

    function closeMonthModal() {
      modalMonth.style.display = "none";
    }

    btnAddMonth.addEventListener("click", () => openMonthModal(false));
    btnEditMonth.addEventListener("click", () => {
      if (!getSelectedMonth()) openMonthModal(false);
      else openMonthModal(true);
    });

    salaryInput.addEventListener("input", () => {
      const digits = salaryInput.value.replace(/\D/g, "");
      salaryInput.value = formatNumber(digits);
      salaryInput.selectionEnd = salaryInput.value.length;
    });

    btnCancelMonth.addEventListener("click", closeMonthModal);
    btnCloseMonth.addEventListener("click", closeMonthModal);

    deleteMonthBtn.addEventListener("click", async () => {
      if (!editingMonthId) return;
      if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุดูุฑ ูุฌููุน ูุตุงุฑูููุ")) return;
      const idx = state.months.findIndex((m) => m.id === editingMonthId);
      if (idx !== -1) state.months.splice(idx, 1);
      if (state.months.length === 0) {
        state.selectedMonthId = null;
      } else {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    saveMonthBtn.addEventListener("click", async () => {
      const monthNum = parseInt(monthInput.value, 10);
      const yearNum = parseInt(yearInput.value, 10);
      const salary = parseFormattedNumber(salaryInput.value);

      if (!yearNum || yearNum < 1900) {
        alert("ูู ูุถูู ุฃุฏุฎู ุณูุฉ ุตุญูุญุฉ.");
        return;
      }
      if (!monthNum || monthNum < 1 || monthNum > 12) {
        alert("ูู ูุถูู ุงุฎุชุฑ ุดูุฑูุง ุตุญูุญูุง.");
        return;
      }

      const id = generateMonthId(yearNum, monthNum);
      const name = monthNames[monthNum];

      if (editingMonthId) {
        const existing = state.months.find((m) => m.id === editingMonthId);
        if (!existing) return;
        if (editingMonthId !== id) {
          const conflict = state.months.find((m) => m.id === id);
          if (conflict) {
            alert("ููุฌุฏ ุดูุฑ ุจููุณ ุงูุชุงุฑูุฎ ุจุงููุนู.");
            return;
          }
        }
        existing.year = yearNum;
        existing.month = monthNum;
        existing.name = name;
        existing.salary = salary;
        existing.id = id;
        state.selectedMonthId = id;
      } else {
        const exists = state.months.find((m) => m.id === id);
        if (exists) {
          alert("ูุฐุง ุงูุดูุฑ ููุฌูุฏ ูุณุจููุง. ุงูุชุญู ูู ุงููุงุฆูุฉ ูุชุนุฏููู.");
          return;
        }
        state.months.push({
          id,
          year: yearNum,
          month: monthNum,
          name,
          salary,
          expenses: [],
        });
        state.selectedMonthId = id;
      }

      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    monthSelect.addEventListener("change", async (e) => {
      state.selectedMonthId = e.target.value || null;
      await refreshUI();
    });

    modalMonth.addEventListener("click", (e) => {
      if (e.target === modalMonth) closeMonthModal();
    });

    /* ======= Expense Modal ======= */

    function openExpenseModal(expenseId = null) {
      isSavingExpense = false; // ุฅุนุงุฏุฉ ุชุนููู ุงูุนูู ุนูุฏ ูุชุญ ุงูู Modal
      const month = getSelectedMonth();
      if (!month) {
        alert("ูู ูุถูู ุฃุถู ุดูุฑูุง ุฃููุงู.");
        return;
      }
      if (expenseId) {
        const exp = (month.expenses || []).find((e) => e.id === expenseId);
        if (!exp) return;
        editingExpenseId = expenseId;
        expenseModalTitle.textContent = "ุชุนุฏูู ูุตุฑูู";
        expenseTitleInput.value = exp.title || "";
        expenseAmountInput.value = formatNumber(exp.amount || 0);
        expenseCategoryInput.value = exp.category || state.categories[0];
        expenseDateInput.value = exp.date || "";
        expenseNoteInput.value = exp.note || "";
        expenseImageInput.value = "";
        // ุนุฑุถ ูุนุงููุฉ ุงูุตูุฑุฉ ุงููุฏููุฉ ุฅู ูุฌุฏุช
        if (exp.imageDataUrl) {
          imagePreviewImg.src = exp.imageDataUrl;
          imagePreviewFilename.textContent = "ุตูุฑุฉ ููุฌูุฏุฉ";
          imagePreviewSize.textContent = "";
          imagePreviewContainer.classList.add("active");
        } else {
          imagePreviewContainer.classList.remove("active");
          imagePreviewImg.src = "";
        }
        deleteExpenseBtn.style.display = "inline-flex";
      } else {
        editingExpenseId = null;
        expenseModalTitle.textContent = "ุฅุถุงูุฉ ูุตุฑูู";
        expenseTitleInput.value = "";
        expenseAmountInput.value = "";
        expenseCategoryInput.value = state.categories[0];
        expenseDateInput.valueAsDate = new Date();
        expenseNoteInput.value = "";
        expenseImageInput.value = "";
        imagePreviewContainer.classList.remove("active");
        imagePreviewImg.src = "";
        deleteExpenseBtn.style.display = "none";
      }
      modalExpense.style.display = "flex";
    }

    function closeExpenseModal() {
      modalExpense.style.display = "none";
      // ุฅุฒุงูุฉ ูุนุงููุฉ ุงูุตูุฑุฉ ุนูุฏ ุงูุฅุบูุงู
      imagePreviewContainer.classList.remove("active");
      imagePreviewImg.src = "";
    }

    btnAddExpense.addEventListener("click", () => openExpenseModal(null));
    btnCancelExpense.addEventListener("click", closeExpenseModal);
    btnCloseExpense.addEventListener("click", closeExpenseModal);

    modalExpense.addEventListener("click", (e) => {
      if (e.target === modalExpense) closeExpenseModal();
    });

    expenseAmountInput.addEventListener("input", () => {
      const digits = expenseAmountInput.value.replace(/\D/g, "");
      expenseAmountInput.value = formatNumber(digits);
      expenseAmountInput.selectionEnd = expenseAmountInput.value.length;
    });

    // ูุนุงูุฌุฉ ูุนุงููุฉ ุงูุตูุฑ
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");
    const imagePreviewImg = document.getElementById("imagePreviewImg");
    const imagePreviewFilename = document.getElementById("imagePreviewFilename");
    const imagePreviewSize = document.getElementById("imagePreviewSize");
    const imagePreviewRemove = document.getElementById("imagePreviewRemove");

    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
    }

    // ุฏุงูุฉ ุถุบุท ุงูุตูุฑ ูุชูููู ุญุฌู ุงูุจูุงูุงุช ุงููููููุฉ
    function compressImage(dataUrl, maxWidth = 800, maxHeight = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = dataUrl;
        img.onload = function () {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // ุญุณุงุจ ุงูุฃุจุนุงุฏ ุงูุฌุฏูุฏุฉ ูุน ุงูุญูุงุธ ุนูู ุงููุณุจุฉ
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.onerror = () => resolve(dataUrl); // ุฅุฑุฌุงุน ุงูุฃุตู ูู ุญุงูุฉ ุงูุฎุทุฃ
      });
    }

    expenseImageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (event) {
          imagePreviewImg.src = event.target.result;
          imagePreviewFilename.textContent = file.name;
          imagePreviewSize.textContent = formatFileSize(file.size);
          imagePreviewContainer.classList.add("active");
        };
        reader.readAsDataURL(file);
      } else if (file) {
        alert("ูู ูุถูู ุงุฎุชุฑ ููู ุตูุฑุฉ ุตุญูุญ");
        expenseImageInput.value = "";
        imagePreviewContainer.classList.remove("active");
      }
    });

    imagePreviewRemove.addEventListener("click", (e) => {
      e.preventDefault();
      expenseImageInput.value = "";
      imagePreviewContainer.classList.remove("active");
      imagePreviewImg.src = "";
      imagePreviewFilename.textContent = "";
      imagePreviewSize.textContent = "";
    });

    async function deleteExpense(expenseId) {
      const month = getSelectedMonth();
      if (!month || !Array.isArray(month.expenses)) return;
      if (!confirm("ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุตุฑููุ")) return;
      const idx = month.expenses.findIndex((e) => e.id === expenseId);
      if (idx !== -1) {
        month.expenses.splice(idx, 1);
        await refreshUI();
      }
    }

    deleteExpenseBtn.addEventListener("click", async () => {
      if (!editingExpenseId) return;
      await deleteExpense(editingExpenseId);
      closeExpenseModal();
    });

    saveExpenseBtn.addEventListener("click", () => {
      // ููุน ุงูููุฑ ุงููุชูุฑุฑ
      if (isSavingExpense) return;
      isSavingExpense = true;

      const month = getSelectedMonth();
      const categoryError = document.getElementById("categoryError");

      if (!month) {
        alert("ูู ูุถูู ุฃุถู ุดูุฑูุง ุฃููุงู.");
        isSavingExpense = false;
        return;
      }
      if (!Array.isArray(month.expenses)) month.expenses = [];

      const title = expenseTitleInput.value.trim() || "ูุตุฑูู";
      const amount = parseFormattedNumber(expenseAmountInput.value);
      const category = expenseCategoryInput.value;
      const date = expenseDateInput.value || "";
      const note = expenseNoteInput.value.trim();

      if (!amount || amount <= 0) {
        alert("ูู ูุถูู ุฃุฏุฎู ูุจูุบูุง ุตุญูุญูุง.");
        isSavingExpense = false;
        return;
      }

      if (!category || category.trim() === "") {
        categoryError.style.display = "block";
        expenseCategoryInput.focus();
        expenseCategoryInput.style.borderColor = "var(--danger)";
        isSavingExpense = false;
        return;
      } else {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }

      const file = expenseImageInput.files[0];

      // ุฅุบูุงู ุงูู Modal ููุฑุงู ูุชุฌูุจ ุงูููุฑ ุงููุชูุฑุฑ
      closeExpenseModal();

      if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          let imageDataUrl = e.target.result;
          
          // ุถุบุท ุงูุตูุฑุฉ ุฅุฐุง ูุงูุช ูุจูุฑุฉ ุงูุญุฌู
          if (file.size > 500000) { // ุฃูุจุฑ ูู 500KB
            imageDataUrl = await compressImage(imageDataUrl, 800, 800, 0.7);
          }
          
          await saveExpenseObject(month, {
            id: editingExpenseId,
            title,
            amount,
            category,
            date,
            note,
            imageDataUrl,
          });
          isSavingExpense = false;
        };
        reader.readAsDataURL(file);
      } else {
        let imageDataUrl = null;
        if (editingExpenseId) {
          const existing = month.expenses.find((exp) => exp.id === editingExpenseId);
          imageDataUrl = existing ? existing.imageDataUrl || null : null;
        }
        saveExpenseObject(month, {
          id: editingExpenseId,
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        });
        isSavingExpense = false;
      }
    });

    async function saveExpenseObject(
      month,
      { id, title, amount, category, date, note, imageDataUrl }
    ) {
      if (!Array.isArray(month.expenses)) month.expenses = [];
      if (id) {
        const existing = month.expenses.find((e) => e.id === id);
        if (!existing) return;
        existing.title = title;
        existing.amount = amount;
        existing.category = category;
        existing.date = date;
        existing.note = note;
        existing.imageDataUrl = imageDataUrl;
      } else {
        month.expenses.push({
          id: Date.now().toString(),
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        });
      }
      editingExpenseId = null;
      await refreshUI();
    }

    /* ======= ููุชุฑุฉ ======= */

    searchInput.addEventListener("input", () => {
      filterState.search = searchInput.value;
      renderExpenses();
    });

    filterCategory.addEventListener("change", () => {
      filterState.category = filterCategory.value;
      renderExpenses();
    });

    filterHasImage.addEventListener("change", () => {
      filterState.hasImageOnly = filterHasImage.checked;
      renderExpenses();
    });

    /* ======= Image Modal ======= */

    modalImage.addEventListener("click", (e) => {
      if (e.target === modalImage) {
        modalImage.style.display = "none";
        imageModalView.src = "";
      }
    });

    /* ======= Theme ======= */

    btnToggleTheme.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(current === "light" ? "dark" : "light");
    });

    /* ======= ููุญุฉ ุงูุชุญูู: ุญุณุงุจ ุฅุญุตุงุฆูุงุช ุงููุณุชุฎุฏู ======= */

    function computeUserStats(userState) {
      const normalized = normalizeState(userState || {});
      const months = Array.isArray(normalized.months) ? normalized.months : [];
      let totalSalary = 0;
      let totalExpenses = 0;
      let expensesCount = 0;

      months.forEach((m) => {
        totalSalary += m.salary || 0;
        if (Array.isArray(m.expenses)) {
          expensesCount += m.expenses.length;
          m.expenses.forEach((ex) => {
            totalExpenses += ex.amount || 0;
          });
        }
      });

      const remaining = totalSalary - totalExpenses;
      return {
        monthsCount: months.length,
        totalSalary,
        totalExpenses,
        remaining,
        expensesCount,
      };
    }

    async function adminDeleteUserData(uid) {
      if (!firebaseEnabled || !db) {
        alert("ููุญุฉ ุงูุชุญูู ุชุชุทูุจ ุงุชุตุงูุงู ุจุงูุฅูุชุฑูุช.");
        return;
      }
      if (!confirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุจูุงูุงุช ูุฐุง ุงููุณุชุฎุฏู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุชุ")) {
        return;
      }
      try {
        await set(ref(db, "users/" + uid), null);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("ุชุนุฐุฑ ุญุฐู ุจูุงูุงุช ุงููุณุชุฎุฏู.");
      }
    }

    async function adminToggleUserDisabled(uid, currentlyDisabled) {
      if (!firebaseEnabled || !db) {
        alert("ููุญุฉ ุงูุชุญูู ุชุชุทูุจ ุงุชุตุงูุงู ุจุงูุฅูุชุฑูุช.");
        return;
      }
      const newValue = !currentlyDisabled;
      try {
        await set(ref(db, "users/" + uid + "/disabled"), newValue);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("ุชุนุฐุฑ ุชุบููุฑ ุญุงูุฉ ุงููุณุชุฎุฏู.");
      }
    }

    async function loadAdminUsers() {
      if (!firebaseEnabled || !db || !currentUser) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">ููุญุฉ ุงูุชุญูู ุชุชุทูุจ ุงุชุตุงูุงู ุจุงูุฅูุชุฑูุช ูFirebase.</div>';
        return;
      }
      if (currentUser.uid !== ADMIN_UID) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">ููุณุช ูุฏูู ุตูุงุญูุฉ ุนุฑุถ ููุญุฉ ุงูุชุญูู.</div>';
        return;
      }

      adminUsersContainer.innerHTML =
        '<div class="empty-state">ุฌุงุฑู ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู...</div>';

      try {
        const usersSnap = await get(ref(db, "users"));
        if (!usersSnap.exists()) {
          adminUsersContainer.innerHTML =
            '<div class="empty-state">ูุง ููุฌุฏ ุฃู ูุณุชุฎุฏููู ุจุนุฏ.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();

        usersSnap.forEach((userSnap) => {
          const uid = userSnap.key;
          const data = userSnap.val() || {};
          const stateData = data.state || {};
          const profile = data.profile || {};
          const disabled = !!data.disabled;
          const isOwner = uid === ADMIN_UID;

          const stats = computeUserStats(stateData);

          const card = document.createElement("div");
          card.className = "admin-user-card";

          // Header
          const header = document.createElement("div");
          header.className = "admin-user-header";

          const main = document.createElement("div");
          main.className = "admin-user-main";

          const emailEl = document.createElement("div");
          emailEl.className = "admin-user-email";
          emailEl.textContent = profile.email || "(ุจุฏูู ุจุฑูุฏ ูุญููุธ)";
          const uidEl = document.createElement("div");
          uidEl.className = "admin-user-uid";
          uidEl.textContent = "UID: " + uid;

          main.appendChild(emailEl);
          main.appendChild(uidEl);

          const badgesContainer = document.createElement("div");

          const statusBadge = document.createElement("span");
          statusBadge.className =
            "admin-badge " + (disabled ? "admin-badge-disabled" : "admin-badge-active");
          statusBadge.textContent = disabled ? "ูุนุทูู" : "ูุดุท";

          badgesContainer.appendChild(statusBadge);

          if (isOwner) {
            const ownerBadge = document.createElement("span");
            ownerBadge.className = "admin-badge admin-badge-admin";
            ownerBadge.textContent = "ูุงูู ุงููุธุงู";
            badgesContainer.appendChild(ownerBadge);
          }

          header.appendChild(main);
          header.appendChild(badgesContainer);

          // Summary stats
          const statsEl = document.createElement("div");
          statsEl.className = "admin-user-stats";

          function makeStat(labelText, valText) {
            const line = document.createElement("div");
            line.className = "admin-stat-line";
            const l = document.createElement("span");
            l.className = "admin-stat-label";
            l.textContent = labelText;
            const v = document.createElement("span");
            v.className = "admin-stat-value";
            v.textContent = valText;
            line.appendChild(l);
            line.appendChild(v);
            return line;
          }

          statsEl.appendChild(makeStat("ุฅุฌูุงูู ุงูุฑูุงุชุจ:", formatNumber(stats.totalSalary)));
          statsEl.appendChild(makeStat("ุฅุฌูุงูู ุงููุตุงุฑูู:", formatNumber(stats.totalExpenses)));
          statsEl.appendChild(makeStat("ุงููุชุจูู ุงูุฅุฌูุงูู:", formatNumber(stats.remaining)));
          statsEl.appendChild(makeStat("ุนุฏุฏ ุงูุฃุดูุฑ:", stats.monthsCount));
          statsEl.appendChild(makeStat("ุนุฏุฏ ุงููุตุงุฑูู:", stats.expensesCount));

          // Actions
          const actions = document.createElement("div");
          actions.className = "admin-user-actions";

          if (!isOwner) {
            const toggleBtn = document.createElement("button");
            toggleBtn.className = "btn-soft";
            toggleBtn.textContent = disabled ? "ุฅูุบุงุก ุงูุชุนุทูู" : "ุชุนุทูู ุงููุณุชุฎุฏู";
            toggleBtn.addEventListener("click", () => {
              adminToggleUserDisabled(uid, disabled);
            });
            actions.appendChild(toggleBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn-danger-soft";
            deleteBtn.textContent = "๐๏ธ ุญุฐู ุฌููุน ุงูุจูุงูุงุช";
            deleteBtn.addEventListener("click", () => {
              adminDeleteUserData(uid);
            });
            actions.appendChild(deleteBtn);
          } else {
            const infoOwner = document.createElement("div");
            infoOwner.className = "admin-note";
            infoOwner.textContent = "ูุง ูููู ุญุฐู ุฃู ุชุนุทูู ูุงูู ุงููุธุงู.";
            actions.appendChild(infoOwner);
          }

          card.appendChild(header);
          card.appendChild(statsEl);

          // Detailed months (+ expenses) view
          const monthsNormalized = normalizeState(stateData).months || [];
          const monthsSorted = monthsNormalized.slice().sort((a, b) => a.year - b.year || a.month - b.month);

          const monthsContainer = document.createElement("div");
          monthsContainer.className = "admin-user-months";

          if (monthsSorted.length === 0) {
            const empty = document.createElement("div");
            empty.className = "admin-note";
            empty.textContent = "ูุง ููุฌุฏ ุฃุดูุฑ ูุญููุธุฉ ููุฐุง ุงููุณุชุฎุฏู.";
            monthsContainer.appendChild(empty);
          } else {
            monthsSorted.forEach((m) => {
              const mItem = document.createElement("div");
              mItem.className = "admin-month-item";

              const mHeader = document.createElement("div");
              mHeader.className = "admin-month-header";
              const nameSpan = document.createElement("span");
              nameSpan.textContent = `${m.name} ${m.year}`;
              const statsSpan = document.createElement("span");
              const mTotal = (Array.isArray(m.expenses) ? m.expenses.reduce((s, e) => s + (e.amount || 0), 0) : 0);
              const mRemaining = (m.salary || 0) - mTotal;
              statsSpan.textContent = `ุงูุฑุงุชุจ: ${formatNumber(m.salary || 0)} ยท ุงููุตุงุฑูู: ${formatNumber(mTotal)} ยท ุงููุชุจูู: ${formatNumber(mRemaining)}`;
              mHeader.appendChild(nameSpan);
              mHeader.appendChild(statsSpan);

              const mExpenses = document.createElement("div");
              mExpenses.className = "admin-month-expenses";
              mExpenses.style.display = "none";

              // Toggle expand/collapse
              mHeader.addEventListener("click", () => {
                mExpenses.style.display = mExpenses.style.display === "none" ? "block" : "none";
              });

              // Expense rows
              const expensesArr = Array.isArray(m.expenses) ? m.expenses.slice().sort((a,b)=> (b.id||0)-(a.id||0)) : [];
              if (expensesArr.length === 0) {
                const emptyRow = document.createElement("div");
                emptyRow.className = "empty-state";
                emptyRow.textContent = "ูุง ุชูุฌุฏ ูุตุงุฑูู ููุฐุง ุงูุดูุฑ.";
                mExpenses.appendChild(emptyRow);
              } else {
                expensesArr.forEach((ex) => {
                  const row = document.createElement("div");
                  row.className = "admin-expense-row";

                  const left = document.createElement("div");
                  left.style.flex = "1";
                  const t = document.createElement("div");
                  t.textContent = ex.title || "ุจุฏูู ุนููุงู";
                  t.style.fontWeight = "600";
                  const meta = document.createElement("div");
                  meta.style.fontSize = "12px";
                  meta.style.color = "var(--subtext-color)";
                  meta.textContent = `${ex.category || 'ุบูุฑ ูุญุฏุฏ'} ยท ${ex.date || 'ุจุฏูู ุชุงุฑูุฎ'}`;
                  if (ex.note) {
                    const note = document.createElement("div");
                    note.style.fontSize = "12px";
                    note.textContent = ex.note;
                    left.appendChild(t);
                    left.appendChild(meta);
                    left.appendChild(note);
                  } else {
                    left.appendChild(t);
                    left.appendChild(meta);
                  }

                  const right = document.createElement("div");
                  right.style.minWidth = "110px";
                  right.style.textAlign = "right";
                  const amountEl = document.createElement("div");
                  amountEl.textContent = formatNumber(ex.amount || 0);
                  amountEl.style.fontWeight = "700";
                  amountEl.style.color = "#2563eb";

                  right.appendChild(amountEl);

                  if (ex.imageDataUrl) {
                    const img = document.createElement("img");
                    img.src = ex.imageDataUrl;
                    img.alt = "ุตูุฑุฉ ุงููุตุฑูู";
                    img.style.height = "40px";
                    img.style.borderRadius = "6px";
                    img.style.marginLeft = "8px";
                    img.addEventListener("click", () => {
                      imageModalView.src = ex.imageDataUrl;
                      modalImage.style.display = "flex";
                    });
                    right.appendChild(img);
                  }

                  row.appendChild(left);
                  row.appendChild(right);
                  mExpenses.appendChild(row);
                });
              }

              mItem.appendChild(mHeader);
              mItem.appendChild(mExpenses);
              monthsContainer.appendChild(mItem);
            });
          }

          card.appendChild(monthsContainer);
          card.appendChild(actions);

          fragment.appendChild(card);
        });

        adminUsersContainer.innerHTML = "";
        adminUsersContainer.appendChild(fragment);
      } catch (e) {
        console.error(e);
        adminUsersContainer.innerHTML =
          '<div class="empty-state">ุชุนุฐุฑ ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏููู.</div>';
      }
    }

    // ุชุญููู ุญุงูุฉ ููู ุงูุชุณุฌูู ูู Firebase
    async function loadRegistrationStatus() {
      if (!firebaseEnabled || !db) return;
      try {
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const isEnabled = snap.exists() ? snap.val() : true;
        updateRegistrationUI(isEnabled);
      } catch (err) {
        console.error("Error loading registration status:", err);
        updateRegistrationUI(true);
      }
    }

    // ุชุญุฏูุซ ูุงุฌูุฉ ููู ุงูุชุณุฌูู
    function updateRegistrationUI(isEnabled) {
      if (btnToggleRegistration) {
        btnToggleRegistration.classList.toggle("active", isEnabled);
        btnToggleRegistration.style.background = isEnabled ? "#10b981" : "#ef4444";
        btnToggleRegistration.style.borderColor = isEnabled ? "#059669" : "#dc2626";
      }
    }

    // ุชุจุฏูู ุญุงูุฉ ุงูุชุณุฌูู
    async function toggleRegistration() {
      if (!firebaseEnabled || !db || currentUser?.uid !== ADMIN_UID) {
        return;
      }

      try {
        btnToggleRegistration.disabled = true;
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const currentStatus = snap.exists() ? snap.val() : true;
        const newStatus = !currentStatus;

        await set(statusRef, newStatus);
        updateRegistrationUI(newStatus);
      } catch (err) {
        console.error("Error toggling registration:", err);
      } finally {
        btnToggleRegistration.disabled = false;
      }
    }

    // ุชุบููุฑ ูููุฉ ุงูุณุฑ
    async function changePassword() {
      const current = modalCurrentPassword?.value?.trim();
      const newPwd = modalNewPassword?.value?.trim();
      const confirmPwd = modalConfirmPassword?.value?.trim();

      // ุงูุชุญูู ูู ุงููุฏุฎูุงุช
      if (!current) {
        showModalPasswordMessage("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ.", "error");
        return;
      }
      if (!newPwd) {
        showModalPasswordMessage("ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ.", "error");
        return;
      }
      if (newPwd.length < 6) {
        showModalPasswordMessage("ูููุฉ ุงูุณุฑ ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู.", "error");
        return;
      }
      if (newPwd !== confirmPwd) {
        showModalPasswordMessage("ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ ูุชุฃููุฏูุง ุบูุฑ ูุชุทุงุจูุฉ.", "error");
        return;
      }
      if (newPwd === current) {
        showModalPasswordMessage("ูููุฉ ุงูุณุฑ ุงูุฌุฏูุฏุฉ ูุฌุจ ุฃู ุชููู ูุฎุชููุฉ ุนู ุงูุญุงููุฉ.", "error");
        return;
      }

      try {
        btnModalChangePassword.disabled = true;
        btnModalChangePassword.textContent = "โณ ุฌุงุฑู ุงูุชุญุฏูุซ...";

        // ุฅุนุงุฏุฉ ุงููุตุงุฏูุฉ
        const email = currentUser.email;
        const credential = EmailAuthProvider.credential(email, current);
        await reauthenticateWithCredential(currentUser, credential);

        // ุชุญุฏูุซ ูููุฉ ุงูุณุฑ
        await updatePassword(currentUser, newPwd);

        // ูุณุญ ุงูุญููู
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";

        showModalPasswordMessage("โ ุชู ุชุญุฏูุซ ูููุฉ ุงูุณุฑ ุจูุฌุงุญ.", "success");
        setTimeout(() => {
          closePasswordModal();
        }, 1500);
      } catch (err) {
        console.error("Error changing password:", err);

        if (err.code === "auth/wrong-password") {
          showModalPasswordMessage("ูููุฉ ุงูุณุฑ ุงูุญุงููุฉ ุบูุฑ ุตุญูุญุฉ.", "error");
        } else if (err.code === "auth/weak-password") {
          showModalPasswordMessage("ูููุฉ ุงูุณุฑ ุถุนููุฉ ุฌุฏุงู.", "error");
        } else if (err.code === "auth/requires-recent-login") {
          showModalPasswordMessage("ุงูุฑุฌุงุก ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู ุซู ุญุงูู.", "error");
        } else {
          showModalPasswordMessage("ุชุนุฐุฑ ุชุญุฏูุซ ูููุฉ ุงูุณุฑ: " + (err.message || "ุฎุทุฃ ุบูุฑ ูุนุฑูู"), "error");
        }
      } finally {
        btnModalChangePassword.disabled = false;
        btnModalChangePassword.textContent = "โ ุชุญุฏูุซ ูููุฉ ุงูุณุฑ";
      }
    }

    // ุนุฑุถ ุฑุณุงูุฉ ุชุญุฏูุซ ูููุฉ ุงูุณุฑ ูู ุงูููุฏุงู
    function showModalPasswordMessage(message, type) {
      if (!modalPasswordMessage) return;
      modalPasswordMessage.textContent = message;
      modalPasswordMessage.className = type === "success" ? "password-success" : "password-error";
    }

    // ูุชุญ ููุฏุงู ุชุบููุฑ ูููุฉ ุงูุณุฑ
    function openPasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "flex";
        modalCurrentPassword.focus();
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // ุฅุบูุงู ููุฏุงู ุชุบููุฑ ูููุฉ ุงูุณุฑ
    function closePasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "none";
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // ุฒุฑ ููู/ูุชุญ ุงูุชุณุฌูู (ูู ููุญุฉ ุงูุชุญูู ููุท)
    if (btnToggleRegistration) {
      btnToggleRegistration.addEventListener("click", toggleRegistration);
    }

    // ุฒุฑ ุชุบููุฑ ูููุฉ ุงูุณุฑ ูู ุงูุฑุฃุณ
    if (btnChangePasswordQuick) {
      btnChangePasswordQuick.addEventListener("click", openPasswordModal);
    }

    // ุฅุบูุงู ููุฏุงู ุชุบููุฑ ูููุฉ ุงูุณุฑ
    if (btnClosePassword) {
      btnClosePassword.addEventListener("click", closePasswordModal);
    }

    // ุฒุฑ ุชุญุฏูุซ ูููุฉ ุงูุณุฑ ูู ุงูููุฏุงู
    if (btnModalChangePassword) {
      btnModalChangePassword.addEventListener("click", changePassword);
    }

    // ุฅุบูุงู ุงูููุฏุงู ุนูุฏ ุงูููุฑ ุฎุงุฑุฌู
    if (modalPassword) {
      modalPassword.addEventListener("click", (e) => {
        if (e.target === modalPassword) {
          closePasswordModal();
        }
      });
    }

    // ุชุญููู ุญุงูุฉ ุงูุชุณุฌูู ุนูุฏ ูุชุญ ููุญุฉ ุงูุชุญูู
    let registrationLoaded = false;
    if (adminTabBtn) {
      adminTabBtn.addEventListener("click", () => {
        if (!registrationLoaded) {
          loadRegistrationStatus();
          registrationLoaded = true;
        }
      });
    }

    // ุฒุฑ ุชุญุฏูุซ ุจูุงูุงุช ููุญุฉ ุงูุชุญูู (ูุนูู ุนูู ุฅุนุงุฏุฉ ุชุญููู ูุงุฆูุฉ ุงููุณุชุฎุฏููู)
    if (btnAdminRefresh) {
      btnAdminRefresh.addEventListener("click", async () => {
        const prevText = btnAdminRefresh.textContent;
        try {
          btnAdminRefresh.disabled = true;
          btnAdminRefresh.textContent = "๐ ุฌุงุฑู ุงูุชุญุฏูุซ...";
          await loadAdminUsers();
          await loadRegistrationStatus();

        } catch (err) {
          console.error(err);
          alert("ุชุนุฐุฑ ุชุญุฏูุซ ุจูุงูุงุช ุงููุณุชุฎุฏููู.");
        } finally {
          btnAdminRefresh.textContent = prevText;
          btnAdminRefresh.disabled = false;
        }
      });
    }

    async function refreshUI() {
      state = normalizeState(state);

      // apply fade-out to the main app view so existing data hides smoothly
      if (appView) {
        appView.classList.remove("fade-in");
        appView.classList.add("fade-out");
        // wait for animation to finish (match CSS duration ~280ms)
        await new Promise((r) => setTimeout(r, 300));
      }

      refreshMonthSelect();
      renderSummary();
      renderAdvancedStats();
      renderExpenses();
      renderComparison();
      renderCategoryOptions();
      renderCategoryList();

      // reveal updated UI with a subtle fade-in
      if (appView) {
        appView.classList.remove("fade-out");
        appView.classList.add("fade-in");
        // remove the class after animation to keep DOM clean
        setTimeout(() => appView && appView.classList.remove("fade-in"), 350);
      }

      await saveState();
    }

    (function init() {
      const savedTheme = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(savedTheme);

      // Show loader while we determine auth state to prevent UI flash
      if (appLoader) {
        appLoader.style.display = "flex";
      }
      if (loginView) loginView.style.display = "none";
      if (appView) appView.style.display = "none";

      // If we have a last signed-in uid and local state, show app immediately (avoid loader flash)
      try {
        const lastUid = localStorage.getItem(LAST_UID_KEY);
        if (lastUid) {
          const raw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid);
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              state = normalizeState(parsed);
              // show app using local data while firebase confirms session
              if (appLoader) appLoader.style.display = "none";
              if (loginView) loginView.style.display = "none";
              if (appView) appView.style.display = "block";
              if (adminTabBtn) adminTabBtn.style.display = "none"; // will update after auth

              // try to show cached profile/email immediately (speeds up UI on refresh)
              try {
                const profileRaw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid + "_profile");
                if (profileRaw) {
                  const p = JSON.parse(profileRaw);
                  if (userEmailLabel) userEmailLabel.textContent = p.email || "";
                }
                // show admin tab from cache when uid matches ADMIN_UID (will be revalidated by auth handler)
                if (adminTabBtn) {
                  adminTabBtn.style.display = lastUid === ADMIN_UID ? "block" : "none";
                }
              } catch (e) {
                /* ignore cache read errors */
              }
              // render local UI
              refreshUI();
            } catch (e) {
              console.warn("failed to parse local cached state", e);
            }
          }
        }
      } catch (e) {
        console.warn("failed to read last uid", e);
      }

      if (firebaseEnabled && auth) {
        onAuthStateChanged(auth, async (user) => {
         if (user) {
  currentUser = user;
  userRef = ref(db, "users/" + currentUser.uid + "/state");

        // remember last uid locally to speed up UI on refresh
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}

  /* ๐ ุงูุชุญูู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูุนุทููุงู */
  try {
    const disabledSnap = await get(ref(db, "users/" + currentUser.uid + "/disabled"));
    if (disabledSnap.exists() && disabledSnap.val() === true) {
      alert("ุชู ุชุนุทูู ุญุณุงุจู ูู ูุจู ุงูุฅุฏุงุฑุฉ.");
      await signOut(auth);
      return;
    }
  } catch (e) {
    console.warn("Failed to check disabled flag:", e);
  }

  /* ๐ ุชุญุฏูุซ ุจุฑููุงูู ุงููุณุชุฎุฏู ุฏุงุฎู ูุงุนุฏุฉ ุงูุจูุงูุงุช */
  try {
    await set(ref(db, "users/" + currentUser.uid + "/profile"), {
      email: currentUser.email || "",
    });
  } catch (e) {
    console.warn("Failed to update user profile:", e);
  }

  /* ๐ง ุฅุธูุงุฑ ุจุฑูุฏ ุงููุณุชุฎุฏู */
  userEmailLabel.textContent = user.email || "";

  /* ๐ ุฅุธูุงุฑ ุชุจููุจ ููุญุฉ ุงูุชุญูู ุฅุฐุง ูุงู ุงููุณุชุฎุฏู ูู ุงููุฏูุฑ */
  if (adminTabBtn) {
    if (currentUser.uid === ADMIN_UID) {
      adminTabBtn.style.display = "block";
    } else {
      adminTabBtn.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
    }
  }

  /* โ๏ธ ุชุญููู ุจูุงูุงุช ุงููุณุชุฎุฏู */
  loadStateLocal();
  state = normalizeState(state);

  await loadStateRemoteIfExists();
  state = normalizeState(state);

  /* ุชุญููู ุงููุณู ุงููุญูู */
  loadPrivateState();

  /* ๐ ุนุฑุถ ูุงุฌูุฉ ุงูุชุทุจูู */
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";

  await refreshUI();

} else {
  /* ๐ช ุญุงูุฉ ุชุณุฌูู ุงูุฎุฑูุฌ */
  currentUser = null;
  userRef = null;
  userEmailLabel.textContent = "";
  
  if (adminTabBtn) adminTabBtn.style.display = "none";
  if (tabAdmin) tabAdmin.style.display = "none";

  /* ๐ ุฅุนุงุฏุฉ ุถุจุท ุญุงูุฉ ุงูุชุทุจูู */
  state = {
    months: [],
    selectedMonthId: null,
    categories: [...defaultCategories],
  };

  filterState = {
    search: "",
    category: "all",
    hasImageOnly: false,
  };

  /* ุนุฑุถ ุดุงุดุฉ ุงูุฏุฎูู */
  if (appLoader) appLoader.style.display = "none";
  appView.style.display = "none";
  loginView.style.display = "block";
}
});
} else {
  // ูู ุญุงูุฉ ูู ูุนูู Firebase (ูุถุน Offline)
  currentUser = null;
  userRef = null;
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";
  refreshUI();
}
})();
    </script>
</body>
</html>
