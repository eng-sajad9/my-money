<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>نظام إدارة المصاريف</title>
  <icon rel="icon" href="http://pngegg.com/ar/png-pxffu" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>

    /* لوحة التحكم - المدير */
#tab-admin .card {
  margin-bottom: 10px;
}

.admin-user-card {
  background: var(--muted-bg);
  border-radius: 14px;
  padding: 10px;
  border: 1px solid var(--border-color);
  margin-bottom: 8px;
}

.admin-user-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 6px;
}

.admin-user-id {
  font-size: 12px;
  color: var(--subtext-color);
  word-break: break-all;
}

.admin-user-stats {
  font-size: 12px;
}

.admin-user-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}

.admin-user-actions .btn {
  font-size: 11px;
  padding: 4px 8px;
}

.admin-user-months {
  margin-top: 6px;
  border-top: 1px dashed var(--border-color);
  padding-top: 6px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.admin-month-item {
  background: var(--card-bg);
  border-radius: 10px;
  padding: 6px 8px;
  border: 1px solid var(--border-color);
}

.admin-month-header {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  cursor: pointer;
}

.admin-month-header span {
  display: inline-block;
}

.admin-month-expenses {
  margin-top: 4px;
  padding-top: 4px;
  border-top: 1px dashed var(--border-color);
  font-size: 11px;
}

.admin-expense-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 2px;
}

/* إعدادات لوحة التحكم الإدارية */
.admin-settings-card {
  background: linear-gradient(135deg, rgba(37,99,235,0.05), rgba(79,70,229,0.03));
  border: 1px solid rgba(37,99,235,0.15);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 12px;
}

.admin-settings-group {
  margin-bottom: 10px;
}

.admin-settings-group:last-child {
  margin-bottom: 0;
}

.admin-settings-label {
  font-weight: 600;
  font-size: 13px;
  margin-bottom: 6px;
  color: var(--text-color);
  display: flex;
  align-items: center;
  gap: 6px;
}

.toggle-switch {
  display: inline-flex;
  width: 44px;
  height: 24px;
  border-radius: 12px;
  background: var(--muted-bg-2);
  border: 1px solid var(--border-color);
  cursor: pointer;
  align-items: center;
  padding: 2px;
  transition: background 0.2s;
}

.toggle-switch.active {
  background: #10b981;
  border-color: #059669;
}

.toggle-circle {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: white;
  transition: transform 0.2s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.toggle-switch.active .toggle-circle {
  transform: translateX(20px);
}

.password-change-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.password-input-group {
  display: flex;
  gap: 6px;
}

.password-input-group input {
  flex: 1;
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid var(--border-color);
  font-size: 13px;
  background: var(--muted-bg);
}

.password-input-group button {
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
  transition: 0.2s;
}

.password-input-group button:hover {
  background: var(--accent-strong);
}

.password-error {
  color: var(--danger);
  font-size: 12px;
  margin-top: -4px;
}

.password-success {
  color: var(--success);
  font-size: 12px;
  margin-top: -4px;
}

    :root {
      --bg-color: #f3f4f6;
      --card-bg: #ffffff;
      --text-color: #111827;
      --subtext-color: #6b7280;
      --border-color: #e5e7eb;
      --muted-bg: #f9fafb;
      --muted-bg-2: #e5e7eb;
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --danger: #b91c1c;
      --success: #059669;
      --shadow-soft: 0 14px 35px rgba(15, 23, 42, 0.18);
    }

    :root[data-theme="dark"] {
      --bg-color: #020617;
      --card-bg: #020617;
      --text-color: #f9fafb;
      --subtext-color: #9ca3af;
      --border-color: #1f2937;
      --muted-bg: #020617;
      --muted-bg-2: #111827;
      --accent: #3b82f6;
      --accent-strong: #60a5fa;
      --danger: #f97373;
      --success: #4ade80;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.85);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    html, body {
      height: auto;
    }

    body {
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      font-size: 15px;
    }

    /* شاشة تسجيل الدخول */
    .login-container {
      width: 100%;
      max-width: 420px;
      border-radius: 20px;
      padding: 20px 18px 18px;
      background: radial-gradient(circle at top, #2563eb22, transparent 50%),
                  radial-gradient(circle at bottom, #22c55e22, transparent 55%),
                  var(--card-bg);
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-color);
      animation: fadeInUp 0.4s ease-out;
    }

    .login-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .login-icon {
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.6);
    }

    .login-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .login-title h1 {
      font-size: 22px;
      font-weight: 700;
    }

    .login-title span {
      font-size: 13px;
      color: var(--subtext-color);
    }

    .login-body {
      margin-top: 10px;
    }

    /* Loader to avoid login flash */
    .app-loader {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: 18px;
      padding: 18px;
      text-align: center;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 14px;
    }

    .login-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }

    .login-tab-btn {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: transparent;
      cursor: pointer;
      font-weight: 600;
    }

    .login-tab-btn.active {
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      color: #fff;
      box-shadow: 0 6px 18px rgba(37,99,235,0.18);
    }

    .form-group {
      margin-bottom: 10px;
    }

    .form-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--subtext-color);
      display: block;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 8px 11px;
      font-size: 14px;
      background: var(--muted-bg);
      color: var(--text-color);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--card-bg);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
    }

    .password-row {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .btn-toggle-pw {
      border-radius: 999px;
      border: 1px solid var(--border-color);
      font-size: 11px;
      padding: 5px 9px;
      background: var(--muted-bg);
      cursor: pointer;
      color: var(--subtext-color);
    }

    .login-footer {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: 0.15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(37, 99, 235, 0.5);
    }

    .btn-outline {
      background: transparent;
      color: var(--accent-strong);
      border: 1px solid var(--border-color);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }

    .login-error {
      min-height: 18px;
      font-size: 12px;
      color: var(--danger);
      margin-top: 4px;
    }

    .login-small-note {
      font-size: 11px;
      color: var(--subtext-color);
      margin-top: 4px;
    }

    /* حاوية التطبيق */
    .app-container {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      padding: 16px;
      border: 1px solid var(--border-color);
      display: none;
      animation: fadeInUp 0.4s ease-out;
      overflow: visible !important;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }

    .header-left {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    header h2 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h2 span.icon {
      font-size: 22px;
    }

    .header-sub {
      font-size: 12px;
      color: var(--subtext-color);
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    @media (min-width: 420px) {
      .header-actions {
        flex-direction: row;
        align-items: center;
      }
    }

    .user-label {
      font-size: 11px;
      color: var(--subtext-color);
    }

    /* تبويبات */
    .tabs {
      display: flex;
      gap: 4px;
      background: var(--muted-bg-2);
      border-radius: 999px;
      padding: 4px;
      margin: 10px 0 14px;
    }

    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 7px 0;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      cursor: pointer;
      background: transparent;
      color: var(--subtext-color);
    }

    .tab-btn.active {
      background: var(--card-bg);
      color: var(--text-color);
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    /* اختيار الشهر */
    .month-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .month-select {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      font-size: 13px;
      background: var(--muted-bg);
      color: var(--text-color);
    }

    /* بطاقات */
    .card {
      background: var(--card-bg);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
      border: 1px solid var(--border-color);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .card-header h3 {
      font-size: 14px;
      font-weight: 600;
    }

    /* ملخص الشهر */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 6px;
    }

    .summary-item {
      background: var(--muted-bg);
      border-radius: 12px;
      padding: 7px 8px;
      text-align: center;
    }

    .summary-label {
      font-size: 12px;
      color: var(--subtext-color);
    }

    .summary-value {
      font-size: 14px;
      font-weight: 700;
      margin-top: 3px;
    }

    .summary-value.positive {
      color: var(--success);
    }

    .summary-value.negative {
      color: var(--danger);
    }

    /* قائمة المصاريف */
    .expense-list {
      max-height: none !important;
      overflow: visible !important;
      padding-right: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .expense-item {
      padding: 14px 10px;
      border-radius: 12px;
      background: var(--muted-bg);
      border: 1px solid #174599;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .expense-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .expense-title {
      font-size: 14px;
      font-weight: 600;
    }

    .expense-meta {
      font-size: 12px;
      color: var(--subtext-color);
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .expense-note {
      font-size: 12px;
      color: var(--text-color);
    }

    .expense-amount {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      background: rgba(37, 99, 235, 0.08);
      color: #2563eb;
      padding: 6px 10px;
      border-radius: 0 8px 8px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: auto;
      text-align: center;
      box-shadow: none;
      border: 1px solid rgba(37, 99, 235, 0.15);
      border-left: none;
      flex-shrink: 0;
    }

    .expense-amount-container {
      display: flex;
      align-items: center;
      gap: 0;
      flex-shrink: 0;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: none;
    }

    .expense-amount-badge {
      font-size: 16px;
      padding: 6px 7px;
      background: rgba(37, 99, 235, 0.06);
      border-radius: 8px 0 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(37, 99, 235, 0.12);
      border-right: none;
      backdrop-filter: none;
    }

    /* Dark mode للسعر */
    [data-theme="dark"] .expense-amount-badge {
      background: rgba(96, 165, 250, 0.08);
      border-color: rgba(96, 165, 250, 0.15);
    }

    [data-theme="dark"] .expense-amount {
      background: rgba(96, 165, 250, 0.1);
      color: #60a5fa;
      box-shadow: none;
      border-color: rgba(96, 165, 250, 0.2);
    }

    [data-theme="dark"] .expense-amount-container {
      box-shadow: none;
    }

    .expense-image-badge {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }

    .expense-thumb {
      margin-top: 6px;
      max-height: 80px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      object-fit: cover;
      cursor: pointer;
    }

    .expense-actions {
      display: flex;
      gap: 4px;
      margin-top: 3px;
      flex-wrap: wrap;
    }

    /* معاينة الصور في Modal المصروف */
    .image-preview-container {
      margin-top: 8px;
      padding: 8px;
      background: var(--muted-bg);
      border-radius: 12px;
      border: 1px solid var(--border-color);
      display: none;
      flex-direction: row;
      align-items: flex-start;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .image-preview-container.active {
      display: flex;
      border-color: var(--accent);
      background: rgba(37, 99, 235, 0.05);
    }

    .image-preview-container[data-theme="dark"] {
      background: var(--muted-bg-2);
    }

    .image-preview-container.active[data-theme="dark"] {
      background: rgba(96, 165, 250, 0.08);
      border-color: var(--accent-strong);
    }

    .image-preview-box {
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .image-preview-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .image-preview-info {
      text-align: right;
      font-size: 11px;
      color: var(--subtext-color);
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1;
    }

    .image-preview-filename {
      font-size: 12px;
      color: var(--text-color);
      font-weight: 500;
      word-break: break-all;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .image-preview-size {
      font-size: 10px;
      color: var(--subtext-color);
    }

    .image-preview-remove {
      background: rgba(185, 28, 28, 0.1);
      color: #b91c1c;
      border: 1px solid rgba(185, 28, 28, 0.25);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .image-preview-remove:hover {
      background: rgba(185, 28, 28, 0.2);
      border-color: rgba(185, 28, 28, 0.4);
    }

    .image-preview-remove:active {
      transform: scale(0.98);
    }

    /* تحسينات للهواتف الذكية */
    @media (max-width: 480px) {
      .image-preview-container {
        padding: 6px;
      }

      .image-preview-box {
        width: 70px;
        height: 70px;
      }

      .image-preview-info {
        font-size: 10px;
      }

      .image-preview-filename {
        font-size: 11px;
      }

      .image-preview-remove {
        padding: 3px 6px;
        font-size: 9px;
        min-height: 26px;
      }
    }

    /* زر عام */
    .btn-ghost {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: 0.15s ease-in-out;
      background: rgba(0, 0, 0, 0.03);
      border: 1px solid var(--border-color);
    }

    /* زر التعديل */
    .btn-edit {
      color: #2563eb;
      background: rgba(37, 99, 235, 0.06);
      border-color: rgba(37, 99, 235, 0.25);
    }

    .btn-edit:hover {
      background: rgba(37, 99, 235, 0.15);
      border-color: rgba(37, 99, 235, 0.4);
    }

    /* زر الحذف */
    .btn-delete {
      color: #b91c1c;
      background: rgba(185, 28, 28, 0.06);
      border-color: rgba(185, 28, 28, 0.25);
    }

    .btn-delete:hover {
      background: rgba(185, 28, 28, 0.15);
      border-color: rgba(185, 28, 28, 0.4);
    }

    .btn-ghost:hover {
      background: var(--muted-bg);
    }

    /* مودالات */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      background: var(--card-bg);
      width: 100%;
      max-width: 520px;
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.5);
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      animation: fadeInUp 0.25s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-header h3 {
      font-size: 15px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .image-modal {
      max-width: 95vw;
      max-height: 95vh;
      border-radius: 20px;
      padding: 8px;
      background: #000;
      border: none;
    }

    .image-modal img {
      max-width: 100%;
      max-height: 100%;
      display: block;
      margin: 0 auto;
      border-radius: 16px;
    }

    /* مقارنة الأشهر */
    .compare-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .compare-item {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .compare-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }

    .compare-bar-bg {
      background: var(--muted-bg-2);
      border-radius: 999px;
      height: 8px;
      overflow: hidden;
    }

    .compare-bar-fill {
      height: 8px;
      border-radius: 999px;
      background: linear-gradient(90deg, #2563eb, #4f46e5);
      width: 0%;
      transition: width 0.3s;
    }

    /* مقارنة احترافية */
    .compare-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .compare-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), var(--card-bg));
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border-color);
      box-shadow: 0 8px 22px rgba(15,23,42,0.06);
    }
    .compare-card:hover {
      transform: translateY(-4px);
      transition: transform 0.18s ease;
      box-shadow: 0 18px 36px rgba(15,23,42,0.08);
    }

    .compare-row {
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
    }

    .stacked-bar {
      height: 14px;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      gap: 1px;
      background: var(--muted-bg-2);
      margin-top: 8px;
    }

    .stacked-seg {
      height: 100%;
      transition: width 0.35s ease;
    }

    .compare-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--subtext-color);
    }

    .compare-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    .compare-table th,
    .compare-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--border-color);
      text-align: left;
    }

    .compare-table th {
      background: var(--muted-bg);
      font-weight: 700;
      font-size: 12px;
    }

    .category-legend {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .legend-item {
      padding: 6px 8px;
      border-radius: 999px;
      background: var(--muted-bg);
      font-size: 12px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .legend-swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      display: inline-block;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    @media (min-width: 760px) {
      .compare-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 1100px) {
      .compare-grid { grid-template-columns: repeat(3, 1fr); }
    }

    .empty-state {
      font-size: 12px;
      color: var(--subtext-color);
      text-align: center;
      padding: 12px 6px;
    }

    /* فلترة */
    .filter-row {
      display: flex;
      gap: 6px;
      margin: 6px 0;
      flex-wrap: wrap;
    }

    .filter-toggle {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 4px;
    }

    .filter-toggle input {
      transform: scale(0.9);
    }

    .form-input-sm,
    .form-select-sm {
      padding: 6px 9px;
      font-size: 12px;
      border-radius: 999px;
    }

    .filter-summary {
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 4px;
    }

    /* إحصائيات متقدمة (طي/فتح) */
    .collapse-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
    }

    .collapse-body.open {
      max-height: 500px;
    }

    .collapse-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    .collapse-icon {
      display: inline-block;
      transition: transform 0.2s ease;
      font-size: 11px;
    }

    .collapse-icon.open {
      transform: rotate(180deg);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 6px;
    }

    .stats-item {
      background: var(--muted-bg);
      border-radius: 12px;
      padding: 6px 8px;
      font-size: 12px;
    }

    .stats-item-title {
      color: var(--subtext-color);
      margin-bottom: 3px;
    }

    .stats-item-value {
      font-weight: 600;
    }

    .category-bars {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .category-bar {
      font-size: 11px;
    }

    .category-bar-top {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .category-bar-bg {
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      background: var(--muted-bg-2);
    }

    .category-bar-fill {
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #4f46e5, #2563eb);
      width: 0%;
      transition: width 0.3s;
    }

    /* التصنيفات */
    .category-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--muted-bg), rgba(37, 99, 235, 0.05));
      border: 1px solid rgba(37, 99, 235, 0.15);
      font-size: 13px;
      margin: 4px;
      user-select: none;
      transition: 0.15s ease;
    }

    .category-chip:hover {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(37, 99, 235, 0.1));
      border-color: rgba(37, 99, 235, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    }

    .category-chip.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .category-chip-controls {
      display: flex;
      gap: 3px;
      align-items: center;
    }

    .category-chip button {
      border: none;
      background: transparent;
      font-size: 13px;
      cursor: pointer;
      color: var(--subtext-color);
      padding: 2px 4px;
      border-radius: 4px;
      transition: 0.1s;
    }

    .category-chip button:hover {
      background: rgba(37, 99, 235, 0.1);
      color: var(--accent);
    }

    #categoryList {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* لوحة التحكم (Admin) */
    .admin-info {
      font-size: 12px;
      color: var(--subtext-color);
      margin-bottom: 8px;
    }

    .admin-users-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
    }

    .admin-user-card {
      border-radius: 12px;
      border: 1px solid var(--border-color);
      padding: 10px;
      background: var(--muted-bg);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .admin-user-main {
      font-size: 12px;
    }

    .admin-user-uid {
      font-size: 11px;
      color: var(--subtext-color);
      word-break: break-all;
    }

    .admin-user-email {
      font-size: 12px;
      font-weight: 600;
    }

    .admin-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border: 1px solid transparent;
    }

    .admin-badge-active {
      background: rgba(34, 197, 94, 0.12);
      color: #15803d;
      border-color: rgba(34, 197, 94, 0.35);
    }

    .admin-badge-disabled {
      background: rgba(239, 68, 68, 0.12);
      color: #b91c1c;
      border-color: rgba(239, 68, 68, 0.4);
    }

    .admin-badge-admin {
      background: rgba(37, 99, 235, 0.07);
      color: #1d4ed8;
      border-color: rgba(37, 99, 235, 0.3);
    }

    .admin-user-stats {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .admin-stat-line {
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .admin-stat-label {
      color: var(--subtext-color);
    }

    .admin-stat-value {
      font-weight: 600;
    }

    .admin-user-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-danger-soft {
      background: rgba(239, 68, 68, 0.08);
      color: #b91c1c;
      border: 1px solid rgba(239, 68, 68, 0.35);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-danger-soft:hover {
      background: rgba(239, 68, 68, 0.15);
    }

    .btn-soft {
      background: rgba(37, 99, 235, 0.05);
      color: #1d4ed8;
      border: 1px solid rgba(37, 99, 235, 0.25);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-soft:hover {
      background: rgba(37, 99, 235, 0.12);
    }

    .admin-note {
      font-size: 11px;
      color: var(--subtext-color);
      margin-top: 6px;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(-6px); }
    }

    .fade-out {
      animation: fadeOut 280ms ease-out forwards;
    }

    .fade-in {
      animation: fadeInUp 280ms ease-out forwards;
    }

    /* login processing bar */
    .login-processing-bar {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin-top: 8px;
      border-radius: 8px;
      background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(37,99,235,0.03));
      color: #1e40af;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(2,6,23,0.06);
    }

    .processing-spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(30,64,175,0.18);
      border-top-color: #1e40af;
      animation: spin 800ms linear infinite;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* قسم الملاحظات والحسابات المحمي */
    .private-section-locked {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(79,70,229,0.05));
      border: 2px dashed var(--border-color);
      border-radius: 14px;
      padding: 20px;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .private-lock-container {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: fadeInUp 0.5s ease-out;
    }

    .private-lock-icon {
      font-size: 48px;
      animation: bounce 2s infinite;
      transition: all 0.3s ease;
    }

    .private-lock-text {
      font-size: 14px;
      color: var(--subtext-color);
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .private-pin-input-group {
      display: flex;
      gap: 6px;
      align-items: center;
      transition: all 0.3s ease;
    }

    .private-pin-input {
      width: 120px;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      font-size: 16px;
      text-align: center;
      letter-spacing: 4px;
      font-weight: bold;
      background: var(--muted-bg);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: transform, border-color;
      -webkit-text-security: disc; /* إخفاء الأرقام كنقاط */
    }

    .private-pin-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
      transform: scale(1.05);
    }

    .btn-open-private {
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: transform, background;
    }

    .btn-open-private:hover {
      background: var(--accent-strong);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-open-private:active {
      transform: translateY(0);
    }

    .btn-open-private:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .private-error-msg {
      color: var(--danger);
      font-size: 12px;
      min-height: 18px;
      animation: shake 0.5s ease-in-out;
      transition: all 0.3s ease;
    }

    /* المحتوى المحمي */
    .private-content {
      display: flex;
      flex-direction: column;
      gap: 14px;
      animation: fadeInUp 0.4s ease-out;
      transition: all 0.4s ease;
      will-change: opacity, transform;
    }

    .private-card {
      background: linear-gradient(135deg, rgba(37,99,235,0.05), rgba(79,70,229,0.03));
      border: 1px solid rgba(37, 99, 235, 0.2);
      border-radius: 12px;
      padding: 14px;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideUp 0.5s ease-out backwards;
      will-change: transform, border-color, box-shadow;
    }

    .private-card:nth-child(1) { animation-delay: 0.05s; }
    .private-card:nth-child(2) { animation-delay: 0.1s; }
    .private-card:nth-child(3) { animation-delay: 0.15s; }
    .private-card:nth-child(4) { animation-delay: 0.2s; }
    .private-card:nth-child(5) { animation-delay: 0.25s; }

    .private-card:hover {
      border-color: rgba(37, 99, 235, 0.4);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.1);
      transform: translateY(-2px);
    }

    .private-card-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .private-total-balance {
      font-size: 14px;
      font-weight: 600;
      color: #10b981;
    }

    /* قسم الرصيد والموازنة */
    .budget-summary-card {
      background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(34,197,94,0.05));
      border-color: rgba(16,185,129,0.3);
      transition: all 0.3s ease;
    }

    .budget-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.3s ease;
    }

    .budget-range-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: all 0.3s ease;
    }

    .budget-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      background: var(--muted-bg);
      padding: 10px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .budget-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .budget-stat-label {
      font-size: 10px;
      color: var(--subtext-color);
      font-weight: 600;
      text-transform: uppercase;
      transition: color 0.3s ease;
    }

    .budget-stat-value {
      font-size: 13px;
      font-weight: 700;
      transition: all 0.3s ease;
    }

    .budget-stat-value.success {
      color: #10b981;
    }

    .budget-stat-value.danger {
      color: #ef4444;
    }

    /* قسم توزيع الرصيد */
    .budget-allocation-card {
      background: linear-gradient(135deg, rgba(59,130,246,0.08), rgba(79,70,229,0.05));
      border-color: rgba(59,130,246,0.3);
      transition: all 0.3s ease;
    }

    .budget-allocations-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .allocation-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
      padding: 10px;
      background: var(--muted-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideInRight 0.3s ease-out backwards;
      will-change: transform, border-color;
    }

    .allocation-item:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
      transform: translateX(2px);
    }

    .allocation-inputs {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 6px;
      transition: all 0.3s ease;
    }

    .allocation-result {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      padding: 8px;
      background: var(--card-bg);
      border-radius: 6px;
      border: 1px solid var(--border-color);
      min-width: 90px;
      transition: all 0.3s ease;
    }

    .allocation-result-label {
      font-size: 9px;
      color: var(--subtext-color);
      font-weight: 600;
      transition: color 0.3s ease;
    }

    .allocation-result-value {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      transition: all 0.3s ease;
    }

    .allocation-remove-btn {
      padding: 4px 8px;
      border: none;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: transform, background;
    }

    .allocation-remove-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: scale(1.1);
    }

    .allocation-remove-btn:active {
      transform: scale(0.95);
    }

    /* الحاسبة والملاحظات */
    .private-calculator {
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .calc-input {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      background: var(--muted-bg);
      font-family: monospace;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: border-color, background, box-shadow;
    }

    .calc-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--card-bg);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .calc-result {
      background: var(--muted-bg);
      padding: 12px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--subtext-color);
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #2563eb;
      border: 1px solid rgba(37, 99, 235, 0.2);
      animation: pulse 0.3s ease-in-out;
      transition: all 0.3s ease;
      will-change: transform, color;
    }

    .private-notes-textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      background: var(--muted-bg);
      resize: vertical;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: border-color, background, box-shadow;
    }

    .private-notes-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--card-bg);
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .private-notes-meta {
      font-size: 11px;
      color: var(--subtext-color);
      text-align: right;
      transition: color 0.3s ease;
    }

    .btn-private-logout {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: transparent;
      color: var(--danger);
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideUp 0.5s ease-out backwards;
      animation-delay: 0.3s;
      will-change: transform, background;
    }

    .btn-private-logout:hover {
      background: rgba(239, 68, 68, 0.08);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    .btn-private-logout:active {
      transform: translateY(0);
    }

    /* الأنميشنات المتقدمة */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    @keyframes pulse {
      0% { transform: scale(0.95); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* ===== تحسينات الأجهزة الصغيرة جداً (< 360px) ===== */
    @media (max-width: 359px) {
      .private-section-locked {
        min-height: 240px;
        padding: 12px;
      }

      .private-lock-icon {
        font-size: 32px;
      }

      .private-pin-input {
        font-size: 14px;
        padding: 8px;
      }

      .btn-open-private {
        font-size: 12px;
        padding: 10px;
      }
    }

    /* ===== تحسينات الهواتف الصغيرة (360px - 480px) ===== */
    @media (max-width: 480px) {
      /* الجزء المحمي - شاشة PIN */
      .private-section-locked {
        min-height: 250px;
        padding: 16px;
        border-radius: 12px;
        animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .private-lock-icon {
        font-size: 40px;
        animation: bounce 1.5s ease-in-out infinite;
      }

      .private-lock-text {
        font-size: 13px;
        line-height: 1.5;
      }

      .private-pin-input-group {
        flex-direction: column;
        gap: 8px;
        width: 100%;
      }

      .private-pin-input {
        width: 100%;
        font-size: 16px; /* منع zoom على الهاتف */
        padding: 12px;
        touch-action: manipulation;
        border-radius: 8px;
      }

      .private-pin-input:focus {
        transform: scale(1.02);
        transition: transform 0.2s ease-out;
      }

      .btn-open-private {
        width: 100%;
        padding: 12px;
        font-size: 14px;
        min-height: 44px; /* حد أدنى لسهولة الضغط على الهاتف */
        border-radius: 8px;
        touch-action: manipulation;
      }

      .btn-open-private:active {
        transform: scale(0.98);
      }

      /* الكارتات */
      .private-card {
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        animation: fadeInUp 0.3s ease-out;
      }

      .private-card-title {
        font-size: 12px;
        margin-bottom: 10px;
        font-weight: 600;
      }

      /* ملخص الميزانية */
      .budget-summary-card {
        border-radius: 10px;
        overflow: hidden;
      }

      .budget-summary {
        grid-template-columns: 1fr 1fr 1fr;
        padding: 8px;
        gap: 6px;
      }

      .budget-stat-item {
        padding: 6px;
        border-radius: 6px;
      }

      .budget-stat-label {
        font-size: 9px;
        line-height: 1.2;
      }

      .budget-stat-value {
        font-size: 12px;
        margin-top: 2px;
      }

      /* توزيع الميزانية */
      .budget-allocations-container {
        gap: 8px;
      }

      .allocation-item {
        grid-template-columns: 1fr;
        gap: 6px;
        padding: 8px;
        border-radius: 8px;
        animation: slideInRight 0.3s ease-out;
      }

      .allocation-item:hover {
        transform: translateX(-2px);
      }

      .allocation-label {
        font-size: 12px;
      }

      .allocation-inputs {
        grid-template-columns: 1fr;
        gap: 4px;
      }

      .allocation-input {
        width: 100%;
        font-size: 14px;
        padding: 8px;
        border-radius: 6px;
      }

      .allocation-result {
        min-width: 100%;
        padding: 6px 8px;
        border-radius: 6px;
        font-size: 12px;
      }

      .allocation-remove-btn {
        width: 100%;
        padding: 8px;
        font-size: 12px;
        min-height: 40px;
        border-radius: 6px;
      }

      /* الحاسبة والملاحظات */
      .calc-input,
      .private-notes-textarea {
        font-size: 16px; /* منع zoom على الهاتف */
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        touch-action: manipulation;
      }

      .calc-input::placeholder,
      .private-notes-textarea::placeholder {
        font-size: 14px;
      }

      .btn-private-logout {
        padding: 10px;
        font-size: 13px;
        min-height: 44px;
        width: 100%;
        border-radius: 8px;
      }

      .private-calculator {
        gap: 6px;
        flex-direction: column;
      }

      .calc-result {
        padding: 10px;
        min-height: 36px;
        font-size: 12px;
        border-radius: 6px;
        text-align: center;
        animation: pulse 0.5s ease-out;
      }

      /* مختار الشهور */
      .month-selectors {
        gap: 6px;
      }

      .month-selector {
        flex: 1;
        font-size: 12px;
      }

      .month-label {
        font-size: 11px;
      }
    }

    /* ===== تحسينات الأجهزة المتوسطة (481px - 768px) ===== */
    @media (min-width: 481px) and (max-width: 768px) {
      .private-card {
        padding: 13px;
        border-radius: 10px;
      }

      .budget-summary {
        grid-template-columns: repeat(3, 1fr);
        padding: 10px;
        gap: 8px;
      }

      .budget-stat-value {
        font-size: 13px;
      }

      .allocation-item {
        padding: 10px;
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .allocation-inputs {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .budget-allocations-container {
        gap: 8px;
      }

      .calc-input {
        font-size: 15px;
      }

      .private-notes-textarea {
        font-size: 14px;
        min-height: 120px;
      }

      .btn-open-private,
      .btn-private-logout,
      .allocation-remove-btn {
        min-height: 42px;
      }
    }

    /* ===== تحسينات الأجهزة الكبيرة (769px+) ===== */
    @media (min-width: 769px) {
      .private-section-locked {
        min-height: 300px;
        padding: 20px;
        border-radius: 14px;
      }

      .private-lock-icon {
        font-size: 60px;
      }

      .private-card {
        padding: 16px;
        border-radius: 12px;
      }

      .budget-summary {
        grid-template-columns: repeat(3, 1fr);
        padding: 12px;
        gap: 12px;
      }

      .budget-stat-label {
        font-size: 11px;
      }

      .budget-stat-value {
        font-size: 16px;
      }

      .allocation-item {
        grid-template-columns: 2fr 1fr auto;
        gap: 12px;
        padding: 12px;
        border-radius: 10px;
      }

      .allocation-label {
        font-size: 13px;
      }

      .allocation-inputs {
        grid-template-columns: 2fr 1fr;
        gap: 8px;
      }

      .allocation-input {
        font-size: 14px;
        padding: 10px;
      }

      .allocation-result {
        padding: 10px 12px;
        font-size: 13px;
        min-width: 120px;
        text-align: center;
      }

      .allocation-remove-btn {
        width: 100px;
        min-height: 40px;
        padding: 8px;
      }

      .calc-input {
        font-size: 16px;
        padding: 12px;
      }

      .calc-result {
        font-size: 14px;
        padding: 12px;
        min-height: 40px;
      }

      .private-notes-textarea {
        font-size: 15px;
        padding: 12px;
        min-height: 150px;
      }

      .btn-private-logout {
        padding: 14px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- لودر تحميل (يظهر أثناء التحقق من حالة الدخول) -->
  <div id="appLoader" class="app-loader">🔄 جاري التحقق من حالة الدخول...</div>

  <!-- شاشة تسجيل الدخول -->
  <div id="loginView" class="login-container" style="display:none;">
    <div class="login-header">
      <div class="login-icon">💸</div>
      <div class="login-title">
        <h1>نظام إدارة المصاريف</h1>
        <span>سجّل الدخول للوصول إلى مصاريفك من أي جهاز.</span>
      </div>
    </div>
    <div class="login-body">
      <div class="login-tabs">
        <button id="tabLogin" class="login-tab-btn active">تسجيل دخول</button>
        <button id="tabRegister" class="login-tab-btn">حساب جديد</button>
      </div>

      <!-- نموذج تسجيل الدخول -->
      <div id="loginForm">
        <div class="form-group">
          <label class="form-label">البريد الإلكتروني</label>
          <input id="loginEmail" type="email" class="form-input" placeholder="Email" />
        </div>
        <div class="form-group">
          <label class="form-label">كلمة السر</label>
          <div class="password-row">
            <input id="loginPassword" type="password" class="form-input" placeholder="password" />
            <button id="btnTogglePwLogin" class="btn-toggle-pw">👁️</button>
          </div>
        </div>
        <div id="authError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnLogin" class="btn btn-primary">تسجيل الدخول</button>
          <div class="login-small-note">
            يعمل بدون إنترنت، ويقوم بالمزامنة مع السحابة عند توفر النت.
          </div>
        </div>
        <div id="loginProcessingBar" class="login-processing-bar" role="status" aria-live="polite">
          <div class="processing-spinner" aria-hidden="true"></div>
          <div>جاري تسجيل الدخول...</div>
        </div>
      </div>

      <!-- نموذج التسجيل -->
      <div id="registerForm" style="display:none;">
        <div class="form-group">
          <label class="form-label">البريد الإلكتروني</label>
          <input id="registerEmail" type="email" class="form-input" placeholder="Email" />
        </div>
        <div class="form-group">
          <label class="form-label">كلمة السر</label>
          <div class="password-row">
            <input id="registerPassword" type="password" class="form-input" placeholder="password" />
            <button id="btnTogglePwReg" class="btn-toggle-pw">👁️</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">تأكيد كلمة السر</label>
          <input id="registerPasswordConfirm" type="password" class="form-input" placeholder="password" />
        </div>
        <div id="registerError" class="login-error"></div>
        <div class="login-footer">
          <button id="btnRegister" class="btn btn-outline">إنشاء حساب</button>
          <button id="btnCancelRegister" class="btn btn-ghost">إلغاء</button>
        </div>
      </div>
    </div>
  </div>

  <!-- واجهة التطبيق -->
  <div id="appView" class="app-container">
    <header>
      <div class="header-left">
        <h2><span class="icon">📊</span>مصروفاتي الشهرية</h2>
        <div class="header-sub">إدارة الراتب والمصاريف مع فصل كامل بين الأشهر.</div>
      </div>
      <div class="header-actions">
        <span id="userEmailLabel" class="user-label"></span>
        <button id="btnChangePasswordQuick" class="btn btn-outline btn-sm">🔐 تغيير كلمة السر</button>
        <button id="btnToggleTheme" class="btn btn-outline btn-sm">🌙 الوضع الداكن</button>
        <button id="btnLogout" class="btn btn-outline btn-sm">🚪 تسجيل خروج</button>
      </div>
    </header>

    <!-- تبويبات -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="month">الشهر الحالي</button>
      <button class="tab-btn" data-tab="compare">مقارنة الأشهر</button>
      <button class="tab-btn" data-tab="private">🔒 ملاحظاتي</button>
      <button id="adminTabBtn" class="tab-btn" data-tab="admin" style="display:none;">لوحة التحكم</button>
    </div>

    <!-- اختيار الشهر -->
    <div class="month-row">
      <select id="monthSelect" class="month-select"></select>
      <button id="btnEditMonth" class="btn btn-outline btn-sm">⚙️ إدارة الشهر</button>
      <button id="btnAddMonth" class="btn btn-primary btn-sm">+ شهر</button>
    </div>

    <!-- تبويب الشهر الحالي -->
    <div id="tab-month">
      <!-- ملخص -->
      <div class="card">
        <div class="card-header">
          <h3>ملخص الشهر</h3>
        </div>
        <div class="summary-grid">
          <div class="summary-item">
            <div class="summary-label">الراتب</div>
            <div id="summarySalary" class="summary-value">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">إجمالي المصاريف</div>
            <div id="summaryExpenses" class="summary-value negative">0</div>
          </div>
          <div class="summary-item">
            <div class="summary-label">المتبقي</div>
            <div id="summaryRemaining" class="summary-value positive">0</div>
          </div>
        </div>
      </div>

      <!-- إحصائيات متقدمة -->
      <div class="card">
        <div class="card-header">
          <div class="collapse-toggle" id="advancedStatsToggle">
            <span>إحصائيات متقدمة للشهر</span>
            <span id="advancedStatsIcon" class="collapse-icon">▼</span>
          </div>
        </div>
        <div id="advancedStatsBody" class="collapse-body">
          <div class="stats-grid">
            <div class="stats-item">
              <div class="stats-item-title">متوسط الصرف اليومي</div>
              <div id="statDailyAvg" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">المتبقي لكل يوم</div>
              <div id="statRemainingPerDay" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">أكبر مصروف</div>
              <div id="statMaxExpense" class="stats-item-value">0</div>
            </div>
            <div class="stats-item">
              <div class="stats-item-title">أكثر تصنيف صرفًا</div>
              <div id="statTopCategory" class="stats-item-value">لا يوجد</div>
            </div>
          </div>
          <div class="category-bars" id="categoryBars"></div>
        </div>
      </div>

      <!-- المصاريف -->
      <div class="card">
        <div class="card-header">
          <h3>المصاريف</h3>
          <button id="btnAddExpense" class="btn btn-primary btn-sm">+ مصروف</button>
        </div>
        <div class="filter-row">
          <input
            id="searchInput"
            type="text"
            class="form-input form-input-sm"
            placeholder="بحث عن مصروف (عنوان أو ملاحظة)"
          />
          <select id="filterCategory" class="form-select form-select-sm">
            <option value="all">كل التصنيفات</option>
          </select>
        </div>
        <label class="filter-toggle">
          <input type="checkbox" id="filterHasImage" />
          عرض المصاريف التي تحتوي على صورة فقط
        </label>
        <div id="filterSummary" class="filter-summary"></div>
        <div id="expenseList" class="expense-list"></div>
      </div>

      <!-- إدارة التصنيفات -->
      <div class="card">
        <div class="card-header">
          <h3>التصنيفات</h3>
        </div>
        <div class="form-group" style="margin-bottom:6px;">
          <div style="display:flex; gap:6px;">
            <input
              id="newCategoryInput"
              type="text"
              class="form-input form-input-sm"
              placeholder="إضافة تصنيف جديد (مثال: قهوة)"
            />
            <button id="btnAddCategory" class="btn btn-outline btn-sm">+ إضافة</button>
          </div>
        </div>
        <div id="categoryList"></div>
      </div>
    </div>

    <!-- تبويب مقارنة الأشهر -->
    <div id="tab-compare" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3>مقارنة مصاريف الأشهر</h3>
        </div>
        <div id="compareContainer" class="compare-row"></div>
      </div>
    </div>

    <!-- تبويب ملاحظاتي والحسابات (محمي برقم PIN) -->
    <div id="tab-private" style="display:none;">
      <div id="privateSection" class="private-section-locked">
        <div class="private-lock-container">
          <div class="private-lock-icon">🔐</div>
          <div class="private-lock-text">بيانات حساسة محمية برقم PIN</div>
          <div class="private-pin-input-group">
            <input id="privatePinInput" type="text" inputmode="numeric" pattern="[0-9]*" class="private-pin-input" placeholder="0000" maxlength="6" />
            <button id="btnOpenPrivate" class="btn-open-private">فتح</button>
          </div>
          <div id="privateErrorMsg" class="private-error-msg"></div>
        </div>
      </div>

      <div id="privateContent" class="private-content" style="display:none;">
        <!-- قسم رصيدي الكامل -->
        <div class="private-card budget-summary-card">
          <div class="private-card-title">💰 رصيدي الكامل</div>
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- حقل الرصيد الكلي -->
            <div class="budget-input-group">
              <label style="font-size: 11px; color: var(--subtext-color); font-weight: 600; margin-bottom: 4px; display: block;">إجمالي أموالي</label>
              <input id="totalBalanceInput" type="text" inputmode="numeric" class="form-input form-input-sm" placeholder="0" />
            </div>

            <!-- اختيار نطاق الأشهر -->
            <div class="budget-range-group">
              <label style="font-size: 11px; color: var(--subtext-color); font-weight: 600; margin-bottom: 6px; display: block;">📅 احسب من:</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                <div>
                  <label style="font-size: 10px; color: var(--subtext-color); display: block; margin-bottom: 3px;">من</label>
                  <select id="budgetFromMonth" class="form-select form-select-sm"></select>
                </div>
                <div>
                  <label style="font-size: 10px; color: var(--subtext-color); display: block; margin-bottom: 3px;">إلى</label>
                  <select id="budgetToMonth" class="form-select form-select-sm"></select>
                </div>
              </div>
            </div>

            <!-- ملخص الحسابات -->
            <div class="budget-summary">
              <div class="budget-stat">
                <span class="budget-stat-label">المصروف</span>
                <span id="privateTotalExpenses" class="budget-stat-value danger">0</span>
              </div>
              <div class="budget-stat">
                <span class="budget-stat-label">الأشهر</span>
                <span id="privateAllMonthsCount" class="budget-stat-value">0</span>
              </div>
              <div class="budget-stat">
                <span class="budget-stat-label">المتبقي</span>
                <span id="privateActualRemaining" class="budget-stat-value success">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- قسم تقسيم الرصيد حسب الفئات -->
        <div class="private-card budget-allocation-card">
          <div class="private-card-title">📊 توزيع رصيدي</div>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <div id="budgetAllocations" class="budget-allocations-container"></div>
            <button id="btnAddAllocation" class="btn btn-outline btn-sm" style="width: 100%; margin-top: 4px;">+ إضافة فئة جديدة</button>
          </div>
        </div>

        <!-- قسم الحاسبة الذكية -->
        <div class="private-card">
          <div class="private-card-title">🧮 حاسبتي الذكية</div>
          <div class="private-calculator">
            <input id="calcInput" type="text" class="calc-input" placeholder="مثال: 100 + 50 * 2 - 20" />
            <div class="calc-result" id="calcResult">انتظر الحساب...</div>
            <div style="font-size: 11px; color: var(--subtext-color); text-align: center;">
              تدعم: + (جمع) | - (طرح) | * (ضرب) | / (قسمة)
            </div>
          </div>
        </div>



        <!-- قسم الملاحظات العامة -->
        <div class="private-card">
          <div class="private-card-title">📝 ملاحظاتي العامة</div>
          <textarea id="privateNotes" class="private-notes-textarea" placeholder="اكتب ملاحظاتك هنا... (آخر تحديث يتم حفظها تلقائياً)"></textarea>
          <div class="private-notes-meta" id="privateNotesLastUpdate"></div>
        </div>

        <!-- زر تعطيل PIN -->
        <div class="private-card" style="background: linear-gradient(135deg, rgba(239,68,68,0.05), rgba(239,68,68,0.03));">
          <div class="private-card-title" style="color: #b91c1c;">⚙️ إعدادات الأمان</div>
          <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="checkbox" id="pinEnabledToggle" checked />
              <span>تفعيل قفل PIN</span>
            </label>
            <div style="font-size: 11px; color: var(--subtext-color);">
              عطّل هذا الخيار إذا كنت تريد الوصول المباشر بدون كلمة سر.
            </div>
            <button id="btnChangePinCode" class="btn btn-outline btn-sm">🔄 تغيير رقم PIN</button>
          </div>
        </div>

        <!-- زر تسجيل الخروج من القسم -->
        <button id="btnPrivateLogout" class="btn-private-logout">🔒 قفل هذا القسم</button>
      </div>
    </div>

 <!-- تبويب لوحة التحكم (يظهر للمدير فقط) -->
<div id="tab-admin" style="display:none;">

  <div class="card">
    <div class="card-header">
      <h3>لوحة تحكم المدير</h3>
      <button id="btnAdminRefresh" class="btn btn-outline btn-sm">🔄 تحديث البيانات</button>
    </div>

    <div id="adminNote" class="login-small-note">
      يمكنك هنا مشاهدة ملخص رواتب ومصاريف جميع المستخدمين مع تفاصيل الأشهر.<br>
      <strong>مهم:</strong> هذه الصفحة تعمل فقط لحساب المدير.
    </div>
  </div>

  <!-- قسم الإعدادات الإدارية -->
  <div class="card">
    <div class="card-header">
      <h3>🔧 الإعدادات الإدارية</h3>
    </div>

    <!-- قفل التسجيل الجديد -->
    <div class="admin-settings-card">
      <div class="admin-settings-group">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <label class="admin-settings-label">
            📋 التسجيل الجديد
          </label>
          <button id="btnToggleRegistration" class="toggle-switch active">
            <div class="toggle-circle"></div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="adminUsersContainer" class="admin-users-container"></div>

  <div class="admin-note">
    ⚠️ يمكنك حذف بيانات المستخدمين أو تعطيلهم، لكن لا يمكن حذف حسابهم من Firebase Auth.
  </div>

</div>
  <!-- مودال إدارة الشهر -->
  <div id="modalMonth" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalMonthTitle">إدارة الشهر</h3>
        <button id="btnCloseMonth" class="btn btn-outline btn-sm">✕</button>
      </div>
      <div class="form-group">
        <label class="form-label">الشهر</label>
        <select id="monthInput" class="form-select">
          <option value="1">يناير</option>
          <option value="2">فبراير</option>
          <option value="3">مارس</option>
          <option value="4">أبريل</option>
          <option value="5">مايو</option>
          <option value="6">يونيو</option>
          <option value="7">يوليو</option>
          <option value="8">أغسطس</option>
          <option value="9">سبتمبر</option>
          <option value="10">أكتوبر</option>
          <option value="11">نوفمبر</option>
          <option value="12">ديسمبر</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">السنة</label>
        <input id="yearInput" type="number" inputmode="numeric" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">الراتب الشهري</label>
        <input
          id="salaryInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="مثال: 1.000.000"
        />
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteMonthBtn" class="btn btn-outline btn-sm" style="display:none;">
          🗑️ حذف الشهر
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelMonth">إلغاء</button>
          <button id="saveMonthBtn" class="btn btn-primary">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال المصروف -->
  <div id="modalExpense" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h3 id="expenseModalTitle">إضافة مصروف</h3>
        <button id="btnCloseExpense" class="btn btn-outline btn-sm">✕</button>
      </div>
      <div class="form-group">
        <label class="form-label">عنوان المصروف</label>
        <input
          id="expenseTitleInput"
          type="text"
          class="form-input"
          placeholder="مثال: غداء، بنزين، شراء كتاب"
        />
      </div>
      <div class="form-group">
        <label class="form-label">المبلغ</label>
        <input
          id="expenseAmountInput"
          type="text"
          inputmode="numeric"
          class="form-input"
          placeholder="مثال: 25.000"
        />
      </div>
      <div class="form-group">
        <label class="form-label">التصنيف</label>
        <select id="expenseCategoryInput" class="form-select"></select>
        <div id="categoryError" style="color: var(--danger); font-size: 12px; margin-top: 3px; display: none;">⚠️ من فضلك اختر تصنيفًا</div>
      </div>
      <div class="form-group">
        <label class="form-label">التاريخ</label>
        <input id="expenseDateInput" type="date" class="form-input" />
      </div>
      <div class="form-group">
        <label class="form-label">ملاحظات</label>
        <textarea
          id="expenseNoteInput"
          class="form-textarea"
          placeholder="تفاصيل إضافية إن وجدت"
        ></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">صورة (اختياري)</label>
        <input id="expenseImageInput" type="file" accept="image/*" class="form-input" />
        <!-- معاينة الصورة -->
        <div id="imagePreviewContainer" class="image-preview-container">
          <div class="image-preview-box">
            <img id="imagePreviewImg" src="" alt="معاينة الصورة" />
          </div>
          <div class="image-preview-info">
            <span class="image-preview-filename" id="imagePreviewFilename"></span>
            <span class="image-preview-size" id="imagePreviewSize"></span>
          </div>
          <button type="button" id="imagePreviewRemove" class="image-preview-remove">
            ✕ إزالة الصورة
          </button>
        </div>
      </div>
      <div class="modal-footer" style="justify-content: space-between;">
        <button id="deleteExpenseBtn" class="btn btn-outline btn-sm" style="display:none;">
          🗑️ حذف المصروف
        </button>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-outline" id="btnCancelExpense">إلغاء</button>
          <button id="saveExpenseBtn" class="btn btn-primary">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- مودال عرض الصورة -->
  <div id="modalImage" class="modal-backdrop">
    <div class="modal image-modal">
      <img id="imageModalView" src="" alt="صورة المصروف" />
    </div>
  </div>

  <!-- مودال تغيير كلمة السر -->
  <div id="modalPassword" class="modal-backdrop" style="display:none;">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>🔐 تغيير كلمة السر</h3>
        <button id="btnClosePassword" class="btn btn-outline btn-sm">✕</button>
      </div>
      <div class="form-group">
        <label class="form-label">كلمة السر الحالية</label>
        <input 
          id="modalCurrentPassword" 
          type="password" 
          class="form-input" 
          placeholder="كلمة السر الحالية"
        />
      </div>
      <div class="form-group">
        <label class="form-label">كلمة السر الجديدة</label>
        <input 
          id="modalNewPassword" 
          type="password" 
          class="form-input" 
          placeholder="كلمة السر الجديدة (6 أحرف على الأقل)"
        />
      </div>
      <div class="form-group">
        <label class="form-label">تأكيد كلمة السر الجديدة</label>
        <input 
          id="modalConfirmPassword" 
          type="password" 
          class="form-input" 
          placeholder="تأكيد كلمة السر الجديدة"
        />
      </div>
      <div id="modalPasswordMessage" style="font-size: 13px; margin-bottom: 12px; min-height: 18px;"></div>
      <button id="btnModalChangePassword" class="btn btn-primary" style="width: 100%;">
        ✓ تحديث كلمة السر
      </button>
    </div>
  </div>

  <!-- سكربت التطبيق + Firebase -->
  <script type="module">
    /* ⚠️ ملاحظة الأمان:
     * - كل مستخدم له بيانات منفصلة في localStorage (محمي برقم UID الفريد)
     * - البيانات في Firebase مخزنة في مسار users/{uid}/state (محمي بـ UID)
     * - يتم مسح جميع البيانات من الذاكرة عند تسجيل الخروج
     * - يجب تطبيق Firebase Security Rules للحماية الإضافية
     */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
    import {
  getDatabase,
  ref,
  set,
  get,
  remove,
} from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
     
    import {
      getAuth,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      updatePassword,
      reauthenticateWithCredential,
      EmailAuthProvider,
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
      authDomain: "mony-ecb81.firebaseapp.com",
      databaseURL: "https://mony-ecb81-default-rtdb.firebaseio.com",
      projectId: "mony-ecb81",
      storageBucket: "mony-ecb81.firebasestorage.app",
      messagingSenderId: "1099032510981",
      appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
      measurementId: "G-PVHFMZ82XL",
    };

    const ADMIN_UID = "6Ss694f4QSOPYeM5TWnfnlxP2O32";

    let app = null;
    let db = null;
    let auth = null;
    let firebaseEnabled = false;

    try {
      app = initializeApp(firebaseConfig);
      db = getDatabase(app);
      auth = getAuth(app);
      firebaseEnabled = true;
    } catch (e) {
      console.warn("Firebase init failed:", e);
    }

    const STORAGE_KEY_PREFIX = "expense_manager_";
    const THEME_KEY = "expense_manager_theme";
    const LAST_UID_KEY = STORAGE_KEY_PREFIX + "last_uid";
    const SYNC_QUEUE_KEY = STORAGE_KEY_PREFIX + "sync_queue";
    const LAST_SYNC_KEY = STORAGE_KEY_PREFIX + "last_sync";
    const defaultCategories = ["أكل", "مواصلات", "تسوق", "فواتير", "ترفيه", "أخرى"];

    // متغيرات لمراقبة حالة الاتصال والمزامنة
    let isOnline = navigator.onLine;
    let isSyncing = false;
    let syncQueue = [];

    // مراقبة حالة الاتصال بالانترنت
    window.addEventListener("online", () => {
      isOnline = true;
      updateConnectionUI();
      // محاولة مزامنة البيانات المعلقة عند العودة للاتصال
      syncPendingChanges();
    });

    window.addEventListener("offline", () => {
      isOnline = false;
      updateConnectionUI();
    });

    // تحديث الواجهة لإظهار حالة الاتصال
    function updateConnectionUI() {
      const indicator = document.querySelector(".connection-indicator");
      if (!indicator) return;
      
      if (isOnline) {
        indicator.classList.remove("offline");
        indicator.classList.add("online");
      } else {
        indicator.classList.remove("online");
        indicator.classList.add("offline");
      }
    }

    let state = {
      months: [],
      selectedMonthId: null,
      categories: [...defaultCategories],
    };

    let filterState = {
      search: "",
      category: "all",
      hasImageOnly: false,
    };

    // حالة القسم المحمي
    let privateState = {
      pinCode: "1234", // الرقم الافتراضي
      pinEnabled: true,
      isUnlocked: false,
      totalBalance: 0,
      budgetFromMonth: null,
      budgetToMonth: null,
      allocations: [
        { id: 1, name: "جامعة", amount: 0 },
        { id: 2, name: "مواصلات", amount: 0 },
        { id: 3, name: "أكل", amount: 0 }
      ],
      notes: "",
      lastNotesUpdate: null,
      nextAllocationId: 4
    };

    let currentUser = null;
    let userRef = null;

    function getStorageKey() {
      if (currentUser && currentUser.uid) {
        return STORAGE_KEY_PREFIX + currentUser.uid;
      }
      return STORAGE_KEY_PREFIX + "guest";
    }

    const monthNames = [
      "",
      "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
      "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر",
    ];

    function formatNumber(value) {
      if (value === null || value === undefined) return "0";
      const number =
        typeof value === "number"
          ? value
          : parseInt(String(value).replace(/\D/g, "")) || 0;
      return number.toLocaleString("en-US");
    }

    function parseFormattedNumber(str) {
      if (!str) return 0;
      const digits = str.replace(/\D/g, "");
      return parseInt(digits || "0", 10);
    }

    function generateMonthId(year, month) {
      return `${year}-${String(month).padStart(2, "0")}`;
    }

    function normalizeState(raw) {
      let s = raw && typeof raw === "object" ? raw : {};
      if (!Array.isArray(s.months)) s.months = [];
      if (!Array.isArray(s.categories)) s.categories = [...defaultCategories];
      if (s.categories.length === 0) s.categories = [...defaultCategories];
      if (typeof s.selectedMonthId !== "string") s.selectedMonthId = null;

      s.months.forEach((m) => {
        if (!Array.isArray(m.expenses)) m.expenses = [];
        m.year = parseInt(m.year) || new Date().getFullYear();
        m.month = parseInt(m.month) || 1;
        m.name = monthNames[m.month] || m.name || "";
        m.salary = parseInt(m.salary) || 0;
        m.id = m.id || generateMonthId(m.year, m.month);
      });

      if (s.months.length === 0) {
        const now = new Date();
        const month = now.getMonth() + 1;
        const year = now.getFullYear();
        const id = generateMonthId(year, month);
        s.months.push({
          id,
          year,
          month,
          name: monthNames[month],
          salary: 0,
          expenses: [],
        });
        s.selectedMonthId = id;
      } else {
        if (!s.months.find((m) => m.id === s.selectedMonthId)) {
          s.selectedMonthId = s.months[s.months.length - 1].id;
        }
      }

      return s;
    }

    function getSelectedMonth() {
      return state.months.find((m) => m.id === state.selectedMonthId) || null;
    }

    function saveStateLocal() {
      const key = getStorageKey();
      localStorage.setItem(key, JSON.stringify(state));
    }

    async function saveStateRemote() {
      if (!firebaseEnabled || !currentUser || !userRef) return;
      try {
        await set(userRef, state);
        // تسجيل وقت آخر مزامنة ناجحة
        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
        return true;
      } catch (e) {
        console.warn("Failed to sync with Firebase:", e);
        return false;
      }
    }

    // إضافة البيانات إلى قائمة الانتظار للمزامنة
    function queueForSync(action, data) {
      try {
        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || "[]");
        queue.push({
          action,
          data,
          timestamp: Date.now(),
          id: Math.random().toString(36).substr(2, 9)
        });
        localStorage.setItem(SYNC_QUEUE_KEY, JSON.stringify(queue));
      } catch (e) {
        console.warn("Failed to queue sync:", e);
      }
    }

    // معالجة قائمة الانتظار عند العودة للاتصال
    async function syncPendingChanges() {
      if (isSyncing || !isOnline || !firebaseEnabled || !currentUser) return;
      
      isSyncing = true;
      try {
        const queue = JSON.parse(localStorage.getItem(SYNC_QUEUE_KEY) || "[]");
        if (queue.length === 0) {
          isSyncing = false;
          return;
        }

        // محاولة المزامنة
        const success = await saveStateRemote();
        if (success) {
          // حذف قائمة الانتظار بعد المزامنة الناجحة
          localStorage.removeItem(SYNC_QUEUE_KEY);
        }
      } catch (e) {
        console.warn("Sync failed:", e);
      } finally {
        isSyncing = false;
      }
    }

    async function saveState() {
      saveStateLocal();
      
      if (!isOnline) {
        // إذا كنا دون اتصال، أضف للقائمة
        queueForSync("save", state);
        return;
      }
      
      // إذا كان هناك اتصال، حاول المزامنة مباشرة
      const success = await saveStateRemote();
      if (!success) {
        // إذا فشلت المزامنة، أضف للقائمة
        queueForSync("save", state);
      }
    }

    function loadStateLocal() {
      const key = getStorageKey();
      const raw = localStorage.getItem(key);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        state = normalizeState(data);
      } catch (e) {
        console.error("Failed to parse local state:", e);
      }
    }

    async function loadStateRemoteIfExists() {
      if (!firebaseEnabled || !currentUser || !userRef) return;
      try {
        const snap = await get(userRef);
        if (snap.exists()) {
          const remoteState = normalizeState(snap.val());
          state = remoteState;
        } else {
          await set(userRef, state);
        }
      } catch (e) {
        console.warn("Failed to load from Firebase:", e);
      }
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      root.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      const btn = document.getElementById("btnToggleTheme");
      if (btn) btn.textContent = theme === "dark" ? "☀️ الوضع الفاتح" : "🌙 الوضع الداكن";
    }

    /* ======= عناصر DOM ======= */

    const loginView = document.getElementById("loginView");
    const appView = document.getElementById("appView");

    const appLoader = document.getElementById("appLoader");
    const authErrorEl = document.getElementById("authError");

    // Login form elements
    const loginEmailInput = document.getElementById("loginEmail");
    const loginPasswordInput = document.getElementById("loginPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnTogglePwLogin = document.getElementById("btnTogglePwLogin");

    // Register form elements
    const registerEmailInput = document.getElementById("registerEmail");
    const registerPasswordInput = document.getElementById("registerPassword");
    const registerPasswordConfirmInput = document.getElementById("registerPasswordConfirm");
    const btnRegister = document.getElementById("btnRegister");
    const registerErrorEl = document.getElementById("registerError");
    const btnCancelRegister = document.getElementById("btnCancelRegister");

    const userEmailLabel = document.getElementById("userEmailLabel");
    const btnLogout = document.getElementById("btnLogout");
    const btnToggleTheme = document.getElementById("btnToggleTheme");

    const tabButtons = document.querySelectorAll(".tab-btn");
const tabMonth = document.getElementById("tab-month");
const tabCompare = document.getElementById("tab-compare");
const tabPrivate = document.getElementById("tab-private");
const tabAdminBtn = document.getElementById("tabAdminBtn");

    // عناصر القسم المحمي
    const privateSection = document.getElementById("privateSection");
    const privateContent = document.getElementById("privateContent");
    const privatePinInput = document.getElementById("privatePinInput");
    const btnOpenPrivate = document.getElementById("btnOpenPrivate");
    const privateErrorMsg = document.getElementById("privateErrorMsg");
    const btnPrivateLogout = document.getElementById("btnPrivateLogout");
    const totalBalanceInput = document.getElementById("totalBalanceInput");
    const privateTotalExpenses = document.getElementById("privateTotalExpenses");
    const privateAllMonthsCount = document.getElementById("privateAllMonthsCount");
    const privateActualRemaining = document.getElementById("privateActualRemaining");
    const budgetFromMonth = document.getElementById("budgetFromMonth");
    const budgetToMonth = document.getElementById("budgetToMonth");
    const budgetAllocationsContainer = document.getElementById("budgetAllocations");
    const btnAddAllocation = document.getElementById("btnAddAllocation");
    const calcInput = document.getElementById("calcInput");
    const calcResult = document.getElementById("calcResult");
    const privateNotes = document.getElementById("privateNotes");
    const privateNotesLastUpdate = document.getElementById("privateNotesLastUpdate");
    const pinEnabledToggle = document.getElementById("pinEnabledToggle");
    const btnChangePinCode = document.getElementById("btnChangePinCode");

const adminUsersContainer = document.getElementById("adminUsersContainer");
const adminNoteEl = document.getElementById("adminNote");
const btnAdminRefresh = document.getElementById("btnAdminRefresh");
const btnToggleRegistration = document.getElementById("btnToggleRegistration");
const registrationStatusEl = document.getElementById("registrationStatus");
const btnChangePasswordQuick = document.getElementById("btnChangePasswordQuick");
const modalPassword = document.getElementById("modalPassword");
const btnClosePassword = document.getElementById("btnClosePassword");
const btnModalChangePassword = document.getElementById("btnModalChangePassword");
const modalCurrentPassword = document.getElementById("modalCurrentPassword");
const modalNewPassword = document.getElementById("modalNewPassword");
const modalConfirmPassword = document.getElementById("modalConfirmPassword");
const modalPasswordMessage = document.getElementById("modalPasswordMessage");

    const tabAdmin = document.getElementById("tab-admin");
    const adminTabBtn = document.getElementById("adminTabBtn");

    const monthSelect = document.getElementById("monthSelect");
    const btnAddMonth = document.getElementById("btnAddMonth");
    const btnEditMonth = document.getElementById("btnEditMonth");

    const summarySalaryEl = document.getElementById("summarySalary");
    const summaryExpensesEl = document.getElementById("summaryExpenses");
    const summaryRemainingEl = document.getElementById("summaryRemaining");

    const advancedStatsToggle = document.getElementById("advancedStatsToggle");
    const advancedStatsIcon = document.getElementById("advancedStatsIcon");
    const advancedStatsBody = document.getElementById("advancedStatsBody");
    const dailyAvgEl = document.getElementById("statDailyAvg");
    const remainingPerDayEl = document.getElementById("statRemainingPerDay");
    const maxExpenseEl = document.getElementById("statMaxExpense");
    const topCategoryEl = document.getElementById("statTopCategory");
    const categoryBars = document.getElementById("categoryBars");

    const btnAddExpense = document.getElementById("btnAddExpense");
    const expenseList = document.getElementById("expenseList");
    const searchInput = document.getElementById("searchInput");
    const filterCategory = document.getElementById("filterCategory");
    const filterHasImage = document.getElementById("filterHasImage");
    const filterSummaryEl = document.getElementById("filterSummary");

    const newCategoryInput = document.getElementById("newCategoryInput");
    const btnAddCategory = document.getElementById("btnAddCategory");
    const categoryList = document.getElementById("categoryList");

    const modalMonth = document.getElementById("modalMonth");
    const modalMonthTitle = document.getElementById("modalMonthTitle");
    const monthInput = document.getElementById("monthInput");
    const yearInput = document.getElementById("yearInput");
    const salaryInput = document.getElementById("salaryInput");
    const deleteMonthBtn = document.getElementById("deleteMonthBtn");
    const saveMonthBtn = document.getElementById("saveMonthBtn");
    const btnCancelMonth = document.getElementById("btnCancelMonth");
    const btnCloseMonth = document.getElementById("btnCloseMonth");

    const modalExpense = document.getElementById("modalExpense");
    const expenseModalTitle = document.getElementById("expenseModalTitle");
    const expenseTitleInput = document.getElementById("expenseTitleInput");
    const expenseAmountInput = document.getElementById("expenseAmountInput");
    const expenseCategoryInput = document.getElementById("expenseCategoryInput");
    const expenseDateInput = document.getElementById("expenseDateInput");
    const expenseNoteInput = document.getElementById("expenseNoteInput");
    const expenseImageInput = document.getElementById("expenseImageInput");
    const deleteExpenseBtn = document.getElementById("deleteExpenseBtn");
    const saveExpenseBtn = document.getElementById("saveExpenseBtn");
    const btnCancelExpense = document.getElementById("btnCancelExpense");
    const btnCloseExpense = document.getElementById("btnCloseExpense");

    const modalImage = document.getElementById("modalImage");
    const imageModalView = document.getElementById("imageModalView");

    const compareContainer = document.getElementById("compareContainer");
    const monthRow = document.querySelector(".month-row");

    let editingMonthId = null;
    let editingExpenseId = null;
    let isSavingExpense = false; // علم للتحكم بعملية الحفظ ومنع التكرار

    /* ======= تسجيل الدخول (نماذج منفصلة) ======= */

    const tabLoginBtn = document.getElementById("tabLogin");
    const tabRegisterBtn = document.getElementById("tabRegister");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");

    function switchToLogin() {
      tabLoginBtn.classList.add("active");
      tabRegisterBtn.classList.remove("active");
      loginForm.style.display = "block";
      registerForm.style.display = "none";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    function switchToRegister() {
      tabLoginBtn.classList.remove("active");
      tabRegisterBtn.classList.add("active");
      loginForm.style.display = "none";
      registerForm.style.display = "block";
      authErrorEl.textContent = "";
      registerErrorEl.textContent = "";
    }

    tabLoginBtn.addEventListener("click", switchToLogin);
    tabRegisterBtn.addEventListener("click", switchToRegister);
    btnCancelRegister.addEventListener("click", (e) => {
      e.preventDefault();
      switchToLogin();
    });

    // Toggle password visibility
    if (btnTogglePwLogin) {
      btnTogglePwLogin.addEventListener("click", () => {
        const isPassword = loginPasswordInput.type === "password";
        loginPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwLogin.textContent = isPassword ? "🙈" : "👁️";
      });
    }
    const btnTogglePwReg = document.getElementById("btnTogglePwReg");
    if (btnTogglePwReg) {
      btnTogglePwReg.addEventListener("click", () => {
        const isPassword = registerPasswordInput.type === "password";
        registerPasswordInput.type = isPassword ? "text" : "password";
        btnTogglePwReg.textContent = isPassword ? "🙈" : "👁️";
      });
    }

    btnRegister.addEventListener("click", async () => {
      registerErrorEl.textContent = "";
      const email = (registerEmailInput.value || "").trim();
      const password = (registerPasswordInput.value || "").trim();
      const confirm = (registerPasswordConfirmInput.value || "").trim();
      if (!email || !password) {
        registerErrorEl.textContent = "أدخل البريد وكلمة السر.";
        return;
      }
      if (password !== confirm) {
        registerErrorEl.textContent = "كلمة السر وتأكيدها غير متطابقين.";
        return;
      }
      if (!firebaseEnabled || !auth) {
        registerErrorEl.textContent = "يتطلب إنشاء الحساب اتصالاً بالإنترنت. حاول مرة أخرى عند توفر الشبكة.";
        return;
      }

      // التحقق من حالة التسجيل
      try {
        if (firebaseEnabled && db) {
          const statusRef = ref(db, "settings/registrationEnabled");
          const snap = await get(statusRef);
          const isEnabled = snap.exists() ? snap.val() : true;
          if (!isEnabled) {
            registerErrorEl.textContent = "✗ التسجيل الجديد معطّل حالياً. يرجى التواصل مع المسؤول.";
            return;
          }
        }
      } catch (err) {
        console.error("Error checking registration status:", err);
        // في حالة الخطأ، اسمح بالمتابعة
      }

      try {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = result.user;
        userRef = ref(db, "users/" + currentUser.uid + "/state");
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        await saveStateRemote();
        if (firebaseEnabled && db) {
          try {
            await set(ref(db, "users/" + currentUser.uid + "/profile"), {
              email: currentUser.email || email,
            });
          } catch (e) {
            console.warn("Failed to save user profile:", e);
          }
        }
        registerPasswordInput.value = "";
        registerPasswordConfirmInput.value = "";
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}
        try { localStorage.setItem(STORAGE_KEY_PREFIX + currentUser.uid + "_profile", JSON.stringify({ email: currentUser.email || "" })); } catch (e) {}
      } catch (e) {
        console.error(e);
        registerErrorEl.textContent = "تعذر إنشاء الحساب. تأكد من صحة البريد وكلمة السر.";
      }
    });

    btnLogin.addEventListener("click", async () => {
      authErrorEl.textContent = "";
      const email = (loginEmailInput.value || "").trim();
      const password = (loginPasswordInput.value || "").trim();
      if (!email || !password) {
        authErrorEl.textContent = "أدخل البريد وكلمة السر.";
        return;
      }

      const loginProcessingBar = document.getElementById("loginProcessingBar");
      try {
        // show processing UI
        if (loginProcessingBar) {
          loginProcessingBar.style.display = "flex";
          loginProcessingBar.classList.remove("fade-out");
          loginProcessingBar.classList.add("fade-in");
        }
        btnLogin.disabled = true;

        await signInWithEmailAndPassword(auth, email, password);
        loginPasswordInput.value = "";
      } catch (e) {
        console.error(e);
        authErrorEl.textContent = "بيانات الدخول غير صحيحة أو حدث خطأ.";
      } finally {
        // hide processing UI
        if (loginProcessingBar) {
          loginProcessingBar.classList.remove("fade-in");
          loginProcessingBar.classList.add("fade-out");
          setTimeout(() => {
            if (loginProcessingBar) {
              loginProcessingBar.style.display = "none";
              loginProcessingBar.classList.remove("fade-out");
            }
          }, 320);
        }
        btnLogin.disabled = false;
      }
    });

    btnLogout.addEventListener("click", async () => {
      try {
        state = {
          months: [],
          selectedMonthId: null,
          categories: [...defaultCategories],
        };
        filterState = {
          search: "",
          category: "all",
          hasImageOnly: false,
        };
        currentUser = null;
        userRef = null;

        try { localStorage.removeItem(LAST_UID_KEY); } catch (e) {}

        await signOut(auth);
      } catch (e) {
        console.error(e);
        alert("حدث خطأ أثناء تسجيل الخروج.");
      }
    });

    /* ======= تبويبات ======= */

    /* ======= القسم المحمي (ملاحظاتي والحسابات) ======= */

    function loadPrivateState() {
      const key = getStorageKey();
      const savedPrivate = localStorage.getItem(key + "_private");
      if (savedPrivate) {
        try {
          const loaded = JSON.parse(savedPrivate);
          privateState = {
            ...privateState,
            ...loaded
          };
        } catch (e) {
          console.warn("Failed to load private state:", e);
        }
      }
      privateState.isUnlocked = false;
      resetPrivateUI();
      populateBudgetMonthSelects();
      updatePrivateSummary();
      
      // استعادة البيانات في الحقول
      totalBalanceInput.value = formatNumber(privateState.totalBalance || 0);
      if (privateState.budgetFromMonth && budgetFromMonth) {
        budgetFromMonth.value = privateState.budgetFromMonth;
      }
      if (privateState.budgetToMonth && budgetToMonth) {
        budgetToMonth.value = privateState.budgetToMonth;
      }
      if (privateNotes) {
        privateNotes.value = privateState.notes || "";
        if (privateState.lastNotesUpdate && privateNotesLastUpdate) {
          privateNotesLastUpdate.textContent = `آخر حفظ: ${privateState.lastNotesUpdate}`;
        }
      }
      if (pinEnabledToggle) {
        pinEnabledToggle.checked = privateState.pinEnabled !== false;
      }
    }

    function savePrivateState() {
      const key = getStorageKey();
      localStorage.setItem(key + "_private", JSON.stringify(privateState));
    }

    function resetPrivateUI() {
      privatePinInput.value = "";
      privateErrorMsg.textContent = "";
      calcResult.textContent = "انتظر الحساب...";
      
      // إذا كان PIN معطّل، فتح مباشرة
      if (!privateState.pinEnabled) {
        privateSection.style.display = "none";
        privateContent.style.display = "flex";
        privateState.isUnlocked = true;
      } else {
        // إذا كان PIN مفعّل، أظهر شاشة القفل
        privateSection.style.display = "flex";
        privateContent.style.display = "none";
        privateState.isUnlocked = false;
      }
    }

    function populateBudgetMonthSelects() {
      budgetFromMonth.innerHTML = "";
      budgetToMonth.innerHTML = "";

      state.months.forEach((m) => {
        const optFrom = document.createElement("option");
        optFrom.value = m.id;
        optFrom.textContent = `${m.name} ${m.year}`;
        budgetFromMonth.appendChild(optFrom);

        const optTo = document.createElement("option");
        optTo.value = m.id;
        optTo.textContent = `${m.name} ${m.year}`;
        budgetToMonth.appendChild(optTo);
      });

      if (state.months.length > 0) {
        budgetFromMonth.value = state.months[0].id;
        budgetToMonth.value = state.months[state.months.length - 1].id;
      }
    }

    function unlockPrivateSection() {
      // إذا كان القفل معطّل، فتح مباشرة
      if (!privateState.pinEnabled) {
        privateState.isUnlocked = true;
        privateSection.style.display = "none";
        privateContent.style.display = "flex";
        updatePrivateSummary();
        renderAllocations();
        // إخفاء الكيبورد بإزالة التركيز مؤقتاً
        document.activeElement.blur();
        setTimeout(() => {
          calcInput.focus();
        }, 300);
        return;
      }

      const pin = privatePinInput.value.trim();
      privateErrorMsg.textContent = "";

      if (!pin) {
        privateErrorMsg.textContent = "أدخل رقم PIN";
        return;
      }

      if (pin !== privateState.pinCode) {
        privateErrorMsg.textContent = "❌ رقم PIN غير صحيح";
        privatePinInput.value = "";
        privatePinInput.focus();
        return;
      }

      privateState.isUnlocked = true;
      privateSection.style.display = "none";
      privateContent.style.display = "flex";
      updatePrivateSummary();
      renderAllocations();
      // إخفاء الكيبورد بإزالة التركيز مؤقتاً
      document.activeElement.blur();
      setTimeout(() => {
        calcInput.focus();
      }, 300);
    }

    function lockPrivateSection() {
      privateState.isUnlocked = false;
      resetPrivateUI();
    }

    function updatePrivateSummary() {
      const fromMonthId = budgetFromMonth?.value || null;
      const toMonthId = budgetToMonth?.value || null;

      let totalExp = 0;
      let countedMonths = 0;

      if (fromMonthId && toMonthId) {
        const months = state.months.map(m => m.id);
        const fromIdx = months.indexOf(fromMonthId);
        const toIdx = months.indexOf(toMonthId);

        if (fromIdx !== -1 && toIdx !== -1) {
          const start = Math.min(fromIdx, toIdx);
          const end = Math.max(fromIdx, toIdx);

          for (let i = start; i <= end; i++) {
            const m = state.months[i];
            if (Array.isArray(m.expenses)) {
              m.expenses.forEach((e) => {
                totalExp += (e.amount || 0);
              });
            }
            countedMonths++;
          }
        }
      }

      privateTotalExpenses.textContent = formatNumber(totalExp);
      privateAllMonthsCount.textContent = countedMonths;

      const totalBal = parseFormattedNumber(totalBalanceInput.value || "0");
      const remaining = totalBal - totalExp;
      privateActualRemaining.textContent = formatNumber(remaining);
      privateActualRemaining.parentElement.className = "budget-stat-value " + (remaining >= 0 ? "success" : "danger");
    }

    function renderAllocations() {
      budgetAllocationsContainer.innerHTML = "";
      
      privateState.allocations.forEach((alloc, idx) => {
        const item = document.createElement("div");
        item.className = "allocation-item";
        item.style.animationDelay = (idx * 0.05) + "s";

        const inputs = document.createElement("div");
        inputs.className = "allocation-inputs";

        const nameInput = document.createElement("input");
        nameInput.type = "text";
        nameInput.className = "form-input form-input-sm";
        nameInput.value = alloc.name;
        nameInput.placeholder = "اسم الفئة";
        nameInput.addEventListener("change", () => {
          privateState.allocations[idx].name = nameInput.value;
          savePrivateState();
        });

        const amountInput = document.createElement("input");
        amountInput.type = "text";
        amountInput.inputMode = "numeric";
        amountInput.className = "form-input form-input-sm";
        amountInput.value = formatNumber(alloc.amount);
        amountInput.placeholder = "0";
        amountInput.addEventListener("input", () => {
          const digits = amountInput.value.replace(/\D/g, "");
          amountInput.value = formatNumber(digits);
          amountInput.selectionEnd = amountInput.value.length;
          privateState.allocations[idx].amount = parseFormattedNumber(amountInput.value);
          savePrivateState();
          updateAllocationResult(idx);
        });

        inputs.appendChild(nameInput);
        inputs.appendChild(amountInput);

        const resultDiv = document.createElement("div");
        resultDiv.className = "allocation-result";
        const resultLabel = document.createElement("div");
        resultLabel.className = "allocation-result-label";
        resultLabel.textContent = "متبقي";
        const resultValue = document.createElement("div");
        resultValue.className = "allocation-result-value";
        resultValue.id = "alloc-result-" + alloc.id;
        resultValue.textContent = "0";
        resultDiv.appendChild(resultLabel);
        resultDiv.appendChild(resultValue);

        const removeBtn = document.createElement("button");
        removeBtn.className = "allocation-remove-btn";
        removeBtn.textContent = "حذف";
        removeBtn.addEventListener("click", () => {
          privateState.allocations.splice(idx, 1);
          savePrivateState();
          renderAllocations();
        });

        item.appendChild(inputs);
        item.appendChild(resultDiv);
        item.appendChild(removeBtn);

        budgetAllocationsContainer.appendChild(item);
      });

      // تحديث النتائج
      privateState.allocations.forEach((_, idx) => updateAllocationResult(idx));
    }

    function updateAllocationResult(idx) {
      const totalBal = parseFormattedNumber(totalBalanceInput.value || "0");
      const totalUsed = privateState.allocations.reduce((sum, a) => sum + (a.amount || 0), 0);
      const remaining = totalBal - totalUsed;

      const resultEl = document.getElementById("alloc-result-" + privateState.allocations[idx].id);
      if (resultEl) {
        resultEl.textContent = formatNumber(remaining);
        resultEl.parentElement.style.color = remaining >= 0 ? "#10b981" : "#ef4444";
      }
    }

    function evaluateExpression(expr) {
      try {
        const sanitized = expr.trim()
          .replace(/[^\d+\-*/.()]/g, "")
          .replace(/\d+/g, (match) => match)
          .trim();

        if (!sanitized) return "أدخل معادلة";

        if (!/^[\d+\-*/.()]+$/.test(sanitized)) {
          return "معادلة غير صحيحة";
        }

        const result = new Function(`"use strict"; return (${sanitized})`)();
        
        if (typeof result !== "number" || !isFinite(result)) {
          return "خطأ في الحساب";
        }

        return formatNumber(Math.round(result * 100) / 100);
      } catch (e) {
        return "خطأ: " + (e.message || "معادلة غير صحيحة");
      }
    }

    function updateCalculator() {
      const expr = calcInput.value;
      if (!expr) {
        calcResult.textContent = "انتظر الحساب...";
        return;
      }
      const result = evaluateExpression(expr);
      calcResult.textContent = result;
    }

    function openChangePinDialog() {
      const newPin = prompt("أدخل رقم PIN جديد (4-6 أرقام):");
      if (!newPin) return;

      if (!/^\d{4,6}$/.test(newPin)) {
        alert("رقم PIN يجب أن يكون 4-6 أرقام فقط");
        return;
      }

      privateState.pinCode = newPin;
      savePrivateState();
      alert("✓ تم تحديث رقم PIN بنجاح");
    }

    // مستمعي أحداث القسم المحمي
    if (btnOpenPrivate) {
      btnOpenPrivate.addEventListener("click", unlockPrivateSection);
    }

    if (privatePinInput) {
      // تصفية الأرقام فقط من PIN input
      privatePinInput.addEventListener("input", (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, "");
      });

      privatePinInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") unlockPrivateSection();
      });
    }

    if (btnPrivateLogout) {
      btnPrivateLogout.addEventListener("click", lockPrivateSection);
    }

    if (totalBalanceInput) {
      totalBalanceInput.addEventListener("input", () => {
        const digits = totalBalanceInput.value.replace(/\D/g, "");
        totalBalanceInput.value = formatNumber(digits);
        totalBalanceInput.selectionEnd = totalBalanceInput.value.length;
        updatePrivateSummary();
        privateState.totalBalance = parseFormattedNumber(totalBalanceInput.value);
        savePrivateState();
        renderAllocations();
      });
    }

    if (budgetFromMonth) {
      budgetFromMonth.addEventListener("change", () => {
        privateState.budgetFromMonth = budgetFromMonth.value;
        savePrivateState();
        updatePrivateSummary();
      });
    }

    if (budgetToMonth) {
      budgetToMonth.addEventListener("change", () => {
        privateState.budgetToMonth = budgetToMonth.value;
        savePrivateState();
        updatePrivateSummary();
      });
    }

    if (btnAddAllocation) {
      btnAddAllocation.addEventListener("click", () => {
        privateState.allocations.push({
          id: privateState.nextAllocationId++,
          name: "فئة جديدة",
          amount: 0
        });
        savePrivateState();
        renderAllocations();
      });
    }

    if (calcInput) {
      calcInput.addEventListener("input", updateCalculator);
    }

    if (privateNotes) {
      privateNotes.addEventListener("input", () => {
        privateState.notes = privateNotes.value;
        privateState.lastNotesUpdate = new Date().toLocaleString("ar-EG");
        savePrivateState();
        if (privateNotesLastUpdate) {
          privateNotesLastUpdate.textContent = `آخر حفظ: ${privateState.lastNotesUpdate}`;
        }
      });
    }

    if (pinEnabledToggle) {
      pinEnabledToggle.addEventListener("change", () => {
        privateState.pinEnabled = pinEnabledToggle.checked;
        savePrivateState();
      });
    }

    if (btnChangePinCode) {
      btnChangePinCode.addEventListener("click", openChangePinDialog);
    }

    /* ======= تبويبات ======= */

tabButtons.forEach((btn) => {
  btn.addEventListener("click", async () => {
    tabButtons.forEach((b) => b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;

    if (tab === "month") {
      tabMonth.style.display = "block";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "flex";
    } else if (tab === "compare") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "block";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "none";
    } else if (tab === "private") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "block";
      if (tabAdmin) tabAdmin.style.display = "none";
      if (monthRow) monthRow.style.display = "none";
      loadPrivateState();
    } else if (tab === "admin") {
      tabMonth.style.display = "none";
      tabCompare.style.display = "none";
      if (tabPrivate) tabPrivate.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "block";
      if (monthRow) monthRow.style.display = "none";

      // عند فتح تبويب لوحة التحكم، حمّل بيانات المستخدمين
      await loadAdminUsers();
    }
  });
});


    /* ======= إحصائيات متقدمة طي/فتح ======= */

    advancedStatsToggle.addEventListener("click", () => {
      const isOpen = advancedStatsBody.classList.contains("open");
      if (isOpen) {
        advancedStatsBody.classList.remove("open");
        advancedStatsIcon.classList.remove("open");
      } else {
        advancedStatsBody.classList.add("open");
        advancedStatsIcon.classList.add("open");
      }
    });

    function refreshMonthSelect() {
      monthSelect.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "لا يوجد أشهر";
        monthSelect.appendChild(option);
        monthSelect.disabled = true;
        return;
      }
      monthSelect.disabled = false;
      state.months
        .slice()
        .sort((a, b) => a.year - b.year || a.month - b.month)
        .forEach((m) => {
          const option = document.createElement("option");
          option.value = m.id;
          option.textContent = `${m.name} ${m.year}`;
          monthSelect.appendChild(option);
        });
      if (!state.selectedMonthId) {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      monthSelect.value = state.selectedMonthId;
    }

    function renderSummary() {
      const month = getSelectedMonth();
      if (!month) {
        summarySalaryEl.textContent = "0";
        summaryExpensesEl.textContent = "0";
        summaryRemainingEl.textContent = "0";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const remaining = (month.salary || 0) - totalExpenses;

      summarySalaryEl.textContent = formatNumber(month.salary || 0);
      summaryExpensesEl.textContent = formatNumber(totalExpenses);
      summaryRemainingEl.textContent = formatNumber(remaining);

      summaryRemainingEl.classList.toggle("positive", remaining >= 0);
      summaryRemainingEl.classList.toggle("negative", remaining < 0);
    }

    function renderAdvancedStats() {
      const month = getSelectedMonth();
      categoryBars.innerHTML = "";
      if (!month) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "لا يوجد";
        return;
      }
      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        dailyAvgEl.textContent = "0";
        remainingPerDayEl.textContent = "0";
        maxExpenseEl.textContent = "0";
        topCategoryEl.textContent = "لا يوجد";
        return;
      }

      const today = new Date();
      const year = month.year;
      const monthIndex = month.month - 1;
      const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
      const nowMonth = today.getMonth();
      const nowYear = today.getFullYear();

      let daysPassed;
      if (nowMonth === monthIndex && nowYear === year) {
        daysPassed = today.getDate();
      } else {
        daysPassed = daysInMonth;
      }

      const totalExpenses = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
      const dailyAvg =
        daysPassed > 0 ? Math.round(totalExpenses / daysPassed) : totalExpenses;
      dailyAvgEl.textContent = formatNumber(dailyAvg);

      const remaining = (month.salary || 0) - totalExpenses;
      const daysRemaining =
        daysInMonth - (nowMonth === monthIndex && nowYear === year ? today.getDate() : daysInMonth);
      const remainingPerDay =
        daysRemaining > 0 ? Math.round(remaining / daysRemaining) : remaining;
      remainingPerDayEl.textContent = formatNumber(remainingPerDay);

      const maxExpense = expenses.reduce(
        (max, e) => (e.amount > max.amount ? e : max),
        expenses[0]
      );
      maxExpenseEl.textContent = `${formatNumber(maxExpense.amount || 0)} (${maxExpense.title || "مصروف"})`;

      const categoryTotals = {};
      expenses.forEach((e) => {
        const cat = e.category || "أخرى";
        categoryTotals[cat] = (categoryTotals[cat] || 0) + (e.amount || 0);
      });

      let topCategory = "لا يوجد";
      let topTotal = 0;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        if (total > topTotal) {
          topTotal = total;
          topCategory = cat;
        }
      });
      topCategoryEl.textContent = `${topCategory} (${formatNumber(topTotal)})`;

      const maxCatTotal = Math.max(...Object.values(categoryTotals)) || 1;
      Object.entries(categoryTotals).forEach(([cat, total]) => {
        const item = document.createElement("div");
        item.className = "category-bar";

        const top = document.createElement("div");
        top.className = "category-bar-top";
        const nameEl = document.createElement("span");
        nameEl.textContent = cat;
        const amountEl = document.createElement("span");
        amountEl.textContent = formatNumber(total);
        top.appendChild(nameEl);
        top.appendChild(amountEl);

        const bg = document.createElement("div");
        bg.className = "category-bar-bg";

        const fill = document.createElement("div");
        fill.className = "category-bar-fill";
        fill.style.width = (total / maxCatTotal) * 100 + "%";

        bg.appendChild(fill);
        item.appendChild(top);
        item.appendChild(bg);
        categoryBars.appendChild(item);
      });
    }

    function applyFilters(expenses) {
      const search = filterState.search.toLowerCase();
      const category = filterState.category;
      const hasImageOnly = filterState.hasImageOnly;

      return expenses.filter((e) => {
        if (category !== "all" && e.category !== category) return false;
        if (
          search &&
          !(
            (e.title || "").toLowerCase().includes(search) ||
            (e.note || "").toLowerCase().includes(search)
          )
        ) {
          return false;
        }
        if (hasImageOnly && !e.imageDataUrl) return false;
        return true;
      });
    }

    function renderExpenses() {
      const month = getSelectedMonth();
      expenseList.innerHTML = "";
      filterSummaryEl.textContent = "";

      if (!month) {
        expenseList.innerHTML =
          '<div class="empty-state">أضف شهرًا ثم أضف مصاريف لعرضها هنا.</div>';
        return;
      }

      const expenses = Array.isArray(month.expenses) ? month.expenses : [];
      if (expenses.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">لا توجد مصاريف لهذا الشهر بعد.</div>';
        return;
      }

      const sorted = expenses
        .slice()
        .sort((a, b) => b.id - a.id);

      const filtered = applyFilters(sorted);

      if (filtered.length === 0) {
        expenseList.innerHTML =
          '<div class="empty-state">لا توجد مصاريف مطابقة لخيارات البحث/الفلترة.</div>';
      } else {
        filtered.forEach((e) => {
          const item = document.createElement("div");
          item.className = "expense-item";

          const main = document.createElement("div");
          main.className = "expense-main";

          const title = document.createElement("div");
          title.className = "expense-title";
          title.textContent = e.title || "بدون عنوان";

          const meta = document.createElement("div");
          meta.className = "expense-meta";
          const catSpan = document.createElement("span");
          catSpan.textContent = e.category || "غير محدد";
          const dateSpan = document.createElement("span");
          dateSpan.textContent = e.date || "بدون تاريخ";
          meta.appendChild(catSpan);
          meta.appendChild(document.createTextNode(" · "));
          meta.appendChild(dateSpan);

          const note = document.createElement("div");
          note.className = "expense-note";
          note.textContent = e.note || "";

          main.appendChild(title);
          main.appendChild(meta);
          if (e.note) main.appendChild(note);

          if (e.imageDataUrl) {
            const imgBadge = document.createElement("div");
            imgBadge.className = "expense-image-badge";
            imgBadge.textContent = "📷 توجد صورة";
            main.appendChild(imgBadge);

            const img = document.createElement("img");
            img.src = e.imageDataUrl;
            img.alt = "صورة المصروف";
            img.className = "expense-thumb";
            img.addEventListener("click", () => {
              imageModalView.src = e.imageDataUrl;
              modalImage.style.display = "flex";
            });
            main.appendChild(img);
          }

          const actions = document.createElement("div");
          actions.className = "expense-actions";
          const editBtn = document.createElement("button");
          editBtn.className = "btn-ghost btn-edit";
          editBtn.textContent = "✏️ تعديل";
          editBtn.addEventListener("click", () => openExpenseModal(e.id));

          const delBtn = document.createElement("button");
          delBtn.className = "btn-ghost btn-delete";
          delBtn.textContent = "🗑️ حذف";
          delBtn.addEventListener("click", () => deleteExpense(e.id));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          main.appendChild(actions);

          const amountContainer = document.createElement("div");
          amountContainer.className = "expense-amount-container";

          const amountBadge = document.createElement("div");
          amountBadge.className = "expense-amount-badge";
          amountBadge.textContent = "💰";

          const amount = document.createElement("div");
          amount.className = "expense-amount";
          amount.textContent = formatNumber(e.amount || 0);

          amountContainer.appendChild(amountBadge);
          amountContainer.appendChild(amount);
          item.appendChild(main);
          item.appendChild(amountContainer);
          expenseList.appendChild(item);
        });
      }

      if (filterState.category !== "all") {
        const catTotal = filtered.reduce((sum, e) => sum + (e.amount || 0), 0);
        filterSummaryEl.textContent =
          "إجمالي فئة " +
          filterState.category +
          ": " +
          formatNumber(catTotal);
      }
    }
async function loadAllUsersForAdmin() {
  adminUsersContainer.innerHTML = "<p>جاري تحميل البيانات...</p>";

  const usersSnap = await get(ref(db, "users"));
  if (!usersSnap.exists()) {
    adminUsersContainer.innerHTML = "<p>لا يوجد مستخدمين.</p>";
    return;
  }

  const users = usersSnap.val();
  adminUsersContainer.innerHTML = "";

  Object.keys(users).forEach(uid => {
    const userData = users[uid];

    const profile = userData.profile || {};
    const state = userData.state || {};
    const months = state.months || [];

    let totalExpenses = 0;
    months.forEach(m => {
      if (Array.isArray(m.expenses)) {
        m.expenses.forEach(e => totalExpenses += (e.amount || 0));
      }
    });

    const totalSalaries = months.reduce((acc, m) => acc + (m.salary || 0), 0);

    const card = document.createElement("div");
    card.className = "admin-user-card";

    card.innerHTML = `
      <h3>${profile.email || "بدون بريد"}</h3>
      <p><strong>المستخدم:</strong> ${uid}</p>
      <p><strong>عدد الأشهر:</strong> ${months.length}</p>
      <p><strong>إجمالي الرواتب:</strong> ${formatNumber(totalSalaries)}</p>
      <p><strong>إجمالي المصاريف:</strong> ${formatNumber(totalExpenses)}</p>
      <p><strong>المتبقي:</strong> ${formatNumber(totalSalaries - totalExpenses)}</p>
    `;

    adminUsersContainer.appendChild(card);
  });
}

    function renderComparison() {
      // helper: deterministic color palette for categories
      function getCategoryColor(cat, i) {
        const palette = [
          "#2563eb",
          "#4f46e5",
          "#06b6d4",
          "#10b981",
          "#f59e0b",
          "#ef4444",
          "#8b5cf6",
          "#ec4899",
          "#0ea5b3",
          "#f97316",
        ];
        if (!cat) return palette[i % palette.length];
        // simple hash to pick color for category name consistently
        let h = 0;
        for (let j = 0; j < cat.length; j++) h = (h << 5) - h + cat.charCodeAt(j);
        const idx = Math.abs(h) % palette.length;
        return palette[idx];
      }

      compareContainer.innerHTML = "";
      if (!Array.isArray(state.months) || state.months.length === 0) {
        compareContainer.innerHTML =
          '<div class="empty-state">أضف شهراً واحداً على الأقل لعرض المقارنة.</div>';
        return;
      }

      const monthsSorted = state.months
        .slice()
        .sort((a, b) => b.year - a.year || b.month - a.month);

      // collect category list across months
      const allCategories = new Set();
      monthsSorted.forEach((m) => {
        (m.expenses || []).forEach((e) => allCategories.add(e.category || "أخرى"));
      });
      const categories = Array.from(allCategories.length ? allCategories : state.categories);

      // totals per month and per-category
      const monthData = monthsSorted.map((m) => {
        const expenses = Array.isArray(m.expenses) ? m.expenses : [];
        const total = expenses.reduce((sum, e) => sum + (e.amount || 0), 0);
        const catTotals = {};
        categories.forEach((c) => (catTotals[c] = 0));
        expenses.forEach((e) => {
          const cat = e.category || "أخرى";
          catTotals[cat] = (catTotals[cat] || 0) + (e.amount || 0);
        });
        return {
          id: m.id,
          label: `${m.name} ${m.year}`,
          year: m.year,
          month: m.month,
          salary: m.salary || 0,
          total,
          remaining: (m.salary || 0) - total,
          catTotals,
        };
      });

      const maxTotal = Math.max(...monthData.map((d) => d.total), 1);

      // build header summary card
      const grid = document.createElement("div");
      grid.className = "compare-grid";

      const topCard = document.createElement("div");
      topCard.className = "compare-card";
      topCard.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><h3>مقارنة الأشهر</h3><div class="compare-meta">` +
        `<div>أشهر: ${monthData.length}</div>` +
        `<div>تصنيفات مفحوصة: ${categories.length}</div>` +
        `</div></div>`;

      // legend for categories (show top few)
      const legend = document.createElement("div");
      legend.className = "category-legend";
      categories.slice(0, 8).forEach((c, i) => {
        const li = document.createElement("div");
        li.className = "legend-item";
        const sw = document.createElement("span");
        sw.className = "legend-swatch";
        sw.style.background = getCategoryColor(c, i);
        li.appendChild(sw);
        const txt = document.createElement("span");
        txt.textContent = c;
        li.appendChild(txt);
        legend.appendChild(li);
      });
      topCard.appendChild(legend);
      grid.appendChild(topCard);

      // create a compare card per month with bar and small table of top categories
      monthData.forEach((d) => {
        const card = document.createElement("div");
        card.className = "compare-card";

        const row = document.createElement("div");
        row.className = "compare-row";

        const left = document.createElement("div");
        left.style.flex = "1";
        const title = document.createElement("div");
        title.style.fontWeight = "700";
        title.textContent = d.label;
        const meta = document.createElement("div");
        meta.className = "compare-meta";
        meta.innerHTML = `الراتب: ${formatNumber(d.salary)} · المصاريف: ${formatNumber(d.total)} · المتبقي: ${formatNumber(d.remaining)}`;
        left.appendChild(title);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.width = "140px";
        right.style.textAlign = "right";
        right.innerHTML = `<div style="font-weight:700;color:#2563eb">${formatNumber(d.total)}</div>` +
          `<div style="font-size:12px;color:var(--subtext-color)">المتبقي: ${formatNumber(d.remaining)}</div>`;

        row.appendChild(left);
        row.appendChild(right);

        // stacked bar showing category breakdown
        const stacked = document.createElement("div");
        stacked.className = "stacked-bar";
        if (d.total <= 0) {
          const emptySeg = document.createElement("div");
          emptySeg.className = "stacked-seg";
          emptySeg.style.width = "100%";
          emptySeg.style.background = "linear-gradient(90deg, rgba(0,0,0,0.03), rgba(0,0,0,0.02))";
          stacked.appendChild(emptySeg);
        } else {
          Object.entries(d.catTotals).forEach(([cat, amt], ci) => {
            const pct = d.total > 0 ? (amt / d.total) * 100 : 0;
            const seg = document.createElement("div");
            seg.className = "stacked-seg";
            seg.style.width = pct > 0 ? pct + "%" : "0%";
            seg.style.background = getCategoryColor(cat, ci);
            seg.title = `${cat}: ${formatNumber(amt)} (${Math.round(pct)}%)`;
            stacked.appendChild(seg);
          });
        }

        card.appendChild(row);
        card.appendChild(stacked);

        // add small table of top 4 categories
        const catEntries = Object.entries(d.catTotals).sort((a, b) => b[1] - a[1]);
        const table = document.createElement("table");
        table.className = "compare-table";
        const thead = document.createElement("thead");
        thead.innerHTML = `<tr><th>التصنيف</th><th>المبلغ</th><th>النسبة</th></tr>`;
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        const top4 = catEntries.slice(0, 4);
        top4.forEach(([cat, amt]) => {
          const tr = document.createElement("tr");
          const pct = maxTotal > 0 ? Math.round((amt / d.total) * 100) : 0;
          tr.innerHTML = `<td>${cat}</td><td>${formatNumber(amt)}</td><td>${pct}%</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        card.appendChild(table);

        grid.appendChild(card);
      });

      compareContainer.appendChild(grid);
    }

    /* ======= التصنيفات ======= */

    function renderCategoryOptions() {
      expenseCategoryInput.innerHTML = "";
      filterCategory.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "كل التصنيفات";
      filterCategory.appendChild(allOpt);

      state.categories.forEach((cat) => {
        const opt1 = document.createElement("option");
        opt1.value = cat;
        opt1.textContent = cat;
        expenseCategoryInput.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = cat;
        opt2.textContent = cat;
        filterCategory.appendChild(opt2);
      });
    }

    function renderCategoryList() {
      categoryList.innerHTML = "";
      state.categories.forEach((cat, index) => {
        const chip = document.createElement("span");
        chip.className = "category-chip";
        chip.draggable = true;
        chip.dataset.index = index;

        const name = document.createElement("span");
        name.textContent = cat;
        name.style.flex = "1";
        chip.appendChild(name);

        const controls = document.createElement("div");
        controls.className = "category-chip-controls";

        if (index > 0) {
          const upBtn = document.createElement("button");
          upBtn.textContent = "↑";
          upBtn.title = "تحريك لأعلى";
          upBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index - 1];
            state.categories[index - 1] = temp;
            refreshUI();
          });
          controls.appendChild(upBtn);
        }

        if (index < state.categories.length - 1) {
          const downBtn = document.createElement("button");
          downBtn.textContent = "↓";
          downBtn.title = "تحريك لأسفل";
          downBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const temp = state.categories[index];
            state.categories[index] = state.categories[index + 1];
            state.categories[index + 1] = temp;
            refreshUI();
          });
          controls.appendChild(downBtn);
        }

        if (state.categories.length > 1) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "✕";
          delBtn.title = "حذف التصنيف";
          delBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            if (!confirm("متأكد من حذف هذا التصنيف؟")) return;
            state.categories.splice(index, 1);
            refreshUI();
          });
          controls.appendChild(delBtn);
        }

        chip.appendChild(controls);

        chip.addEventListener("dragstart", (e) => {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/html", chip.innerHTML);
          chip.classList.add("dragging");
        });

        chip.addEventListener("dragend", () => {
          chip.classList.remove("dragging");
        });

        chip.addEventListener("dragover", (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = "move";
        });

        chip.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedIndex = parseInt(
            document.querySelector(".category-chip.dragging")?.dataset.index || -1
          );
          if (draggedIndex !== -1 && draggedIndex !== index) {
            const temp = state.categories[draggedIndex];
            state.categories[draggedIndex] = state.categories[index];
            state.categories[index] = temp;
            refreshUI();
          }
        });

        categoryList.appendChild(chip);
      });
    }

    btnAddCategory.addEventListener("click", async () => {
      const name = newCategoryInput.value.trim();
      if (!name) return;
      if (state.categories.includes(name)) {
        alert("هذا التصنيف موجود بالفعل.");
        return;
      }
      state.categories.push(name);
      newCategoryInput.value = "";
      await refreshUI();
    });

    expenseCategoryInput.addEventListener("change", () => {
      const categoryError = document.getElementById("categoryError");
      if (expenseCategoryInput.value && expenseCategoryInput.value.trim() !== "") {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }
    });

    /* ======= Month Modal ======= */

    function openMonthModal(edit = false) {
      const now = new Date();
      const currentMonth = getSelectedMonth();
      if (edit && currentMonth) {
        editingMonthId = currentMonth.id;
        modalMonthTitle.textContent = "تعديل الشهر";
        monthInput.value = String(currentMonth.month);
        yearInput.value = currentMonth.year;
        salaryInput.value = formatNumber(currentMonth.salary || 0);
        deleteMonthBtn.style.display = "inline-flex";
      } else {
        editingMonthId = null;
        modalMonthTitle.textContent = "إضافة شهر جديد";
        monthInput.value = String(now.getMonth() + 1);
        yearInput.value = now.getFullYear();
        salaryInput.value = "";
        deleteMonthBtn.style.display = "none";
      }
      modalMonth.style.display = "flex";
    }

    function closeMonthModal() {
      modalMonth.style.display = "none";
    }

    btnAddMonth.addEventListener("click", () => openMonthModal(false));
    btnEditMonth.addEventListener("click", () => {
      if (!getSelectedMonth()) openMonthModal(false);
      else openMonthModal(true);
    });

    salaryInput.addEventListener("input", () => {
      const digits = salaryInput.value.replace(/\D/g, "");
      salaryInput.value = formatNumber(digits);
      salaryInput.selectionEnd = salaryInput.value.length;
    });

    btnCancelMonth.addEventListener("click", closeMonthModal);
    btnCloseMonth.addEventListener("click", closeMonthModal);

    deleteMonthBtn.addEventListener("click", async () => {
      if (!editingMonthId) return;
      if (!confirm("هل أنت متأكد من حذف هذا الشهر وجميع مصاريفه؟")) return;
      const idx = state.months.findIndex((m) => m.id === editingMonthId);
      if (idx !== -1) state.months.splice(idx, 1);
      if (state.months.length === 0) {
        state.selectedMonthId = null;
      } else {
        state.selectedMonthId = state.months[state.months.length - 1].id;
      }
      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    saveMonthBtn.addEventListener("click", async () => {
      const monthNum = parseInt(monthInput.value, 10);
      const yearNum = parseInt(yearInput.value, 10);
      const salary = parseFormattedNumber(salaryInput.value);

      if (!yearNum || yearNum < 1900) {
        alert("من فضلك أدخل سنة صحيحة.");
        return;
      }
      if (!monthNum || monthNum < 1 || monthNum > 12) {
        alert("من فضلك اختر شهرًا صحيحًا.");
        return;
      }

      const id = generateMonthId(yearNum, monthNum);
      const name = monthNames[monthNum];

      if (editingMonthId) {
        const existing = state.months.find((m) => m.id === editingMonthId);
        if (!existing) return;
        if (editingMonthId !== id) {
          const conflict = state.months.find((m) => m.id === id);
          if (conflict) {
            alert("يوجد شهر بنفس التاريخ بالفعل.");
            return;
          }
        }
        existing.year = yearNum;
        existing.month = monthNum;
        existing.name = name;
        existing.salary = salary;
        existing.id = id;
        state.selectedMonthId = id;
      } else {
        const exists = state.months.find((m) => m.id === id);
        if (exists) {
          alert("هذا الشهر موجود مسبقًا. افتحه من القائمة لتعديله.");
          return;
        }
        state.months.push({
          id,
          year: yearNum,
          month: monthNum,
          name,
          salary,
          expenses: [],
        });
        state.selectedMonthId = id;
      }

      editingMonthId = null;
      closeMonthModal();
      await refreshUI();
    });

    monthSelect.addEventListener("change", async (e) => {
      state.selectedMonthId = e.target.value || null;
      await refreshUI();
    });

    modalMonth.addEventListener("click", (e) => {
      if (e.target === modalMonth) closeMonthModal();
    });

    /* ======= Expense Modal ======= */

    function openExpenseModal(expenseId = null) {
      isSavingExpense = false; // إعادة تعيين العلم عند فتح الـ Modal
      const month = getSelectedMonth();
      if (!month) {
        alert("من فضلك أضف شهرًا أولاً.");
        return;
      }
      if (expenseId) {
        const exp = (month.expenses || []).find((e) => e.id === expenseId);
        if (!exp) return;
        editingExpenseId = expenseId;
        expenseModalTitle.textContent = "تعديل مصروف";
        expenseTitleInput.value = exp.title || "";
        expenseAmountInput.value = formatNumber(exp.amount || 0);
        expenseCategoryInput.value = exp.category || state.categories[0];
        expenseDateInput.value = exp.date || "";
        expenseNoteInput.value = exp.note || "";
        expenseImageInput.value = "";
        // عرض معاينة الصورة القديمة إن وجدت
        if (exp.imageDataUrl) {
          imagePreviewImg.src = exp.imageDataUrl;
          imagePreviewFilename.textContent = "صورة موجودة";
          imagePreviewSize.textContent = "";
          imagePreviewContainer.classList.add("active");
        } else {
          imagePreviewContainer.classList.remove("active");
          imagePreviewImg.src = "";
        }
        deleteExpenseBtn.style.display = "inline-flex";
      } else {
        editingExpenseId = null;
        expenseModalTitle.textContent = "إضافة مصروف";
        expenseTitleInput.value = "";
        expenseAmountInput.value = "";
        expenseCategoryInput.value = state.categories[0];
        expenseDateInput.valueAsDate = new Date();
        expenseNoteInput.value = "";
        expenseImageInput.value = "";
        imagePreviewContainer.classList.remove("active");
        imagePreviewImg.src = "";
        deleteExpenseBtn.style.display = "none";
      }
      modalExpense.style.display = "flex";
    }

    function closeExpenseModal() {
      modalExpense.style.display = "none";
      // إزالة معاينة الصورة عند الإغلاق
      imagePreviewContainer.classList.remove("active");
      imagePreviewImg.src = "";
    }

    btnAddExpense.addEventListener("click", () => openExpenseModal(null));
    btnCancelExpense.addEventListener("click", closeExpenseModal);
    btnCloseExpense.addEventListener("click", closeExpenseModal);

    modalExpense.addEventListener("click", (e) => {
      if (e.target === modalExpense) closeExpenseModal();
    });

    expenseAmountInput.addEventListener("input", () => {
      const digits = expenseAmountInput.value.replace(/\D/g, "");
      expenseAmountInput.value = formatNumber(digits);
      expenseAmountInput.selectionEnd = expenseAmountInput.value.length;
    });

    // معالجة معاينة الصور
    const imagePreviewContainer = document.getElementById("imagePreviewContainer");
    const imagePreviewImg = document.getElementById("imagePreviewImg");
    const imagePreviewFilename = document.getElementById("imagePreviewFilename");
    const imagePreviewSize = document.getElementById("imagePreviewSize");
    const imagePreviewRemove = document.getElementById("imagePreviewRemove");

    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
    }

    // دالة ضغط الصور لتقليل حجم البيانات المنقولة
    function compressImage(dataUrl, maxWidth = 800, maxHeight = 800, quality = 0.7) {
      return new Promise((resolve) => {
        const img = new Image();
        img.src = dataUrl;
        img.onload = function () {
          const canvas = document.createElement("canvas");
          let width = img.width;
          let height = img.height;

          // حساب الأبعاد الجديدة مع الحفاظ على النسبة
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.onerror = () => resolve(dataUrl); // إرجاع الأصل في حالة الخطأ
      });
    }

    expenseImageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith("image/")) {
        const reader = new FileReader();
        reader.onload = function (event) {
          imagePreviewImg.src = event.target.result;
          imagePreviewFilename.textContent = file.name;
          imagePreviewSize.textContent = formatFileSize(file.size);
          imagePreviewContainer.classList.add("active");
        };
        reader.readAsDataURL(file);
      } else if (file) {
        alert("من فضلك اختر ملف صورة صحيح");
        expenseImageInput.value = "";
        imagePreviewContainer.classList.remove("active");
      }
    });

    imagePreviewRemove.addEventListener("click", (e) => {
      e.preventDefault();
      expenseImageInput.value = "";
      imagePreviewContainer.classList.remove("active");
      imagePreviewImg.src = "";
      imagePreviewFilename.textContent = "";
      imagePreviewSize.textContent = "";
    });

    async function deleteExpense(expenseId) {
      const month = getSelectedMonth();
      if (!month || !Array.isArray(month.expenses)) return;
      if (!confirm("متأكد من حذف هذا المصروف؟")) return;
      const idx = month.expenses.findIndex((e) => e.id === expenseId);
      if (idx !== -1) {
        month.expenses.splice(idx, 1);
        await refreshUI();
      }
    }

    deleteExpenseBtn.addEventListener("click", async () => {
      if (!editingExpenseId) return;
      await deleteExpense(editingExpenseId);
      closeExpenseModal();
    });

    saveExpenseBtn.addEventListener("click", () => {
      // منع النقر المتكرر
      if (isSavingExpense) return;
      isSavingExpense = true;

      const month = getSelectedMonth();
      const categoryError = document.getElementById("categoryError");

      if (!month) {
        alert("من فضلك أضف شهرًا أولاً.");
        isSavingExpense = false;
        return;
      }
      if (!Array.isArray(month.expenses)) month.expenses = [];

      const title = expenseTitleInput.value.trim() || "مصروف";
      const amount = parseFormattedNumber(expenseAmountInput.value);
      const category = expenseCategoryInput.value;
      const date = expenseDateInput.value || "";
      const note = expenseNoteInput.value.trim();

      if (!amount || amount <= 0) {
        alert("من فضلك أدخل مبلغًا صحيحًا.");
        isSavingExpense = false;
        return;
      }

      if (!category || category.trim() === "") {
        categoryError.style.display = "block";
        expenseCategoryInput.focus();
        expenseCategoryInput.style.borderColor = "var(--danger)";
        isSavingExpense = false;
        return;
      } else {
        categoryError.style.display = "none";
        expenseCategoryInput.style.borderColor = "";
      }

      const file = expenseImageInput.files[0];

      // إغلاق الـ Modal فوراً لتجنب النقر المتكرر
      closeExpenseModal();

      if (file) {
        const reader = new FileReader();
        reader.onload = async function (e) {
          let imageDataUrl = e.target.result;
          
          // ضغط الصورة إذا كانت كبيرة الحجم
          if (file.size > 500000) { // أكبر من 500KB
            imageDataUrl = await compressImage(imageDataUrl, 800, 800, 0.7);
          }
          
          await saveExpenseObject(month, {
            id: editingExpenseId,
            title,
            amount,
            category,
            date,
            note,
            imageDataUrl,
          });
          isSavingExpense = false;
        };
        reader.readAsDataURL(file);
      } else {
        let imageDataUrl = null;
        if (editingExpenseId) {
          const existing = month.expenses.find((exp) => exp.id === editingExpenseId);
          imageDataUrl = existing ? existing.imageDataUrl || null : null;
        }
        saveExpenseObject(month, {
          id: editingExpenseId,
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        });
        isSavingExpense = false;
      }
    });

    async function saveExpenseObject(
      month,
      { id, title, amount, category, date, note, imageDataUrl }
    ) {
      if (!Array.isArray(month.expenses)) month.expenses = [];
      if (id) {
        const existing = month.expenses.find((e) => e.id === id);
        if (!existing) return;
        existing.title = title;
        existing.amount = amount;
        existing.category = category;
        existing.date = date;
        existing.note = note;
        existing.imageDataUrl = imageDataUrl;
      } else {
        month.expenses.push({
          id: Date.now().toString(),
          title,
          amount,
          category,
          date,
          note,
          imageDataUrl,
        });
      }
      editingExpenseId = null;
      await refreshUI();
    }

    /* ======= فلترة ======= */

    searchInput.addEventListener("input", () => {
      filterState.search = searchInput.value;
      renderExpenses();
    });

    filterCategory.addEventListener("change", () => {
      filterState.category = filterCategory.value;
      renderExpenses();
    });

    filterHasImage.addEventListener("change", () => {
      filterState.hasImageOnly = filterHasImage.checked;
      renderExpenses();
    });

    /* ======= Image Modal ======= */

    modalImage.addEventListener("click", (e) => {
      if (e.target === modalImage) {
        modalImage.style.display = "none";
        imageModalView.src = "";
      }
    });

    /* ======= Theme ======= */

    btnToggleTheme.addEventListener("click", () => {
      const current = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(current === "light" ? "dark" : "light");
    });

    /* ======= لوحة التحكم: حساب إحصائيات المستخدم ======= */

    function computeUserStats(userState) {
      const normalized = normalizeState(userState || {});
      const months = Array.isArray(normalized.months) ? normalized.months : [];
      let totalSalary = 0;
      let totalExpenses = 0;
      let expensesCount = 0;

      months.forEach((m) => {
        totalSalary += m.salary || 0;
        if (Array.isArray(m.expenses)) {
          expensesCount += m.expenses.length;
          m.expenses.forEach((ex) => {
            totalExpenses += ex.amount || 0;
          });
        }
      });

      const remaining = totalSalary - totalExpenses;
      return {
        monthsCount: months.length,
        totalSalary,
        totalExpenses,
        remaining,
        expensesCount,
      };
    }

    async function adminDeleteUserData(uid) {
      if (!firebaseEnabled || !db) {
        alert("لوحة التحكم تتطلب اتصالاً بالإنترنت.");
        return;
      }
      if (!confirm("هل أنت متأكد من حذف جميع بيانات هذا المستخدم من قاعدة البيانات؟")) {
        return;
      }
      try {
        await set(ref(db, "users/" + uid), null);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("تعذر حذف بيانات المستخدم.");
      }
    }

    async function adminToggleUserDisabled(uid, currentlyDisabled) {
      if (!firebaseEnabled || !db) {
        alert("لوحة التحكم تتطلب اتصالاً بالإنترنت.");
        return;
      }
      const newValue = !currentlyDisabled;
      try {
        await set(ref(db, "users/" + uid + "/disabled"), newValue);
        await loadAdminUsers();
      } catch (e) {
        console.error(e);
        alert("تعذر تغيير حالة المستخدم.");
      }
    }

    async function loadAdminUsers() {
      if (!firebaseEnabled || !db || !currentUser) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">لوحة التحكم تتطلب اتصالاً بالإنترنت وFirebase.</div>';
        return;
      }
      if (currentUser.uid !== ADMIN_UID) {
        adminUsersContainer.innerHTML =
          '<div class="empty-state">ليست لديك صلاحية عرض لوحة التحكم.</div>';
        return;
      }

      adminUsersContainer.innerHTML =
        '<div class="empty-state">جاري تحميل بيانات المستخدمين...</div>';

      try {
        const usersSnap = await get(ref(db, "users"));
        if (!usersSnap.exists()) {
          adminUsersContainer.innerHTML =
            '<div class="empty-state">لا يوجد أي مستخدمين بعد.</div>';
          return;
        }

        const fragment = document.createDocumentFragment();

        usersSnap.forEach((userSnap) => {
          const uid = userSnap.key;
          const data = userSnap.val() || {};
          const stateData = data.state || {};
          const profile = data.profile || {};
          const disabled = !!data.disabled;
          const isOwner = uid === ADMIN_UID;

          const stats = computeUserStats(stateData);

          const card = document.createElement("div");
          card.className = "admin-user-card";

          // Header
          const header = document.createElement("div");
          header.className = "admin-user-header";

          const main = document.createElement("div");
          main.className = "admin-user-main";

          const emailEl = document.createElement("div");
          emailEl.className = "admin-user-email";
          emailEl.textContent = profile.email || "(بدون بريد محفوظ)";
          const uidEl = document.createElement("div");
          uidEl.className = "admin-user-uid";
          uidEl.textContent = "UID: " + uid;

          main.appendChild(emailEl);
          main.appendChild(uidEl);

          const badgesContainer = document.createElement("div");

          const statusBadge = document.createElement("span");
          statusBadge.className =
            "admin-badge " + (disabled ? "admin-badge-disabled" : "admin-badge-active");
          statusBadge.textContent = disabled ? "معطّل" : "نشط";

          badgesContainer.appendChild(statusBadge);

          if (isOwner) {
            const ownerBadge = document.createElement("span");
            ownerBadge.className = "admin-badge admin-badge-admin";
            ownerBadge.textContent = "مالك النظام";
            badgesContainer.appendChild(ownerBadge);
          }

          header.appendChild(main);
          header.appendChild(badgesContainer);

          // Summary stats
          const statsEl = document.createElement("div");
          statsEl.className = "admin-user-stats";

          function makeStat(labelText, valText) {
            const line = document.createElement("div");
            line.className = "admin-stat-line";
            const l = document.createElement("span");
            l.className = "admin-stat-label";
            l.textContent = labelText;
            const v = document.createElement("span");
            v.className = "admin-stat-value";
            v.textContent = valText;
            line.appendChild(l);
            line.appendChild(v);
            return line;
          }

          statsEl.appendChild(makeStat("إجمالي الرواتب:", formatNumber(stats.totalSalary)));
          statsEl.appendChild(makeStat("إجمالي المصاريف:", formatNumber(stats.totalExpenses)));
          statsEl.appendChild(makeStat("المتبقي الإجمالي:", formatNumber(stats.remaining)));
          statsEl.appendChild(makeStat("عدد الأشهر:", stats.monthsCount));
          statsEl.appendChild(makeStat("عدد المصاريف:", stats.expensesCount));

          // Actions
          const actions = document.createElement("div");
          actions.className = "admin-user-actions";

          if (!isOwner) {
            const toggleBtn = document.createElement("button");
            toggleBtn.className = "btn-soft";
            toggleBtn.textContent = disabled ? "إلغاء التعطيل" : "تعطيل المستخدم";
            toggleBtn.addEventListener("click", () => {
              adminToggleUserDisabled(uid, disabled);
            });
            actions.appendChild(toggleBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "btn-danger-soft";
            deleteBtn.textContent = "🗑️ حذف جميع البيانات";
            deleteBtn.addEventListener("click", () => {
              adminDeleteUserData(uid);
            });
            actions.appendChild(deleteBtn);
          } else {
            const infoOwner = document.createElement("div");
            infoOwner.className = "admin-note";
            infoOwner.textContent = "لا يمكن حذف أو تعطيل مالك النظام.";
            actions.appendChild(infoOwner);
          }

          card.appendChild(header);
          card.appendChild(statsEl);

          // Detailed months (+ expenses) view
          const monthsNormalized = normalizeState(stateData).months || [];
          const monthsSorted = monthsNormalized.slice().sort((a, b) => a.year - b.year || a.month - b.month);

          const monthsContainer = document.createElement("div");
          monthsContainer.className = "admin-user-months";

          if (monthsSorted.length === 0) {
            const empty = document.createElement("div");
            empty.className = "admin-note";
            empty.textContent = "لا يوجد أشهر محفوظة لهذا المستخدم.";
            monthsContainer.appendChild(empty);
          } else {
            monthsSorted.forEach((m) => {
              const mItem = document.createElement("div");
              mItem.className = "admin-month-item";

              const mHeader = document.createElement("div");
              mHeader.className = "admin-month-header";
              const nameSpan = document.createElement("span");
              nameSpan.textContent = `${m.name} ${m.year}`;
              const statsSpan = document.createElement("span");
              const mTotal = (Array.isArray(m.expenses) ? m.expenses.reduce((s, e) => s + (e.amount || 0), 0) : 0);
              const mRemaining = (m.salary || 0) - mTotal;
              statsSpan.textContent = `الراتب: ${formatNumber(m.salary || 0)} · المصاريف: ${formatNumber(mTotal)} · المتبقي: ${formatNumber(mRemaining)}`;
              mHeader.appendChild(nameSpan);
              mHeader.appendChild(statsSpan);

              const mExpenses = document.createElement("div");
              mExpenses.className = "admin-month-expenses";
              mExpenses.style.display = "none";

              // Toggle expand/collapse
              mHeader.addEventListener("click", () => {
                mExpenses.style.display = mExpenses.style.display === "none" ? "block" : "none";
              });

              // Expense rows
              const expensesArr = Array.isArray(m.expenses) ? m.expenses.slice().sort((a,b)=> (b.id||0)-(a.id||0)) : [];
              if (expensesArr.length === 0) {
                const emptyRow = document.createElement("div");
                emptyRow.className = "empty-state";
                emptyRow.textContent = "لا توجد مصاريف لهذا الشهر.";
                mExpenses.appendChild(emptyRow);
              } else {
                expensesArr.forEach((ex) => {
                  const row = document.createElement("div");
                  row.className = "admin-expense-row";

                  const left = document.createElement("div");
                  left.style.flex = "1";
                  const t = document.createElement("div");
                  t.textContent = ex.title || "بدون عنوان";
                  t.style.fontWeight = "600";
                  const meta = document.createElement("div");
                  meta.style.fontSize = "12px";
                  meta.style.color = "var(--subtext-color)";
                  meta.textContent = `${ex.category || 'غير محدد'} · ${ex.date || 'بدون تاريخ'}`;
                  if (ex.note) {
                    const note = document.createElement("div");
                    note.style.fontSize = "12px";
                    note.textContent = ex.note;
                    left.appendChild(t);
                    left.appendChild(meta);
                    left.appendChild(note);
                  } else {
                    left.appendChild(t);
                    left.appendChild(meta);
                  }

                  const right = document.createElement("div");
                  right.style.minWidth = "110px";
                  right.style.textAlign = "right";
                  const amountEl = document.createElement("div");
                  amountEl.textContent = formatNumber(ex.amount || 0);
                  amountEl.style.fontWeight = "700";
                  amountEl.style.color = "#2563eb";

                  right.appendChild(amountEl);

                  if (ex.imageDataUrl) {
                    const img = document.createElement("img");
                    img.src = ex.imageDataUrl;
                    img.alt = "صورة المصروف";
                    img.style.height = "40px";
                    img.style.borderRadius = "6px";
                    img.style.marginLeft = "8px";
                    img.addEventListener("click", () => {
                      imageModalView.src = ex.imageDataUrl;
                      modalImage.style.display = "flex";
                    });
                    right.appendChild(img);
                  }

                  row.appendChild(left);
                  row.appendChild(right);
                  mExpenses.appendChild(row);
                });
              }

              mItem.appendChild(mHeader);
              mItem.appendChild(mExpenses);
              monthsContainer.appendChild(mItem);
            });
          }

          card.appendChild(monthsContainer);
          card.appendChild(actions);

          fragment.appendChild(card);
        });

        adminUsersContainer.innerHTML = "";
        adminUsersContainer.appendChild(fragment);
      } catch (e) {
        console.error(e);
        adminUsersContainer.innerHTML =
          '<div class="empty-state">تعذر تحميل بيانات المستخدمين.</div>';
      }
    }

    // تحميل حالة قفل التسجيل من Firebase
    async function loadRegistrationStatus() {
      if (!firebaseEnabled || !db) return;
      try {
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const isEnabled = snap.exists() ? snap.val() : true;
        updateRegistrationUI(isEnabled);
      } catch (err) {
        console.error("Error loading registration status:", err);
        updateRegistrationUI(true);
      }
    }

    // تحديث واجهة قفل التسجيل
    function updateRegistrationUI(isEnabled) {
      if (btnToggleRegistration) {
        btnToggleRegistration.classList.toggle("active", isEnabled);
        btnToggleRegistration.style.background = isEnabled ? "#10b981" : "#ef4444";
        btnToggleRegistration.style.borderColor = isEnabled ? "#059669" : "#dc2626";
      }
    }

    // تبديل حالة التسجيل
    async function toggleRegistration() {
      if (!firebaseEnabled || !db || currentUser?.uid !== ADMIN_UID) {
        return;
      }

      try {
        btnToggleRegistration.disabled = true;
        const statusRef = ref(db, "settings/registrationEnabled");
        const snap = await get(statusRef);
        const currentStatus = snap.exists() ? snap.val() : true;
        const newStatus = !currentStatus;

        await set(statusRef, newStatus);
        updateRegistrationUI(newStatus);
      } catch (err) {
        console.error("Error toggling registration:", err);
      } finally {
        btnToggleRegistration.disabled = false;
      }
    }

    // تغيير كلمة السر
    async function changePassword() {
      const current = modalCurrentPassword?.value?.trim();
      const newPwd = modalNewPassword?.value?.trim();
      const confirmPwd = modalConfirmPassword?.value?.trim();

      // التحقق من المدخلات
      if (!current) {
        showModalPasswordMessage("الرجاء إدخال كلمة السر الحالية.", "error");
        return;
      }
      if (!newPwd) {
        showModalPasswordMessage("الرجاء إدخال كلمة السر الجديدة.", "error");
        return;
      }
      if (newPwd.length < 6) {
        showModalPasswordMessage("كلمة السر يجب أن تكون 6 أحرف على الأقل.", "error");
        return;
      }
      if (newPwd !== confirmPwd) {
        showModalPasswordMessage("كلمة السر الجديدة وتأكيدها غير متطابقة.", "error");
        return;
      }
      if (newPwd === current) {
        showModalPasswordMessage("كلمة السر الجديدة يجب أن تكون مختلفة عن الحالية.", "error");
        return;
      }

      try {
        btnModalChangePassword.disabled = true;
        btnModalChangePassword.textContent = "⏳ جاري التحديث...";

        // إعادة المصادقة
        const email = currentUser.email;
        const credential = EmailAuthProvider.credential(email, current);
        await reauthenticateWithCredential(currentUser, credential);

        // تحديث كلمة السر
        await updatePassword(currentUser, newPwd);

        // مسح الحقول
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";

        showModalPasswordMessage("✓ تم تحديث كلمة السر بنجاح.", "success");
        setTimeout(() => {
          closePasswordModal();
        }, 1500);
      } catch (err) {
        console.error("Error changing password:", err);

        if (err.code === "auth/wrong-password") {
          showModalPasswordMessage("كلمة السر الحالية غير صحيحة.", "error");
        } else if (err.code === "auth/weak-password") {
          showModalPasswordMessage("كلمة السر ضعيفة جداً.", "error");
        } else if (err.code === "auth/requires-recent-login") {
          showModalPasswordMessage("الرجاء تسجيل الدخول مرة أخرى ثم حاول.", "error");
        } else {
          showModalPasswordMessage("تعذر تحديث كلمة السر: " + (err.message || "خطأ غير معروف"), "error");
        }
      } finally {
        btnModalChangePassword.disabled = false;
        btnModalChangePassword.textContent = "✓ تحديث كلمة السر";
      }
    }

    // عرض رسالة تحديث كلمة السر في المودال
    function showModalPasswordMessage(message, type) {
      if (!modalPasswordMessage) return;
      modalPasswordMessage.textContent = message;
      modalPasswordMessage.className = type === "success" ? "password-success" : "password-error";
    }

    // فتح مودال تغيير كلمة السر
    function openPasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "flex";
        modalCurrentPassword.focus();
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // إغلاق مودال تغيير كلمة السر
    function closePasswordModal() {
      if (modalPassword) {
        modalPassword.style.display = "none";
        modalCurrentPassword.value = "";
        modalNewPassword.value = "";
        modalConfirmPassword.value = "";
        modalPasswordMessage.textContent = "";
        modalPasswordMessage.className = "";
      }
    }

    // زر قفل/فتح التسجيل (في لوحة التحكم فقط)
    if (btnToggleRegistration) {
      btnToggleRegistration.addEventListener("click", toggleRegistration);
    }

    // زر تغيير كلمة السر من الرأس
    if (btnChangePasswordQuick) {
      btnChangePasswordQuick.addEventListener("click", openPasswordModal);
    }

    // إغلاق مودال تغيير كلمة السر
    if (btnClosePassword) {
      btnClosePassword.addEventListener("click", closePasswordModal);
    }

    // زر تحديث كلمة السر في المودال
    if (btnModalChangePassword) {
      btnModalChangePassword.addEventListener("click", changePassword);
    }

    // إغلاق المودال عند النقر خارجه
    if (modalPassword) {
      modalPassword.addEventListener("click", (e) => {
        if (e.target === modalPassword) {
          closePasswordModal();
        }
      });
    }

    // تحميل حالة التسجيل عند فتح لوحة التحكم
    let registrationLoaded = false;
    if (adminTabBtn) {
      adminTabBtn.addEventListener("click", () => {
        if (!registrationLoaded) {
          loadRegistrationStatus();
          registrationLoaded = true;
        }
      });
    }

    // زر تحديث بيانات لوحة التحكم (يعمل على إعادة تحميل قائمة المستخدمين)
    if (btnAdminRefresh) {
      btnAdminRefresh.addEventListener("click", async () => {
        const prevText = btnAdminRefresh.textContent;
        try {
          btnAdminRefresh.disabled = true;
          btnAdminRefresh.textContent = "🔄 جاري التحديث...";
          await loadAdminUsers();
          await loadRegistrationStatus();

        } catch (err) {
          console.error(err);
          alert("تعذر تحديث بيانات المستخدمين.");
        } finally {
          btnAdminRefresh.textContent = prevText;
          btnAdminRefresh.disabled = false;
        }
      });
    }

    async function refreshUI() {
      state = normalizeState(state);

      // apply fade-out to the main app view so existing data hides smoothly
      if (appView) {
        appView.classList.remove("fade-in");
        appView.classList.add("fade-out");
        // wait for animation to finish (match CSS duration ~280ms)
        await new Promise((r) => setTimeout(r, 300));
      }

      refreshMonthSelect();
      renderSummary();
      renderAdvancedStats();
      renderExpenses();
      renderComparison();
      renderCategoryOptions();
      renderCategoryList();

      // reveal updated UI with a subtle fade-in
      if (appView) {
        appView.classList.remove("fade-out");
        appView.classList.add("fade-in");
        // remove the class after animation to keep DOM clean
        setTimeout(() => appView && appView.classList.remove("fade-in"), 350);
      }

      await saveState();
    }

    (function init() {
      const savedTheme = localStorage.getItem(THEME_KEY) || "light";
      applyTheme(savedTheme);

      // Show loader while we determine auth state to prevent UI flash
      if (appLoader) {
        appLoader.style.display = "flex";
      }
      if (loginView) loginView.style.display = "none";
      if (appView) appView.style.display = "none";

      // If we have a last signed-in uid and local state, show app immediately (avoid loader flash)
      try {
        const lastUid = localStorage.getItem(LAST_UID_KEY);
        if (lastUid) {
          const raw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid);
          if (raw) {
            try {
              const parsed = JSON.parse(raw);
              state = normalizeState(parsed);
              // show app using local data while firebase confirms session
              if (appLoader) appLoader.style.display = "none";
              if (loginView) loginView.style.display = "none";
              if (appView) appView.style.display = "block";
              if (adminTabBtn) adminTabBtn.style.display = "none"; // will update after auth

              // try to show cached profile/email immediately (speeds up UI on refresh)
              try {
                const profileRaw = localStorage.getItem(STORAGE_KEY_PREFIX + lastUid + "_profile");
                if (profileRaw) {
                  const p = JSON.parse(profileRaw);
                  if (userEmailLabel) userEmailLabel.textContent = p.email || "";
                }
                // show admin tab from cache when uid matches ADMIN_UID (will be revalidated by auth handler)
                if (adminTabBtn) {
                  adminTabBtn.style.display = lastUid === ADMIN_UID ? "block" : "none";
                }
              } catch (e) {
                /* ignore cache read errors */
              }
              // render local UI
              refreshUI();
            } catch (e) {
              console.warn("failed to parse local cached state", e);
            }
          }
        }
      } catch (e) {
        console.warn("failed to read last uid", e);
      }

      if (firebaseEnabled && auth) {
        onAuthStateChanged(auth, async (user) => {
         if (user) {
  currentUser = user;
  userRef = ref(db, "users/" + currentUser.uid + "/state");

        // remember last uid locally to speed up UI on refresh
        try { localStorage.setItem(LAST_UID_KEY, currentUser.uid); } catch (e) {}

  /* 🔒 التحقق إذا كان المستخدم معطّلاً */
  try {
    const disabledSnap = await get(ref(db, "users/" + currentUser.uid + "/disabled"));
    if (disabledSnap.exists() && disabledSnap.val() === true) {
      alert("تم تعطيل حسابك من قبل الإدارة.");
      await signOut(auth);
      return;
    }
  } catch (e) {
    console.warn("Failed to check disabled flag:", e);
  }

  /* 📌 تحديث بروفايل المستخدم داخل قاعدة البيانات */
  try {
    await set(ref(db, "users/" + currentUser.uid + "/profile"), {
      email: currentUser.email || "",
    });
  } catch (e) {
    console.warn("Failed to update user profile:", e);
  }

  /* 📧 إظهار بريد المستخدم */
  userEmailLabel.textContent = user.email || "";

  /* 👑 إظهار تبويب لوحة التحكم إذا كان المستخدم هو المدير */
  if (adminTabBtn) {
    if (currentUser.uid === ADMIN_UID) {
      adminTabBtn.style.display = "block";
    } else {
      adminTabBtn.style.display = "none";
      if (tabAdmin) tabAdmin.style.display = "none";
    }
  }

  /* ☁️ تحميل بيانات المستخدم */
  loadStateLocal();
  state = normalizeState(state);

  await loadStateRemoteIfExists();
  state = normalizeState(state);

  /* تحميل القسم المحمي */
  loadPrivateState();

  /* 🔄 عرض واجهة التطبيق */
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";

  await refreshUI();

} else {
  /* 🚪 حالة تسجيل الخروج */
  currentUser = null;
  userRef = null;
  userEmailLabel.textContent = "";
  
  if (adminTabBtn) adminTabBtn.style.display = "none";
  if (tabAdmin) tabAdmin.style.display = "none";

  /* 🔄 إعادة ضبط حالة التطبيق */
  state = {
    months: [],
    selectedMonthId: null,
    categories: [...defaultCategories],
  };

  filterState = {
    search: "",
    category: "all",
    hasImageOnly: false,
  };

  /* عرض شاشة الدخول */
  if (appLoader) appLoader.style.display = "none";
  appView.style.display = "none";
  loginView.style.display = "block";
}
});
} else {
  // في حالة لم يعمل Firebase (وضع Offline)
  currentUser = null;
  userRef = null;
  if (appLoader) appLoader.style.display = "none";
  loginView.style.display = "none";
  appView.style.display = "block";
  refreshUI();
}
})();
    </script>
</body>
</html>

