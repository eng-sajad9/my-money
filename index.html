<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Theme & palette (soft, mobile-friendly) */
      --bg: linear-gradient(180deg,#fbfdff 0%, #f3f6fb 100%);
      --card: #ffffff;
      --text: #0b1220; --muted: #5b6776;
      --accent-start:#6b8cff; --accent-end:#5ad0ff; --danger:#ff6b6b; --success:#34d399; --blue:#3b82f6; --gray:#9aa3b2;
      --glass: rgba(255,255,255,0.6);
      --radius:14px;
      font-family: 'Poppins', system-ui, Arial;
      font-size:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale; padding:20px 18px; -webkit-tap-highlight-color: transparent;
    }
    /* App grid: main + sidebar */
    .app{
      max-width:1100px; margin:0 auto; display:grid; gap:18px; grid-template-columns: 1fr 340px;
      align-items:start;
    }
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:20px;margin:0;font-weight:700}
    .top-actions{display:flex;gap:10px;align-items:center}

    /* Primary button (default) - neutral pleasant gradient
       Note: colors are kept as-is (ID selectors below override gradients for semantics).
       Styling focuses on size, padding, radius, shadow, and centering for touch. */
    .btn{
      background:linear-gradient(90deg,var(--accent-start),var(--accent-end));
      color:#fff;
      padding:0.8rem 1rem; /* comfortable touch target */
      border-radius:0.875rem; /* ~14px */
      border:0;
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s, opacity .14s;
      font-weight:600;
      font-size:1.025rem; /* within requested 1rem - 1.1rem */
      box-shadow:0 0.375rem 1.125rem rgba(16,24,40,.08);
      display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;line-height:1;
      text-align:center;
      vertical-align:middle;
    }
    .btn:hover{transform:translateY(-0.125rem);box-shadow:0 0.75rem 1.75rem rgba(16,24,40,.10)}
    .btn:active{transform:translateY(-0.0625rem);box-shadow:0 0.375rem 1rem rgba(16,24,40,.06)}

  /* Ghost style (secondary) - subtle border */
  .ghost{background:transparent;color:var(--muted);box-shadow:none;border:1px solid rgba(100,110,140,.08);display:inline-flex;align-items:center;justify-content:center}

    /* Specific semantic colors by ID (do not change any IDs in HTML/JS) */
    /* Add / Create (green) */
    #openAddBtn, #addCatBtn, #openAddBtn:focus, #addCatBtn:focus{ background:linear-gradient(90deg,#34d399,#10b981); }
    /* Save actions (blue) */
    #saveBudgetCatBtn, #salarySave, #initFirebaseBtn{ background:linear-gradient(90deg,var(--blue),#60a5fa); }
    /* Cancel-like actions (gray/neutral) */
    #cancelAdd, #salaryCancel, #closeCats, #closeConfig{ background:transparent; color:var(--muted); border:1px solid rgba(100,110,140,.08); box-shadow:none }
    /* Clear / Delete month (destructive) */
    #clearMonthBtn{ background:linear-gradient(90deg,#ff7b7b,#ff5a5a); }

  /* Make the 'Ø§Ù„ÙØ¦Ø§Øª' (categories) button more prominent (purple) */
  #openCatsBtn{ background: linear-gradient(90deg,#8b5cf6,#7c3aed); color:#fff; border:0 }

    /* For dynamic lists: treat the last ghost button inside an expense/card as Delete (red)
       This matches the structure where edit then delete buttons are appended. */
    .expense .btn.ghost:last-child{ background:linear-gradient(90deg,#ff6b6b,#ff4b4b); color:#fff; border:0 }

  /* Edit buttons inside expense rows should be blue for clarity */
  .expense .btn.ghost:first-child{ background: linear-gradient(90deg,#3b82f6,#60a5fa); color:#fff; border:0 }

    /* Per-category budgets list: make the 'Ø­Ø°Ù' button visually destructive (red)
       Target the last button inside the right cell of each budget row so we don't
       need to change JS or add classes. Also ensure edit+delete buttons are
       consistent and touch-friendly on phones. */
    #catBudgetsList > div > div:last-child > button.btn.ghost:last-child{
      background: linear-gradient(90deg,#ff6b6b,#ff4b4b) !important;
      color: #fff !important;
      border: 0 !important;
      box-shadow: 0 8px 20px rgba(255,90,90,.12) !important;
      padding: 10px 12px !important;
      min-width: 64px;
      font-weight: 700 !important;
      border-radius: 10px !important;
      display: inline-flex !important; align-items: center; justify-content: center;
    }

    /* Make edit + delete buttons inside catBudgetsList consistent */
    #catBudgetsList button.btn.ghost{
      padding: 10px 12px !important;
      min-width: 64px !important;
      font-weight: 700 !important;
      border-radius: 10px !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 8px;
      color: inherit !important;
      background: transparent !important;
      border: 1px solid rgba(100,110,140,.06) !important;
    }

    /* Make the edit button in the budgets list blue (first button) */
    #catBudgetsList > div > div:last-child > button.btn.ghost:first-child{
      background: linear-gradient(90deg,#3b82f6,#60a5fa) !important;
      color:#fff !important; border:0 !important;
    }

    /* On small screens make buttons slightly larger for easier touch */
    @media (max-width:420px){
      #catBudgetsList button.btn.ghost{ padding:12px 14px !important; min-width:72px !important; }
      #catBudgetsList > div > div:last-child > button.btn.ghost:last-child{ padding:12px 14px !important; min-width:72px !important; }
    }

    .search{display:flex;gap:8px;align-items:center}
    input,select,textarea{padding:12px;border-radius:12px;border:1px solid #e9eef6;background:var(--card);font-family:inherit;color:var(--text);font-size:15px}
    input::placeholder, textarea::placeholder{color:var(--gray)}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 10px 30px rgba(16,24,40,.04);transition:transform .14s ease, box-shadow .14s}
    .card:hover{transform:translateY(-4px);box-shadow:0 20px 50px rgba(16,24,40,.06)}

    /* left column */
    .main{display:flex;flex-direction:column;gap:14px}
    .summary{display:flex;gap:12px}
    .summary .item{flex:1;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.4));}
    .month-list{display:flex;gap:8px;overflow:auto;padding-bottom:6px;align-items:center}
    .month-chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(100,110,140,.06);color:var(--muted);cursor:pointer;transition:transform .12s, box-shadow .12s}
    .month-chip:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(16,24,40,.04)}

   /* Allow the expenses list to grow taller so more items are visible on mobile.
     Use a viewport-based calc so it adapts to headers/summaries and keeps scrolling. */
   .expenses-list{display:flex;flex-direction:column;gap:10px;max-height:calc(100vh - 240px);overflow:auto;padding-right:6px}
    .expense{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px}
    .expense .left{display:flex;gap:12px;align-items:center}
    .cat-badge{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;background:linear-gradient(135deg, rgba(124,108,255,0.9), rgba(90,208,255,0.8));}
    .muted{color:var(--muted);font-size:13px}

    /* entry meta (date + notes) clearer and separated */
    .entry-meta{display:none}
    .entry-date{color:var(--muted);font-size:13px;margin-top:6px;font-weight:600}
    .entry-notes{color:var(--text);font-size:14px;margin-top:6px;opacity:0.98;line-height:1.35;font-weight:600}
    .meta-label{display:inline-block;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;padding:2px 8px;border-radius:999px;font-size:11px;margin-inline-end:8px;font-weight:700}
    .meta-value{color:inherit}

    /* right column */
    aside{display:flex;flex-direction:column;gap:12px}
    .small{font-size:13px}

    /* modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;z-index:60;padding:18px}
    .modal{width:520px;max-width:100%;border-radius:14px}
    .modal .card{padding:18px}
    .row{display:flex;gap:8px}

    /* Responsive: mobile-first improvements */
    @media (max-width:900px){
      .app{grid-template-columns:1fr; padding-bottom:40px}
      aside{order:2}
      .aside-hidden{display:none}
    }
    @media (max-width:420px){
      body{padding:14px}
      .btn{padding:0.9rem 1rem;font-size:1.025rem;border-radius:0.875rem}
      input,select,textarea{padding:0.9rem;font-size:1rem}
      .month-chip{padding:10px 14px}
  .expense{flex-direction:column;align-items:flex-start}
      .expense .left{width:100%}
  .right{width:100%;text-align:left;margin-top:10px}
  /* Give more vertical space to the expenses list on small phones */
  .expenses-list{max-height:68vh}
      .entry-notes{font-size:15px}
      .entry-date{font-size:14px}
      .cat-badge{width:42px;height:42px;font-size:18px}
      .actions{display:flex;gap:8px;margin-top:8px}
      .summary{flex-direction:column}
      header{flex-direction:column;align-items:stretch;gap:10px}
      .top-actions{flex-direction:column;align-items:stretch;gap:0.6rem}
      .top-actions .btn, .top-actions .btn.ghost{width:100%;display:flex;justify-content:center}
      .modal{width:100%;max-width:620px}
    }

    /* progress */
    .progress{height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));width:0;transition:width .6s ease}

    /* charts */
    canvas{width:100%;height:180px}

    /* toasts */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent-start),var(--accent-end));color:#fff;padding:12px 16px;border-radius:12px;opacity:0;transform:translateY(12px) scale(.98);transition:opacity .24s cubic-bezier(.2,.9,.2,1),transform .24s cubic-bezier(.2,.9,.2,1);box-shadow:0 10px 30px rgba(16,24,40,.08)}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}

  /* Lightbox for full-size image preview */
  .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.8);z-index:9999;padding:18px}
  .lightbox.show{display:flex}
  .lightbox img{max-width:100%;max-height:100%;border-radius:12px;box-shadow:0 20px 60px rgba(2,6,23,.6)}
  img.clickable-thumb{cursor:pointer;border-radius:8px}
  /* Receipt preview and remove button styling (added for better mobile visibility) */
  #addModal #receiptPreview{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee;display:none}
  #addModal #removeReceiptBtn{padding:0.5rem 0.6rem;margin-left:0.375rem;border-radius:0.65rem;align-self:center}
  #addModal #receiptInput{display:inline-block}

  /* On small screens, stack receipt input, preview and remove button vertically and make button full-width */
  @media (max-width:420px){
    #addModal #receiptInput{display:block !important;width:100% !important;margin-bottom:0.5rem !important}
    #addModal #receiptPreview{display:block !important;width:100% !important;height:auto !important;max-height:6rem!important;margin-bottom:0.5rem !important;object-fit:contain !important}
    #addModal #removeReceiptBtn{display:flex !important;width:100% !important;margin-left:0 !important;padding:0.8rem 1rem !important;justify-content:center !important}
  }
  /* iOS smoothing and momentum scroll improvements */
  .month-list, .expenses-list{ -webkit-overflow-scrolling:touch }

    /* tiny helpers */
    .flex{display:flex;align-items:center}
    .spacer{flex:1}
    /* Hide the raw category ID text rendered as <div class="muted" small>... */
    #catsList .muted[small], #catsList [small]{ display: none !important; }
  </style>
</head>
<body>
  <div class="app">
    <main class="main">
      <header>
        <div>
          <h1>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ø®ØµÙŠØ©</h1>
        </div>
        <div class="top-actions">
          <div class="search">
            <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø£Ùˆ Ø§Ù„ÙØ¦Ø©" style="min-width:220px" />
            <select id="filterCategory"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
            <select id="filterMonth"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option></select>
          </div>
          <button class="btn" id="openAddBtn">Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ</button>
          <button class="btn" id="addSalaryBtn" title="Ø£Ø¶Ù Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ">Ø£Ø¶Ù Ø±Ø§ØªØ¨</button>
          <button class="btn ghost" id="clearMonthBtn" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯">Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø±</button>
        </div>
      </header>

      <section class="card summary" id="summaryBar">
        <div class="item">
          <div class="small muted">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø¯Ø®Ù„)</div>
          <div style="font-weight:700;font-size:18px" id="totalIncome">0</div>
        </div>
        <div class="item">
          <div class="small muted" id="totalExpenseLabel">Ø§Ù„Ù…ØµØ±ÙˆÙ</div>
          <div style="font-weight:700;font-size:18px;color:var(--danger)" id="totalExpense">0</div>
        </div>
        <div class="item">
          <div class="small muted">Ø§Ù„Ø¨Ù€Ø§Ù‚ÙŠ</div>
          <div style="font-weight:700;font-size:18px;color:var(--accent-start)" id="balance">0</div>
        </div>
      </section>

      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <strong>Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±</strong>
          <div class="muted small">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø´Ù‡Ø± Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</div>
        </div>
        <div class="month-list" id="monthChips"></div>
      </section>

      <section class="card" style="padding-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <strong>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</strong>
          <div class="flex"><div class="muted small" id="selectedMonthTitle">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</div></div>
        </div>
        <div class="expenses-list" id="expensesList"></div>
      </section>

      <section class="card">
        <strong>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø´Ù‡Ø± (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)</strong>
        <canvas id="barChart"></canvas>
      </section>

    </main>

    <aside class="card" style="min-width:260px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px"><strong>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</strong>
        <button class="btn ghost" id="openCatsBtn">Ø§Ù„ÙØ¦Ø§Øª</button>
      </div>

      <!-- Monthly budget removed â€” using per-category budgets only -->

      <!-- Per-category budgets -->
      <div style="margin-top:14px">
        <div class="small muted">Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <select id="budgetCatSelect" style="flex:1"></select>
          <input id="budgetCatInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="width:110px" />
          <button class="btn" id="saveBudgetCatBtn">Ø­ÙØ¸</button>
        </div>
        <div id="catBudgetsList" style="margin-top:10px;display:flex;flex-direction:column;gap:8px"></div>
      </div>

      <div style="margin-top:10px">
        <div class="small muted">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ - Ø£ÙƒØ«Ø± ÙØ¦Ø©</div>
        <div style="margin-top:10px"><canvas id="pieChart"></canvas></div>
      </div>

    </aside>
  </div>

  <!-- Modals -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal card" id="addModal" style="display:none">
      <h3>Ø£Ø¶Ù Ù…ØµØ±ÙˆÙ / Ø¯Ø®Ù„</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
  <div class="row"><input id="amountInput" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" type="text" inputmode="decimal" pattern="[0-9,\.]+" style="flex:1" /><select id="typeInput" style="width:130px"><option value="expense">Ù…ØµØ±ÙˆÙ</option></select></div>
        <div class="row"><select id="categoryInput" style="flex:1"></select><input id="dateInput" type="date" style="width:150px" /></div>
        <textarea id="notesInput" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..." rows="2"></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="btn ghost" id="cancelAdd">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="saveAdd">Ø£Ø¶Ù</button>
        </div>
      </div>
    </div>

    <div class="modal card" id="catsModal" style="display:none">
      <h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h3>
      <div styl
      e="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px"><input id="newCatName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø©" /><input id="newCatColor" type="color" value="#ff7b7b" style="width:60px" /><input id="newCatIcon" placeholder="Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ø±Ù…Ø²)" style="width:72px" /><button class="btn" id="addCatBtn">Ø£Ø¶Ù</button></div>
        <div id="catsList"></div>
        <div style="display:flex;justify-content:flex-end"><button class="btn ghost" id="closeCats">Ø¥ØºÙ„Ø§Ù‚</button></div>
      </div>
    </div>

    <div class="modal card" id="salaryModal" style="display:none">
      <h3>Ø£Ø¶Ù / Ø¹Ø¯Ù„ Ø§Ù„Ø±Ø§ØªØ¨</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="salaryAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="flex:1" />
          <input id="salaryDate" type="date" style="width:150px" title="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" />
        </div>
        <label style="display:flex;gap:8px;align-items:center"><input id="salaryAddNow" type="checkbox" checked /> Ø£Ø¶Ù Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</label>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
          <button class="btn ghost" id="salaryDelete">Ø­Ø°Ù</button>
          <button class="btn ghost" id="salaryCancel">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="salarySave">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>

    <div class="modal card" id="configModal" style="display:none">
      <h3>Ø¥Ø¹Ø¯Ø§Ø¯ Firebase</h3>
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:8px">
        <textarea id="firebaseConfigInput" rows="6" placeholder='Ø§Ù†Ø³Ø® Ù‡Ù†Ø§ Ù…Ø­ØªÙˆÙ‰ firebase config JSON (object) Ù…Ù† Ù„ÙˆØ­Ø© Firebase'></textarea>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button class="btn ghost" id="closeConfig">Ø¥ØºÙ„Ø§Ù‚</button>
          <button class="btn" id="initFirebaseBtn">Initialize</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…</div>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- User-provided Firebase config (saved to localStorage so the app auto-initializes) -->
  <script>
    // Firebase config provided by user
    const firebaseConfig = {
      apiKey: "AIzaSyDQxzIZjBuk5ngd2c7ZHhmfvzUq9TU26Yw",
      authDomain: "mony-ecb81.firebaseapp.com",
      databaseURL: "https://mony-ecb81-default-rtdb.firebaseio.com",
      projectId: "mony-ecb81",
      storageBucket: "mony-ecb81.firebasestorage.app",
      messagingSenderId: "1099032510981",
      appId: "1:1099032510981:web:36e36003b13ffe6d72926c",
      measurementId: "G-PVHFMZ82XL"
    };
    try{
      localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));
      // The main script will pick this up and initialize on load
      console.info('Firebase config injected to localStorage');
    }catch(e){console.warn('Could not save firebase config to localStorage', e)}
  </script>

  <script>
    /***** Helpers and state *****/
    // Simple todo: format numbers with comma separators
    const fmt = (v) => Number(v || 0).toLocaleString('en-US',{maximumFractionDigits:2});

    // Short id generator for local use
    const uid = ()=> 'id'+Math.random().toString(36).slice(2,9);

  // App state
  let db = null;
  let app = null;
  let categories = {};
  let expenses = {};
  let editingExpenseId = null;

    // DOM refs
    const refs = {};

    function $(id){return document.getElementById(id)}

  // Toast â€” accepts HTML string
  function showToast(msg='ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…',dur=3500){const t=$('toast'); t.innerHTML = String(msg); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),dur)}

    // Number formatting helpers (global) - used across functions
    function formatNumberWithCommas(value){
      if(value === null || value === undefined) return '';
      const parts = String(value).replace(/[^0-9.\-]/g,'').split('.');
      // remove leading zeros except if single zero
      parts[0] = parts[0].replace(/^0+(?=\d)/, '') || '0';
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.length>1 ? parts[0] + '.' + parts[1].slice(0,2) : parts[0];
    }

    function parseFormattedNumber(str){
      if(!str) return 0;
      const cleaned = String(str).replace(/,/g,'').replace(/[^0-9.\-]/g,'');
      return Number(cleaned) || 0;
    }

    // Date formatting helper: accept ISO 'YYYY-MM-DD' or other strings and return 'DD/MM/YYYY'
    function formatDisplayDate(d){
      if(!d) return '';
      try{
        // if already looks like YYYY-MM-DD
        if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(d)){
          const [y,m,day] = d.split('-');
          return String(day).padStart(2,'0') + '/' + String(m).padStart(2,'0') + '/' + y;
        }
        // try parsing as Date
        const dt = new Date(d);
        if(!isNaN(dt.getTime())){
          const dd = String(dt.getDate()).padStart(2,'0');
          const mm = String(dt.getMonth()+1).padStart(2,'0');
          const yy = dt.getFullYear();
          return dd + '/' + mm + '/' + yy;
        }
      }catch(e){}
      return String(d);
    }

    // Offline helpers: pending expenses queue stored locally until synced
    const PENDING_KEY = 'pendingExpenses';
    function getPendingExpenses(){ try{ return JSON.parse(localStorage.getItem(PENDING_KEY)||'{}'); }catch(e){ return {}; } }
    function savePendingExpenses(obj){ localStorage.setItem(PENDING_KEY, JSON.stringify(obj)); }
    function enqueuePendingExpense(payload){ const id = 'local_'+uid(); const p = {...payload, _localId:id, _createdAt:Date.now()}; const all = getPendingExpenses(); all[id]=p; savePendingExpenses(all); return id; }
    function removePendingExpense(id){ const all = getPendingExpenses(); delete all[id]; savePendingExpenses(all); }

    // Try to sync pending expenses to Firebase when possible
    async function syncPendingExpenses(){
      const pending = getPendingExpenses(); const keys = Object.keys(pending||{}); if(!keys.length) return 0;
      if(!db) return 0;
      let synced = 0;
      for(const id of keys){
        const p = {...pending[id]};
        // strip local-only fields
        delete p._localId; delete p._createdAt;
        try{
          await db.ref('expenses').push().set(p);
          removePendingExpense(id);
          synced++;
        }catch(e){ console.warn('sync failed for', id, e); }
      }
      if(synced) showToast('ØªÙ…Øª Ù…Ø²Ø§Ù…Ù†Ø© ' + synced + ' Ø¹Ù†ØµØ±(Ø¹Ù†Ø§ØµØ±) Ø¥Ù„Ù‰ Firebase âœ…', 3500);
      return synced;
    }

    // Month placeholders helpers (so months appear even if empty)
    const MONTHS_PLACEHOLDER_KEY = 'localMonthPlaceholders';
    function getLocalMonthPlaceholders(){ try{ return JSON.parse(localStorage.getItem(MONTHS_PLACEHOLDER_KEY)||'{}'); }catch(e){return{}} }
    function saveLocalMonthPlaceholders(obj){ localStorage.setItem(MONTHS_PLACEHOLDER_KEY, JSON.stringify(obj)); }
    function ensureMonthPlaceholder(yyyyMM){
      // persist placeholder either in Firebase (recommended) or localStorage
      if(db){
        db.ref('settings/monthPlaceholders/'+yyyyMM).set(true).catch(e=>console.warn('could not set month placeholder',e));
      } else {
        const p = getLocalMonthPlaceholders(); p[yyyyMM]=true; saveLocalMonthPlaceholders(p);
      }
    }
    // Return merged months placeholders from settings (firebase) and local
    function getMergedMonthPlaceholders(){
      const res = {};
      try{ if(window.settings && window.settings.monthPlaceholders) Object.assign(res, window.settings.monthPlaceholders); }catch(e){}
      const local = getLocalMonthPlaceholders(); Object.assign(res, local);
      return res;
    }

    // Return merged expenses object (Firebase + pending local)
    function getAllExpensesObject(){
      const merged = {};
      try{ Object.assign(merged, expenses); }catch(e){}
      const pending = getPendingExpenses();
      for(const [id,p] of Object.entries(pending||{})){
        merged[id] = {...p}; // keep local id
      }
      return merged;
    }

    function attachFormattedInput(el){
      if(!el) return;
      el.addEventListener('input', (ev) => {
        const selectionStart = el.selectionStart;
        const oldValue = el.value;
        const raw = String(oldValue).replace(/,/g,'');
        const formatted = formatNumberWithCommas(raw);
        el.value = formatted;
        try{ const newPos = Math.max(0, formatted.length - (oldValue.length - selectionStart)); el.setSelectionRange(newPos, newPos); }catch(e){}
      });
      el.addEventListener('blur', ()=>{ el.value = formatNumberWithCommas(el.value); });
    }

    /***** Firebase initialization (user pastes config JSON) *****/
    function initFirebaseFromConfigString(cfgStr){
      try{
        const cfg = JSON.parse(cfgStr);
        // Save locally so user doesn't need to paste again
        localStorage.setItem('firebaseConfig', JSON.stringify(cfg));
        if(app){app.delete && app.delete();}
        app = firebase.initializeApp(cfg);
        db = firebase.database();
        attachListeners();
        showToast('Firebase Ù…ØªØµÙ„ âœ…');
        closeModalAndBackdrop();
        return true;
      }catch(e){alert('Ø®Ø·Ø£ Ø¨Ù…Ù„Ù config: '+e.message);return false}
    }

    /***** Realtime listeners and syncing *****/
    function attachListeners(){
      if(!db) return;
      // Categories
      db.ref('categories').on('value', snap=>{
        categories = snap.val() || {};
        try{ localStorage.setItem('cachedCategories', JSON.stringify(categories)); }catch(e){}
        renderCategoriesUI();
        populateCategorySelects();
        try{ populateBudgetCatSelect(); }catch(e){}
        computeAndRender();
      });

      // Expenses
      db.ref('expenses').on('value', snap=>{
        expenses = snap.val() || {};
        computeAndRender();
      });

      // Settings (budgets)
      db.ref('settings').on('value', snap=>{
        window.settings = snap.val() || {};
        computeAndRender();
      });
    }

    /***** CRUD operations *****/
    function addExpense(payload){
      payload.createdAt = Date.now();
      // if Firebase available, write directly
      if(db){
        const ref = db.ref('expenses').push();
        ref.set(payload).then(()=>{
          const tmsg = `<div style="font-weight:700;color:#fff">${payload.type==='income'?'+':'-'} ${fmt(payload.amount)}</div><div style="font-size:12px;color:rgba(255,255,255,0.95)">${formatDisplayDate(payload.date)}${payload.notes? ' â€¢ '+(payload.notes||'') : ''}</div>`;
          showToast(tmsg, 4200);
          // try sync any pending too
          try{ syncPendingExpenses(); }catch(e){}
        }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸: '+e.message));
      } else {
        // offline: enqueue locally and show toast
        const localId = enqueuePendingExpense(payload);
        const tmsg = `<div style="font-weight:700;color:#111">Ù…Ø­Ù„ÙŠÙ‹Ø§ Ù…Ø­ÙÙˆØ¸: ${fmt(payload.amount)}</div><div style="font-size:12px;color:#333">${formatDisplayDate(payload.date)}${payload.notes? ' â€¢ '+(payload.notes||'') : ''}</div>`;
        showToast(tmsg, 4200);
        // update UI immediately by adding to local in-memory view
      }
    }

    function addCategory(cat){
      if(db){
        const ref = db.ref('categories').push();
        ref.set(cat);
      } else {
        // local fallback: create local key and persist to cachedCategories
        const key = 'localcat_'+uid();
        categories = categories || {};
        categories[key] = {...cat, id:key};
        try{ localStorage.setItem('cachedCategories', JSON.stringify(categories)); }catch(e){console.warn(e)}
        renderCategoriesUI(); populateCategorySelects();
      }
    }

    // Ensure there is a category called 'Ø±Ø§ØªØ¨' and return its id if exists.
    // NOTE: We no longer auto-create a 'Ø±Ø§ØªØ¨' category. Salary entries are treated as incomes
    // and can be saved without assigning a dedicated category. This avoids cluttering the
    // categories list with a category that represents an income source rather than an expense.
    function ensureSalaryCategory(){
      return new Promise((resolve)=>{
        for(const [id,c] of Object.entries(categories||{})){
          if((c.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') return resolve(id);
        }
        // Do NOT create the category automatically. Return empty string to indicate no category.
        resolve('');
      });
    }

    // Remove any stored category whose name is 'Ø±Ø§ØªØ¨' (case-insensitive).
    // This removes from Firebase if connected, and from local cachedCategories.
    function removeSalaryCategories(){
      try{
        const toRemove = [];
        for(const [id,c] of Object.entries(categories||{})){
          if((c.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') toRemove.push(id);
        }
        if(!toRemove.length) return;
        for(const id of toRemove){
          // remove from in-memory categories
          delete categories[id];
          // remove from firebase if available
          if(db){ try{ db.ref('categories/'+id).remove().catch(()=>{}); }catch(e){} }
        }
        // also purge from cachedCategories in localStorage
        try{
          const cached = JSON.parse(localStorage.getItem('cachedCategories')||'{}');
          let changed = false;
          for(const id of toRemove){ if(cached && cached[id]){ delete cached[id]; changed = true; } }
          if(changed) localStorage.setItem('cachedCategories', JSON.stringify(cached));
        }catch(e){}
        // update UI
        try{ renderCategoriesUI(); populateCategorySelects(); populateBudgetCatSelect(); computeAndRender(); }catch(e){}
      }catch(e){console.warn('removeSalaryCategories failed', e)}
    }

    // find recurring 'Ø±Ø§ØªØ¨' entry if exists (firebase or local)
    function findSalaryRecurring(){
      const recs = (window.settings && window.settings.recurringIncomes) || {};
      for(const [id,r] of Object.entries(recs||{})){
        if((r.name||'').toLowerCase() === 'Ø±Ø§ØªØ¨') return {id, item:r};
      }
      try{ const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}'); for(const [id,r] of Object.entries(local||{})){ if((r.name||'').toLowerCase()==='Ø±Ø§ØªØ¨') return {id, item:r}; } }catch(e){}
      return null;
    }

    function updateExpense(id, payload){
      if(!db){alert('Ø±Ø¨Ø· Firebase Ù…Ø·Ù„ÙˆØ¨.');return}
      db.ref('expenses/'+id).update({...payload}).then(()=>{
        showToast('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…');
      }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message));
    }

    function deleteExpense(id){
      if(!db){alert('Ø±Ø¨Ø· Firebase Ù…Ø·Ù„ÙˆØ¨.');return}
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ')) return;
      db.ref('expenses/'+id).remove().then(()=>{
        showToast('Ø­ÙØ°Ù Ø§Ù„Ø¹Ù†ØµØ± âœ…');
      }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù: '+e.message));
    }

    function exportExpensesCSV(filteredList){
      const rows = [['id','date','type','category','amount','notes']];
      for(const e of filteredList){
        rows.push([e.id, e.date, e.type, (categories[e.categoryId]?.name)||e.categoryId||'', Number(e.amount)||0, (e.notes||'')]);
      }
      const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'expenses.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV âœ…');
    }

    function deleteCategory(catId){
      if(!db) return;
      // Reassigning or deleting expenses in that category is left to user. We'll just delete category.
      db.ref('categories/'+catId).remove();
    }

    function saveBudgetForMonth(yyyyMM, amount){
      if(!db) return;
      db.ref('settings/monthlyBudgets/'+yyyyMM).set(Number(amount));
    }

    // Delete per-category budget for a given month (Firebase if available, otherwise local fallback)
    function deleteCategoryBudgetForMonth(yyyyMM, catId){
      if(!catId) return;
      if(db){
        db.ref('settings/monthlyBudgets/'+yyyyMM+'/categories/'+catId).remove().then(()=>{
          try{ showToast('ØªÙ… Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© âœ…'); }catch(e){}
        }).catch(e=>{ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù: '+e.message); });
      } else {
        try{
          const key = 'localMonthCategoryBudgets';
          const all = JSON.parse(localStorage.getItem(key)||'{}');
          if(all[yyyyMM] && all[yyyyMM][catId]){ delete all[yyyyMM][catId]; localStorage.setItem(key, JSON.stringify(all)); }
          // reflect in window.settings for UI
          try{
            if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories){
              delete window.settings.monthlyBudgets[yyyyMM].categories[catId];
            }
          }catch(e){}
          try{ showToast('ØªÙ… Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§) âœ…'); }catch(e){}
        }catch(e){ console.warn('deleteCategoryBudgetForMonth failed', e) }
      }
      // Recompute UI
      try{ renderCategoryBudgetsList(yyyyMM); computeAndRender(); }catch(e){}
    }

    // Global helper: populate budget category select (safe to call from listeners)
    function populateBudgetCatSelect(){
      const sel = $('budgetCatSelect'); if(!sel) return;
      sel.innerHTML = '';
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [id,c] of Object.entries(catObj||{})){
        const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
      }
    }

    // Global helper: render per-category budgets list for a given month
    function renderCategoryBudgetsList(yyyyMM){
      const el = $('catBudgetsList'); if(!el) return; el.innerHTML='';
      // read budgets from settings or local
      let catBud = {};
      try{ if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories) catBud = window.settings.monthlyBudgets[yyyyMM].categories; }catch(e){}
      try{ const local = JSON.parse(localStorage.getItem('localMonthCategoryBudgets')||'{}'); if(local[yyyyMM]) Object.assign(catBud, local[yyyyMM]); }catch(e){}
      // compute usage per category
      const allObj = getAllExpensesObject();
      const totals = {};
      for(const [id,e] of Object.entries(allObj||{})){
        const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(key!==yyyyMM) continue;
        const cid = e.categoryId || 'uncat'; totals[cid] = (totals[cid]||0) + Number(e.amount||0);
      }
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [cid,bud] of Object.entries(catBud||{})){
        const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${(catObj[cid]&&catObj[cid].name)||cid}</div><div class=muted style="font-size:12px">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(bud)} Â· Ù…Ø³ØªØ®Ø¯Ù…: ${fmt(totals[cid]||0)}</div>`;
        const percent = bud>0 ? Math.round((totals[cid]||0)/bud*100) : 0;
        const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
        const p = document.createElement('div'); p.style.minWidth='48px'; p.style.textAlign='right'; p.textContent = percent+'%';
  const edit = document.createElement('button'); edit.className='btn ghost'; edit.style.padding='6px 8px'; edit.textContent='ØªØ¹Ø¯ÙŠÙ„';
  edit.onclick = ()=>{ const sel = $('budgetCatSelect'); if(sel) sel.value = cid; const input = $('budgetCatInput'); if(input) input.value = formatNumberWithCommas(String(bud||0)); };
  const del = document.createElement('button');
  del.className='btn ghost';
  del.style.padding='10px 12px';
  del.style.fontWeight='700';
  del.style.borderRadius='10px';
  del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-inline-end:8px;vertical-align:middle;color:inherit"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>Ø­Ø°Ù';
  del.onclick = ()=>{ if(!confirm('Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù„Ù„Ø´Ù‡Ø± ' + yyyyMM + 'ØŸ')) return; deleteCategoryBudgetForMonth(yyyyMM, cid); };
  right.appendChild(p); right.appendChild(edit); right.appendChild(del);
        row.appendChild(left); row.appendChild(right); el.appendChild(row);
      }
      if(Object.keys(catBud||{}).length===0) el.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙØ¦Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
    }

    // Recurring incomes (salary) - add/update/delete with localStorage fallback when Firebase not connected
    function addRecurringIncome(payload){
      if(db){
        const ref = db.ref('settings/recurringIncomes').push();
        ref.set(payload).then(()=>{ showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸: '+e.message));
        return ref.key;
      } else {
        // local fallback
        const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
        const id = uid();
        local[id] = payload;
        localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
        // also reflect in window.settings for immediate UI updates
        window.settings = window.settings || {};
        window.settings.recurringIncomes = window.settings.recurringIncomes || {};
        window.settings.recurringIncomes['local_'+id] = payload;
        computeAndRender();
        showToast('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        return 'local_'+id;
      }
    }

    function updateRecurringIncome(id, payload){
      if(db){
        db.ref('settings/recurringIncomes/'+id).set(payload).then(()=>{ showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: '+e.message));
      } else {
        try{
          const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
          const realId = id.startsWith('local_') ? id.slice(6) : id;
          if(local[realId]) local[realId] = payload;
          localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
          window.settings = window.settings || {};
          window.settings.recurringIncomes = window.settings.recurringIncomes || {};
          window.settings.recurringIncomes[id] = payload;
          computeAndRender();
          showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        }catch(e){alert('Ø®Ø·Ø£ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ: '+e.message)}
      }
    }

    function deleteRecurringIncome(id){
      if(db){
        db.ref('settings/recurringIncomes/'+id).remove().then(()=>{ showToast('Ø­ÙØ°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù: '+e.message));
      } else {
        try{
          const local = JSON.parse(localStorage.getItem('localRecurringIncomes')||'{}');
          const realId = id.startsWith('local_') ? id.slice(6) : id;
          delete local[realId];
          localStorage.setItem('localRecurringIncomes', JSON.stringify(local));
          if(window.settings && window.settings.recurringIncomes) delete window.settings.recurringIncomes[id];
          computeAndRender();
          showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…ØªÙƒØ±Ø± (Ù…Ø­Ù„ÙŠ) âœ…');
        }catch(e){alert('Ø®Ø·Ø£ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø­Ù„ÙŠ: '+e.message)}
      }
    }

    /***** UI rendering and computations *****/
  function computeAndRender(){
      // Group expenses by month YYYY-MM
      const months = {};
      const allObj = getAllExpensesObject();
      const allExpenses = Object.entries(allObj).map(([id,e])=>({id,...e}));
      for(const e of allExpenses){
        const d = new Date(e.date);
        const yyyyMM = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
        months[yyyyMM] = months[yyyyMM] || [];
        months[yyyyMM].push(e);
      }

      // Sort months desc
      let monthKeys = Object.keys(months).sort((a,b)=>b.localeCompare(a));
      // Include persisted month placeholders (DB or local) and ensure current/next exist
      try{
        const placeholders = getMergedMonthPlaceholders();
        const s = new Set(monthKeys);
        Object.keys(placeholders||{}).forEach(k=>s.add(k));
        const now = new Date();
        const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
        const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
        const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
        s.add(currentMM); s.add(nextMM);
        monthKeys = Array.from(s).sort((a,b)=>b.localeCompare(a));
      }catch(e){}
      renderMonthChips(monthKeys);
      populateFilterMonths(monthKeys);
  // render per-category budgets for selected month
  try{ const selMonth = $('filterMonth').value || (new Date()).getFullYear()+'-'+String((new Date()).getMonth()+1).padStart(2,'0'); renderCategoryBudgetsList(selMonth); }catch(e){}

      // compute global totals (all data)
      let globalIncome = 0, globalExpense = 0;
      for(const e of allExpenses){ const amt = Number(e.amount)||0; if(e.type==='income') globalIncome += amt; else globalExpense += amt; }

      // apply current filters (category, month, search) for the list view
      const filtered = applyFilters(allExpenses);

      // compute expense total for filtered view (used when a category filter is active)
      let filteredExpense = 0;
      for(const e of filtered){ if(e.type !== 'income') filteredExpense += Number(e.amount||0); }

      // show global income always, show expense either filtered (when category selected) or global
      const catFilter = $('filterCategory').value;
      $('totalIncome').textContent = fmt(globalIncome);
      $('totalExpense').textContent = fmt(catFilter ? filteredExpense : globalExpense);
      // Update expense label to include selected category name when filtered
      try{
        const lbl = $('totalExpenseLabel');
        if(lbl){
          if(catFilter){ const cname = (categories[catFilter] && categories[catFilter].name) || catFilter; lbl.textContent = 'Ø§Ù„Ù…ØµØ±ÙˆÙ â€” ' + cname; }
          else lbl.textContent = 'Ø§Ù„Ù…ØµØ±ÙˆÙ';
        }
      }catch(e){}
      // keep balance as global balance (income - global expense)
      $('balance').textContent = fmt(globalIncome - globalExpense);

      // Render expenses list (use prefiltered list)
      renderExpensesList(filtered, true);

  // Charts
  renderBarChart(monthKeys.slice(0,6).reverse(), months);
  renderPieChartForSelectedMonth();

      // budget
      updateBudgetUI();
    }

    function renderMonthChips(monthKeys){
      const el = $('monthChips'); el.innerHTML='';
      const addAll = document.createElement('button'); addAll.className='month-chip'; addAll.textContent='ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±'; addAll.onclick=()=>{ $('filterMonth').value=''; $('selectedMonthTitle').textContent='ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±'; computeAndRender(); };
      el.appendChild(addAll);
      for(const m of monthKeys){
        const btn = document.createElement('button'); btn.className='month-chip'; btn.textContent=m; btn.onclick=()=>{ $('filterMonth').value=m; $('selectedMonthTitle').textContent=m; computeAndRender(); };
        el.appendChild(btn);
      }
    }

    // Apply filters (search, category, month) to an array of expense objects
    function applyFilters(items){
      const search = $('searchInput').value.trim().toLowerCase();
      const catFilter = $('filterCategory').value;
      const monthFilter = $('filterMonth').value;
      let list = items.slice();
      if(search){
        list = list.filter(e=>(((e.notes||'')+ (categories[e.categoryId]?.name||'') + (e.amount||'')).toLowerCase().includes(search)));
      }
      if(catFilter) list = list.filter(e=>e.categoryId === catFilter);
      if(monthFilter) list = list.filter(e=>{const d=new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); return key===monthFilter});
      return list;
    }

    // renderExpensesList accepts either a full list (and will filter it) or a prefiltered
    // list with the second argument set to true to skip filtering.
    function renderExpensesList(items, prefiltered){
      let list = items.slice();
      if(!prefiltered){
        list = applyFilters(list);
      }

      const out = $('expensesList'); out.innerHTML='';
      list.sort((a,b)=>b.createdAt - a.createdAt);
      for(const e of list){
        const row = document.createElement('div'); row.className='expense card';
        const left = document.createElement('div'); left.className='left';
        // Determine category display: if this entry is a salary (isSalary true or notes contains 'Ø±Ø§ØªØ¨')
        // show a transient 'Ø±Ø§ØªØ¨' label in the details but do NOT require a persistent category.
        let cat = categories[e.categoryId] || null;
        let transientSalary = false;
        try{ if(e.isSalary || ((e.notes||'').toLowerCase().includes('Ø±Ø§ØªØ¨') && e.type==='income')) transientSalary = true; }catch(ex){}
        if(!cat){ if(transientSalary){ cat = { name:'Ø±Ø§ØªØ¨', color: 'linear-gradient(135deg, #60a5fa, #34d399)', icon: 'ğŸ’°' }; } else { cat = {name:'Ø¨Ø¯ÙˆÙ†',color:'#999',icon:'â”'}; } }
        const badge = document.createElement('div'); badge.className='cat-badge'; badge.style.background=cat.color; badge.textContent = cat.icon || 'â€¢';
  const meta = document.createElement('div');
  const titleLine = document.createElement('div');
  titleLine.style.fontWeight = '600';
  titleLine.style.color = 'var(--text)';
  titleLine.textContent = `${cat.name} â€¢ ${fmt(e.amount)}`;
  const dateEl = document.createElement('div');
  dateEl.className = 'entry-date';
  const dateLabel = document.createElement('span'); dateLabel.className = 'meta-label'; dateLabel.textContent = 'Ø§Ù„ØªØ§Ø±ÙŠØ®';
  const dateVal = document.createElement('span'); dateVal.className = 'meta-value'; dateVal.textContent = formatDisplayDate(e.date);
  dateEl.appendChild(dateLabel); dateEl.appendChild(dateVal);

  const notesEl = document.createElement('div');
  notesEl.className = 'entry-notes';
  if(e.notes){
    const notesLabel = document.createElement('span'); notesLabel.className = 'meta-label'; notesLabel.textContent = 'Ù…Ù„Ø§Ø­Ø¸Ø©';
    const notesVal = document.createElement('span'); notesVal.className = 'meta-value'; notesVal.textContent = e.notes || '';
    notesEl.appendChild(notesLabel); notesEl.appendChild(notesVal);
  } else {
    notesEl.textContent = '';
  }

  meta.appendChild(titleLine);
  meta.appendChild(dateEl);
  if(e.notes) meta.appendChild(notesEl);
  left.appendChild(badge);
  left.appendChild(meta);

  const right = document.createElement('div'); right.className='right'; right.style.textAlign='right';
  const mainVal = document.createElement('div'); mainVal.style.fontWeight = '700'; mainVal.style.color = e.type==='income' ? 'var(--accent-start)' : 'var(--danger)'; mainVal.textContent = (e.type==='income'?'+':'-') + ' ' + fmt(e.amount);
        // receipt thumbnail (if any)
        if(e.imageData){
          try{
            const thumb = document.createElement('img'); thumb.src = e.imageData; thumb.alt = 'ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„'; thumb.style.width='56px'; thumb.style.height='56px'; thumb.style.objectFit='cover'; thumb.style.borderRadius='8px'; thumb.style.marginRight='8px';
            // mark as clickable-thumb and store full image in data attribute; lightbox handler added separately
            thumb.className = 'clickable-thumb';
            thumb.dataset.full = e.imageData;
            right.appendChild(thumb);
          }catch(ex){console.warn(ex)}
        }
        const sub = document.createElement('div'); sub.className = 'muted'; sub.textContent = e.createdAt? new Date(e.createdAt).toLocaleString() : '';

        // action buttons
        const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='6px'; actions.style.justifyContent='flex-end'; actions.style.marginTop='6px';
        const editBtn = document.createElement('button'); editBtn.className='btn ghost'; editBtn.style.padding='6px 8px'; editBtn.textContent='ØªØ¹Ø¯ÙŠÙ„';
        editBtn.onclick = ()=>{
          // populate modal for editing
          editingExpenseId = e.id;
          refs.amountInput.value = formatNumberWithCommas(String(e.amount || '0'));
          refs.typeInput.value = e.type || 'expense';
          refs.categoryInput.value = e.categoryId || '';
          refs.dateInput.value = e.date || new Date().toISOString().slice(0,10);
          refs.notesInput.value = e.notes || '';
          refs.saveAdd.textContent = 'ØªØ¹Ø¯ÙŠÙ„';
          openModal('addModal');
          // populate receipt preview when editing
          try{
            refs._removeReceipt = false;
            if(e.imageData){
              refs._receiptData = e.imageData;
              if(refs.receiptPreview) { refs.receiptPreview.src = e.imageData; refs.receiptPreview.style.display = 'block'; }
              if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'inline-block';
            } else {
              if(refs.receiptPreview) { refs.receiptPreview.src = ''; refs.receiptPreview.style.display = 'none'; }
              if(refs.receiptInput) refs.receiptInput.value = '';
              if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'none';
            }
          }catch(ex){console.warn(ex)}
        };
        const delBtn = document.createElement('button'); delBtn.className='btn ghost'; delBtn.style.padding='6px 8px'; delBtn.textContent='Ø­Ø°Ù';
        delBtn.onclick = ()=>{ deleteExpense(e.id); };

        actions.appendChild(editBtn); actions.appendChild(delBtn);

        right.appendChild(mainVal); right.appendChild(sub); right.appendChild(actions);

        row.appendChild(left); row.appendChild(right);
        out.appendChild(row);
      }
    }

    function populateCategorySelects(){
      const sel = $('categoryInput'); const filter = $('filterCategory'); sel.innerHTML=''; filter.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>';
      const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
      for(const [id,c] of Object.entries(catObj||{})){
        const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
        const f = document.createElement('option'); f.value=id; f.textContent=c.name; filter.appendChild(f);
      }
    }

    function renderCategoriesUI(){
      const list = $('catsList'); list.innerHTML='';
      for(const [id,c] of Object.entries(categories)){
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='8px 0';
        const left = document.createElement('div'); left.className='flex'; left.innerHTML = `<div class=cat-badge style=background:${c.color}>${c.icon||'â€¢'}</div><div style=marginInlineStart:10px><div style=font-weight:600>${c.name}</div><div class=muted small>${c.id||id}</div></div>`;
        const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Ø­Ø°Ù'; del.onclick=()=>{ if(confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ')) deleteCategory(id); };
        el.appendChild(left); el.appendChild(del); list.appendChild(el);
      }
    }

    function populateFilterMonths(monthKeys){
      const sel = $('filterMonth'); const prev = sel.value; sel.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø´Ù‡Ø±</option>';
      for(const m of monthKeys){ const o=document.createElement('option'); o.value=m; o.textContent=m; sel.appendChild(o);} if(prev) sel.value = prev;
    }

    /***** Charts (vanilla canvas) *****/
    function renderBarChart(monthKeys, months){
      const c = $('barChart'); const ctx = c.getContext('2d'); c.width = c.clientWidth*devicePixelRatio; c.height = 180*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      // clear
      ctx.clearRect(0,0,c.clientWidth,180);
      const w = c.clientWidth; const h = 160;
      const padding = 20; const barWidth = Math.max(18, (w - padding*2) / Math.max(1, monthKeys.length) - 12);
      // compute totals per month (expense total)
      const totals = monthKeys.map(k=>{ const arr = months[k]||[]; return arr.reduce((s,x)=> s + (x.type==='expense'?Number(x.amount): -Number(x.amount)),0) });
      const max = Math.max(...totals.map(Math.abs),1);
      // draw bars
      monthKeys.forEach((k,i)=>{
        const val = totals[i]; const x = padding + i*(barWidth+12);
        const barH = Math.abs(val)/max * (h-40);
        ctx.fillStyle = val<0 ? '#ff7b7b' : 'rgba(108,92,231,0.9)';
        ctx.fillRect(x, h - barH, barWidth, barH);
        ctx.fillStyle = '#333'; ctx.font = '12px Poppins'; ctx.fillText(k, x, h+12);
      });
    }

    function renderPieChartForSelectedMonth(){
      const monthSel = $('filterMonth').value; if(!monthSel) return; // only show when a month selected
      const month = monthSel;
      // collect category totals in month
      const totals = {};
      const allObj = getAllExpensesObject();
      for(const [id,e] of Object.entries(allObj)){
        const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
        if(key !== month) continue;
        const cat = e.categoryId || 'uncat';
        totals[cat] = (totals[cat]||0) + Number(e.amount || 0);
      }
      const entries = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
      // draw pie
      const c = $('pieChart'); const ctx = c.getContext('2d'); c.width = c.clientWidth*devicePixelRatio; c.height = 160*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
      ctx.clearRect(0,0,c.clientWidth,160);
      const w = c.clientWidth; const cx = w/2; const cy = 80; const r = 60;
      let start = -Math.PI/2; const total = entries.reduce((s,_)=>s+_[1],0) || 1;
      entries.forEach(([cid,val],i)=>{
        const slice = val/total * Math.PI*2; const end = start + slice;
        ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start,end); ctx.closePath();
        const color = categories[cid]?.color || `hsl(${(i*60)%360} 70% 60%)`;
        ctx.fillStyle = color; ctx.fill();
        start = end;
      });
      // legend
      ctx.fillStyle='#333'; ctx.font='12px Poppins'; let yy=10; entries.forEach(([cid,val],i)=>{ ctx.fillText(`${categories[cid]?.name||cid} (${Math.round(val/total*100)}%)`, 10, yy+=14) });
    }

    /***** Budget UI *****/
    function updateBudgetUI(){
      // Update per-category budgets list for the selected month
      const month = $('filterMonth').value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
      try{ renderCategoryBudgetsList(month); }catch(e){}
    }

    /***** Modal helpers *****/
    function openModal(modalId){
      $('modalBackdrop').style.display='flex';
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
      $(modalId).style.display='block';
    }
    function closeModalAndBackdrop(){
      $('modalBackdrop').style.display='none';
      document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
    }

    /***** Wire events on DOMContentLoaded *****/
    document.addEventListener('DOMContentLoaded', ()=>{
      // refs
  ['searchInput','filterCategory','filterMonth','openAddBtn','addSalaryBtn','clearMonthBtn','openCatsBtn','addCatBtn','saveAdd','cancelAdd','addModal','catsModal','salaryModal','configModal','modalBackdrop','initFirebaseBtn','firebaseConfigInput','closeConfig','closeCats','newCatName','newCatColor','newCatIcon','catsList','amountInput','typeInput','categoryInput','dateInput','notesInput','salaryAmount','salaryDate','salaryAddNow','salarySave','salaryDelete','salaryCancel'].forEach(id=>refs[id]=$(id));

  // extra refs added: per-category budget and receipt photo
  ['budgetCatSelect','budgetCatInput','saveBudgetCatBtn','catBudgetsList','receiptInput','receiptPreview','removeReceiptBtn'].forEach(id=>{ try{ refs[id] = $(id); }catch(e){} });

  // buttons
  refs.openAddBtn.onclick = ()=>{ editingExpenseId = null; refs.saveAdd.textContent = 'Ø£Ø¶Ù'; openModal('addModal'); refs.dateInput.value = new Date().toISOString().slice(0,10); try{ if(refs.receiptPreview) refs.receiptPreview.src=''; refs._receiptData = null; if(refs.receiptInput) refs.receiptInput.value=''; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display='none'; refs._removeReceipt = false;}catch(e){} };
      refs.cancelAdd.onclick = closeModalAndBackdrop;
      refs.openCatsBtn.onclick = ()=>openModal('catsModal');
      refs.closeCats.onclick = closeModalAndBackdrop;
  // (config modal remains accessible via settings area) openConfigBtn removed from header
      refs.closeConfig.onclick = closeModalAndBackdrop;

      // add / edit expense
        refs.saveAdd.onclick = ()=>{
        const amt = parseFormattedNumber(refs.amountInput.value || '0'); if(!amt){ alert('Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨'); return }
        const payload = { amount: Math.abs(amt), categoryId: refs.categoryInput.value || '', notes: refs.notesInput.value, date: refs.dateInput.value || new Date().toISOString().slice(0,10), type: refs.typeInput.value };
        // include or remove receipt image data if requested
        try{
          if(refs._removeReceipt){ payload.imageData = null; }
          else if(refs._receiptData){ payload.imageData = refs._receiptData; }
        }catch(e){}
        if(editingExpenseId){
          // update
          updateExpense(editingExpenseId, payload);
        } else {
          addExpense(payload);
        }
        // clear
        refs.amountInput.value=''; refs.notesInput.value=''; editingExpenseId = null; refs.saveAdd.textContent = 'Ø£Ø¶Ù'; closeModalAndBackdrop();
        // clear receipt preview and flags
        try{ if(refs.receiptPreview) refs.receiptPreview.src=''; refs._receiptData = null; refs._removeReceipt = false; if(refs.receiptInput) refs.receiptInput.value=''; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display='none'; }catch(e){}
      };

      // open salary modal for add/edit
      if(refs.addSalaryBtn){ refs.addSalaryBtn.onclick = ()=>{
        // prefill from existing recurring if present
        const found = findSalaryRecurring();
        if(found){
          refs.salaryAmount.value = formatNumberWithCommas(String(found.item.amount||0));
          refs.salarySave.dataset.editing = found.id;
        } else {
          refs.salaryAmount.value = formatNumberWithCommas(localStorage.getItem('lastSalary')||'30000');
          delete refs.salarySave.dataset.editing;
        }
        refs.salaryDate.value = new Date().toISOString().slice(0,10);
        refs.salaryAddNow.checked = true;
        openModal('salaryModal');
        try{ refs.salaryAmount.focus(); }catch(e){}
      } }

      // add category
      refs.addCatBtn.onclick = ()=>{
        const name = refs.newCatName.value.trim(); if(!name){alert('Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© Ù…Ø·Ù„ÙˆØ¨');return}
        addCategory({name, color: refs.newCatColor.value, icon: refs.newCatIcon.value || 'â€¢'});
        refs.newCatName.value=''; refs.newCatIcon.value='';
      };

      // populate budget category select (uses categories or cached)
      function populateBudgetCatSelect(){
        const sel = refs.budgetCatSelect; if(!sel) return;
        sel.innerHTML = '';
        const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
        for(const [id,c] of Object.entries(catObj||{})){
          const o = document.createElement('option'); o.value=id; o.textContent=c.name; sel.appendChild(o);
        }
      }

      // save per-category budget for month
      function saveCategoryBudgetForMonth(yyyyMM, catId, amount){
        if(!catId) return;
        if(db){
          db.ref('settings/monthlyBudgets/'+yyyyMM+'/categories/'+catId).set(Number(amount)).then(()=>{ showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© âœ…'); }).catch(e=>alert('Ø®Ø·Ø£ Ø§Ù„Ø­ÙØ¸: '+e.message));
        } else {
          // local fallback
          const key = 'localMonthCategoryBudgets';
          const all = JSON.parse(localStorage.getItem(key)||'{}');
          all[yyyyMM] = all[yyyyMM] || {};
          all[yyyyMM][catId] = Number(amount);
          localStorage.setItem(key, JSON.stringify(all));
          // reflect in window.settings for UI
          window.settings = window.settings || {};
          window.settings.monthlyBudgets = window.settings.monthlyBudgets || {};
          window.settings.monthlyBudgets[yyyyMM] = window.settings.monthlyBudgets[yyyyMM] || {};
          window.settings.monthlyBudgets[yyyyMM].categories = window.settings.monthlyBudgets[yyyyMM].categories || {};
          window.settings.monthlyBudgets[yyyyMM].categories[catId] = Number(amount);
          computeAndRender();
          showToast('ØªÙ… Ø­ÙØ¸ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© (Ù…Ø­Ù„ÙŠÙ‹Ø§) âœ…');
        }
      }

      // render per-category budgets list for selected month
      function renderCategoryBudgetsList(yyyyMM){
        const el = refs.catBudgetsList; if(!el) return; el.innerHTML='';
        // read budgets from settings or local
        let catBud = {};
        try{ if(window.settings && window.settings.monthlyBudgets && window.settings.monthlyBudgets[yyyyMM] && window.settings.monthlyBudgets[yyyyMM].categories) catBud = window.settings.monthlyBudgets[yyyyMM].categories; }catch(e){}
        try{ const local = JSON.parse(localStorage.getItem('localMonthCategoryBudgets')||'{}'); if(local[yyyyMM]) Object.assign(catBud, local[yyyyMM]); }catch(e){}
        // compute usage per category
        const allObj = getAllExpensesObject();
        const totals = {};
        for(const [id,e] of Object.entries(allObj||{})){
          const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(key!==yyyyMM) continue;
          const cid = e.categoryId || 'uncat'; totals[cid] = (totals[cid]||0) + Number(e.amount||0);
        }
        const catObj = categories && Object.keys(categories).length ? categories : (()=>{ try{ return JSON.parse(localStorage.getItem('cachedCategories')||'{}')}catch(e){return{}} })();
        for(const [cid,bud] of Object.entries(catBud||{})){
          const row = document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
          const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:600">${(catObj[cid]&&catObj[cid].name)||cid}</div><div class=muted style="font-size:12px">Ù…ÙŠØ²Ø§Ù†ÙŠØ©: ${fmt(bud)} Â· Ù…Ø³ØªØ®Ø¯Ù…: ${fmt(totals[cid]||0)}</div>`;
          const percent = bud>0 ? Math.round((totals[cid]||0)/bud*100) : 0;
          const right = document.createElement('div'); right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
          const p = document.createElement('div'); p.style.minWidth='48px'; p.style.textAlign='right'; p.textContent = percent+'%';
          const edit = document.createElement('button'); edit.className='btn ghost'; edit.style.padding='6px 8px'; edit.textContent='ØªØ¹Ø¯ÙŠÙ„';
          edit.onclick = ()=>{ refs.budgetCatSelect.value = cid; refs.budgetCatInput.value = formatNumberWithCommas(String(bud||0)); };
          const del = document.createElement('button');
          del.className='btn ghost';
          del.style.padding='10px 12px';
          del.style.fontWeight='700';
          del.style.borderRadius='10px';
          del.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-inline-end:8px;vertical-align:middle;color:inherit"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path></svg>Ø­Ø°Ù';
          del.onclick = ()=>{ if(!confirm('Ø­Ø°Ù Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„ÙØ¦Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø© Ù„Ù„Ø´Ù‡Ø± ' + yyyyMM + 'ØŸ')) return; deleteCategoryBudgetForMonth(yyyyMM, cid); };
          right.appendChild(p); right.appendChild(edit); right.appendChild(del);
          row.appendChild(left); row.appendChild(right); el.appendChild(row);
        }
        if(Object.keys(catBud||{}).length===0) el.innerHTML = '<div class="muted small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„ÙØ¦Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>';
      }

      // wire saveBudgetCatBtn
      if(refs.saveBudgetCatBtn){ refs.saveBudgetCatBtn.onclick = ()=>{
        const month = refs.filterMonth.value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
        const cid = refs.budgetCatSelect.value; const amt = parseFormattedNumber(refs.budgetCatInput.value||'0');
        if(!cid){ alert('Ø§Ø®ØªØ± ÙØ¦Ø©'); return }
        saveCategoryBudgetForMonth(month, cid, Math.abs(amt));
        refs.budgetCatInput.value=''; renderCategoryBudgetsList(month);
      } }

      // populate select initially
      populateBudgetCatSelect();

      // receipt photo input handling (downscale & preview)
      function readImageFileAsDataURL(file, maxWidth=1000){
        return new Promise((res,rej)=>{
          const reader = new FileReader(); reader.onload = (e)=>{
            const img = new Image(); img.onload = ()=>{
              // downscale if needed
              const canvas = document.createElement('canvas');
              let w = img.width; let h = img.height; if(w>maxWidth){ h = Math.round(h * (maxWidth / w)); w = maxWidth; }
              canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
              const dataUrl = canvas.toDataURL('image/jpeg', 0.8); res(dataUrl);
            };
            img.onerror = ()=>res(e.target.result); img.src = e.target.result;
          };
          reader.onerror = rej; reader.readAsDataURL(file);
        })
      }

      // create file input and preview inside add modal if not present
      try{
        const addModal = $('addModal');
        if(addModal && !$('receiptInput')){
          const container = document.createElement('div'); container.style.marginTop='8px';
          container.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><input id="receiptInput" type="file" accept="image/*" /><img id="receiptPreview" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid #eee;display:none" /><button id="removeReceiptBtn" class="btn ghost" type="button" style="padding:6px 8px;display:none;margin-left:6px">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button></div>`;
          addModal.querySelector('div[style*="margin-top:10px;display:flex;flex-direction:column;gap:8px"]').appendChild(container);
          refs.receiptInput = $('receiptInput'); refs.receiptPreview = $('receiptPreview'); refs.removeReceiptBtn = $('removeReceiptBtn');
          refs.receiptInput.onchange = async (ev)=>{
            const f = ev.target.files && ev.target.files[0]; if(!f) return;
            try{ const data = await readImageFileAsDataURL(f, 800); refs._receiptData = data; refs.receiptPreview.src = data; refs.receiptPreview.style.display='block'; refs._removeReceipt = false; if(refs.removeReceiptBtn) refs.removeReceiptBtn.style.display = 'inline-block'; }catch(e){ console.warn(e) }
          };
          if(refs.removeReceiptBtn){ refs.removeReceiptBtn.onclick = ()=>{ try{ refs._receiptData = null; refs._removeReceipt = true; refs.receiptPreview.src=''; refs.receiptPreview.style.display='none'; if(refs.receiptInput) refs.receiptInput.value=''; refs.removeReceiptBtn.style.display='none'; }catch(e){} } }
        }
      }catch(e){console.warn(e)}

      // salary modal actions
      if(refs.salarySave){ refs.salarySave.onclick = async ()=>{
        const amt = parseFormattedNumber(refs.salaryAmount.value||'0'); if(!amt){ alert('Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨'); return }
        const payload = { name: 'Ø±Ø§ØªØ¨', amount: Math.abs(amt), notes: '' };
        const editing = refs.salarySave.dataset.editing;
        try{
          if(editing) updateRecurringIncome(editing, payload); else addRecurringIncome(payload);
          localStorage.setItem('lastSalary', String(Math.abs(amt)));
          // optionally add now to expenses
          if(refs.salaryAddNow && refs.salaryAddNow.checked){
            const catId = await ensureSalaryCategory();
            const date = refs.salaryDate.value || new Date().toISOString().slice(0,10);
            // mark the expense as a salary record but do not create a persistent category
            addExpense({ amount: Math.abs(amt), categoryId: catId||'', notes:'Ø±Ø§ØªØ¨', date, type:'income', isSalary: true });
          }
          closeModalAndBackdrop();
        }catch(e){ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸: '+(e.message||e)); }
      }}

      if(refs.salaryDelete){ refs.salaryDelete.onclick = ()=>{
        const editing = refs.salarySave.dataset.editing; if(!editing){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ù†Ø¯ Ù…ØªÙƒØ±Ø± Ù„Ù„Ø­Ø°Ù'); return }
        deleteRecurringIncome(editing); delete refs.salarySave.dataset.editing; refs.salaryAmount.value='';
      }}

      if(refs.salaryCancel) refs.salaryCancel.onclick = closeModalAndBackdrop;

      // attach formatted input to salary amount
      try{ attachFormattedInput(refs.salaryAmount); }catch(e){}

      // config initialize
      refs.initFirebaseBtn.onclick = ()=>{
        const txt = refs.firebaseConfigInput.value.trim(); if(!txt){alert('Ø§Ù„ØµÙ‚ Ø§Ù„config JSON');return}
        initFirebaseFromConfigString(txt);
      };

      // monthly budget removed â€” use per-category budgets instead

      // export button removed from header; exportExpensesCSV still available for future use

      // clear all expenses in selected month
      refs.clearMonthBtn.onclick = ()=>{
        const monthFilter = refs.filterMonth.value || (new Date()).getFullYear()+'-'+String(new Date().getMonth()+1).padStart(2,'0');
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ù„Ù„Ø´Ù‡Ø± ' + monthFilter + ' ØŸ\nÙ‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§.')) return;
        for(const [id,e] of Object.entries(expenses)){
          const d = new Date(e.date); const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
          if(key === monthFilter){ db.ref('expenses/'+id).remove(); }
        }
        showToast('ØªÙ… Ø­Ø°Ù Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø± âœ…');
      };

      // filters
      refs.searchInput.oninput = debounce(()=>computeAndRender(), 300);
      refs.filterCategory.onchange = ()=>computeAndRender();
      refs.filterMonth.onchange = ()=>{ computeAndRender(); renderPieChartForSelectedMonth(); };

      // load cached firebase config automatically if present
      const cached = localStorage.getItem('firebaseConfig');
      if(cached){ try{ initFirebaseFromConfigString(cached); }catch(e){console.log('no init') } }

      // Try to sync pending local expenses when app loads (if firebase available later attach will call sync too)
      try{ syncPendingExpenses(); }catch(e){}

      // Ensure current and next month placeholders exist (persisted) so user can add for next month
      try{
        const now = new Date();
        const currentMM = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0');
        const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
        const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
        ensureMonthPlaceholder(currentMM);
        ensureMonthPlaceholder(nextMM);
      }catch(e){}

      // Online/offline events: attempt auto-init and sync when connection returns
      window.addEventListener('online', ()=>{
        showToast('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª â€” Ø­Ø§ÙˆÙ„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©',2000);
        const cached = localStorage.getItem('firebaseConfig');
        if(cached && !db){ try{ initFirebaseFromConfigString(cached); }catch(e){ console.warn('init on online failed', e); } }
        try{ syncPendingExpenses(); }catch(e){console.warn(e)}
      });
      window.addEventListener('offline', ()=>{ showToast('Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„. Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§'); });
      // also ensure month placeholders when we go online (persist next month in DB if possible)
      window.addEventListener('online', ()=>{
        try{
          const now = new Date();
          const next = new Date(now.getFullYear(), now.getMonth()+1, 1);
          const nextMM = next.getFullYear() + '-' + String(next.getMonth()+1).padStart(2,'0');
          ensureMonthPlaceholder(nextMM);
        }catch(e){}
      });

  // default to current month for quicker daily logging
  const defaultMonth = (new Date()).getFullYear() + '-' + String((new Date()).getMonth()+1).padStart(2,'0');
  if(!refs.filterMonth.value) { refs.filterMonth.value = defaultMonth; $('selectedMonthTitle').textContent = defaultMonth; }

      // initial placeholder categories if none (local-first)
      if(!localStorage.getItem('seededCats')){
        const sample = {
          food:{name:'Ø·Ø¹Ø§Ù…',color:'#ff8a65',icon:'ğŸ”'},
          transport:{name:'Ù…ÙˆØ§ØµÙ„Ø§Øª',color:'#4fd1c5',icon:'ğŸš—'},
          clothes:{name:'Ù…Ù„Ø§Ø¨Ø³',color:'#9f7aea',icon:'ğŸ‘—'}
        };
        // only show locally; will be overwritten when firebase loads
        categories = Object.fromEntries(Object.entries(sample).map(([k,v])=>[k,{...v,id:k}]));
        localStorage.setItem('seededCats','1');
        renderCategoriesUI(); populateCategorySelects();
      }

      // If offline or no firebase yet, try load cached categories from previous session
      try{
        const cachedCats = localStorage.getItem('cachedCategories');
        if(cachedCats){
          const parsed = JSON.parse(cachedCats);
          if(parsed && Object.keys(parsed).length){
            categories = parsed;
            renderCategoriesUI(); populateCategorySelects();
          }
        }
      }catch(e){console.warn('failed loading cachedCategories',e)}

      // Immediately remove any existing persistent 'Ø±Ø§ØªØ¨' categories per user request
      try{ removeSalaryCategories(); }catch(e){}

      // small helpers
        function debounce(fn,ms){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}

  // attach to amount and per-category budget inputs for nicer UX (refs available)
  attachFormattedInput(refs.amountInput);
  try{ attachFormattedInput(refs.budgetCatInput); }catch(e){}

    });

  </script>
</script>

  <!-- Lightbox element for full-size image preview -->
  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true">
    <img id="lightboxImg" src="" alt="Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©" />
  </div>

  <script>
    // Lightweight lightbox: opens any image with class 'clickable-thumb' or the receipt preview
    (function(){
      const lb = document.getElementById('lightbox');
      const lbImg = document.getElementById('lightboxImg');
      function showImage(src){ if(!lb||!lbImg) return; lbImg.src = src; lb.classList.add('show'); document.documentElement.style.overflow = 'hidden'; lb.setAttribute('aria-hidden','false'); }
      function hideImage(){ if(!lb||!lbImg) return; lb.classList.remove('show'); lbImg.src = ''; document.documentElement.style.overflow = ''; lb.setAttribute('aria-hidden','true'); }

      // Delegate clicks for thumbnails and receipt preview
      document.addEventListener('click', function(e){
        const t = e.target;
        if(!t) return;
        // clickable thumbnail inside expense rows
        if(t.classList && t.classList.contains('clickable-thumb')){
          e.preventDefault(); e.stopPropagation();
          const src = t.dataset.full || t.src;
          if(src) showImage(src);
          return;
        }
        // receipt preview image by id
        if(t.id === 'receiptPreview'){
          e.preventDefault(); e.stopPropagation();
          const src = t.src;
          if(src) showImage(src);
          return;
        }
        // clicking the lightbox backdrop closes it
        if(t.id === 'lightbox'){
          hideImage();
          return;
        }
      }, false);

      // close on ESC
      document.addEventListener('keyup', function(e){ if(e.key === 'Escape') hideImage(); });

      // also close when tapping outside the image
      if(lb){ lb.addEventListener('click', function(ev){ if(ev.target === lb) hideImage(); }); }
    })();
  </script>

</body>
</html>
